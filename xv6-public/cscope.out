cscope 15 $HOME/xv6-public -q 0000001848 0000197772
	@asm.h

5 
	#SEG_NULLASM
 \

6 .
wï¿½d
 0, 0; \

7 .
byï¿½
 0, 0, 0, 0

	)

11 
	#SEG_ASM
(
tyï¿½
,
baï¿½
,
lim
) \

12 .
	`wï¿½d
 (((
lim
ï¿½>> 12ï¿½& 0xffff), ((
baï¿½
) & 0xffff); \

13 .
	`byï¿½
 (((
baï¿½
ï¿½>> 16ï¿½& 0xff), (0x90 | (
tyï¿½
)), \

14 (0xC0 | (((
lim
ï¿½>> 28ï¿½& 0xf)), (((
baï¿½
ï¿½>> 24ï¿½& 0xff)

	)

16 
	#STA_X
 0x8

17 
	#STA_W
 0x2

18 
	#STA_R
 0x2

	@bio.c

21 
	~"tyï¿½s.h
"

22 
	~"defs.h
"

23 
	~"ï¿½ï¿½m.h
"

24 
	~"ï¿½ï¿½lock.h
"

25 
	~"ï¿½ï¿½ï¿½ock.h
"

26 
	~"fs.h
"

27 
	~"buf.h
"

30 
ï¿½ï¿½lock
 
	mlock
;

31 
buf
 
	mbuf
[
NBUF
];

35 
buf
 
	mhï¿½d
;

36 } 
	gbï¿½che
;

39 
	$bï¿½ï¿½
()

41 
buf
 *
b
;

43 
	`ï¿½ï¿½lock
(&
bï¿½che
.
lock
, "bcache");

47 
bï¿½che
.
hï¿½d
.
ï¿½ev
 = &bcache.head;

48 
bï¿½che
.
hï¿½d
.
ï¿½xt
 = &bcache.head;

49 
b
 = 
bï¿½che
.
buf
; b < bï¿½che.buf+
NBUF
; b++){

50 
b
->
ï¿½xt
 = 
bï¿½che
.
hï¿½d
.next;

51 
b
->
ï¿½ev
 = &
bï¿½che
.
hï¿½d
;

52 
	`ï¿½ï¿½ï¿½ï¿½ï¿½ock
(&
b
->
lock
, "buffer");

53 
bï¿½che
.
hï¿½d
.
ï¿½xt
->
ï¿½ev
 = 
b
;

54 
bï¿½che
.
hï¿½d
.
ï¿½xt
 = 
b
;

56 
	}
}

61 
buf
*

62 
	$bgï¿½
(
uï¿½t
 
dev
, uï¿½ï¿½
blockno
)

64 
buf
 *
b
;

66 
	`acquï¿½e
(&
bï¿½che
.
lock
);

69 
b
 = 
bï¿½che
.
hï¿½d
.
ï¿½xt
; b != &bcache.head; b = b->next){

70 if(
b
->
dev
 =ï¿½dev && b->
blockno
 == blockno){

71 
b
->
ï¿½fï¿½t
++;

72 
	`ï¿½ï¿½aï¿½
(&
bï¿½che
.
lock
);

73 
	`acquï¿½eï¿½ï¿½p
(&
b
->
lock
);

74  
b
;

81 
b
 = 
bï¿½che
.
hï¿½d
.
ï¿½ev
; b != &bcache.head; b = b->prev){

82 if(
b
->
ï¿½fï¿½t
 =ï¿½0 && (b->
ï¿½ags
 & 
B_DIRTY
) == 0) {

83 
b
->
dev
 = dev;

84 
b
->
blockno
 = blockno;

85 
b
->
ï¿½ags
 = 0;

86 
b
->
ï¿½fï¿½t
 = 1;

87 
	`ï¿½ï¿½aï¿½
(&
bï¿½che
.
lock
);

88 
	`acquï¿½eï¿½ï¿½p
(&
b
->
lock
);

89  
b
;

92 
	`ï¿½nic
("bget:ï¿½o buffers");

93 
	}
}

96 
buf
*

97 
	$bï¿½ad
(
uï¿½t
 
dev
, uï¿½ï¿½
blockno
)

99 
buf
 *
b
;

101 
b
 = 
	`bgï¿½
(
dev
, 
blockno
);

102 if((
b
->
ï¿½ags
 & 
B_VALID
) == 0) {

103 
	`idï¿½w
(
b
);

105  
b
;

106 
	}
}

110 
	$bwrï¿½e
(
buf
 *
b
)

112 if(!
	`hï¿½dï¿½gï¿½ï¿½p
(&
b
->
lock
))

113 
	`ï¿½nic
("bwrite");

114 
b
->
ï¿½ags
 |ï¿½
B_DIRTY
;

115 
	`idï¿½w
(
b
);

116 
	}
}

121 
	$bï¿½lï¿½
(
buf
 *
b
)

123 if(!
	`hï¿½dï¿½gï¿½ï¿½p
(&
b
->
lock
))

124 
	`ï¿½nic
("brelse");

126 
	`ï¿½ï¿½aï¿½ï¿½ï¿½p
(&
b
->
lock
);

128 
	`acquï¿½e
(&
bï¿½che
.
lock
);

129 
b
->
ï¿½fï¿½t
--;

130 iï¿½(
b
->
ï¿½fï¿½t
 == 0) {

132 
b
->
ï¿½xt
->
ï¿½ev
 = b->prev;

133 
b
->
ï¿½ev
->
ï¿½xt
 = b->next;

134 
b
->
ï¿½xt
 = 
bï¿½che
.
hï¿½d
.next;

135 
b
->
ï¿½ev
 = &
bï¿½che
.
hï¿½d
;

136 
bï¿½che
.
hï¿½d
.
ï¿½xt
->
ï¿½ev
 = 
b
;

137 
bï¿½che
.
hï¿½d
.
ï¿½xt
 = 
b
;

140 
	`ï¿½ï¿½aï¿½
(&
bï¿½che
.
lock
);

141 
	}
}

	@bootasm.S

1 
	~"asm.h
"

2 
	~"memï¿½yout.h
"

3 
	~"mmu.h
"

5 #Sï¿½ï¿½ 
the
 
fï¿½ï¿½
 
CPU
: 
to
 32-
bï¿½
 
ï¿½ï¿½eï¿½ed
 
mode
, 
jump
 
ï¿½to
 
C
.

6 #Thï¿½
BIOS
 
lï¿½ds
 
this
 
code
 
ï¿½om
 
the
 
fï¿½ï¿½
 
ï¿½ï¿½ï¿½
 
of
ï¿½hï¿½
hï¿½d
 
disk
 
ï¿½to


7 #memï¿½y 
ï¿½
 
physiï¿½l
 
addï¿½ss
 0x7c00 
ï¿½d
 
ï¿½ï¿½ts
 
executï¿½g
 
ï¿½
 
ï¿½ï¿½
 
mode


8 #wï¿½h %
cs
=0 %
ï¿½
=7c00.

10 .
	gcode16
 #Asï¿½mbï¿½ 16-
bï¿½
 
	gmode


11 .
globl
 
ï¿½ï¿½t


12 
	gï¿½ï¿½t
:

13 
ï¿½i
 #BIOS 
ï¿½abï¿½d
 
ï¿½ï¿½ï¿½uï¿½s
; 
	gdiï¿½bï¿½


15 #Zï¿½ï¿½
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½giï¿½ï¿½s
 
DS
, 
ES
, 
ï¿½d
 
SS
.

16 
	gxï¿½w
 %
	gax
,%ax #Sï¿½ %
ax
 
to
 
zï¿½o


17 
	gmovw
 %
	gax
,%
	gds
 #-> 
Dï¿½a
 
Segmï¿½t


18 
	gmovw
 %
	gax
,%
	ges
 #-> 
Exï¿½a
 
Segmï¿½t


19 
	gmovw
 %
	gax
,%
	gss
 #-> 
Sï¿½ck
 
	gSegmï¿½t


21 #Physiï¿½ï¿½
addï¿½ss
 
lï¿½e
 
A20
 
is
 
tï¿½d
 
to
 
zï¿½o
 
so
 
thï¿½
 
the
 
fï¿½ï¿½
 
PCs


22 #wï¿½h 2 
MB
 
would
 
run
 
soï¿½wï¿½e
 
thï¿½
 
assumed
 1 MB. 
Undo
ï¿½hat.

23 
	gï¿½ï¿½20
.1:

24 
ï¿½b
 
$0x64
,%
	gï¿½
 #Waï¿½ 
nï¿½
 
busy


25 
ï¿½ï¿½b
 
	g$0x2
,%
ï¿½


26 
jnz
 
	gï¿½ï¿½20
.1

28 
movb
 
	g$0xd1
,%
	gï¿½
 #0
	gxd1
 -> 
	gpï¿½t
 0x64

29 
	goutb
 %
	gï¿½
,
$0x64


31 
	gï¿½ï¿½20
.2:

32 
ï¿½b
 
$0x64
,%
	gï¿½
 #Waï¿½ 
nï¿½
 
busy


33 
ï¿½ï¿½b
 
	g$0x2
,%
ï¿½


34 
jnz
 
	gï¿½ï¿½20
.2

36 
movb
 
	g$0xdf
,%
	gï¿½
 #0
	gxdf
 -> 
	gpï¿½t
 0x60

37 
	goutb
 %
	gï¿½
,
	g$0x60


39 #Swï¿½ch 
ï¿½om
 
ï¿½ï¿½
 
to
 
ï¿½ï¿½eï¿½ed
 
mode
. 
Uï¿½
 
a
 
boÙ¡ï¿½p
 
GDT
 
thï¿½
 
makes


40 #vï¿½tuï¿½ 
addï¿½sï¿½s
 
mï¿½
 
dï¿½eï¿½ly
 
to
 
physiï¿½l
ï¿½ddï¿½sï¿½ï¿½
so
 
thï¿½
 
the


41 #efï¿½ï¿½ivï¿½
memï¿½y
 
mï¿½
 
dÛ¢
't change duringï¿½heï¿½ransition.

42 
lgdt
 
gdtdesc


43 
	gmovl
 %
	gï¿½0
, %
ï¿½x


44 
ï¿½l
 
	g$CR0_PE
, %
ï¿½x


45 
	gmovl
 %
	gï¿½x
, %
	gï¿½0


48 #Comï¿½ï¿½ï¿½
the
 
ï¿½ï¿½sï¿½iï¿½
 
to
 32-
bï¿½
 
ï¿½ï¿½eï¿½ed
 
mode
 
by
 
usï¿½g
 
a
 
jmp


49 #tï¿½
ï¿½lï¿½d
 %
cs
 
ï¿½d
 %
eï¿½
. 
The
 
ï¿½gmï¿½t
 
desï¿½ï¿½tï¿½s
 
ï¿½e
 
ï¿½t
 
up
 
wï¿½h
 
no


50 #ï¿½ï¿½ï¿½ï¿½iï¿½, 
so
 
thï¿½
 
the
 
mï¿½pï¿½g
 
is
 
ï¿½ï¿½l
ï¿½hï¿½
idï¿½tï¿½y
 mapping.

51 
ljmp
 
$
(
SEG_KCODE
<<3), 
	g$ï¿½ï¿½t32


53 .
	gcode32
 #Tï¿½ï¿½
asï¿½mbï¿½r
 
to
 
	ggï¿½ï¿½ï¿½e
 32-
bï¿½
 
code
 
	gnow
.

54 
	gï¿½ï¿½t32
:

55 #Sï¿½ 
up
 
the
 
ï¿½ï¿½eï¿½ed
-
mode
 
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½giï¿½ï¿½s


56 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ouï¿½
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½ï¿½ï¿½ï¿½


57 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
Dï¿½a
 
Segmï¿½t


58 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exï¿½a
 
Segmï¿½t


59 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sï¿½ck
 
Segmï¿½t


60 
movw
 
$0
, %
	gax
 #Zï¿½ï¿½
ï¿½gmï¿½ts
 
nï¿½
 
ï¿½ady
 
uï¿½


61 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


62 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


64 #Sï¿½ 
up
 
the
 
ï¿½ack
 
poï¿½ï¿½r
 
ï¿½d
 
ï¿½ï¿½
 
ï¿½to
 
C
.

65 
movl
 
	g$ï¿½ï¿½t
, %
eï¿½


66 
ï¿½ï¿½
 
	gboï¿½maï¿½


68 #Iï¿½
boï¿½maï¿½
 
ï¿½tuï¿½s
 (
ï¿½
 
shouldn
't),ï¿½riggerï¿½ Bochs

69 #bï¿½akpoï¿½ï¿½
ruÂšg
 
undï¿½
 
Bochs
, 
thï¿½
 
loï¿½
.

70 
movw
 
$0x8a00
, %
ax
 #0
x8a00
 -> 
pï¿½t
 0x8a00

71 
movw
 %
ax
, %
dx


72 
outw
 %
ax
, %
dx


73 
movw
 
$0x8ï¿½0
, %
ax
 #0
x8ï¿½0
 -> 
pï¿½t
 0x8a00

74 
outw
 %
ax
, %
dx


75 
ï¿½ï¿½
:

76 
jmp
 
ï¿½ï¿½


78 #BoÙ¡ï¿½ï¿½
GDT


79 .
p2ï¿½ign
 2 #fï¿½ï¿½ 4 
byï¿½
 
ï¿½ignmï¿½t


80 
gdt
:

81 
SEG_NULLASM
 #nuï¿½ 
ï¿½g


82 
SEG_ASM
(
STA_X
|
STA_R
, 0x0, 0xffffffffï¿½#codï¿½
ï¿½g


83 
	$SEG_ASM
(
STA_W
, 0x0, 0xffffffffï¿½#dï¿½ï¿½
ï¿½g


85 
gdtdesc
:

86 .
	`wï¿½d
 (
gdtdesc
 - 
gdt
 - 1) #sizeof(gdt) - 1

87 .
gdt
 #address gdt

	@bootmain.c

8 
	~"tyï¿½s.h
"

9 
	~"ï¿½f.h
"

10 
	~"x86.h
"

11 
	~"memï¿½yout.h
"

13 
	#SECTSIZE
 512

	)

15 
ï¿½adï¿½g
(
uchï¿½
*, 
uï¿½t
, uint);

18 
	$boï¿½maï¿½
()

20 
ï¿½fhdr
 *
ï¿½f
;

21 
ï¿½oghdr
 *
ph
, *
ï¿½h
;

22 (*
ï¿½ï¿½y
)();

23 
uchï¿½
* 
ï¿½
;

25 
ï¿½f
 = (
ï¿½fhdr
*)0x10000;

28 
	`ï¿½adï¿½g
((
uchï¿½
*)
ï¿½f
, 4096, 0);

31 if(
ï¿½f
->
magic
 !ï¿½
ELF_MAGIC
)

35 
ph
 = (
ï¿½oghdr
*)((
uchï¿½
*)
ï¿½f
 +ï¿½lf->
phoff
);

36 
ï¿½h
 = 
ph
 + 
ï¿½f
->
phnum
;

37 ; 
ph
 < 
ï¿½h
;ï¿½h++){

38 
ï¿½
 = (
uchï¿½
*)
ph
->
ï¿½ddr
;

39 
	`ï¿½adï¿½g
(
ï¿½
, 
ph
->
fï¿½esz
,ï¿½h->
off
);

40 if(
ph
->
memsz
 >ï¿½h->
fï¿½esz
)

41 
	`ï¿½osb
(
ï¿½
 + 
ph
->
fï¿½esz
, 0,ï¿½h->
memsz
 -ï¿½h->filesz);

46 
ï¿½ï¿½y
 = ((*)())(
ï¿½f
->entry);

47 
	`ï¿½ï¿½y
();

48 
	}
}

51 
	$waï¿½disk
()

54 (
	`ï¿½b
(0x1F7) & 0xC0) != 0x40)

56 
	}
}

60 
	$ï¿½adï¿½ï¿½
(*
dï¿½
, 
uï¿½t
 
offï¿½t
)

63 
	`waï¿½disk
();

64 
	`outb
(0x1F2, 1);

65 
	`outb
(0x1F3, 
offï¿½t
);

66 
	`outb
(0x1F4, 
offï¿½t
 >> 8);

67 
	`outb
(0x1F5, 
offï¿½t
 >> 16);

68 
	`outb
(0x1F6, (
offï¿½t
 >> 24) | 0xE0);

69 
	`outb
(0x1F7, 0x20);

72 
	`waï¿½disk
();

73 
	`ï¿½ï¿½
(0x1F0, 
dï¿½
, 
SECTSIZE
/4);

74 
	}
}

79 
	$ï¿½adï¿½g
(
uchï¿½
* 
ï¿½
, 
uï¿½t
 
couï¿½
, uï¿½ï¿½
offï¿½t
)

81 
uchï¿½
* 
ï¿½a
;

83 
ï¿½a
 = 
ï¿½
 + 
couï¿½
;

86 
ï¿½
 -ï¿½
offï¿½t
 % 
SECTSIZE
;

89 
offï¿½t
 = (offï¿½ï¿½/ 
SECTSIZE
) + 1;

94 ; 
ï¿½
 < 
ï¿½a
;ï¿½ï¿½+ï¿½
SECTSIZE
, 
offï¿½t
++)

95 
	`ï¿½adï¿½ï¿½
(
ï¿½
, 
offï¿½t
);

96 
	}
}

	@buf.h

1 
	sbuf
 {

2 
	mï¿½ags
;

3 
uï¿½t
 
	mdev
;

4 
uï¿½t
 
	mblockno
;

5 
ï¿½ï¿½ï¿½ock
 
	mlock
;

6 
uï¿½t
 
	mï¿½fï¿½t
;

7 
buf
 *
	mï¿½ev
;

8 
buf
 *
	mï¿½xt
;

9 
buf
 *
	mqï¿½xt
;

10 
uchï¿½
 
	mdï¿½a
[
BSIZE
];

12 
	#B_VALID
 0x2

13 
	#B_DIRTY
 0x4

14 

	)

	@cat.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

5 
	gbuf
[512];

8 
	$ï¿½t
(
fd
)

10 
n
;

12 (
n
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf))) > 0) {

13 iï¿½(
	`wrï¿½e
(1, 
buf
, 
n
) !=ï¿½) {

14 
	`ï¿½ï¿½tf
(1, "cat: writeï¿½rror\n");

15 
	`exï¿½
();

18 if(
n
 < 0){

19 
	`ï¿½ï¿½tf
(1, "cat:ï¿½eadï¿½rror\n");

20 
	`exï¿½
();

22 
	}
}

25 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

27 
fd
, 
i
;

29 if(
ï¿½gc
 <= 1){

30 
	`ï¿½t
(0);

31 
	`exï¿½
();

34 
i
 = 1; i < 
ï¿½gc
; i++){

35 if((
fd
 = 
	`Ý’
(
ï¿½gv
[
i
], 0)) < 0){

36 
	`ï¿½ï¿½tf
(1, "ï¿½t: cï¿½nï¿½ oï¿½ï¿½%s\n", 
ï¿½gv
[
i
]);

37 
	`exï¿½
();

39 
	`ï¿½t
(
fd
);

40 
	`ï¿½oï¿½
(
fd
);

42 
	`exï¿½
();

43 
	}
}

	@console.c

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"ï¿½ï¿½m.h
"

8 
	~"ï¿½ï¿½s.h
"

9 
	~"ï¿½ï¿½lock.h
"

10 
	~"ï¿½ï¿½ï¿½ock.h
"

11 
	~"fs.h
"

12 
	~"fï¿½e.h
"

13 
	~"memï¿½yout.h
"

14 
	~"mmu.h
"

15 
	~"ï¿½oc.h
"

16 
	~"x86.h
"

18 
cÚ¥utc
();

20 
	gï¿½nicked
 = 0;

23 
ï¿½ï¿½lock
 
	mlock
;

24 
	mlockï¿½g
;

25 } 
	gcï¿½s
;

28 
	$ï¿½ï¿½tï¿½t
(
xx
, 
baï¿½
, 
sign
)

30 
digï¿½s
[] = "0123456789abcdef";

31 
buf
[16];

32 
i
;

33 
uï¿½t
 
x
;

35 if(
sign
 && (sigï¿½ï¿½
xx
 < 0))

36 
x
 = -
xx
;

38 
x
 = 
xx
;

40 
i
 = 0;

42 
buf
[
i
++] = 
digï¿½s
[
x
 % 
baï¿½
];

43 }(
x
 /ï¿½
baï¿½
) != 0);

45 if(
sign
)

46 
buf
[
i
++] = '-';

48 --
i
 >= 0)

49 
	`cÚ¥utc
(
buf
[
i
]);

50 
	}
}

55 
	$ï¿½rï¿½tf
(*
fmt
, ...)

57 
i
, 
c
, 
lockï¿½g
;

58 
uï¿½t
 *
ï¿½gp
;

59 *
s
;

61 
lockï¿½g
 = 
cï¿½s
.locking;

62 if(
lockï¿½g
)

63 
	`acquï¿½e
(&
cï¿½s
.
lock
);

65 iï¿½(
fmt
 == 0)

66 
	`ï¿½nic
("null fmt");

68 
ï¿½gp
 = (
uï¿½t
*)(*)(&
fmt
 + 1);

69 
i
 = 0; (
c
 = 
fmt
[i] & 0xff) != 0; i++){

70 if(
c
 != '%'){

71 
	`cÚ¥utc
(
c
);

74 
c
 = 
fmt
[++
i
] & 0xff;

75 if(
c
 == 0)

77 
c
){

79 
	`ï¿½ï¿½tï¿½t
(*
ï¿½gp
++, 10, 1);

83 
	`ï¿½ï¿½tï¿½t
(*
ï¿½gp
++, 16, 0);

86 if((
s
 = (*)*
ï¿½gp
++) == 0)

87 
s
 = "(null)";

88 ; *
s
; s++)

89 
	`cÚ¥utc
(*
s
);

92 
	`cÚ¥utc
('%');

96 
	`cÚ¥utc
('%');

97 
	`cÚ¥utc
(
c
);

102 if(
lockï¿½g
)

103 
	`ï¿½ï¿½aï¿½
(&
cï¿½s
.
lock
);

104 
	}
}

107 
	$ï¿½nic
(*
s
)

109 
i
;

110 
uï¿½t
 
pcs
[10];

112 
	`ï¿½i
();

113 
cï¿½s
.
lockï¿½g
 = 0;

115 
	`ï¿½rï¿½tf
("ï¿½picid %d:ï¿½ï¿½ic: ", 
	`ï¿½picid
());

116 
	`ï¿½rï¿½tf
(
s
);

117 
	`ï¿½rï¿½tf
("\n");

118 
	`gï¿½ï¿½Î”pcs
(&
s
, 
pcs
);

119 
i
=0; i<10; i++)

120 
	`ï¿½rï¿½tf
(" %p", 
pcs
[
i
]);

121 
ï¿½nicked
 = 1;

124 
	}
}

127 
	#BACKSPACE
 0x100

	)

128 
	#CRTPORT
 0x3d4

	)

129 
ushï¿½t
 *
	gï¿½t
 = (ushï¿½t*)
P2V
(0xb8000);

132 
	$cgï¿½utc
(
c
)

134 
pos
;

137 
	`outb
(
CRTPORT
, 14);

138 
pos
 = 
	`ï¿½b
(
CRTPORT
+1) << 8;

139 
	`outb
(
CRTPORT
, 15);

140 
pos
 |ï¿½
	`ï¿½b
(
CRTPORT
+1);

142 if(
c
 == '\n')

143 
pos
 += 80 -ï¿½os%80;

144 if(
c
 =ï¿½
BACKSPACE
){

145 if(
pos
 > 0) --pos;

147 
ï¿½t
[
pos
++] = (
c
&0xff) | 0x0700;

149 if(
pos
 < 0 ||ï¿½os > 25*80)

150 
	`ï¿½nic
("pos under/overflow");

152 if((
pos
/80) >= 24){

153 
	`memmove
(
ï¿½t
, crt+80, (crt[0])*23*80);

154 
pos
 -= 80;

155 
	`memï¿½t
(
ï¿½t
+
pos
, 0, (crt[0])*(24*80 -ï¿½os));

158 
	`outb
(
CRTPORT
, 14);

159 
	`outb
(
CRTPORT
+1, 
pos
>>8);

160 
	`outb
(
CRTPORT
, 15);

161 
	`outb
(
CRTPORT
+1, 
pos
);

162 
ï¿½t
[
pos
] = ' ' | 0x0700;

163 
	}
}

166 
	$cÚ¥utc
(
c
)

168 if(
ï¿½nicked
){

169 
	`ï¿½i
();

174 if(
c
 =ï¿½
BACKSPACE
){

175 
	`uï¿½ï¿½utc
('\b'); uartputc(' '); uartputc('\b');

177 
	`uï¿½ï¿½utc
(
c
);

178 
	`cgï¿½utc
(
c
);

179 
	}
}

181 
	#INPUT_BUF
 128

	)

183 
	mbuf
[
INPUT_BUF
];

184 
uï¿½t
 
	mr
;

185 
uï¿½t
 
	mw
;

186 
uï¿½t
 
	me
;

187 } 
	gï¿½put
;

189 
	#C
(
x
) ((x)-'@')

190 

	)

192 
	$cï¿½sï¿½eï¿½ï¿½
((*
gï¿½c
)())

194 
c
, 
dï¿½rocdump
 = 0;

196 
	`acquï¿½e
(&
cï¿½s
.
lock
);

197 (
c
 = 
	`gï¿½c
()) >= 0){

198 
c
){

199 
	`C
('P'):

201 
dï¿½rocdump
 = 1;

203 
	`C
('U'):

204 
ï¿½put
.
e
 !ï¿½put.
w
 &&

205 
ï¿½put
.
buf
[(ï¿½put.
e
-1ï¿½% 
INPUT_BUF
] != '\n'){

206 
ï¿½put
.
e
--;

207 
	`cÚ¥utc
(
BACKSPACE
);

210 
	`C
('H'): '\x7f':

211 if(
ï¿½put
.
e
 !ï¿½put.
w
){

212 
ï¿½put
.
e
--;

213 
	`cÚ¥utc
(
BACKSPACE
);

217 if(
c
 !ï¿½0 && 
ï¿½put
.
e
-ï¿½put.
r
 < 
INPUT_BUF
){

218 
c
 = (c == '\r') ? '\n' : c;

219 
ï¿½put
.
buf
[ï¿½put.
e
++ % 
INPUT_BUF
] = 
c
;

220 
	`cÚ¥utc
(
c
);

221 if(
c
 =ï¿½'\n' || c =ï¿½
	`C
('D'ï¿½|| 
ï¿½put
.
e
 =ï¿½put.
r
+
INPUT_BUF
){

222 
ï¿½put
.
w
 = iï¿½ut.
e
;

223 
	`wakeup
(&
ï¿½put
.
r
);

229 
	`ï¿½ï¿½aï¿½
(&
cï¿½s
.
lock
);

230 if(
dï¿½rocdump
) {

231 
	`ï¿½ocdump
();

233 
	}
}

236 
	$cï¿½sÞ”ï¿½d
(
ï¿½ode
 *
ï¿½
, *
dï¿½
, 
n
)

238 
uï¿½t
 
ï¿½rgï¿½
;

239 
c
;

241 
	`iuï¿½ock
(
ï¿½
);

242 
ï¿½rgï¿½
 = 
n
;

243 
	`acquï¿½e
(&
cï¿½s
.
lock
);

244 
n
 > 0){

245 
ï¿½put
.
r
 =ï¿½put.
w
){

246 if(
	`myï¿½oc
()->
kï¿½ï¿½d
){

247 
	`ï¿½ï¿½aï¿½
(&
cï¿½s
.
lock
);

248 
	`ï¿½ock
(
ï¿½
);

251 
	`ï¿½ï¿½p
(&
ï¿½put
.
r
, &
cï¿½s
.
lock
);

253 
c
 = 
ï¿½put
.
buf
[ï¿½put.
r
++ % 
INPUT_BUF
];

254 if(
c
 =ï¿½
	`C
('D')){

255 if(
n
 < 
ï¿½rgï¿½
){

258 
ï¿½put
.
r
--;

262 *
dï¿½
++ = 
c
;

263 --
n
;

264 if(
c
 == '\n')

267 
	`ï¿½ï¿½aï¿½
(&
cï¿½s
.
lock
);

268 
	`ï¿½ock
(
ï¿½
);

270  
ï¿½rgï¿½
 - 
n
;

271 
	}
}

274 
	$cï¿½sï¿½ewrï¿½e
(
ï¿½ode
 *
ï¿½
, *
buf
, 
n
)

276 
i
;

278 
	`iuï¿½ock
(
ï¿½
);

279 
	`acquï¿½e
(&
cï¿½s
.
lock
);

280 
i
 = 0; i < 
n
; i++)

281 
	`cÚ¥utc
(
buf
[
i
] & 0xff);

282 
	`ï¿½ï¿½aï¿½
(&
cï¿½s
.
lock
);

283 
	`ï¿½ock
(
ï¿½
);

285  
n
;

286 
	}
}

289 
	$cï¿½sï¿½eï¿½ï¿½
()

291 
	`ï¿½ï¿½lock
(&
cï¿½s
.
lock
, "console");

293 
devsw
[
CONSOLE
].
wrï¿½e
 = 
cï¿½sï¿½ewrï¿½e
;

294 
devsw
[
CONSOLE
].
ï¿½ad
 = 
cï¿½sÞ”ï¿½d
;

295 
cï¿½s
.
lockï¿½g
 = 1;

297 
	`iï¿½piï¿½ï¿½bï¿½
(
IRQ_KBD
, 0);

298 
	}
}

	@date.h

1 
	sï¿½cdï¿½e
 {

2 
uï¿½t
 
	mï¿½cï¿½d
;

3 
uï¿½t
 
	mmï¿½uï¿½
;

4 
uï¿½t
 
	mhour
;

5 
uï¿½t
 
	mday
;

6 
uï¿½t
 
	mmï¿½th
;

7 
uï¿½t
 
	myï¿½r
;

	@defs.h

1 
	gbuf
;

2 
	gcÚ‹xt
;

3 
	gfï¿½e
;

4 
	gï¿½ode
;

5 
	gpï¿½e
;

6 
	gï¿½oc
;

7 
	gï¿½cdï¿½e
;

8 
	gï¿½ï¿½lock
;

9 
	gï¿½ï¿½ï¿½ock
;

10 
	gï¿½ï¿½
;

11 
	gsuï¿½rblock
;

14 
bï¿½ï¿½
();

15 
buf
* 
bï¿½ad
(
uï¿½t
, uint);

16 
bï¿½lï¿½
(
buf
*);

17 
bwrï¿½e
(
buf
*);

20 
cï¿½sï¿½eï¿½ï¿½
();

21 
ï¿½rï¿½tf
(*, ...);

22 
cï¿½sï¿½eï¿½ï¿½
((*)());

23 
	$ï¿½nic
(*ï¿½
	`__ï¿½ï¿½ibuï¿½__
((
nÜ‘uï¿½
));

26 
	`exec
(*, **);

29 
fï¿½e
* 
	`fï¿½ï¿½ï¿½oc
();

30 
	`fï¿½eï¿½oï¿½
(
fï¿½e
*);

31 
fï¿½e
* 
	`fï¿½edup
(file*);

32 
	`fï¿½eï¿½ï¿½
();

33 
	`fï¿½ï¿½ï¿½d
(
fï¿½e
*, *, 
n
);

34 
	`fï¿½eï¿½ï¿½
(
fï¿½e
*, 
ï¿½ï¿½
*);

35 
	`fï¿½ewrï¿½e
(
fï¿½e
*, *, 
n
);

38 
	`ï¿½adsb
(
dev
, 
suï¿½rblock
 *
sb
);

39 
	`dï¿½lï¿½k
(
ï¿½ode
*, *, 
uï¿½t
);

40 
ï¿½ode
* 
	`dï¿½lookup
(ï¿½ode*, *, 
uï¿½t
*);

41 
ï¿½ode
* 
	`ï¿½ï¿½oc
(
uï¿½t
, );

42 
ï¿½ode
* 
	`idup
(inode*);

43 
	`iï¿½ï¿½
(
dev
);

44 
	`ï¿½ock
(
ï¿½ode
*);

45 
	`ï¿½ut
(
ï¿½ode
*);

46 
	`iuï¿½ock
(
ï¿½ode
*);

47 
	`iuï¿½ockput
(
ï¿½ode
*);

48 
	`iupdï¿½e
(
ï¿½ode
*);

49 
	`ï¿½mecmp
(const *, const *);

50 
ï¿½ode
* 
	`ï¿½mei
(*);

51 
ï¿½ode
* 
	`ï¿½meï¿½ï¿½ï¿½t
(*, *);

52 
	`ï¿½adi
(
ï¿½ode
*, *, 
uï¿½t
, uint);

53 
	`ï¿½ï¿½i
(
ï¿½ode
*, 
ï¿½ï¿½
*);

54 
	`wrï¿½ei
(
ï¿½ode
*, *, 
uï¿½t
, uint);

57 
	`ideï¿½ï¿½
();

58 
	`ideï¿½ï¿½
();

59 
	`idï¿½w
(
buf
*);

62 
	`iï¿½piï¿½ï¿½bï¿½
(
ï¿½q
, 
ï¿½u
);

63 
uchï¿½
 
iï¿½picid
;

64 
	`iï¿½picï¿½ï¿½
();

67 * 
	`kï¿½loc
();

68 
	`kï¿½
(*);

69 
	`kï¿½ï¿½1
(*, *);

70 
	`kï¿½ï¿½2
(*, *);

73 
	`kbdï¿½ï¿½
();

76 
	`cmoï¿½ime
(
ï¿½cdï¿½e
 *
r
);

77 
	`ï¿½picid
();

78 
vÞ©ï¿½ï¿½
uï¿½t
* 
ï¿½pic
;

79 
	`ï¿½piï¿½oi
();

80 
	`ï¿½picï¿½ï¿½
();

81 
	`ï¿½picï¿½ï¿½ï¿½p
(
uchï¿½
, 
uï¿½t
);

82 
	`miï¿½odï¿½ay
();

85 
	`ï¿½ï¿½log
(
dev
);

86 
	`log_wrï¿½e
(
buf
*);

87 
	`begï¿½_ï¿½
();

88 
	`ï¿½d_ï¿½
();

91 

ismp
;

92 
	`mpï¿½ï¿½
();

95 
	`piï¿½ï¿½bï¿½
();

96 
	`picï¿½ï¿½
();

99 
	`pï¿½ï¿½ï¿½oc
(
fï¿½e
**, file**);

100 
	`pï¿½eï¿½oï¿½
(
pï¿½e
*, );

101 
	`pï¿½ï¿½ï¿½d
(
pï¿½e
*, *, );

102 
	`pï¿½ewrï¿½e
(
pï¿½e
*, *, );

106 
	`ï¿½uid
();

107 
	`exï¿½
();

108 
	`fï¿½k
();

109 
	`growï¿½oc
();

110 
	`kï¿½l
();

111 
ï¿½u
* 
	`myï¿½u
();

112 
ï¿½oc
* 
	`myï¿½oc
();

113 
	`pï¿½ï¿½
();

114 
	`ï¿½ocdump
();

115 
	$scheduï¿½r
(ï¿½
	`__ï¿½ï¿½ibuï¿½__
((
nÜ‘uï¿½
));

116 
	`sched
();

117 
	`ï¿½ï¿½roc
(
ï¿½oc
*);

118 
	`ï¿½ï¿½p
(*, 
ï¿½ï¿½lock
*);

119 
	`uï¿½rï¿½ï¿½
();

120 
	`waï¿½
();

121 
	`wakeup
(*);

122 
	`yï¿½ld
();

125 
	`swtch
(
cÚ‹xt
**, context*);

128 
	`acquï¿½e
(
ï¿½ï¿½lock
*);

129 
	`gï¿½ï¿½Î”pcs
(*, 
uï¿½t
*);

130 
	`hï¿½dï¿½g
(
ï¿½ï¿½lock
*);

131 
	`ï¿½ï¿½lock
(
ï¿½ï¿½lock
*, *);

132 
	`ï¿½ï¿½aï¿½
(
ï¿½ï¿½lock
*);

133 
	`pushï¿½i
();

134 
	`pï¿½ï¿½i
();

137 
	`acquï¿½eï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
*);

138 
	`ï¿½ï¿½aï¿½ï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
*);

139 
	`hï¿½dï¿½gï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
*);

140 
	`ï¿½ï¿½ï¿½ï¿½ï¿½ock
(
ï¿½ï¿½ï¿½ock
*, *);

143 
	`memcmp
(cÚ¡ *, cÚ¡ *, 
uï¿½t
);

144 * 
	`memmove
(*, cÚ¡ *, 
uï¿½t
);

145 * 
	`memï¿½t
(*, , 
uï¿½t
);

146 * 
	`ï¿½ï¿½rï¿½y
(*, const *, );

147 
	`ï¿½ï¿½ï¿½
(const *);

148 
	`ï¿½ï¿½cmp
(cÚ¡ *, cÚ¡ *, 
uï¿½t
);

149 * 
	`ï¿½ï¿½ï¿½y
(*, const *, );

152 
	`ï¿½gï¿½t
(, *);

153 
	`ï¿½gï¿½r
(, **, );

154 
	`ï¿½gï¿½r
(, **);

155 
	`ï¿½tchï¿½t
(
uï¿½t
, *);

156 
	`ï¿½tchï¿½r
(
uï¿½t
, **);

157 
	`sysï¿½ï¿½
();

160 
	`timï¿½ï¿½ï¿½
();

163 
	`idtï¿½ï¿½
();

164 
uï¿½t
 
ticks
;

165 
	`tvï¿½ï¿½
();

166 

ï¿½ï¿½lock
 
tickï¿½ock
;

169 
	`uï¿½tï¿½ï¿½
();

170 
	`uï¿½tï¿½ï¿½
();

171 
	`uï¿½ï¿½utc
();

174 
	`ï¿½gï¿½ï¿½
();

175 
	`kvmï¿½loc
();

176 
pde_t
* 
	`ï¿½tupkvm
();

177 * 
	`uva2ka
(
pde_t
*, *);

178 
	`ï¿½locuvm
(
pde_t
*, 
uï¿½t
, uint);

179 
	`dï¿½ï¿½ocuvm
(
pde_t
*, 
uï¿½t
, uint);

180 
	`ï¿½vm
(
pde_t
*);

181 
	`ï¿½ï¿½uvm
(
pde_t
*, *, 
uï¿½t
);

182 
	`lï¿½duvm
(
pde_t
*, *, 
ï¿½ode
*, 
uï¿½t
, uint);

183 
pde_t
* 
	`cï¿½yuvm
ï¿½de_t*, 
uï¿½t
);

184 
	`swï¿½chuvm
(
ï¿½oc
*);

185 
	`swï¿½chkvm
();

186 
	`cï¿½yout
(
pde_t
*, 
uï¿½t
, *, uint);

187 
	`ï¿½ï¿½ï¿½ï¿½u
(
pde_t
 *
pgdï¿½
, *
uva
);

190 
	#NELEM
(
x
ï¿½((x)/((x)[0]))

	)

	@echo.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

8 
i
;

10 
i
 = 1; i < 
ï¿½gc
; i++)

11 
	`ï¿½ï¿½tf
(1, "%s%s", 
ï¿½gv
[
i
], i+1 < 
ï¿½gc
 ? " " : "\n");

12 
	`exï¿½
();

13 
	}
}

	@elf.h

3 
	#ELF_MAGIC
 0x464C457FU

4 

	)

6 
	sï¿½fhdr
 {

7 
uï¿½t
 
	mmagic
;

8 
uchï¿½
 
	mï¿½f
[12];

9 
ushï¿½t
 
	mtyï¿½
;

10 
ushï¿½t
 
	mmachï¿½e
;

11 
uï¿½t
 
	mvï¿½siï¿½
;

12 
uï¿½t
 
	mï¿½ï¿½y
;

13 
uï¿½t
 
	mphoff
;

14 
uï¿½t
 
	mshoff
;

15 
uï¿½t
 
	mï¿½ags
;

16 
ushï¿½t
 
	mehsize
;

17 
ushï¿½t
 
	mphï¿½tsize
;

18 
ushï¿½t
 
	mphnum
;

19 
ushï¿½t
 
	mshï¿½tsize
;

20 
ushï¿½t
 
	mshnum
;

21 
ushï¿½t
 
	mshï¿½ï¿½dx
;

25 
	sï¿½oghdr
 {

26 
uï¿½t
 
	mtyï¿½
;

27 
uï¿½t
 
	moff
;

28 
uï¿½t
 
	mvaddr
;

29 
uï¿½t
 
	mï¿½ddr
;

30 
uï¿½t
 
	mfï¿½esz
;

31 
uï¿½t
 
	mmemsz
;

32 
uï¿½t
 
	mï¿½ags
;

33 
uï¿½t
 
	mï¿½ign
;

37 
	#ELF_PROG_LOAD
 1

	)

40 
	#ELF_PROG_FLAG_EXEC
 1

	)

41 
	#ELF_PROG_FLAG_WRITE
 2

	)

42 
	#ELF_PROG_FLAG_READ
 4

	)

	@entry.S

1 #Thï¿½
xv6
 
kï¿½ï¿½l
 
ï¿½ï¿½ts
 
executï¿½g
 
ï¿½
 
this
 
fï¿½e
. 
This
 fï¿½ï¿½
is
 
lï¿½ked
 
wï¿½h


2 #thï¿½
kï¿½ï¿½l
 
C
 
code
, 
so
 
ï¿½
 
ï¿½n
 
ï¿½ï¿½r
 
to
 kï¿½ï¿½ï¿½
symbï¿½s
 
such
 
as
 
maï¿½
().

3 #Thï¿½
boï¿½
 
block
 (
boï¿½asm
.
S
 
ï¿½d
 
boï¿½maï¿½
.
c
ï¿½
jumps
 
to
 
ï¿½ï¿½y
 
bï¿½ow
.

5 #Muï¿½iboï¿½ 
hï¿½dï¿½
, 
muï¿½iboï¿½
 
boï¿½
 
lï¿½dï¿½s
 
like
 
GNU
 
Grub
.

7 #
#Usï¿½g 
GRUB
 2, 
you
 
ï¿½n
 
boï¿½
 
xv6
 
ï¿½om
 
a
 
fï¿½e
 
ï¿½ï¿½ed
 
ï¿½
ï¿½

9 #Lï¿½ux 
fï¿½e
 
syï¿½em
 
by
 
cï¿½yï¿½g
 
kï¿½ï¿½l
 
ï¿½
 
kï¿½ï¿½lmemfs
 
to
 /
boï¿½


10 #ï¿½d 
thï¿½
 
addï¿½g
 
this
 
mï¿½u
 
ï¿½ï¿½y
:

13 #ï¿½smod 
ext2


14 #ï¿½ï¿½
roï¿½
='(hd0,msdos1)'

15 #ï¿½ï¿½
kï¿½ï¿½l
='/boot/kernel'

17 #muï¿½iboï¿½ 
$
{
kï¿½ï¿½l
} ${kernel}

21 
	~"asm.h
"

22 
	~"memï¿½yout.h
"

23 
	~"mmu.h
"

24 
	~"ï¿½ï¿½m.h
"

26 #Muï¿½iboï¿½ 
hï¿½dï¿½
. 
Dï¿½a
 
to
 
dï¿½eï¿½
 
muï¿½iboï¿½
 
lï¿½dï¿½
.

27 .
	gp2ï¿½ign
 2

28 .
	gï¿½xt


29 .
globl
 
muï¿½iboï¿½_hï¿½dï¿½


30 
	gmuï¿½iboï¿½_hï¿½dï¿½
:

31 
	#magic
 0x1badb002

	)

32 
	#ï¿½ags
 0

	)

33 .
magic


34 .
ï¿½ags


35 .(-
magic
-
ï¿½ags
)

37 #By 
cï¿½vï¿½tiï¿½
, 
the
 
_ï¿½ï¿½t
 
symbï¿½
 
ï¿½ecifï¿½s
ï¿½hï¿½
ELF
 
ï¿½ï¿½y
 
poï¿½t
.

38 #Sï¿½ï¿½ 
we
 
havï¿½
't set up virtual memory yet, ourï¿½ntryï¿½oint is

39 #thï¿½
physiï¿½l
 
addï¿½ss
 
of
 'entry'.

40 .
globl
 
_ï¿½ï¿½t


41 
	g_ï¿½ï¿½t
 = 
V2P_WO
(
ï¿½ï¿½y
)

43 #Eï¿½ï¿½ï¿½g 
xv6
 
ï¿½
 
boï¿½
 
ï¿½oï¿½ssï¿½
, 
wï¿½h
 
ï¿½gï¿½g
 
off
.

44 .
globl
 
ï¿½ï¿½y


45 
	gï¿½ï¿½y
:

46 #Tuï¿½ 
ï¿½
 
ï¿½ge
 
size
 
exï¿½nsiï¿½
 4
Mbyï¿½
 
ï¿½ges


47 
movl
 %
ï¿½4
, %
ï¿½x


48 
ï¿½l
 
$
(
CR4_PSE
), %
ï¿½x


49 
	gmovl
 %
	gï¿½x
, %
	gï¿½4


50 #Sï¿½ 
ï¿½ge
 
dï¿½eï¿½ï¿½y


51 
movl
 
$
(
V2P_WO
(
ï¿½ï¿½ypgdï¿½
)), %
ï¿½x


52 
	gmovl
 %
	gï¿½x
, %
	gï¿½3


53 #Tuï¿½ 
ï¿½
 
ï¿½gï¿½g
.

54 
	gmovl
 %
	gï¿½0
, %
ï¿½x


55 
ï¿½l
 
$
(
CR0_PG
|
CR0_WP
), %
ï¿½x


56 
	gmovl
 %
	gï¿½x
, %
	gï¿½0


58 #Sï¿½ 
up
 
the
 
ï¿½ack
 
poï¿½ï¿½r
.

59 
movl
 
$
(
ï¿½ack
 + 
KSTACKSIZE
), %
	geï¿½


61 #Jumï¿½
to
 
maï¿½
(), 
ï¿½d
 tï¿½
executï¿½g
 
ï¿½


62 #high 
addï¿½sï¿½s
. 
The
 
ï¿½dï¿½eï¿½
 
ï¿½ï¿½
 
is
 
ï¿½eded
 
beï¿½uï¿½


63 #thï¿½
asï¿½mbï¿½r
 
ï¿½oduï¿½s
 
a
 
PC
-
ï¿½ï¿½tive
 
ï¿½ï¿½ruï¿½iï¿½


64 #fï¿½ 
a
 
dï¿½eï¿½
 
jump
.

65 
mov
 
	g$maï¿½
, %
ï¿½x


66 
	gjmp
 *%
	gï¿½x


68 .
comm
 
	gï¿½ack
, 
	gKSTACKSIZE


	@entryother.S

1 
	~"asm.h
"

2 
	~"memï¿½yout.h
"

3 
	~"mmu.h
"

5 #Each 
nï¿½
-
boï¿½
 
CPU
 ("AP"ï¿½
is
 
ï¿½ï¿½ï¿½d
 
up
 
ï¿½
 
ï¿½ï¿½Ú£
 
to
 
a
 
STARTUP


6 #IPI 
ï¿½om
 
the
 
boï¿½
 
CPU
. 
Seï¿½iï¿½
 
B
.4.2 
of
ï¿½hï¿½
Muï¿½i
-
Proï¿½ssï¿½


7 #Sï¿½cifiï¿½tiï¿½ 
ï¿½ys
 
thï¿½
 
the
 
AP
 
wï¿½l
 
ï¿½ï¿½t
 
ï¿½
 
ï¿½ï¿½
 
mode
 
wï¿½h
 
CS
:
IP


8 #ï¿½ï¿½
to
 
XY00
:0000, 
whï¿½e
 
XY
 
is
 
ï¿½
 8-
bï¿½
 
vï¿½ue
 
ï¿½ï¿½
 
wï¿½h
 
the


9 #STARTUP. 
Thus
 
this
 
code
 
muï¿½
 
ï¿½ï¿½t
 
ï¿½
 
a
 4096-
byï¿½
 
boundï¿½y
.

10 #
#Beï¿½uï¿½ 
this
 
code
 
ï¿½ts
 
DS
 
to
 
zï¿½o
, 
ï¿½
 
muï¿½
 
sï¿½


12 #ï¿½ 
ï¿½
 
addï¿½ss
 
ï¿½
 
the
 
low
 2^16 
byï¿½s
.

13 #
#Sï¿½ï¿½ï¿½hï¿½ï¿½(
ï¿½
 
maï¿½
.
c
ï¿½
ï¿½nds
 
the
 
STARTUPs
 
ï¿½e
 
ï¿½
 
a
 
time
.

15 #Iï¿½
cÝ›s
 
this
 
code
 (
ï¿½ï¿½t
ï¿½
ï¿½
 0x7000. 
It
 
puts
 
the
 
addï¿½ss
 
of


16 #ï¿½
ï¿½wly
 
ï¿½loï¿½ï¿½d
 
ï¿½r
-
cï¿½e
 
ï¿½ack
 
ï¿½
 
ï¿½ï¿½t
-4,
the
 
addï¿½ss
 
of
ï¿½he

17 #ï¿½aï¿½ 
to
 
jump
ï¿½ï¿½(
mï¿½ï¿½ï¿½
ï¿½
ï¿½
 
ï¿½ï¿½t
-8, 
ï¿½d
 
the
 
physiï¿½l
 
addï¿½ss


18 #oï¿½
ï¿½ï¿½ypgdï¿½
 
ï¿½
 
ï¿½ï¿½t
-12.

19 #
#Thiï¿½
code
 
combï¿½es
 
ï¿½emï¿½ts
 
of
 
boï¿½asm
.
S
 
ï¿½d
 
ï¿½ï¿½y
.S.

22 .
	gcode16


23 .
globl
 
ï¿½ï¿½t


24 
	gï¿½ï¿½t
:

25 
ï¿½i


27 #Zï¿½ï¿½
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½giï¿½ï¿½s
 
DS
, 
ES
, 
ï¿½d
 
SS
.

28 
	gxï¿½w
 %
	gax
,%
ax


29 
	gmovw
 %
	gax
,%
ds


30 
	gmovw
 %
	gax
,%
es


31 
	gmovw
 %
	gax
,%
	gss


33 #Swï¿½ch 
ï¿½om
 
ï¿½ï¿½
 
to
 
ï¿½ï¿½eï¿½ed
 
mode
. 
Uï¿½
 
a
 
boÙ¡ï¿½p
 
GDT
 
thï¿½
 
makes


34 #vï¿½tuï¿½ 
addï¿½sï¿½s
 
mï¿½
 
dï¿½eï¿½ly
 
to
 
physiï¿½l
ï¿½ddï¿½sï¿½ï¿½
so
 
thï¿½
 
the


35 #efï¿½ï¿½ivï¿½
memï¿½y
 
mï¿½
 
dÛ¢
't change duringï¿½heï¿½ransition.

36 
lgdt
 
gdtdesc


37 
	gmovl
 %
	gï¿½0
, %
ï¿½x


38 
ï¿½l
 
	g$CR0_PE
, %
ï¿½x


39 
	gmovl
 %
	gï¿½x
, %
	gï¿½0


41 #Comï¿½ï¿½ï¿½
the
 
ï¿½ï¿½sï¿½iï¿½
 
to
 32-
bï¿½
 
ï¿½ï¿½eï¿½ed
 
mode
 
by
 
usï¿½g
 
a
 
jmp


42 #tï¿½
ï¿½lï¿½d
 %
cs
 
ï¿½d
 %
eï¿½
. 
The
 
ï¿½gmï¿½t
 
desï¿½ï¿½tï¿½s
 
ï¿½e
 
ï¿½t
 
up
 
wï¿½h
 
no


43 #ï¿½ï¿½ï¿½ï¿½iï¿½, 
so
 
thï¿½
 
the
 
mï¿½pï¿½g
 
is
 
ï¿½ï¿½l
ï¿½hï¿½
idï¿½tï¿½y
 mapping.

44 
ljmï¿½
 
$
(
SEG_KCODE
<<3), $(
ï¿½ï¿½t32
)

47 .
	gcode32
 #Tï¿½ï¿½
asï¿½mbï¿½r
 
to
 
	ggï¿½ï¿½ï¿½e
 32-
bï¿½
 
code
 
	gnow
.

48 
	gï¿½ï¿½t32
:

49 #Sï¿½ 
up
 
the
 
ï¿½ï¿½eï¿½ed
-
mode
 
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½giï¿½ï¿½s


50 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ouï¿½
dï¿½a
 
ï¿½gmï¿½t
 
ï¿½ï¿½ï¿½ï¿½


51 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
Dï¿½a
 
Segmï¿½t


52 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exï¿½a
 
Segmï¿½t


53 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sï¿½ck
 
Segmï¿½t


54 
movw
 
$0
, %
	gax
 #Zï¿½ï¿½
ï¿½gmï¿½ts
 
nï¿½
 
ï¿½ady
 
uï¿½


55 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


56 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


58 #Tuï¿½ 
ï¿½
 
ï¿½ge
 
size
 
exï¿½nsiï¿½
 4
Mbyï¿½
 
ï¿½ges


59 
	gmovl
 %
	gï¿½4
, %
ï¿½x


60 
ï¿½l
 
$
(
CR4_PSE
), %
ï¿½x


61 
	gmovl
 %
	gï¿½x
, %
	gï¿½4


62 #Uï¿½ 
ï¿½ï¿½ypgdï¿½
 
as
 
our
 
ï¿½ï¿½ï¿½l
 
ï¿½ge
 
ï¿½bï¿½


63 
movl
 (
ï¿½ï¿½t
-12), %
ï¿½x


64 
	gmovl
 %
	gï¿½x
, %
	gï¿½3


65 #Tuï¿½ 
ï¿½
 
ï¿½gï¿½g
.

66 
	gmovl
 %
	gï¿½0
, %
ï¿½x


67 
ï¿½l
 
$
(
CR0_PE
|
CR0_PG
|
CR0_WP
), %
ï¿½x


68 
	gmovl
 %
	gï¿½x
, %
	gï¿½0


70 #Swï¿½ch 
to
 
the
 
ï¿½ack
 
ï¿½loï¿½ï¿½d
 
by
 
ï¿½ï¿½tï¿½hï¿½s
()

71 
movl
 (
ï¿½ï¿½t
-4), %
	geï¿½


72 #Cï¿½ï¿½
mï¿½ï¿½ï¿½
()

73 
	gï¿½ï¿½
 *(
	gï¿½ï¿½t
-8)

75 
movw
 
	g$0x8a00
, %
ax


76 
	gmovw
 %
	gax
, %
dx


77 
	goutw
 %
	gax
, %
dx


78 
movw
 
	g$0x8ï¿½0
, %
ax


79 
	goutw
 %
	gax
, %
dx


80 
	gï¿½ï¿½
:

81 
jmp
 
ï¿½ï¿½


83 .
p2ï¿½ign
 2

84 
gdt
:

85 
SEG_NULLASM


86 
SEG_ASM
(
STA_X
|
STA_R
, 0, 0xffffffff)

87 
	$SEG_ASM
(
STA_W
, 0, 0xffffffff)

90 
gdtdesc
:

91 .
	`wï¿½d
 (
gdtdesc
 - 
gdt
 - 1)

92 .
gdt


	@exec.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½m.h
"

3 
	~"memï¿½yout.h
"

4 
	~"mmu.h
"

5 
	~"ï¿½oc.h
"

6 
	~"defs.h
"

7 
	~"x86.h
"

8 
	~"ï¿½f.h
"

11 
	$exec
(*
ï¿½th
, **
ï¿½gv
)

13 *
s
, *
Ï¡
;

14 
i
, 
off
;

15 
uï¿½t
 
ï¿½gc
, 
sz
, 
ï¿½
, 
uï¿½ack
[3+
MAXARG
+1];

16 
ï¿½fhdr
 
ï¿½f
;

17 
ï¿½ode
 *
ï¿½
;

18 
ï¿½oghdr
 
ph
;

19 
pde_t
 *
pgdï¿½
, *
ï¿½dpgdï¿½
;

20 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

22 
	`begï¿½_ï¿½
();

24 if((
ï¿½
 = 
	`ï¿½mei
(
ï¿½th
)) == 0){

25 
	`ï¿½d_ï¿½
();

26 
	`ï¿½rï¿½tf
("exec: fail\n");

29 
	`ï¿½ock
(
ï¿½
);

30 
pgdï¿½
 = 0;

33 if(
	`ï¿½adi
(
ï¿½
, (*)&
ï¿½f
, 0, (elf)) != (elf))

34 
bad
;

35 if(
ï¿½f
.
magic
 !ï¿½
ELF_MAGIC
)

36 
bad
;

38 if((
pgdï¿½
 = 
	`ï¿½tupkvm
()) == 0)

39 
bad
;

42 
sz
 = 0;

43 
i
=0, 
off
=
ï¿½f
.
phoff
; i<ï¿½f.
phnum
; i++, off+=(
ph
)){

44 if(
	`ï¿½adi
(
ï¿½
, (*)&
ph
, 
off
, (ph)) != (ph))

45 
bad
;

46 if(
ph
.
tyï¿½
 !ï¿½
ELF_PROG_LOAD
)

48 if(
ph
.
memsz
 <ï¿½h.
fï¿½esz
)

49 
bad
;

50 if(
ph
.
vaddr
 +ï¿½h.
memsz
 <ï¿½h.vaddr)

51 
bad
;

52 if((
sz
 = 
	`ï¿½locuvm
(
pgdï¿½
, sz, 
ph
.
vaddr
 +ï¿½h.
memsz
)) == 0)

53 
bad
;

54 if(
ph
.
vaddr
 % 
PGSIZE
 != 0)

55 
bad
;

56 if(
	`lï¿½duvm
(
pgdï¿½
, (*)
ph
.
vaddr
, 
ï¿½
,ï¿½h.
off
,ï¿½h.
fï¿½esz
) < 0)

57 
bad
;

59 
	`iuï¿½ockput
(
ï¿½
);

60 
	`ï¿½d_ï¿½
();

61 
ï¿½
 = 0;

65 
sz
 = 
	`PGROUNDUP
(sz);

66 if((
sz
 = 
	`ï¿½locuvm
(
pgdï¿½
, sz, sz + 2*
PGSIZE
)) == 0)

67 
bad
;

68 
	`ï¿½ï¿½ï¿½ï¿½u
(
pgdï¿½
, (*)(
sz
 - 2*
PGSIZE
));

69 
ï¿½
 = 
sz
;

72 
ï¿½gc
 = 0; 
ï¿½gv
[argc];ï¿½rgc++) {

73 if(
ï¿½gc
 >ï¿½
MAXARG
)

74 
bad
;

75 
ï¿½
 = (ï¿½ - (
	`ï¿½ï¿½ï¿½
(
ï¿½gv
[
ï¿½gc
]) + 1)) & ~3;

76 if(
	`cï¿½yout
(
pgdï¿½
, 
ï¿½
, 
ï¿½gv
[
ï¿½gc
], 
	`ï¿½ï¿½ï¿½
(argv[argc]) + 1) < 0)

77 
bad
;

78 
uï¿½ack
[3+
ï¿½gc
] = 
ï¿½
;

80 
uï¿½ack
[3+
ï¿½gc
] = 0;

82 
uï¿½ack
[0] = 0xffffffff;

83 
uï¿½ack
[1] = 
ï¿½gc
;

84 
uï¿½ack
[2] = 
ï¿½
 - (
ï¿½gc
+1)*4;

86 
ï¿½
 -ï¿½(3+
ï¿½gc
+1) * 4;

87 if(
	`cï¿½yout
(
pgdï¿½
, 
ï¿½
, 
uï¿½ack
, (3+
ï¿½gc
+1)*4) < 0)

88 
bad
;

91 
Ï¡
=
s
=
ï¿½th
; *s; s++)

92 if(*
s
 == '/')

93 
Ï¡
 = 
s
+1;

94 
	`ï¿½ï¿½rï¿½y
(
cuï¿½roc
->
ï¿½me
, 
Ï¡
, (curproc->name));

97 
ï¿½dpgdï¿½
 = 
cuï¿½roc
->
pgdï¿½
;

98 
cuï¿½roc
->
pgdï¿½
 =ï¿½gdir;

99 
cuï¿½roc
->
sz
 = sz;

100 
cuï¿½roc
->
tf
->
eï¿½
 = 
ï¿½f
.
ï¿½ï¿½y
;

101 
cuï¿½roc
->
tf
->
eï¿½
 = 
ï¿½
;

102 
	`swï¿½chuvm
(
cuï¿½roc
);

103 
	`ï¿½vm
(
ï¿½dpgdï¿½
);

106 
bad
:

107 if(
pgdï¿½
)

108 
	`ï¿½vm
(
pgdï¿½
);

109 if(
ï¿½
){

110 
	`iuï¿½ockput
(
ï¿½
);

111 
	`ï¿½d_ï¿½
();

114 
	}
}

	@fcntl.h

1 
	#O_RDONLY
 0x000

	)

2 
	#O_WRONLY
 0x001

	)

3 
	#O_RDWR
 0x002

	)

4 
	#O_CREATE
 0x200

	)

	@file.c

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"ï¿½ï¿½m.h
"

8 
	~"fs.h
"

9 
	~"ï¿½ï¿½lock.h
"

10 
	~"ï¿½ï¿½ï¿½ock.h
"

11 
	~"fï¿½e.h
"

13 
devsw
 
	gdevsw
[
NDEV
];

15 
ï¿½ï¿½lock
 
	mlock
;

16 
fï¿½e
 
	mfï¿½e
[
NFILE
];

17 } 
	gï¿½abï¿½
;

20 
	$fï¿½eï¿½ï¿½
()

22 
	`ï¿½ï¿½lock
(&
ï¿½abï¿½
.
lock
, "ftable");

23 
	}
}

26 
fï¿½e
*

27 
	$fï¿½ï¿½ï¿½oc
()

29 
fï¿½e
 *
f
;

31 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

32 
f
 = 
ï¿½abï¿½
.
fï¿½e
; f < fï¿½bï¿½.fï¿½ï¿½+ 
NFILE
; f++){

33 if(
f
->
ï¿½f
 == 0){

34 
f
->
ï¿½f
 = 1;

35 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

36  
f
;

39 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

41 
	}
}

44 
fï¿½e
*

45 
	$fï¿½edup
(
fï¿½e
 *
f
)

47 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

48 if(
f
->
ï¿½f
 < 1)

49 
	`ï¿½nic
("filedup");

50 
f
->
ï¿½f
++;

51 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

52  
f
;

53 
	}
}

57 
	$fï¿½eï¿½oï¿½
(
fï¿½e
 *
f
)

59 
fï¿½e
 
ff
;

61 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

62 if(
f
->
ï¿½f
 < 1)

63 
	`ï¿½nic
("fileclose");

64 if(--
f
->
ï¿½f
 > 0){

65 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

68 
ff
 = *
f
;

69 
f
->
ï¿½f
 = 0;

70 
f
->
tyï¿½
 = 
FD_NONE
;

71 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

73 if(
ff
.
tyï¿½
 =ï¿½
FD_PIPE
)

74 
	`pï¿½eï¿½oï¿½
(
ff
.
pï¿½e
, ff.
wrï¿½abï¿½
);

75 if(
ff
.
tyï¿½
 =ï¿½
FD_INODE
){

76 
	`begï¿½_ï¿½
();

77 
	`ï¿½ut
(
ff
.
ï¿½
);

78 
	`ï¿½d_ï¿½
();

80 
	}
}

84 
	$fï¿½eï¿½ï¿½
(
fï¿½e
 *
f
, 
ï¿½ï¿½
 *
ï¿½
)

86 if(
f
->
tyï¿½
 =ï¿½
FD_INODE
){

87 
	`ï¿½ock
(
f
->
ï¿½
);

88 
	`ï¿½ï¿½i
(
f
->
ï¿½
, 
ï¿½
);

89 
	`iuï¿½ock
(
f
->
ï¿½
);

93 
	}
}

97 
	$fï¿½ï¿½ï¿½d
(
fï¿½e
 *
f
, *
addr
, 
n
)

99 
r
;

101 if(
f
->
ï¿½adabï¿½
 == 0)

103 if(
f
->
tyï¿½
 =ï¿½
FD_PIPE
)

104  
	`pï¿½ï¿½ï¿½d
(
f
->
pï¿½e
, 
addr
, 
n
);

105 if(
f
->
tyï¿½
 =ï¿½
FD_INODE
){

106 
	`ï¿½ock
(
f
->
ï¿½
);

107 if((
r
 = 
	`ï¿½adi
(
f
->
ï¿½
, 
addr
, f->
off
, 
n
)) > 0)

108 
f
->
off
 +ï¿½
r
;

109 
	`iuï¿½ock
(
f
->
ï¿½
);

110  
r
;

112 
	`ï¿½nic
("fileread");

113 
	}
}

118 
	$fï¿½ewrï¿½e
(
fï¿½e
 *
f
, *
addr
, 
n
)

120 
r
;

122 if(
f
->
wrï¿½abï¿½
 == 0)

124 if(
f
->
tyï¿½
 =ï¿½
FD_PIPE
)

125  
	`pï¿½ewrï¿½e
(
f
->
pï¿½e
, 
addr
, 
n
);

126 if(
f
->
tyï¿½
 =ï¿½
FD_INODE
){

133 
max
 = ((
MAXOPBLOCKS
-1-1-2) / 2) * 512;

134 
i
 = 0;

135 
i
 < 
n
){

136 
n1
 = 
n
 - 
i
;

137 if(
n1
 > 
max
)

138 
n1
 = 
max
;

140 
	`begï¿½_ï¿½
();

141 
	`ï¿½ock
(
f
->
ï¿½
);

142 iï¿½((
r
 = 
	`wrï¿½ei
(
f
->
ï¿½
, 
addr
 + 
i
, f->
off
, 
n1
)) > 0)

143 
f
->
off
 +ï¿½
r
;

144 
	`iuï¿½ock
(
f
->
ï¿½
);

145 
	`ï¿½d_ï¿½
();

147 if(
r
 < 0)

149 if(
r
 !ï¿½
n1
)

150 
	`ï¿½nic
("short filewrite");

151 
i
 +ï¿½
r
;

153  
i
 =ï¿½
n
 ?ï¿½ : -1;

155 
	`ï¿½nic
("filewrite");

156 
	}
}

	@file.h

1 
	sfï¿½e
 {

2 ï¿½um { 
	mFD_NONE
, 
	mFD_PIPE
, 
	mFD_INODE
 } 
	mtyï¿½
;

3 
	mï¿½f
;

4 
	mï¿½adabï¿½
;

5 
	mwrï¿½abï¿½
;

6 
pï¿½e
 *
	mpï¿½e
;

7 
ï¿½ode
 *
	mï¿½
;

8 
uï¿½t
 
	moff
;

13 
	sï¿½ode
 {

14 
uï¿½t
 
	mdev
;

15 
uï¿½t
 
	mï¿½um
;

16 
	mï¿½f
;

17 
ï¿½ï¿½ï¿½ock
 
	mlock
;

18 
	mvï¿½id
;

20 
	mtyï¿½
;

21 
	mmajï¿½
;

22 
	mmï¿½ï¿½
;

23 
	mÆšk
;

24 
uï¿½t
 
	msize
;

25 
uï¿½t
 
	maddrs
[
NDIRECT
+1];

30 
	sdevsw
 {

31 (*
	mï¿½ad
)(
	mï¿½ode
*, *, );

32 (*
	mwrï¿½e
)(
	mï¿½ode
*, *, );

35 

devsw
 devsw[];

37 
	#CONSOLE
 1

	)

	@forktest.c

4 
	~"tyï¿½s.h
"

5 
	~"ï¿½ï¿½.h
"

6 
	~"uï¿½r.h
"

8 
	#N
 1000

	)

11 
	$ï¿½ï¿½tf
(
fd
, cÚ¡ *
s
, ...)

13 
	`wrï¿½e
(
fd
, 
s
, 
	`ï¿½ï¿½ï¿½
(s));

14 
	}
}

17 
	$fï¿½kï¿½ï¿½
()

19 
n
, 
pid
;

21 
	`ï¿½ï¿½tf
(1, "forkï¿½est\n");

23 
n
=0;ï¿½<
N
;ï¿½++){

24 
pid
 = 
	`fï¿½k
();

25 if(
pid
 < 0)

27 if(
pid
 == 0)

28 
	`exï¿½
();

31 if(
n
 =ï¿½
N
){

32 
	`ï¿½ï¿½tf
(1, "fï¿½k cï¿½imedï¿½ï¿½wï¿½k Nï¿½imes!\n", 
N
);

33 
	`exï¿½
();

36 ; 
n
 > 0;ï¿½--){

37 if(
	`waï¿½
() < 0){

38 
	`ï¿½ï¿½tf
(1, "wait stoppedï¿½arly\n");

39 
	`exï¿½
();

43 if(
	`waï¿½
() != -1){

44 
	`ï¿½ï¿½tf
(1, "wait gotï¿½oo many\n");

45 
	`exï¿½
();

48 
	`ï¿½ï¿½tf
(1, "forkï¿½est OK\n");

49 
	}
}

52 
	$maï¿½
()

54 
	`fï¿½kï¿½ï¿½
();

55 
	`exï¿½
();

56 
	}
}

	@fs.c

12 
	~"tyï¿½s.h
"

13 
	~"defs.h
"

14 
	~"ï¿½ï¿½m.h
"

15 
	~"ï¿½ï¿½.h
"

16 
	~"mmu.h
"

17 
	~"ï¿½oc.h
"

18 
	~"ï¿½ï¿½lock.h
"

19 
	~"ï¿½ï¿½ï¿½ock.h
"

20 
	~"fs.h
"

21 
	~"buf.h
"

22 
	~"fï¿½e.h
"

24 
	#mï¿½
(
a
, 
b
ï¿½(ï¿½ï¿½< (bï¿½? (aï¿½: (b))

	)

25 
ï¿½runc
(
ï¿½ode
*);

28 
suï¿½rblock
 
	gsb
;

32 
	$ï¿½adsb
(
dev
, 
suï¿½rblock
 *
sb
)

34 
buf
 *
bp
;

36 
bp
 = 
	`bï¿½ad
(
dev
, 1);

37 
	`memmove
(
sb
, 
bp
->
dï¿½a
, (*sb));

38 
	`bï¿½lï¿½
(
bp
);

39 
	}
}

43 
	$bzï¿½o
(
dev
, 
bno
)

45 
buf
 *
bp
;

47 
bp
 = 
	`bï¿½ad
(
dev
, 
bno
);

48 
	`memï¿½t
(
bp
->
dï¿½a
, 0, 
BSIZE
);

49 
	`log_wrï¿½e
(
bp
);

50 
	`bï¿½lï¿½
(
bp
);

51 
	}
}

56 
uï¿½t


57 
	$bï¿½loc
(
uï¿½t
 
dev
)

59 
b
, 
bi
, 
m
;

60 
buf
 *
bp
;

62 
bp
 = 0;

63 
b
 = 0; b < 
sb
.
size
; b +ï¿½
BPB
){

64 
bp
 = 
	`bï¿½ad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

65 
bi
 = 0; bï¿½< 
BPB
 && 
b
 + bï¿½< 
sb
.
size
; bi++){

66 
m
 = 1 << (
bi
 % 8);

67 if((
bp
->
dï¿½a
[
bi
/8] & 
m
) == 0){

68 
bp
->
dï¿½a
[
bi
/8] |ï¿½
m
;

69 
	`log_wrï¿½e
(
bp
);

70 
	`bï¿½lï¿½
(
bp
);

71 
	`bzï¿½o
(
dev
, 
b
 + 
bi
);

72  
b
 + 
bi
;

75 
	`bï¿½lï¿½
(
bp
);

77 
	`ï¿½nic
("balloc: out of blocks");

78 
	}
}

82 
	$bï¿½
(
dev
, 
uï¿½t
 
b
)

84 
buf
 *
bp
;

85 
bi
, 
m
;

87 
bp
 = 
	`bï¿½ad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

88 
bi
 = 
b
 % 
BPB
;

89 
m
 = 1 << (
bi
 % 8);

90 if((
bp
->
dï¿½a
[
bi
/8] & 
m
) == 0)

91 
	`ï¿½nic
("freeing free block");

92 
bp
->
dï¿½a
[
bi
/8] &ï¿½~
m
;

93 
	`log_wrï¿½e
(
bp
);

94 
	`bï¿½lï¿½
(
bp
);

95 
	}
}

167 
ï¿½ï¿½lock
 
	mlock
;

168 
ï¿½ode
 
	mï¿½ode
[
NINODE
];

169 } 
	giï¿½che
;

172 
	$iï¿½ï¿½
(
dev
)

174 
i
 = 0;

176 
	`ï¿½ï¿½lock
(&
iï¿½che
.
lock
, "icache");

177 
i
 = 0; i < 
NINODE
; i++) {

178 
	`ï¿½ï¿½ï¿½ï¿½ï¿½ock
(&
iï¿½che
.
ï¿½ode
[
i
].
lock
, "inode");

181 
	`ï¿½adsb
(
dev
, &
sb
);

182 
	`ï¿½rï¿½tf
("sb: sizï¿½%dï¿½blockï¿½%dï¿½ï¿½odeï¿½%dï¿½log %dï¿½ogï¿½ï¿½ï¿½%d\
 %d bmï¿½ sï¿½ï¿½ %d\n", 
sb
.
size
, sb.
nblocks
,

184 
sb
.
nï¿½odes
, sb.
ï¿½og
, sb.
logï¿½ï¿½t
, sb.
ï¿½odeï¿½ï¿½t
,

185 
sb
.
bmï¿½ï¿½ï¿½t
);

186 
	}
}

188 
ï¿½ode
* 
igï¿½
(
uï¿½t
 
dev
, uï¿½ï¿½
ï¿½um
);

194 
ï¿½ode
*

195 
	$ï¿½ï¿½oc
(
uï¿½t
 
dev
, 
tyï¿½
)

197 
ï¿½um
;

198 
buf
 *
bp
;

199 
dï¿½ode
 *
dï¿½
;

201 
ï¿½um
 = 1; inum < 
sb
.
nï¿½odes
; inum++){

202 
bp
 = 
	`bï¿½ad
(
dev
, 
	`IBLOCK
(
ï¿½um
, 
sb
));

203 
dï¿½
 = (
dï¿½ode
*)
bp
->
dï¿½a
 + 
ï¿½um
%
IPB
;

204 if(
dï¿½
->
tyï¿½
 == 0){

205 
	`memï¿½t
(
dï¿½
, 0, (*dip));

206 
dï¿½
->
tyï¿½
 =ï¿½ype;

207 
	`log_wrï¿½e
(
bp
);

208 
	`bï¿½lï¿½
(
bp
);

209  
	`igï¿½
(
dev
, 
ï¿½um
);

211 
	`bï¿½lï¿½
(
bp
);

213 
	`ï¿½nic
("ialloc:ï¿½o inodes");

214 
	}
}

221 
	$iupdï¿½e
(
ï¿½ode
 *
ï¿½
)

223 
buf
 *
bp
;

224 
dï¿½ode
 *
dï¿½
;

226 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, 
	`IBLOCK
(ï¿½->
ï¿½um
, 
sb
));

227 
dï¿½
 = (
dï¿½ode
*)
bp
->
dï¿½a
 + 
ï¿½
->
ï¿½um
%
IPB
;

228 
dï¿½
->
tyï¿½
 = 
ï¿½
->type;

229 
dï¿½
->
majï¿½
 = 
ï¿½
->major;

230 
dï¿½
->
mï¿½ï¿½
 = 
ï¿½
->minor;

231 
dï¿½
->
Æšk
 = 
ï¿½
->nlink;

232 
dï¿½
->
size
 = 
ï¿½
->size;

233 
	`memmove
(
dï¿½
->
addrs
, 
ï¿½
->addrs, (ip->addrs));

234 
	`log_wrï¿½e
(
bp
);

235 
	`bï¿½lï¿½
(
bp
);

236 
	}
}

241 
ï¿½ode
*

242 
	$igï¿½
(
uï¿½t
 
dev
, uï¿½ï¿½
ï¿½um
)

244 
ï¿½ode
 *
ï¿½
, *
emï¿½y
;

246 
	`acquï¿½e
(&
iï¿½che
.
lock
);

249 
emï¿½y
 = 0;

250 
ï¿½
 = &
iï¿½che
.
ï¿½ode
[0]; iï¿½< &iï¿½che.ï¿½ode[
NINODE
]; ip++){

251 if(
ï¿½
->
ï¿½f
 > 0 && ip->
dev
 =ï¿½dev && ip->
ï¿½um
 == inum){

252 
ï¿½
->
ï¿½f
++;

253 
	`ï¿½ï¿½aï¿½
(&
iï¿½che
.
lock
);

254  
ï¿½
;

256 if(
emï¿½y
 =ï¿½0 && 
ï¿½
->
ï¿½f
 == 0)

257 
emï¿½y
 = 
ï¿½
;

261 if(
emï¿½y
 == 0)

262 
	`ï¿½nic
("iget:ï¿½o inodes");

264 
ï¿½
 = 
emï¿½y
;

265 
ï¿½
->
dev
 = dev;

266 
ï¿½
->
ï¿½um
 = inum;

267 
ï¿½
->
ï¿½f
 = 1;

268 
ï¿½
->
vï¿½id
 = 0;

269 
	`ï¿½ï¿½aï¿½
(&
iï¿½che
.
lock
);

271  
ï¿½
;

272 
	}
}

276 
ï¿½ode
*

277 
	$idup
(
ï¿½ode
 *
ï¿½
)

279 
	`acquï¿½e
(&
iï¿½che
.
lock
);

280 
ï¿½
->
ï¿½f
++;

281 
	`ï¿½ï¿½aï¿½
(&
iï¿½che
.
lock
);

282  
ï¿½
;

283 
	}
}

288 
	$ï¿½ock
(
ï¿½ode
 *
ï¿½
)

290 
buf
 *
bp
;

291 
dï¿½ode
 *
dï¿½
;

293 if(
ï¿½
 =ï¿½0 || ip->
ï¿½f
 < 1)

294 
	`ï¿½nic
("ilock");

296 
	`acquï¿½eï¿½ï¿½p
(&
ï¿½
->
lock
);

298 if(
ï¿½
->
vï¿½id
 == 0){

299 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, 
	`IBLOCK
(ï¿½->
ï¿½um
, 
sb
));

300 
dï¿½
 = (
dï¿½ode
*)
bp
->
dï¿½a
 + 
ï¿½
->
ï¿½um
%
IPB
;

301 
ï¿½
->
tyï¿½
 = 
dï¿½
->type;

302 
ï¿½
->
majï¿½
 = 
dï¿½
->major;

303 
ï¿½
->
mï¿½ï¿½
 = 
dï¿½
->minor;

304 
ï¿½
->
Æšk
 = 
dï¿½
->nlink;

305 
ï¿½
->
size
 = 
dï¿½
->size;

306 
	`memmove
(
ï¿½
->
addrs
, 
dï¿½
->addrs, (ip->addrs));

307 
	`bï¿½lï¿½
(
bp
);

308 
ï¿½
->
vï¿½id
 = 1;

309 if(
ï¿½
->
tyï¿½
 == 0)

310 
	`ï¿½nic
("ilock:ï¿½oï¿½ype");

312 
	}
}

316 
	$iuï¿½ock
(
ï¿½ode
 *
ï¿½
)

318 if(
ï¿½
 =ï¿½0 || !
	`hï¿½dï¿½gï¿½ï¿½p
(&ï¿½->
lock
ï¿½|| ip->
ï¿½f
 < 1)

319 
	`ï¿½nic
("iunlock");

321 
	`ï¿½ï¿½aï¿½ï¿½ï¿½p
(&
ï¿½
->
lock
);

322 
	}
}

332 
	$ï¿½ut
(
ï¿½ode
 *
ï¿½
)

334 
	`acquï¿½eï¿½ï¿½p
(&
ï¿½
->
lock
);

335 if(
ï¿½
->
vï¿½id
 && ip->
Æšk
 == 0){

336 
	`acquï¿½e
(&
iï¿½che
.
lock
);

337 
r
 = 
ï¿½
->
ï¿½f
;

338 
	`ï¿½ï¿½aï¿½
(&
iï¿½che
.
lock
);

339 if(
r
 == 1){

341 
	`ï¿½runc
(
ï¿½
);

342 
ï¿½
->
tyï¿½
 = 0;

343 
	`iupdï¿½e
(
ï¿½
);

344 
ï¿½
->
vï¿½id
 = 0;

347 
	`ï¿½ï¿½aï¿½ï¿½ï¿½p
(&
ï¿½
->
lock
);

349 
	`acquï¿½e
(&
iï¿½che
.
lock
);

350 
ï¿½
->
ï¿½f
--;

351 
	`ï¿½ï¿½aï¿½
(&
iï¿½che
.
lock
);

352 
	}
}

356 
	$iuï¿½ockput
(
ï¿½ode
 *
ï¿½
)

358 
	`iuï¿½ock
(
ï¿½
);

359 
	`ï¿½ut
(
ï¿½
);

360 
	}
}

372 
uï¿½t


373 
	$bmï¿½
(
ï¿½ode
 *
ï¿½
, 
uï¿½t
 
bn
)

375 
uï¿½t
 
addr
, *
a
;

376 
buf
 *
bp
;

378 if(
bn
 < 
NDIRECT
){

379 if((
addr
 = 
ï¿½
->
addrs
[
bn
]) == 0)

380 
ï¿½
->
addrs
[
bn
] = 
addr
 = 
	`bï¿½loc
(ï¿½->
dev
);

381  
addr
;

383 
bn
 -ï¿½
NDIRECT
;

385 if(
bn
 < 
NINDIRECT
){

387 if((
addr
 = 
ï¿½
->
addrs
[
NDIRECT
]) == 0)

388 
ï¿½
->
addrs
[
NDIRECT
] = 
addr
 = 
	`bï¿½loc
(ï¿½->
dev
);

389 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, 
addr
);

390 
a
 = (
uï¿½t
*)
bp
->
dï¿½a
;

391 if((
addr
 = 
a
[
bn
]) == 0){

392 
a
[
bn
] = 
addr
 = 
	`bï¿½loc
(
ï¿½
->
dev
);

393 
	`log_wrï¿½e
(
bp
);

395 
	`bï¿½lï¿½
(
bp
);

396  
addr
;

399 
	`ï¿½nic
("bmap: out ofï¿½ange");

400 
	}
}

408 
	$ï¿½runc
(
ï¿½ode
 *
ï¿½
)

410 
i
, 
j
;

411 
buf
 *
bp
;

412 
uï¿½t
 *
a
;

414 
i
 = 0; i < 
NDIRECT
; i++){

415 if(
ï¿½
->
addrs
[
i
]){

416 
	`bï¿½
(
ï¿½
->
dev
, ip->
addrs
[
i
]);

417 
ï¿½
->
addrs
[
i
] = 0;

421 if(
ï¿½
->
addrs
[
NDIRECT
]){

422 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, ip->
addrs
[
NDIRECT
]);

423 
a
 = (
uï¿½t
*)
bp
->
dï¿½a
;

424 
j
 = 0; j < 
NINDIRECT
; j++){

425 if(
a
[
j
])

426 
	`bï¿½
(
ï¿½
->
dev
, 
a
[
j
]);

428 
	`bï¿½lï¿½
(
bp
);

429 
	`bï¿½
(
ï¿½
->
dev
, ip->
addrs
[
NDIRECT
]);

430 
ï¿½
->
addrs
[
NDIRECT
] = 0;

433 
ï¿½
->
size
 = 0;

434 
	`iupdï¿½e
(
ï¿½
);

435 
	}
}

440 
	$ï¿½ï¿½i
(
ï¿½ode
 *
ï¿½
, 
ï¿½ï¿½
 *
ï¿½
)

442 
ï¿½
->
dev
 = 
ï¿½
->dev;

443 
ï¿½
->
ï¿½o
 = 
ï¿½
->
ï¿½um
;

444 
ï¿½
->
tyï¿½
 = 
ï¿½
->type;

445 
ï¿½
->
Æšk
 = 
ï¿½
->nlink;

446 
ï¿½
->
size
 = 
ï¿½
->size;

447 
	}
}

453 
	$ï¿½adi
(
ï¿½ode
 *
ï¿½
, *
dï¿½
, 
uï¿½t
 
off
, uï¿½ï¿½
n
)

455 
uï¿½t
 
tï¿½
, 
m
;

456 
buf
 *
bp
;

458 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DEV
){

459 if(
ï¿½
->
majï¿½
 < 0 || ip->majï¿½ >ï¿½
NDEV
 || !
devsw
[ï¿½->majï¿½].
ï¿½ad
)

461  
devsw
[
ï¿½
->
majï¿½
].
	`ï¿½ad
(ï¿½, 
dï¿½
, 
n
);

464 if(
off
 > 
ï¿½
->
size
 || ofï¿½+ 
n
 < off)

466 if(
off
 + 
n
 > 
ï¿½
->
size
)

467 
n
 = 
ï¿½
->
size
 - 
off
;

469 
tï¿½
=0;ï¿½ï¿½<
n
;ï¿½ï¿½+=
m
, 
off
+=m, 
dï¿½
+=m){

470 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, 
	`bmï¿½
(ï¿½, 
off
/
BSIZE
));

471 
m
 = 
	`mï¿½
(
n
 - 
tï¿½
, 
BSIZE
 - 
off
%BSIZE);

472 
	`memmove
(
dï¿½
, 
bp
->
dï¿½a
 + 
off
%
BSIZE
, 
m
);

473 
	`bï¿½lï¿½
(
bp
);

475  
n
;

476 
	}
}

482 
	$wrï¿½ei
(
ï¿½ode
 *
ï¿½
, *
ï¿½c
, 
uï¿½t
 
off
, uï¿½ï¿½
n
)

484 
uï¿½t
 
tï¿½
, 
m
;

485 
buf
 *
bp
;

487 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DEV
){

488 if(
ï¿½
->
majï¿½
 < 0 || ip->majï¿½ >ï¿½
NDEV
 || !
devsw
[ï¿½->majï¿½].
wrï¿½e
)

490  
devsw
[
ï¿½
->
majï¿½
].
	`wrï¿½e
(ï¿½, 
ï¿½c
, 
n
);

493 if(
off
 > 
ï¿½
->
size
 || ofï¿½+ 
n
 < off)

495 if(
off
 + 
n
 > 
MAXFILE
*
BSIZE
)

498 
tï¿½
=0;ï¿½ï¿½<
n
;ï¿½ï¿½+=
m
, 
off
+=m, 
ï¿½c
+=m){

499 
bp
 = 
	`bï¿½ad
(
ï¿½
->
dev
, 
	`bmï¿½
(ï¿½, 
off
/
BSIZE
));

500 
m
 = 
	`mï¿½
(
n
 - 
tï¿½
, 
BSIZE
 - 
off
%BSIZE);

501 
	`memmove
(
bp
->
dï¿½a
 + 
off
%
BSIZE
, 
ï¿½c
, 
m
);

502 
	`log_wrï¿½e
(
bp
);

503 
	`bï¿½lï¿½
(
bp
);

506 if(
n
 > 0 && 
off
 > 
ï¿½
->
size
){

507 
ï¿½
->
size
 = 
off
;

508 
	`iupdï¿½e
(
ï¿½
);

510  
n
;

511 
	}
}

517 
	$ï¿½mecmp
(cÚ¡ *
s
, cÚ¡ *
t
)

519  
	`ï¿½ï¿½cmp
(
s
, 
t
, 
DIRSIZ
);

520 
	}
}

524 
ï¿½ode
*

525 
	$dï¿½lookup
(
ï¿½ode
 *
dp
, *
ï¿½me
, 
uï¿½t
 *
poff
)

527 
uï¿½t
 
off
, 
ï¿½um
;

528 
dï¿½ï¿½t
 
de
;

530 if(
dp
->
tyï¿½
 !ï¿½
T_DIR
)

531 
	`ï¿½nic
("dirlookupï¿½ot DIR");

533 
off
 = 0; ofï¿½< 
dp
->
size
; ofï¿½+ï¿½(
de
)){

534 if(
	`ï¿½adi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

535 
	`ï¿½nic
("dirlookupï¿½ead");

536 if(
de
.
ï¿½um
 == 0)

538 if(
	`ï¿½mecmp
(
ï¿½me
, 
de
.name) == 0){

540 if(
poff
)

541 *
poff
 = 
off
;

542 
ï¿½um
 = 
de
.inum;

543  
	`igï¿½
(
dp
->
dev
, 
ï¿½um
);

548 
	}
}

552 
	$dï¿½lï¿½k
(
ï¿½ode
 *
dp
, *
ï¿½me
, 
uï¿½t
 
ï¿½um
)

554 
off
;

555 
dï¿½ï¿½t
 
de
;

556 
ï¿½ode
 *
ï¿½
;

559 if((
ï¿½
 = 
	`dï¿½lookup
(
dp
, 
ï¿½me
, 0)) != 0){

560 
	`ï¿½ut
(
ï¿½
);

565 
off
 = 0; ofï¿½< 
dp
->
size
; ofï¿½+ï¿½(
de
)){

566 if(
	`ï¿½adi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

567 
	`ï¿½nic
("dirlinkï¿½ead");

568 if(
de
.
ï¿½um
 == 0)

572 
	`ï¿½ï¿½ï¿½y
(
de
.
ï¿½me
,ï¿½ame, 
DIRSIZ
);

573 
de
.
ï¿½um
 = inum;

574 if(
	`wrï¿½ei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

575 
	`ï¿½nic
("dirlink");

578 
	}
}

596 
	$skï¿½ï¿½em
(*
ï¿½th
, *
ï¿½me
)

598 *
s
;

599 
ï¿½n
;

601 *
ï¿½th
 == '/')

602 
ï¿½th
++;

603 if(*
ï¿½th
 == 0)

605 
s
 = 
ï¿½th
;

606 *
ï¿½th
 != '/' && *path != 0)

607 
ï¿½th
++;

608 
ï¿½n
 = 
ï¿½th
 - 
s
;

609 if(
ï¿½n
 >ï¿½
DIRSIZ
)

610 
	`memmove
(
ï¿½me
, 
s
, 
DIRSIZ
);

612 
	`memmove
(
ï¿½me
, 
s
, 
ï¿½n
);

613 
ï¿½me
[
ï¿½n
] = 0;

615 *
ï¿½th
 == '/')

616 
ï¿½th
++;

617  
ï¿½th
;

618 
	}
}

624 
ï¿½ode
*

625 
	$ï¿½mex
(*
ï¿½th
, 
ï¿½meï¿½ï¿½ï¿½t
, *
ï¿½me
)

627 
ï¿½ode
 *
ï¿½
, *
ï¿½xt
;

629 if(*
ï¿½th
 == '/')

630 
ï¿½
 = 
	`igï¿½
(
ROOTDEV
, 
ROOTINO
);

632 
ï¿½
 = 
	`idup
(
	`myï¿½oc
()->
cwd
);

634 (
ï¿½th
 = 
	`skï¿½ï¿½em
Õ©h, 
ï¿½me
)) != 0){

635 
	`ï¿½ock
(
ï¿½
);

636 if(
ï¿½
->
tyï¿½
 !ï¿½
T_DIR
){

637 
	`iuï¿½ockput
(
ï¿½
);

640 if(
ï¿½meï¿½ï¿½ï¿½t
 && *
ï¿½th
 == '\0'){

642 
	`iuï¿½ock
(
ï¿½
);

643  
ï¿½
;

645 if((
ï¿½xt
 = 
	`dï¿½lookup
(
ï¿½
, 
ï¿½me
, 0)) == 0){

646 
	`iuï¿½ockput
(
ï¿½
);

649 
	`iuï¿½ockput
(
ï¿½
);

650 
ï¿½
 = 
ï¿½xt
;

652 if(
ï¿½meï¿½ï¿½ï¿½t
){

653 
	`ï¿½ut
(
ï¿½
);

656  
ï¿½
;

657 
	}
}

659 
ï¿½ode
*

660 
	$ï¿½mei
(*
ï¿½th
)

662 
ï¿½me
[
DIRSIZ
];

663  
	`ï¿½mex
(
ï¿½th
, 0, 
ï¿½me
);

664 
	}
}

666 
ï¿½ode
*

667 
	$ï¿½meï¿½ï¿½ï¿½t
(*
ï¿½th
, *
ï¿½me
)

669  
	`ï¿½mex
(
ï¿½th
, 1, 
ï¿½me
);

670 
	}
}

	@fs.h

5 
	#ROOTINO
 1

6 
	#BSIZE
 512

7 

	)

14 
	ssuï¿½rblock
 {

15 
uï¿½t
 
	msize
;

16 
uï¿½t
 
	mnblocks
;

17 
uï¿½t
 
	mnï¿½odes
;

18 
uï¿½t
 
	mï¿½og
;

19 
uï¿½t
 
	mlogï¿½ï¿½t
;

20 
uï¿½t
 
	mï¿½odeï¿½ï¿½t
;

21 
uï¿½t
 
	mbmï¿½ï¿½ï¿½t
;

24 
	#NDIRECT
 12

	)

25 
	#NINDIRECT
 (
BSIZE
 / (
uï¿½t
))

	)

26 
	#MAXFILE
 (
NDIRECT
 + 
NINDIRECT
)

	)

29 
	sdï¿½ode
 {

30 
	mtyï¿½
;

31 
	mmajï¿½
;

32 
	mmï¿½ï¿½
;

33 
	mÆšk
;

34 
uï¿½t
 
	msize
;

35 
uï¿½t
 
	maddrs
[
NDIRECT
+1];

39 
	#IPB
 (
BSIZE
 / (
dï¿½ode
))

	)

42 
	#IBLOCK
(
i
, 
sb
ï¿½((iï¿½/ 
IPB
 + sb.
ï¿½odeï¿½ï¿½t
)

	)

45 
	#BPB
 (
BSIZE
*8)

	)

48 
	#BBLOCK
(
b
, 
sb
ï¿½(b/
BPB
 + sb.
bmï¿½ï¿½ï¿½t
)

	)

51 
	#DIRSIZ
 14

	)

53 
	sdï¿½ï¿½t
 {

54 
ushï¿½t
 
	mï¿½um
;

55 
	mï¿½me
[
DIRSIZ
];

	@grep.c

3 
	~"tyï¿½s.h
"

4 
	~"ï¿½ï¿½.h
"

5 
	~"uï¿½r.h
"

7 
	gbuf
[1024];

8 
mï¿½ch
(*, *);

11 
	$gï¿½p
(*
ï¿½ï¿½ï¿½n
, 
fd
)

13 
n
, 
m
;

14 *
p
, *
q
;

16 
m
 = 0;

17 (
n
 = 
	`ï¿½ad
(
fd
, 
buf
+
m
, (buf)-m-1)) > 0){

18 
m
 +ï¿½
n
;

19 
buf
[
m
] = '\0';

20 
p
 = 
buf
;

21 (
q
 = 
	`ï¿½rchr
(
p
, '\n')) != 0){

22 *
q
 = 0;

23 if(
	`mï¿½ch
(
ï¿½ï¿½ï¿½n
, 
p
)){

24 *
q
 = '\n';

25 
	`wrï¿½e
(1, 
p
, 
q
+1 -ï¿½);

27 
p
 = 
q
+1;

29 if(
p
 =ï¿½
buf
)

30 
m
 = 0;

31 if(
m
 > 0){

32 
m
 -ï¿½
p
 - 
buf
;

33 
	`memmove
(
buf
, 
p
, 
m
);

36 
	}
}

39 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

41 
fd
, 
i
;

42 *
ï¿½ï¿½ï¿½n
;

44 if(
ï¿½gc
 <= 1){

45 
	`ï¿½ï¿½tf
(2, "usage: grepï¿½attern [file ...]\n");

46 
	`exï¿½
();

48 
ï¿½ï¿½ï¿½n
 = 
ï¿½gv
[1];

50 if(
ï¿½gc
 <= 2){

51 
	`gï¿½p
(
ï¿½ï¿½ï¿½n
, 0);

52 
	`exï¿½
();

55 
i
 = 2; i < 
ï¿½gc
; i++){

56 if((
fd
 = 
	`Ý’
(
ï¿½gv
[
i
], 0)) < 0){

57 
	`ï¿½ï¿½tf
(1, "gï¿½p: cï¿½nï¿½ oï¿½ï¿½%s\n", 
ï¿½gv
[
i
]);

58 
	`exï¿½
();

60 
	`gï¿½p
(
ï¿½ï¿½ï¿½n
, 
fd
);

61 
	`ï¿½oï¿½
(
fd
);

63 
	`exï¿½
();

64 
	}
}

69 
mï¿½chhï¿½e
(*, *);

70 
mï¿½chï¿½ï¿½
(, *, *);

73 
	$mï¿½ch
(*
ï¿½
, *
ï¿½xt
)

75 if(
ï¿½
[0] == '^')

76  
	`mï¿½chhï¿½e
(
ï¿½
+1, 
ï¿½xt
);

78 if(
	`mï¿½chhï¿½e
(
ï¿½
, 
ï¿½xt
))

80 }*
ï¿½xt
++ != '\0');

82 
	}
}

85 
	$mï¿½chhï¿½e
(*
ï¿½
, *
ï¿½xt
)

87 if(
ï¿½
[0] == '\0')

89 if(
ï¿½
[1] == '*')

90  
	`mï¿½chï¿½ï¿½
(
ï¿½
[0],ï¿½e+2, 
ï¿½xt
);

91 if(
ï¿½
[0] == '$' &&ï¿½e[1] == '\0')

92  *
ï¿½xt
 == '\0';

93 if(*
ï¿½xt
!='\0' && (
ï¿½
[0]=='.' ||ï¿½e[0]==*text))

94  
	`mï¿½chhï¿½e
(
ï¿½
+1, 
ï¿½xt
+1);

96 
	}
}

99 
	$mï¿½chï¿½ï¿½
(
c
, *
ï¿½
, *
ï¿½xt
)

102 if(
	`mï¿½chhï¿½e
(
ï¿½
, 
ï¿½xt
))

104 }*
ï¿½xt
!='\0' && (*ï¿½xt++==
c
 || c=='.'));

106 
	}
}

	@ide.c

3 
	~"tyï¿½s.h
"

4 
	~"defs.h
"

5 
	~"ï¿½ï¿½m.h
"

6 
	~"memï¿½yout.h
"

7 
	~"mmu.h
"

8 
	~"ï¿½oc.h
"

9 
	~"x86.h
"

10 
	~"ï¿½ï¿½s.h
"

11 
	~"ï¿½ï¿½lock.h
"

12 
	~"ï¿½ï¿½ï¿½ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
	#SECTOR_SIZE
 512

	)

17 
	#IDE_BSY
 0x80

	)

18 
	#IDE_DRDY
 0x40

	)

19 
	#IDE_DF
 0x20

	)

20 
	#IDE_ERR
 0x01

	)

22 
	#IDE_CMD_READ
 0x20

	)

23 
	#IDE_CMD_WRITE
 0x30

	)

24 
	#IDE_CMD_RDMUL
 0xc4

	)

25 
	#IDE_CMD_WRMUL
 0xc5

	)

31 
ï¿½ï¿½lock
 
	gidï¿½ock
;

32 
buf
 *
	gidequeue
;

34 
	ghavedisk1
;

35 
ideï¿½ï¿½t
(
buf
*);

39 
	$idewaï¿½
(
checkï¿½r
)

41 
r
;

43 ((
r
 = 
	`ï¿½b
(0x1f7)ï¿½& (
IDE_BSY
|
IDE_DRDY
)) != IDE_DRDY)

45 if(
checkï¿½r
 && (
r
 & (
IDE_DF
|
IDE_ERR
)) != 0)

48 
	}
}

51 
	$ideï¿½ï¿½
()

53 
i
;

55 
	`ï¿½ï¿½lock
(&
idï¿½ock
, "ide");

56 
	`iï¿½piï¿½ï¿½bï¿½
(
IRQ_IDE
, 
nï¿½u
 - 1);

57 
	`idewaï¿½
(0);

60 
	`outb
(0x1f6, 0xe0 | (1<<4));

61 
i
=0; i<1000; i++){

62 if(
	`ï¿½b
(0x1f7) != 0){

63 
havedisk1
 = 1;

69 
	`outb
(0x1f6, 0xe0 | (0<<4));

70 
	}
}

74 
	$ideï¿½ï¿½t
(
buf
 *
b
)

76 if(
b
 == 0)

77 
	`ï¿½nic
("idestart");

78 if(
b
->
blockno
 >ï¿½
FSSIZE
)

79 
	`ï¿½nic
("incorrect blockno");

80 
ï¿½ï¿½ï¿½_ï¿½r_block
 = 
BSIZE
/
SECTOR_SIZE
;

81 
ï¿½ï¿½ï¿½
 = 
b
->
blockno
 * 
ï¿½ï¿½ï¿½_ï¿½r_block
;

82 
ï¿½ad_cmd
 = (
ï¿½ï¿½ï¿½_ï¿½r_block
 =ï¿½1ï¿½? 
IDE_CMD_READ
 : 
IDE_CMD_RDMUL
;

83 
wrï¿½e_cmd
 = (
ï¿½ï¿½ï¿½_ï¿½r_block
 =ï¿½1ï¿½? 
IDE_CMD_WRITE
 : 
IDE_CMD_WRMUL
;

85 iï¿½(
ï¿½ï¿½ï¿½_ï¿½r_block
 > 7ï¿½
	`ï¿½nic
("idestart");

87 
	`idewaï¿½
(0);

88 
	`outb
(0x3f6, 0);

89 
	`outb
(0x1f2, 
ï¿½ï¿½ï¿½_ï¿½r_block
);

90 
	`outb
(0x1f3, 
ï¿½ï¿½ï¿½
 & 0xff);

91 
	`outb
(0x1f4, (
ï¿½ï¿½ï¿½
 >> 8) & 0xff);

92 
	`outb
(0x1f5, (
ï¿½ï¿½ï¿½
 >> 16) & 0xff);

93 
	`outb
(0x1f6, 0xe0 | ((
b
->
dev
&1)<<4ï¿½| ((
ï¿½ï¿½ï¿½
>>24)&0x0f));

94 if(
b
->
ï¿½ags
 & 
B_DIRTY
){

95 
	`outb
(0x1f7, 
wrï¿½e_cmd
);

96 
	`outï¿½
(0x1f0, 
b
->
dï¿½a
, 
BSIZE
/4);

98 
	`outb
(0x1f7, 
ï¿½ad_cmd
);

100 
	}
}

104 
	$ideï¿½ï¿½
()

106 
buf
 *
b
;

109 
	`acquï¿½e
(&
idï¿½ock
);

111 if((
b
 = 
idequeue
) == 0){

112 
	`ï¿½ï¿½aï¿½
(&
idï¿½ock
);

115 
idequeue
 = 
b
->
qï¿½xt
;

118 if(!(
b
->
ï¿½ags
 & 
B_DIRTY
ï¿½&& 
	`idewaï¿½
(1) >= 0)

119 
	`ï¿½ï¿½
(0x1f0, 
b
->
dï¿½a
, 
BSIZE
/4);

122 
b
->
ï¿½ags
 |ï¿½
B_VALID
;

123 
b
->
ï¿½ags
 &ï¿½~
B_DIRTY
;

124 
	`wakeup
(
b
);

127 if(
idequeue
 != 0)

128 
	`ideï¿½ï¿½t
(
idequeue
);

130 
	`ï¿½ï¿½aï¿½
(&
idï¿½ock
);

131 
	}
}

138 
	$idï¿½w
(
buf
 *
b
)

140 
buf
 **
ï¿½
;

142 if(!
	`hï¿½dï¿½gï¿½ï¿½p
(&
b
->
lock
))

143 
	`ï¿½nic
("iderw: bufï¿½otï¿½ocked");

144 if((
b
->
ï¿½ags
 & (
B_VALID
|
B_DIRTY
)) == B_VALID)

145 
	`ï¿½nic
("iderw:ï¿½othingï¿½o do");

146 if(
b
->
dev
 !ï¿½0 && !
havedisk1
)

147 
	`ï¿½nic
("iderw: ide disk 1ï¿½otï¿½resent");

149 
	`acquï¿½e
(&
idï¿½ock
);

152 
b
->
qï¿½xt
 = 0;

153 
ï¿½
=&
idequeue
; *ï¿½;ï¿½p=&(*ï¿½)->
qï¿½xt
)

155 *
ï¿½
 = 
b
;

158 if(
idequeue
 =ï¿½
b
)

159 
	`ideï¿½ï¿½t
(
b
);

162 (
b
->
ï¿½ags
 & (
B_VALID
|
B_DIRTY
)) != B_VALID){

163 
	`ï¿½ï¿½p
(
b
, &
idï¿½ock
);

167 
	`ï¿½ï¿½aï¿½
(&
idï¿½ock
);

168 
	}
}

	@init.c

3 
	~"tyï¿½s.h
"

4 
	~"ï¿½ï¿½.h
"

5 
	~"uï¿½r.h
"

6 
	~"fï¿½ï¿½.h
"

8 *
	gï¿½gv
[] = { "sh", 0 };

11 
	$maï¿½
()

13 
pid
, 
wpid
;

15 if(
	`Ý’
("cï¿½sï¿½e", 
O_RDWR
) < 0){

16 
	`mknod
("console", 1, 1);

17 
	`Ý’
("cï¿½sï¿½e", 
O_RDWR
);

19 
	`dup
(0);

20 
	`dup
(0);

23 
	`ï¿½ï¿½tf
(1, "init: starting sh\n");

24 
pid
 = 
	`fï¿½k
();

25 if(
pid
 < 0){

26 
	`ï¿½ï¿½tf
(1, "init: fork failed\n");

27 
	`exï¿½
();

29 if(
pid
 == 0){

30 
	`exec
("sh", 
ï¿½gv
);

31 
	`ï¿½ï¿½tf
(1, "init:ï¿½xec sh failed\n");

32 
	`exï¿½
();

34 (
wpid
=
	`waï¿½
()ï¿½>ï¿½0 && wpid !ï¿½
pid
)

35 
	`ï¿½ï¿½tf
(1, "zombie!\n");

37 
	}
}

	@initcode.S

1 #Inï¿½ï¿½ï¿½
ï¿½oï¿½ss
 
execs
 /
ï¿½ï¿½
.

2 #Thiï¿½
code
 
runs
 
ï¿½
 
uï¿½r
 
ï¿½aï¿½
.

4 
	~"sysï¿½ï¿½.h
"

5 
	~"ï¿½ï¿½s.h
"

8 #exec(
ï¿½ï¿½
, 
ï¿½gv
)

9 .
globl
 
ï¿½ï¿½t


10 
	gï¿½ï¿½t
:

11 
pushl
 
$ï¿½gv


12 
pushl
 
$ï¿½ï¿½


13 
pushl
 
$0


14 
movl
 
$SYS_exec
, %
ï¿½x


15 
	g$T_SYSCALL


17 #fï¿½(;;ï¿½
exï¿½
();

18 
	gexï¿½
:

19 
movl
 
$SYS_exï¿½
, %
ï¿½x


20 
$T_SYSCALL


21 
jmp
 
	gexï¿½


23 #chï¿½ 
ï¿½ï¿½
[] = "/init\0";

24 
	gï¿½ï¿½
:

25 .
ï¿½rï¿½g
 "/init\0"

27 #chï¿½ *
ï¿½gv
[] = { 
ï¿½ï¿½
, 0 };

28 .
	gp2ï¿½ign
 2

29 
	gï¿½gv
:

30 .
ï¿½ï¿½


	@ioapic.c

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"ï¿½ï¿½s.h
"

9 
	#IOAPIC
 0xFEC00000

10 

	)

11 
	#REG_ID
 0x00

12 
	#REG_VER
 0x01

13 
	#REG_TABLE
 0x10

14 

	)

20 
	#INT_DISABLED
 0x00010000

21 
	#INT_LEVEL
 0x00008000

22 
	#INT_ACTIVELOW
 0x00002000

23 
	#INT_LOGICAL
 0x00000800

24 

	)

25 vÞ©ï¿½ï¿½
iï¿½pic
 *
	giï¿½pic
;

28 
	siï¿½pic
 {

29 
uï¿½t
 
	mï¿½g
;

30 
uï¿½t
 
	mï¿½d
[3];

31 
uï¿½t
 
	mdï¿½a
;

34 
uï¿½t


35 
	$iï¿½piï¿½ï¿½d
(
ï¿½g
)

37 
iï¿½pic
->
ï¿½g
 =ï¿½eg;

38  
iï¿½pic
->
dï¿½a
;

39 
	}
}

42 
	$iï¿½picwrï¿½e
(
ï¿½g
, 
uï¿½t
 
dï¿½a
)

44 
iï¿½pic
->
ï¿½g
 =ï¿½eg;

45 
iï¿½pic
->
dï¿½a
 = data;

46 
	}
}

49 
	$iï¿½picï¿½ï¿½
()

51 
i
, 
id
, 
maxï¿½ï¿½
;

53 
iï¿½pic
 = (vÞ©ï¿½ï¿½iï¿½pic*)
IOAPIC
;

54 
maxï¿½ï¿½
 = (
	`iï¿½piï¿½ï¿½d
(
REG_VER
) >> 16) & 0xFF;

55 
id
 = 
	`iï¿½piï¿½ï¿½d
(
REG_ID
) >> 24;

56 if(
id
 !ï¿½
iï¿½picid
)

57 
	`ï¿½rï¿½tf
("ioapicinit: id isn'tï¿½qualï¿½o ioapicid;ï¿½otï¿½ MP\n");

61 
i
 = 0; i <ï¿½
maxï¿½ï¿½
; i++){

62 
	`iï¿½picwrï¿½e
(
REG_TABLE
+2*
i
, 
INT_DISABLED
 | (
T_IRQ0
 + i));

63 
	`iï¿½picwrï¿½e
(
REG_TABLE
+2*
i
+1, 0);

65 
	}
}

68 
	$iï¿½piï¿½ï¿½bï¿½
(
ï¿½q
, 
ï¿½unum
)

73 
	`iï¿½picwrï¿½e
(
REG_TABLE
+2*
ï¿½q
, 
T_IRQ0
 + irq);

74 
	`iï¿½picwrï¿½e
(
REG_TABLE
+2*
ï¿½q
+1, 
ï¿½unum
 << 24);

75 
	}
}

	@kalloc.c

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"ï¿½ï¿½m.h
"

8 
	~"memï¿½yout.h
"

9 
	~"mmu.h
"

10 
	~"ï¿½ï¿½lock.h
"

12 
ä“¿nge
(*
vï¿½ï¿½t
, *
vï¿½d
);

13 

ï¿½d
[];

16 
	srun
 {

17 
run
 *
	mï¿½xt
;

21 
ï¿½ï¿½lock
 
	mlock
;

22 
	muï¿½_lock
;

23 
run
 *
	mï¿½liï¿½
;

24 } 
	gkmem
;

32 
	$kï¿½ï¿½1
(*
vï¿½ï¿½t
, *
vï¿½d
)

34 
	`ï¿½ï¿½lock
(&
kmem
.
lock
, "kmem");

35 
kmem
.
uï¿½_lock
 = 0;

36 
	`ä“¿nge
(
vï¿½ï¿½t
, 
vï¿½d
);

37 
	}
}

40 
	$kï¿½ï¿½2
(*
vï¿½ï¿½t
, *
vï¿½d
)

42 
	`ä“¿nge
(
vï¿½ï¿½t
, 
vï¿½d
);

43 
kmem
.
uï¿½_lock
 = 1;

44 
	}
}

47 
	$ä“¿nge
(*
vï¿½ï¿½t
, *
vï¿½d
)

49 *
p
;

50 
p
 = (*)
	`PGROUNDUP
((
uï¿½t
)
vï¿½ï¿½t
);

51 ; 
p
 + 
PGSIZE
 <ï¿½(*)
vï¿½d
;ï¿½ += PGSIZE)

52 
	`kï¿½
(
p
);

53 
	}
}

60 
	$kï¿½
(*
v
)

62 
run
 *
r
;

64 if((
uï¿½t
)
v
 % 
PGSIZE
 || v < 
ï¿½d
 || 
	`V2P
(vï¿½>ï¿½
PHYSTOP
)

65 
	`ï¿½nic
("kfree");

68 
	`memï¿½t
(
v
, 1, 
PGSIZE
);

70 if(
kmem
.
uï¿½_lock
)

71 
	`acquï¿½e
(&
kmem
.
lock
);

72 
r
 = (
run
*)
v
;

73 
r
->
ï¿½xt
 = 
kmem
.
ï¿½liï¿½
;

74 
kmem
.
ï¿½liï¿½
 = 
r
;

75 if(
kmem
.
uï¿½_lock
)

76 
	`ï¿½ï¿½aï¿½
(&
kmem
.
lock
);

77 
	}
}

83 
	$kï¿½loc
()

85 
run
 *
r
;

87 if(
kmem
.
uï¿½_lock
)

88 
	`acquï¿½e
(&
kmem
.
lock
);

89 
r
 = 
kmem
.
ï¿½liï¿½
;

90 if(
r
)

91 
kmem
.
ï¿½liï¿½
 = 
r
->
ï¿½xt
;

92 if(
kmem
.
uï¿½_lock
)

93 
	`ï¿½ï¿½aï¿½
(&
kmem
.
lock
);

94  (*)
r
;

95 
	}
}

	@kbd.c

1 
	~"tyï¿½s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"kbd.h
"

7 
	$kbdgï¿½c
()

9 
uï¿½t
 
shiï¿½
;

10 
uchï¿½
 *
chï¿½code
[4] = {

11 
nï¿½mï¿½mï¿½
, 
shiï¿½mï¿½
, 
ï¿½lmï¿½
, ctlmap

13 
uï¿½t
 
ï¿½
, 
dï¿½a
, 
c
;

15 
ï¿½
 = 
	`ï¿½b
(
KBSTATP
);

16 if((
ï¿½
 & 
KBS_DIB
) == 0)

18 
dï¿½a
 = 
	`ï¿½b
(
KBDATAP
);

20 if(
dï¿½a
 == 0xE0){

21 
shiï¿½
 |ï¿½
E0ESC
;

23 } if(
dï¿½a
 & 0x80){

25 
dï¿½a
 = (
shiï¿½
 & 
E0ESC
 ? data : data & 0x7F);

26 
shiï¿½
 &ï¿½~(
shiï¿½code
[
dï¿½a
] | 
E0ESC
);

28 } if(
shiï¿½
 & 
E0ESC
){

30 
dï¿½a
 |= 0x80;

31 
shiï¿½
 &ï¿½~
E0ESC
;

34 
shiï¿½
 |ï¿½
shiï¿½code
[
dï¿½a
];

35 
shiï¿½
 ^ï¿½
toggï¿½code
[
dï¿½a
];

36 
c
 = 
chï¿½code
[
shiï¿½
 & (
CTL
 | 
SHIFT
)][
dï¿½a
];

37 if(
shiï¿½
 & 
CAPSLOCK
){

38 if('a' <ï¿½
c
 && c <= 'z')

39 
c
 += 'A' - 'a';

40 if('A' <ï¿½
c
 && c <= 'Z')

41 
c
 += 'a' - 'A';

43  
c
;

44 
	}
}

47 
	$kbdï¿½ï¿½
()

49 
	`cï¿½sï¿½eï¿½ï¿½
(
kbdgï¿½c
);

50 
	}
}

	@kbd.h

3 
	#KBSTATP
 0x64

4 
	#KBS_DIB
 0x01

5 
	#KBDATAP
 0x60

6 

	)

7 
	#NO
 0

	)

9 
	#SHIFT
 (1<<0)

	)

10 
	#CTL
 (1<<1)

	)

11 
	#ALT
 (1<<2)

	)

13 
	#CAPSLOCK
 (1<<3)

	)

14 
	#NUMLOCK
 (1<<4)

	)

15 
	#SCROLLLOCK
 (1<<5)

	)

17 
	#E0ESC
 (1<<6)

	)

20 
	#KEY_HOME
 0xE0

	)

21 
	#KEY_END
 0xE1

	)

22 
	#KEY_UP
 0xE2

	)

23 
	#KEY_DN
 0xE3

	)

24 
	#KEY_LF
 0xE4

	)

25 
	#KEY_RT
 0xE5

	)

26 
	#KEY_PGUP
 0xE6

	)

27 
	#KEY_PGDN
 0xE7

	)

28 
	#KEY_INS
 0xE8

	)

29 
	#KEY_DEL
 0xE9

	)

32 
	#C
(
x
ï¿½(x - '@')

	)

34 
uchï¿½
 
	gshiï¿½code
[256] =

36 [0x1D] 
CTL
,

37 [0x2A] 
SHIFT
,

38 [0x36] 
SHIFT
,

39 [0x38] 
ALT
,

40 [0x9D] 
CTL
,

41 [0xB8] 
ALT


44 
uchï¿½
 
	gtoggï¿½code
[256] =

46 [0x3A] 
CAPSLOCK
,

47 [0x45] 
NUMLOCK
,

48 [0x46] 
SCROLLLOCK


51 
uchï¿½
 
	gnï¿½mï¿½mï¿½
[256] =

53 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

56 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

58 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

59 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

60 
NO
, ' ', NO, NO, NO, NO, NO, NO,

61 
NO
, NO, NO, NO, NO, NO, NO, '7',

63 '2', '3', '0', '.', 
NO
, NO, NO, NO,

66 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

67 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

68 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

69 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

70 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


73 
uchï¿½
 
	gshiï¿½mï¿½
[256] =

75 
NO
, 033, '!', '@', '#', '$', '%', '^',

78 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

80 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

81 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

82 
NO
, ' ', NO, NO, NO, NO, NO, NO,

83 
NO
, NO, NO, NO, NO, NO, NO, '7',

85 '2', '3', '0', '.', 
NO
, NO, NO, NO,

88 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

89 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

90 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

91 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

92 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


95 
uchï¿½
 
	gï¿½lmï¿½
[256] =

97 
NO
, NO, NO, NO, NO, NO, NO, NO,

98 
NO
, NO, NO, NO, NO, NO, NO, NO,

99 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

100 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

101 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

102 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

103 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

105 [0xB5] 
C
('/'),

106 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

107 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

108 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

109 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

110 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


	@kill.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$maï¿½
(
ï¿½gc
, **
ï¿½gv
)

8 
i
;

10 if(
ï¿½gc
 < 2){

11 
	`ï¿½ï¿½tf
(2, "usage: killï¿½id...\n");

12 
	`exï¿½
();

14 
i
=1; i<
ï¿½gc
; i++)

15 
	`kï¿½l
(
	`ï¿½oi
(
ï¿½gv
[
i
]));

16 
	`exï¿½
();

17 
	}
}

	@lapic.c

4 
	~"ï¿½ï¿½m.h
"

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"dï¿½e.h
"

8 
	~"memï¿½yout.h
"

9 
	~"ï¿½ï¿½s.h
"

10 
	~"mmu.h
"

11 
	~"x86.h
"

14 
	#ID
 (0x0020/4)

15 
	#VER
 (0x0030/4)

16 
	#TPR
 (0x0080/4)

17 
	#EOI
 (0x00B0/4)

18 
	#SVR
 (0x00F0/4)

19 
	#ENABLE
 0x00000100

20 
	#ESR
 (0x0280/4)

21 
	#ICRLO
 (0x0300/4)

22 
	#INIT
 0x00000500

23 
	#STARTUP
 0x00000600

24 
	#DELIVS
 0x00001000

25 
	#ASSERT
 0x00004000

26 
	#DEASSERT
 0x00000000

	)

27 
	#LEVEL
 0x00008000

28 
	#BCAST
 0x00080000

29 
	#BUSY
 0x00001000

	)

30 
	#FIXED
 0x00000000

	)

31 
	#ICRHI
 (0x0310/4)

32 
	#TIMER
 (0x0320/4)

33 
	#X1
 0x0000000B

34 
	#PERIODIC
 0x00020000

35 
	#PCINT
 (0x0340/4)

36 
	#LINT0
 (0x0350/4)

37 
	#LINT1
 (0x0360/4)

38 
	#ERROR
 (0x0370/4)

39 
	#MASKED
 0x00010000

40 
	#TICR
 (0x0380/4)

41 
	#TCCR
 (0x0390/4)

42 
	#TDCR
 (0x03E0/4)

43 

	)

44 vÞ©ï¿½ï¿½
uï¿½t
 *
	gï¿½pic
;

48 
	$ï¿½picw
(
ï¿½dex
, 
vï¿½ue
)

50 
ï¿½pic
[
ï¿½dex
] = 
vï¿½ue
;

51 
ï¿½pic
[
ID
];

52 
	}
}

55 
	$ï¿½picï¿½ï¿½
()

57 if(!
ï¿½pic
)

61 
	`ï¿½picw
(
SVR
, 
ENABLE
 | (
T_IRQ0
 + 
IRQ_SPURIOUS
));

67 
	`ï¿½picw
(
TDCR
, 
X1
);

68 
	`ï¿½picw
(
TIMER
, 
PERIODIC
 | (
T_IRQ0
 + 
IRQ_TIMER
));

69 
	`ï¿½picw
(
TICR
, 10000000);

72 
	`ï¿½picw
(
LINT0
, 
MASKED
);

73 
	`ï¿½picw
(
LINT1
, 
MASKED
);

77 if(((
ï¿½pic
[
VER
]>>16) & 0xFF) >= 4)

78 
	`ï¿½picw
(
PCINT
, 
MASKED
);

81 
	`ï¿½picw
(
ERROR
, 
T_IRQ0
 + 
IRQ_ERROR
);

84 
	`ï¿½picw
(
ESR
, 0);

85 
	`ï¿½picw
(
ESR
, 0);

88 
	`ï¿½picw
(
EOI
, 0);

91 
	`ï¿½picw
(
ICRHI
, 0);

92 
	`ï¿½picw
(
ICRLO
, 
BCAST
 | 
INIT
 | 
LEVEL
);

93 
ï¿½pic
[
ICRLO
] & 
DELIVS
)

97 
	`ï¿½picw
(
TPR
, 0);

98 
	}
}

101 
	$ï¿½picid
()

103 iï¿½(!
ï¿½pic
)

105  
ï¿½pic
[
ID
] >> 24;

106 
	}
}

110 
	$ï¿½piï¿½oi
()

112 if(
ï¿½pic
)

113 
	`ï¿½picw
(
EOI
, 0);

114 
	}
}

119 
	$miï¿½odï¿½ay
(
us
)

121 
	}
}

123 
	#CMOS_PORT
 0x70

	)

124 
	#CMOS_RETURN
 0x71

	)

129 
	$ï¿½picï¿½ï¿½ï¿½p
(
uchï¿½
 
ï¿½icid
, 
uï¿½t
 
addr
)

131 
i
;

132 
ushï¿½t
 *
wrv
;

137 
	`outb
(
CMOS_PORT
, 0xF);

138 
	`outb
(
CMOS_PORT
+1, 0x0A);

139 
wrv
 = (
ushï¿½t
*)
	`P2V
((0x40<<4 | 0x67));

140 
wrv
[0] = 0;

141 
wrv
[1] = 
addr
 >> 4;

145 
	`ï¿½picw
(
ICRHI
, 
ï¿½icid
<<24);

146 
	`ï¿½picw
(
ICRLO
, 
INIT
 | 
LEVEL
 | 
ASSERT
);

147 
	`miï¿½odï¿½ay
(200);

148 
	`ï¿½picw
(
ICRLO
, 
INIT
 | 
LEVEL
);

149 
	`miï¿½odï¿½ay
(100);

156 
i
 = 0; i < 2; i++){

157 
	`ï¿½picw
(
ICRHI
, 
ï¿½icid
<<24);

158 
	`ï¿½picw
(
ICRLO
, 
STARTUP
 | (
addr
>>12));

159 
	`miï¿½odï¿½ay
(200);

161 
	}
}

163 
	#CMOS_STATA
 0x0a

	)

164 
	#CMOS_STATB
 0x0b

	)

165 
	#CMOS_UIP
 (1 << 7)

166 

	)

167 
	#SECS
 0x00

	)

168 
	#MINS
 0x02

	)

169 
	#HOURS
 0x04

	)

170 
	#DAY
 0x07

	)

171 
	#MONTH
 0x08

	)

172 
	#YEAR
 0x09

	)

174 
uï¿½t


175 
	$cmos_ï¿½ad
(
uï¿½t
 
ï¿½g
)

177 
	`outb
(
CMOS_PORT
, 
ï¿½g
);

178 
	`miï¿½odï¿½ay
(200);

180  
	`ï¿½b
(
CMOS_RETURN
);

181 
	}
}

184 
	$fï¿½l_ï¿½cdï¿½e
(
ï¿½cdï¿½e
 *
r
)

186 
r
->
ï¿½cï¿½d
 = 
	`cmos_ï¿½ad
(
SECS
);

187 
r
->
mï¿½uï¿½
 = 
	`cmos_ï¿½ad
(
MINS
);

188 
r
->
hour
 = 
	`cmos_ï¿½ad
(
HOURS
);

189 
r
->
day
 = 
	`cmos_ï¿½ad
(
DAY
);

190 
r
->
mï¿½th
 = 
	`cmos_ï¿½ad
(
MONTH
);

191 
r
->
yï¿½r
 = 
	`cmos_ï¿½ad
(
YEAR
);

192 
	}
}

196 
	$cmoï¿½ime
(
ï¿½cdï¿½e
 *
r
)

198 
ï¿½cdï¿½e
 
t1
, 
t2
;

199 
sb
, 
bcd
;

201 
sb
 = 
	`cmos_ï¿½ad
(
CMOS_STATB
);

203 
bcd
 = (
sb
 & (1 << 2)) == 0;

207 
	`fï¿½l_ï¿½cdï¿½e
(&
t1
);

208 if(
	`cmos_ï¿½ad
(
CMOS_STATA
ï¿½& 
CMOS_UIP
)

210 
	`fï¿½l_ï¿½cdï¿½e
(&
t2
);

211 if(
	`memcmp
(&
t1
, &
t2
, (t1)) == 0)

216 if(
bcd
) {

217 
	#CONV
(
x
ï¿½(
t1
.x = (ï¿½1.x >> 4ï¿½* 10ï¿½+ (t1.x & 0xf))

	)

218 
	`CONV
(
ï¿½cï¿½d
);

219 
	`CONV
(
mï¿½uï¿½
);

220 
	`CONV
(
hour
 );

221 
	`CONV
(
day
 );

222 
	`CONV
(
mï¿½th
 );

223 
	`CONV
(
yï¿½r
 );

224 #undeï¿½
CONV


227 *
r
 = 
t1
;

228 
r
->
yï¿½r
 += 2000;

229 
	}
}

	@ln.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

8 if(
ï¿½gc
 != 3){

9 
	`ï¿½ï¿½tf
(2, "Usage:ï¿½n oldï¿½ew\n");

10 
	`exï¿½
();

12 if(
	`lï¿½k
(
ï¿½gv
[1],ï¿½rgv[2]) < 0)

13 
	`ï¿½ï¿½tf
(2, "lï¿½k %ï¿½%s: faï¿½ed\n", 
ï¿½gv
[1],ï¿½rgv[2]);

14 
	`exï¿½
();

15 
	}
}

	@log.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"ï¿½ï¿½lock.h
"

5 
	~"ï¿½ï¿½ï¿½ock.h
"

6 
	~"fs.h
"

7 
	~"buf.h
"

34 
	sloghï¿½dï¿½
 {

35 
	mn
;

36 
	mblock
[
LOGSIZE
];

39 
	slog
 {

40 
ï¿½ï¿½lock
 
	mlock
;

41 
	mï¿½ï¿½t
;

42 
	msize
;

43 
	moutï¿½ï¿½dï¿½g
;

44 
	mcommï¿½tï¿½g
;

45 
	mdev
;

46 
loghï¿½dï¿½
 
	mlh
;

48 
log
 
	glog
;

50 
ï¿½covï¿½_ï¿½om_log
();

51 
commï¿½
();

54 
	$ï¿½ï¿½log
(
dev
)

56 iï¿½((
loghï¿½dï¿½
ï¿½>ï¿½
BSIZE
)

57 
	`ï¿½nic
("initlog:ï¿½oo bigï¿½ogheader");

59 
suï¿½rblock
 
sb
;

60 
	`ï¿½ï¿½lock
(&
log
.
lock
, "log");

61 
	`ï¿½adsb
(
dev
, &
sb
);

62 
log
.
ï¿½ï¿½t
 = 
sb
.
logï¿½ï¿½t
;

63 
log
.
size
 = 
sb
.
ï¿½og
;

64 
log
.
dev
 = dev;

65 
	`ï¿½covï¿½_ï¿½om_log
();

66 
	}
}

70 
	$ï¿½ï¿½ï¿½l_ï¿½ï¿½s
()

72 
ï¿½ï¿½
;

74 
ï¿½ï¿½
 = 0;ï¿½aï¿½ < 
log
.
lh
.
n
;ï¿½ail++) {

75 
buf
 *
lbuf
 = 
	`bï¿½ad
(
log
.
dev
,ï¿½og.
ï¿½ï¿½t
+
ï¿½ï¿½
+1);

76 
buf
 *
dbuf
 = 
	`bï¿½ad
(
log
.
dev
,ï¿½og.
lh
.
block
[
ï¿½ï¿½
]);

77 
	`memmove
(
dbuf
->
dï¿½a
, 
lbuf
->dï¿½a, 
BSIZE
);

78 
	`bwrï¿½e
(
dbuf
);

79 
	`bï¿½lï¿½
(
lbuf
);

80 
	`bï¿½lï¿½
(
dbuf
);

82 
	}
}

86 
	$ï¿½ad_hï¿½d
()

88 
buf
 *buï¿½ï¿½
	`bï¿½ad
(
log
.
dev
,ï¿½og.
ï¿½ï¿½t
);

89 
loghï¿½dï¿½
 *
lh
 = (loghï¿½dï¿½ *ï¿½(
buf
->
dï¿½a
);

90 
i
;

91 
log
.
lh
.
n
 =ï¿½h->n;

92 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

93 
log
.
lh
.
block
[
i
] =ï¿½h->block[i];

95 
	`bï¿½lï¿½
(
buf
);

96 
	}
}

102 
	$wrï¿½e_hï¿½d
()

104 
buf
 *buï¿½ï¿½
	`bï¿½ad
(
log
.
dev
,ï¿½og.
ï¿½ï¿½t
);

105 
loghï¿½dï¿½
 *
hb
 = (loghï¿½dï¿½ *ï¿½(
buf
->
dï¿½a
);

106 
i
;

107 
hb
->
n
 = 
log
.
lh
.n;

108 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

109 
hb
->
block
[
i
] = 
log
.
lh
.block[i];

111 
	`bwrï¿½e
(
buf
);

112 
	`bï¿½lï¿½
(
buf
);

113 
	}
}

116 
	$ï¿½covï¿½_ï¿½om_log
()

118 
	`ï¿½ad_hï¿½d
();

119 
	`ï¿½ï¿½ï¿½l_ï¿½ï¿½s
();

120 
log
.
lh
.
n
 = 0;

121 
	`wrï¿½e_hï¿½d
();

122 
	}
}

126 
	$begï¿½_ï¿½
()

128 
	`acquï¿½e
(&
log
.
lock
);

130 if(
log
.
commï¿½tï¿½g
){

131 
	`ï¿½ï¿½p
(&
log
, &log.
lock
);

132 } if(
log
.
lh
.
n
 + (log.
outï¿½ï¿½dï¿½g
+1)*
MAXOPBLOCKS
 > 
LOGSIZE
){

134 
	`ï¿½ï¿½p
(&
log
, &log.
lock
);

136 
log
.
outï¿½ï¿½dï¿½g
 += 1;

137 
	`ï¿½ï¿½aï¿½
(&
log
.
lock
);

141 
	}
}

146 
	$ï¿½d_ï¿½
()

148 
do_commï¿½
 = 0;

150 
	`acquï¿½e
(&
log
.
lock
);

151 
log
.
outï¿½ï¿½dï¿½g
 -= 1;

152 if(
log
.
commï¿½tï¿½g
)

153 
	`ï¿½nic
("log.committing");

154 if(
log
.
outï¿½ï¿½dï¿½g
 == 0){

155 
do_commï¿½
 = 1;

156 
log
.
commï¿½tï¿½g
 = 1;

161 
	`wakeup
(&
log
);

163 
	`ï¿½ï¿½aï¿½
(&
log
.
lock
);

165 if(
do_commï¿½
){

168 
	`commï¿½
();

169 
	`acquï¿½e
(&
log
.
lock
);

170 
log
.
commï¿½tï¿½g
 = 0;

171 
	`wakeup
(&
log
);

172 
	`ï¿½ï¿½aï¿½
(&
log
.
lock
);

174 
	}
}

178 
	$wrï¿½e_log
()

180 
ï¿½ï¿½
;

182 
ï¿½ï¿½
 = 0;ï¿½aï¿½ < 
log
.
lh
.
n
;ï¿½ail++) {

183 
buf
 *
to
 = 
	`bï¿½ad
(
log
.
dev
,ï¿½og.
ï¿½ï¿½t
+
ï¿½ï¿½
+1);

184 
buf
 *
ï¿½om
 = 
	`bï¿½ad
(
log
.
dev
,ï¿½og.
lh
.
block
[
ï¿½ï¿½
]);

185 
	`memmove
(
to
->
dï¿½a
, 
ï¿½om
->dï¿½a, 
BSIZE
);

186 
	`bwrï¿½e
(
to
);

187 
	`bï¿½lï¿½
(
ï¿½om
);

188 
	`bï¿½lï¿½
(
to
);

190 
	}
}

193 
	$commï¿½
()

195 iï¿½(
log
.
lh
.
n
 > 0) {

196 
	`wrï¿½e_log
();

197 
	`wrï¿½e_hï¿½d
();

198 
	`ï¿½ï¿½ï¿½l_ï¿½ï¿½s
();

199 
log
.
lh
.
n
 = 0;

200 
	`wrï¿½e_hï¿½d
();

202 
	}
}

214 
	$log_wrï¿½e
(
buf
 *
b
)

216 
i
;

218 iï¿½(
log
.
lh
.
n
 >ï¿½
LOGSIZE
 ||ï¿½og.lh.ï¿½>ï¿½log.
size
 - 1)

219 
	`ï¿½nic
("too bigï¿½ï¿½ransaction");

220 iï¿½(
log
.
outï¿½ï¿½dï¿½g
 < 1)

221 
	`ï¿½nic
("log_write outside ofï¿½rans");

223 
	`acquï¿½e
(&
log
.
lock
);

224 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

225 iï¿½(
log
.
lh
.
block
[
i
] =ï¿½
b
->
blockno
)

228 
log
.
lh
.
block
[
i
] = 
b
->
blockno
;

229 iï¿½(
i
 =ï¿½
log
.
lh
.
n
)

230 
log
.
lh
.
n
++;

231 
b
->
ï¿½ags
 |ï¿½
B_DIRTY
;

232 
	`ï¿½ï¿½aï¿½
(&
log
.
lock
);

233 
	}
}

	@ls.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

4 
	~"fs.h
"

7 
	$fmï¿½ame
(*
ï¿½th
)

9 
buf
[
DIRSIZ
+1];

10 *
p
;

13 
p
=
ï¿½th
+
	`ï¿½ï¿½ï¿½
(path);ï¿½ >=ï¿½ath && *p != '/';ï¿½--)

15 
p
++;

18 if(
	`ï¿½ï¿½ï¿½
(
p
ï¿½>ï¿½
DIRSIZ
)

19  
p
;

20 
	`memmove
(
buf
, 
p
, 
	`ï¿½ï¿½ï¿½
(p));

21 
	`memï¿½t
(
buf
+
	`ï¿½ï¿½ï¿½
(
p
), ' ', 
DIRSIZ
-strlen(p));

22  
buf
;

23 
	}
}

26 
	$ls
(*
ï¿½th
)

28 
buf
[512], *
p
;

29 
fd
;

30 
dï¿½ï¿½t
 
de
;

31 
ï¿½ï¿½
 
ï¿½
;

33 if((
fd
 = 
	`Ý’
(
ï¿½th
, 0)) < 0){

34 
	`ï¿½ï¿½tf
(2, "ls: cï¿½nï¿½ oï¿½ï¿½%s\n", 
ï¿½th
);

38 if(
	`fï¿½ï¿½
(
fd
, &
ï¿½
) < 0){

39 
	`ï¿½ï¿½tf
(2, "ls: cï¿½nï¿½ sï¿½ï¿½%s\n", 
ï¿½th
);

40 
	`ï¿½oï¿½
(
fd
);

44 
ï¿½
.
tyï¿½
){

45 
T_FILE
:

46 
	`ï¿½ï¿½tf
(1, "%ï¿½%d %d %d\n", 
	`fmï¿½ame
(
ï¿½th
), 
ï¿½
.
tyï¿½
, st.
ï¿½o
, st.
size
);

49 
T_DIR
:

50 if(
	`ï¿½ï¿½ï¿½
(
ï¿½th
ï¿½+ 1 + 
DIRSIZ
 + 1 >  
buf
){

51 
	`ï¿½ï¿½tf
(1, "ls:ï¿½athï¿½ooï¿½ong\n");

54 
	`ï¿½rï¿½y
(
buf
, 
ï¿½th
);

55 
p
 = 
buf
+
	`ï¿½ï¿½ï¿½
(buf);

56 *
p
++ = '/';

57 
	`ï¿½ad
(
fd
, &
de
, (de)) == (de)){

58 if(
de
.
ï¿½um
 == 0)

60 
	`memmove
(
p
, 
de
.
ï¿½me
, 
DIRSIZ
);

61 
p
[
DIRSIZ
] = 0;

62 if(
	`ï¿½ï¿½
(
buf
, &
ï¿½
) < 0){

63 
	`ï¿½ï¿½tf
(1, "ls: cï¿½nï¿½ sï¿½ï¿½%s\n", 
buf
);

66 
	`ï¿½ï¿½tf
(1, "%ï¿½%d %d %d\n", 
	`fmï¿½ame
(
buf
), 
ï¿½
.
tyï¿½
, st.
ï¿½o
, st.
size
);

70 
	`ï¿½oï¿½
(
fd
);

71 
	}
}

74 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

76 
i
;

78 if(
ï¿½gc
 < 2){

79 
	`ls
(".");

80 
	`exï¿½
();

82 
i
=1; i<
ï¿½gc
; i++)

83 
	`ls
(
ï¿½gv
[
i
]);

84 
	`exï¿½
();

85 
	}
}

	@main.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"memï¿½yout.h
"

5 
	~"mmu.h
"

6 
	~"ï¿½oc.h
"

7 
	~"x86.h
"

9 
ï¿½ï¿½tï¿½hï¿½s
();

10 
	$mpmaï¿½
(ï¿½
	`__ï¿½ï¿½ibuï¿½__
((
nÜ‘uï¿½
));

11 
pde_t
 *
kpgdï¿½
;

12 

ï¿½d
[];

18 
	$maï¿½
()

20 
	`kï¿½ï¿½1
(
ï¿½d
, 
	`P2V
(4*1024*1024));

21 
	`kvmï¿½loc
();

22 
	`mpï¿½ï¿½
();

23 
	`ï¿½picï¿½ï¿½
();

24 
	`ï¿½gï¿½ï¿½
();

25 
	`picï¿½ï¿½
();

26 
	`iï¿½picï¿½ï¿½
();

27 
	`cï¿½sï¿½eï¿½ï¿½
();

28 
	`uï¿½tï¿½ï¿½
();

29 
	`pï¿½ï¿½
();

30 
	`tvï¿½ï¿½
();

31 
	`bï¿½ï¿½
();

32 
	`fï¿½eï¿½ï¿½
();

33 
	`ideï¿½ï¿½
();

34 
	`ï¿½ï¿½tï¿½hï¿½s
();

35 
	`kï¿½ï¿½2
(
	`P2V
(4*1024*1024), P2V(
PHYSTOP
));

36 
	`uï¿½rï¿½ï¿½
();

37 
	`mpmaï¿½
();

38 
	}
}

42 
	$mï¿½ï¿½ï¿½
()

44 
	`swï¿½chkvm
();

45 
	`ï¿½gï¿½ï¿½
();

46 
	`ï¿½picï¿½ï¿½
();

47 
	`mpmaï¿½
();

48 
	}
}

52 
	$mpmaï¿½
()

54 
	`tf
("ï¿½u%d: sï¿½ï¿½ï¿½g %d\n", 
	`ï¿½uid
(), cpuid());

55 
	`idtï¿½ï¿½
();

56 
	`xchg
(&(
	`myï¿½u
()->
ï¿½ï¿½ï¿½d
), 1);

57 
	`scheduï¿½r
();

58 
	}
}

60 
pde_t
 
	gï¿½ï¿½ypgdï¿½
[];

64 
	$ï¿½ï¿½tï¿½hï¿½s
()

66 
uchï¿½
 
_bï¿½ï¿½y_ï¿½ï¿½yï¿½hï¿½_ï¿½ï¿½t
[], 
_bï¿½ï¿½y_ï¿½ï¿½yï¿½hï¿½_size
[];

67 
uchï¿½
 *
code
;

68 
ï¿½u
 *
c
;

69 *
ï¿½ack
;

74 
code
 = 
	`P2V
(0x7000);

75 
	`memmove
(
code
, 
_bï¿½ï¿½y_ï¿½ï¿½yï¿½hï¿½_ï¿½ï¿½t
, (
uï¿½t
)
_bï¿½ï¿½y_ï¿½ï¿½yï¿½hï¿½_size
);

77 
c
 = 
ï¿½us
; c < cpus+
nï¿½u
; c++){

78 if(
c
 =ï¿½
	`myï¿½u
())

84 
ï¿½ack
 = 
	`kï¿½loc
();

85 *(**)(
code
-4ï¿½ï¿½
ï¿½ack
 + 
KSTACKSIZE
;

86 *((**)())(
code
-8ï¿½ï¿½
mï¿½ï¿½ï¿½
;

87 *(**)(
code
-12ï¿½ï¿½(*ï¿½
	`V2P
(
ï¿½ï¿½ypgdï¿½
);

89 
	`ï¿½picï¿½ï¿½ï¿½p
(
c
->
ï¿½icid
, 
	`V2P
(
code
));

92 
c
->
ï¿½ï¿½ï¿½d
 == 0)

95 
	}
}

102 
__ï¿½ï¿½ibuï¿½__
((
	$__ï¿½igï¿½d__
(
PGSIZE
)))

103 
pde_t
 
ï¿½ï¿½ypgdï¿½
[
NPDENTRIES
] = {

105 [0] = (0ï¿½| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

107 [
KERNBASE
>>
PDXSHIFT
] = (0ï¿½| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

108 
	}
};

	@memide.c

4 
	~"tyï¿½s.h
"

5 
	~"defs.h
"

6 
	~"ï¿½ï¿½m.h
"

7 
	~"mmu.h
"

8 
	~"ï¿½oc.h
"

9 
	~"x86.h
"

10 
	~"ï¿½ï¿½s.h
"

11 
	~"ï¿½ï¿½lock.h
"

12 
	~"ï¿½ï¿½ï¿½ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
uchï¿½
 
_bï¿½ï¿½y_fs_img_ï¿½ï¿½t
[], 
_bï¿½ï¿½y_fs_img_size
[];

18 
	gdisksize
;

19 
uchï¿½
 *
	gmemdisk
;

22 
	$ideï¿½ï¿½
()

24 
memdisk
 = 
_bï¿½ï¿½y_fs_img_ï¿½ï¿½t
;

25 
disksize
 = (
uï¿½t
)
_bï¿½ï¿½y_fs_img_size
/
BSIZE
;

26 
	}
}

30 
	$ideï¿½ï¿½
()

33 
	}
}

39 
	$idï¿½w
(
buf
 *
b
)

41 
uchï¿½
 *
p
;

43 if(!
	`hï¿½dï¿½gï¿½ï¿½p
(&
b
->
lock
))

44 
	`ï¿½nic
("iderw: bufï¿½otï¿½ocked");

45 if((
b
->
ï¿½ags
 & (
B_VALID
|
B_DIRTY
)) == B_VALID)

46 
	`ï¿½nic
("iderw:ï¿½othingï¿½o do");

47 if(
b
->
dev
 != 1)

48 
	`ï¿½nic
("iderw:ï¿½equestï¿½ot for disk 1");

49 if(
b
->
blockno
 >ï¿½
disksize
)

50 
	`ï¿½nic
("iderw: block out ofï¿½ange");

52 
p
 = 
memdisk
 + 
b
->
blockno
*
BSIZE
;

54 if(
b
->
ï¿½ags
 & 
B_DIRTY
){

55 
b
->
ï¿½ags
 &ï¿½~
B_DIRTY
;

56 
	`memmove
(
p
, 
b
->
dï¿½a
, 
BSIZE
);

58 
	`memmove
(
b
->
dï¿½a
, 
p
, 
BSIZE
);

59 
b
->
ï¿½ags
 |ï¿½
B_VALID
;

60 
	}
}

	@memlayout.h

3 
	#EXTMEM
 0x100000

4 
	#PHYSTOP
 0xE000000

5 
	#DEVSPACE
 0xFE000000

6 

	)

8 
	#KERNBASE
 0x80000000

9 
	#KERNLINK
 (
KERNBASE
+
EXTMEM
)

10 

	)

11 
	#V2P
(
a
ï¿½(((
uï¿½t
ï¿½ï¿½)ï¿½- 
KERNBASE
)

	)

12 
	#P2V
(
a
ï¿½((*)(((*ï¿½ï¿½)ï¿½+ 
KERNBASE
))

	)

14 
	#V2P_WO
(
x
ï¿½((xï¿½- 
KERNBASE
)

15 
	#P2V_WO
(
x
ï¿½((xï¿½+ 
KERNBASE
)

	@mkdir.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

8 
i
;

10 if(
ï¿½gc
 < 2){

11 
	`ï¿½ï¿½tf
(2, "Usage: mkdir files...\n");

12 
	`exï¿½
();

15 
i
 = 1; i < 
ï¿½gc
; i++){

16 if(
	`mkdï¿½
(
ï¿½gv
[
i
]) < 0){

17 
	`ï¿½ï¿½tf
(2, "mkdï¿½: %ï¿½ï¿½edï¿½ï¿½ï¿½ï¿½ï¿½\n", 
ï¿½gv
[
i
]);

22 
	`exï¿½
();

23 
	}
}

	@mkfs.c

1 
	~<ï¿½dio.h
>

2 
	~<uniï¿½d.h
>

3 
	~<ï¿½dlib.h
>

4 
	~<ï¿½rï¿½g.h
>

5 
	~<fï¿½ï¿½.h
>

6 
	~<asï¿½ï¿½.h
>

8 
	#ï¿½ï¿½
 
xv6_ï¿½ï¿½


9 
	~"tyï¿½s.h
"

	)

10 
	~"fs.h
"

11 
	~"ï¿½ï¿½.h
"

12 
	~"ï¿½ï¿½m.h
"

14 #iï¿½deï¿½
ï¿½ï¿½ic_asï¿½ï¿½


15 
	#ï¿½ï¿½ic_asï¿½ï¿½
(
a
, 
b
ï¿½dï¿½{ 0ï¿½0: ï¿½): ; } 0)

	)

18 
	#NINODES
 200

	)

23 
	gnbï¿½mï¿½
 = 
FSSIZE
/(
BSIZE
*8) + 1;

24 
	gnï¿½odeblocks
 = 
NINODES
 / 
IPB
 + 1;

25 
	gï¿½og
 = 
LOGSIZE
;

26 
	gnmï¿½a
;

27 
	gnblocks
;

29 
	gfsfd
;

30 
suï¿½rblock
 
	gsb
;

31 
	gzï¿½ï¿½s
[
BSIZE
];

32 
uï¿½t
 
	gä“šode
 = 1;

33 
uï¿½t
 
	gï¿½block
;

36 
bï¿½loc
();

37 
wï¿½ï¿½
(
uï¿½t
, *);

38 
wï¿½ode
(
uï¿½t
, 
dï¿½ode
*);

39 
rï¿½ode
(
uï¿½t
 
ï¿½um
, 
dï¿½ode
 *
ï¿½
);

40 
rï¿½ï¿½
(
uï¿½t
 
ï¿½c
, *
buf
);

41 
uï¿½t
 
ï¿½ï¿½oc
(
ushï¿½t
 
tyï¿½
);

42 
ï¿½ï¿½ï¿½d
(
uï¿½t
 
ï¿½um
, *
p
, 
n
);

45 
ushï¿½t


46 
	$xshï¿½t
(
ushï¿½t
 
x
)

48 
ushï¿½t
 
y
;

49 
uchï¿½
 *
a
 = (uchï¿½*)&
y
;

50 
a
[0] = 
x
;

51 
a
[1] = 
x
 >> 8;

52  
y
;

53 
	}
}

55 
uï¿½t


56 
	$xï¿½t
(
uï¿½t
 
x
)

58 
uï¿½t
 
y
;

59 
uchï¿½
 *
a
 = (uchï¿½*)&
y
;

60 
a
[0] = 
x
;

61 
a
[1] = 
x
 >> 8;

62 
a
[2] = 
x
 >> 16;

63 
a
[3] = 
x
 >> 24;

64  
y
;

65 
	}
}

68 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

70 
i
, 
cc
, 
fd
;

71 
uï¿½t
 
roÙšo
, 
ï¿½um
, 
off
;

72 
dï¿½ï¿½t
 
de
;

73 
buf
[
BSIZE
];

74 
dï¿½ode
 
dï¿½
;

77 
	`ï¿½ï¿½ic_asï¿½ï¿½
(() == 4, "Integers must be 4 bytes!");

79 if(
ï¿½gc
 < 2){

80 
	`ï¿½rï¿½tf
(
ï¿½dï¿½r
, "Usage: mkfs fs.img files...\n");

81 
	`exï¿½
(1);

84 
	`asï¿½ï¿½
((
BSIZE
 % (
dï¿½ode
)) == 0);

85 
	`asï¿½ï¿½
((
BSIZE
 % (
dï¿½ï¿½t
)) == 0);

87 
fsfd
 = 
	`Ý’
(
ï¿½gv
[1], 
O_RDWR
|
O_CREAT
|
O_TRUNC
, 0666);

88 if(
fsfd
 < 0){

89 
	`ï¿½ï¿½ï¿½
(
ï¿½gv
[1]);

90 
	`exï¿½
(1);

94 
nmï¿½a
 = 2 + 
ï¿½og
 + 
nï¿½odeblocks
 + 
nbï¿½mï¿½
;

95 
nblocks
 = 
FSSIZE
 - 
nmï¿½a
;

97 
sb
.
size
 = 
	`xï¿½t
(
FSSIZE
);

98 
sb
.
nblocks
 = 
	`xï¿½t
(nblocks);

99 
sb
.
nï¿½odes
 = 
	`xï¿½t
(
NINODES
);

100 
sb
.
ï¿½og
 = 
	`xï¿½t
(nlog);

101 
sb
.
logï¿½ï¿½t
 = 
	`xï¿½t
(2);

102 
sb
.
ï¿½odeï¿½ï¿½t
 = 
	`xï¿½t
(2+
ï¿½og
);

103 
sb
.
bmï¿½ï¿½ï¿½t
 = 
	`xï¿½t
(2+
ï¿½og
+
nï¿½odeblocks
);

105 
	`ï¿½ï¿½tf
("nmeta %d (boot, super,ï¿½og blocks %u inode blocks %u, bitmap blocks %u) blocks %dï¿½otal %d\n",

106 
nmï¿½a
, 
ï¿½og
, 
nï¿½odeblocks
, 
nbï¿½mï¿½
, 
nblocks
, 
FSSIZE
);

108 
ï¿½block
 = 
nmï¿½a
;

110 
i
 = 0; i < 
FSSIZE
; i++)

111 
	`wï¿½ï¿½
(
i
, 
zï¿½ï¿½s
);

113 
	`memï¿½t
(
buf
, 0, (buf));

114 
	`memmove
(
buf
, &
sb
, (sb));

115 
	`wï¿½ï¿½
(1, 
buf
);

117 
roÙšo
 = 
	`ï¿½ï¿½oc
(
T_DIR
);

118 
	`asï¿½ï¿½
(
roÙšo
 =ï¿½
ROOTINO
);

120 
	`bzï¿½o
(&
de
, (de));

121 
de
.
ï¿½um
 = 
	`xshï¿½t
(
roÙšo
);

122 
	`ï¿½rï¿½y
(
de
.
ï¿½me
, ".");

123 
	`ï¿½ï¿½ï¿½d
(
roÙšo
, &
de
, (de));

125 
	`bzï¿½o
(&
de
, (de));

126 
de
.
ï¿½um
 = 
	`xshï¿½t
(
roÙšo
);

127 
	`ï¿½rï¿½y
(
de
.
ï¿½me
, "..");

128 
	`ï¿½ï¿½ï¿½d
(
roÙšo
, &
de
, (de));

130 
i
 = 2; i < 
ï¿½gc
; i++){

131 
	`asï¿½ï¿½
(
	`ï¿½dex
(
ï¿½gv
[
i
], '/') == 0);

133 if((
fd
 = 
	`Ý’
(
ï¿½gv
[
i
], 0)) < 0){

134 
	`ï¿½ï¿½ï¿½
(
ï¿½gv
[
i
]);

135 
	`exï¿½
(1);

142 if(
ï¿½gv
[
i
][0] == '_')

143 ++
ï¿½gv
[
i
];

145 
ï¿½um
 = 
	`ï¿½ï¿½oc
(
T_FILE
);

147 
	`bzï¿½o
(&
de
, (de));

148 
de
.
ï¿½um
 = 
	`xshï¿½t
(inum);

149 
	`ï¿½ï¿½ï¿½y
(
de
.
ï¿½me
, 
ï¿½gv
[
i
], 
DIRSIZ
);

150 
	`ï¿½ï¿½ï¿½d
(
roÙšo
, &
de
, (de));

152 (
cc
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf))) > 0)

153 
	`ï¿½ï¿½ï¿½d
(
ï¿½um
, 
buf
, 
cc
);

155 
	`ï¿½oï¿½
(
fd
);

159 
	`rï¿½ode
(
roÙšo
, &
dï¿½
);

160 
off
 = 
	`xï¿½t
(
dï¿½
.
size
);

161 
off
 = ((off/
BSIZE
) + 1) * BSIZE;

162 
dï¿½
.
size
 = 
	`xï¿½t
(
off
);

163 
	`wï¿½ode
(
roÙšo
, &
dï¿½
);

165 
	`bï¿½loc
(
ï¿½block
);

167 
	`exï¿½
(0);

168 
	}
}

171 
	$wï¿½ï¿½
(
uï¿½t
 
ï¿½c
, *
buf
)

173 if(
	`lï¿½ek
(
fsfd
, 
ï¿½c
 * 
BSIZE
, 0) != sec * BSIZE){

174 
	`ï¿½ï¿½ï¿½
("lseek");

175 
	`exï¿½
(1);

177 if(
	`wrï¿½e
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE){

178 
	`ï¿½ï¿½ï¿½
("write");

179 
	`exï¿½
(1);

181 
	}
}

184 
	$wï¿½ode
(
uï¿½t
 
ï¿½um
, 
dï¿½ode
 *
ï¿½
)

186 
buf
[
BSIZE
];

187 
uï¿½t
 
bn
;

188 
dï¿½ode
 *
dï¿½
;

190 
bn
 = 
	`IBLOCK
(
ï¿½um
, 
sb
);

191 
	`rï¿½ï¿½
(
bn
, 
buf
);

192 
dï¿½
 = ((
dï¿½ode
*)
buf
ï¿½+ (
ï¿½um
 % 
IPB
);

193 *
dï¿½
 = *
ï¿½
;

194 
	`wï¿½ï¿½
(
bn
, 
buf
);

195 
	}
}

198 
	$rï¿½ode
(
uï¿½t
 
ï¿½um
, 
dï¿½ode
 *
ï¿½
)

200 
buf
[
BSIZE
];

201 
uï¿½t
 
bn
;

202 
dï¿½ode
 *
dï¿½
;

204 
bn
 = 
	`IBLOCK
(
ï¿½um
, 
sb
);

205 
	`rï¿½ï¿½
(
bn
, 
buf
);

206 
dï¿½
 = ((
dï¿½ode
*)
buf
ï¿½+ (
ï¿½um
 % 
IPB
);

207 *
ï¿½
 = *
dï¿½
;

208 
	}
}

211 
	$rï¿½ï¿½
(
uï¿½t
 
ï¿½c
, *
buf
)

213 if(
	`lï¿½ek
(
fsfd
, 
ï¿½c
 * 
BSIZE
, 0) != sec * BSIZE){

214 
	`ï¿½ï¿½ï¿½
("lseek");

215 
	`exï¿½
(1);

217 if(
	`ï¿½ad
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE){

218 
	`ï¿½ï¿½ï¿½
("read");

219 
	`exï¿½
(1);

221 
	}
}

223 
uï¿½t


224 
	$ï¿½ï¿½oc
(
ushï¿½t
 
tyï¿½
)

226 
uï¿½t
 
ï¿½um
 = 
ä“šode
++;

227 
dï¿½ode
 
dï¿½
;

229 
	`bzï¿½o
(&
dï¿½
, (din));

230 
dï¿½
.
tyï¿½
 = 
	`xshï¿½t
(type);

231 
dï¿½
.
Æšk
 = 
	`xshï¿½t
(1);

232 
dï¿½
.
size
 = 
	`xï¿½t
(0);

233 
	`wï¿½ode
(
ï¿½um
, &
dï¿½
);

234  
ï¿½um
;

235 
	}
}

238 
	$bï¿½loc
(
uï¿½d
)

240 
uchï¿½
 
buf
[
BSIZE
];

241 
i
;

243 
	`ï¿½ï¿½tf
("bï¿½loc: fï¿½ï¿½ %d blockï¿½havï¿½bï¿½ï¿½ï¿½loï¿½ï¿½d\n", 
uï¿½d
);

244 
	`asï¿½ï¿½
(
uï¿½d
 < 
BSIZE
*8);

245 
	`bzï¿½o
(
buf
, 
BSIZE
);

246 
i
 = 0; i < 
uï¿½d
; i++){

247 
buf
[
i
/8] = buf[i/8] | (0x1 << (i%8));

249 
	`ï¿½ï¿½tf
("bï¿½loc: wrï¿½ï¿½bï¿½mï¿½ blockï¿½ï¿½ï¿½ï¿½ï¿½ %d\n", 
sb
.
bmï¿½ï¿½ï¿½t
);

250 
	`wï¿½ï¿½
(
sb
.
bmï¿½ï¿½ï¿½t
, 
buf
);

251 
	}
}

253 
	#mï¿½
(
a
, 
b
ï¿½(ï¿½ï¿½< (bï¿½? (aï¿½: (b))

	)

256 
	$ï¿½ï¿½ï¿½d
(
uï¿½t
 
ï¿½um
, *
xp
, 
n
)

258 *
p
 = (*)
xp
;

259 
uï¿½t
 
fbn
, 
off
, 
n1
;

260 
dï¿½ode
 
dï¿½
;

261 
buf
[
BSIZE
];

262 
uï¿½t
 
ï¿½dï¿½eï¿½
[
NINDIRECT
];

263 
uï¿½t
 
x
;

265 
	`rï¿½ode
(
ï¿½um
, &
dï¿½
);

266 
off
 = 
	`xï¿½t
(
dï¿½
.
size
);

268 
n
 > 0){

269 
fbn
 = 
off
 / 
BSIZE
;

270 
	`asï¿½ï¿½
(
fbn
 < 
MAXFILE
);

271 if(
fbn
 < 
NDIRECT
){

272 if(
	`xï¿½t
(
dï¿½
.
addrs
[
fbn
]) == 0){

273 
dï¿½
.
addrs
[
fbn
] = 
	`xï¿½t
(
ï¿½block
++);

275 
x
 = 
	`xï¿½t
(
dï¿½
.
addrs
[
fbn
]);

277 if(
	`xï¿½t
(
dï¿½
.
addrs
[
NDIRECT
]) == 0){

278 
dï¿½
.
addrs
[
NDIRECT
] = 
	`xï¿½t
(
ï¿½block
++);

280 
	`rï¿½ï¿½
(
	`xï¿½t
(
dï¿½
.
addrs
[
NDIRECT
]), (*)
ï¿½dï¿½eï¿½
);

281 if(
ï¿½dï¿½eï¿½
[
fbn
 - 
NDIRECT
] == 0){

282 
ï¿½dï¿½eï¿½
[
fbn
 - 
NDIRECT
] = 
	`xï¿½t
(
ï¿½block
++);

283 
	`wï¿½ï¿½
(
	`xï¿½t
(
dï¿½
.
addrs
[
NDIRECT
]), (*)
ï¿½dï¿½eï¿½
);

285 
x
 = 
	`xï¿½t
(
ï¿½dï¿½eï¿½
[
fbn
-
NDIRECT
]);

287 
n1
 = 
	`mï¿½
(
n
, (
fbn
 + 1ï¿½* 
BSIZE
 - 
off
);

288 
	`rï¿½ï¿½
(
x
, 
buf
);

289 
	`bcï¿½y
(
p
, 
buf
 + 
off
 - (
fbn
 * 
BSIZE
), 
n1
);

290 
	`wï¿½ï¿½
(
x
, 
buf
);

291 
n
 -ï¿½
n1
;

292 
off
 +ï¿½
n1
;

293 
p
 +ï¿½
n1
;

295 
dï¿½
.
size
 = 
	`xï¿½t
(
off
);

296 
	`wï¿½ode
(
ï¿½um
, &
dï¿½
);

297 
	}
}

	@mmu.h

5 
	#FL_IF
 0x00000200

6 

	)

8 
	#CR0_PE
 0x00000001

9 
	#CR0_WP
 0x00010000

10 
	#CR0_PG
 0x80000000

11 

	)

12 
	#CR4_PSE
 0x00000010

13 

	)

15 
	#SEG_KCODE
 1

16 
	#SEG_KDATA
 2

17 
	#SEG_UCODE
 3

18 
	#SEG_UDATA
 4

19 
	#SEG_TSS
 5

20 

	)

22 
	#NSEGS
 6

	)

24 #iï¿½deï¿½
__ASSEMBLER__


26 
	sï¿½gdesc
 {

27 
uï¿½t
 
	mlim_15_0
 : 16;

28 
uï¿½t
 
	mbaï¿½_15_0
 : 16;

29 
uï¿½t
 
	mbaï¿½_23_16
 : 8;

30 
uï¿½t
 
	mtyï¿½
 : 4;

31 
uï¿½t
 
	ms
 : 1;

32 
uï¿½t
 
	mdï¿½
 : 2;

33 
uï¿½t
 
	mp
 : 1;

34 
uï¿½t
 
	mlim_19_16
 : 4;

35 
uï¿½t
 
	mavl
 : 1;

36 
uï¿½t
 
	mrsv1
 : 1;

37 
uï¿½t
 
	mdb
 : 1;

38 
uï¿½t
 
	mg
 : 1;

39 
uï¿½t
 
	mbaï¿½_31_24
 : 8;

43 
	#SEG
(
tyï¿½
, 
baï¿½
, 
lim
, 
dï¿½
ï¿½(
ï¿½gdesc
) \

44 { ((
lim
ï¿½>> 12ï¿½& 0xffff, (
uï¿½t
)(
baï¿½
) & 0xffff, \

45 ((
uï¿½t
)(
baï¿½
ï¿½>> 16ï¿½& 0xff, 
tyï¿½
, 1, 
dï¿½
, 1, \

46 (
uï¿½t
)(
lim
ï¿½>> 28, 0, 0, 1, 1, (uï¿½t)(
baï¿½
ï¿½>> 24 }

	)

47 
	#SEG16
(
tyï¿½
, 
baï¿½
, 
lim
, 
dï¿½
ï¿½(
ï¿½gdesc
) \

48 { (
lim
ï¿½& 0xffff, (
uï¿½t
)(
baï¿½
) & 0xffff, \

49 ((
uï¿½t
)(
baï¿½
ï¿½>> 16ï¿½& 0xff, 
tyï¿½
, 1, 
dï¿½
, 1, \

50 (
uï¿½t
)(
lim
ï¿½>> 16, 0, 0, 1, 0, (uï¿½t)(
baï¿½
ï¿½>> 24 }

	)

53 
	#DPL_USER
 0x3

54 

	)

56 
	#STA_X
 0x8

57 
	#STA_W
 0x2

58 
	#STA_R
 0x2

59 

	)

61 
	#STS_T32A
 0x9

62 
	#STS_IG32
 0xE

63 
	#STS_TG32
 0xF

64 

	)

74 
	#PDX
(
va
ï¿½(((
uï¿½t
)(vaï¿½>> 
PDXSHIFT
ï¿½& 0x3FF)

	)

77 
	#PTX
(
va
ï¿½(((
uï¿½t
)(vaï¿½>> 
PTXSHIFT
ï¿½& 0x3FF)

	)

80 
	#PGADDR
(
d
, 
t
, 
o
ï¿½((
uï¿½t
)((dï¿½<< 
PDXSHIFT
 | (tï¿½<< 
PTXSHIFT
 | (o)))

	)

83 
	#NPDENTRIES
 1024

84 
	#NPTENTRIES
 1024

85 
	#PGSIZE
 4096

86 

	)

87 
	#PTXSHIFT
 12

88 
	#PDXSHIFT
 22

89 

	)

90 
	#PGROUNDUP
(
sz
ï¿½(((sz)+
PGSIZE
-1ï¿½& ~(PGSIZE-1))

	)

91 
	#PGROUNDDOWN
(
a
ï¿½((ï¿½)ï¿½& ~(
PGSIZE
-1))

	)

94 
	#PTE_P
 0x001

95 
	#PTE_W
 0x002

96 
	#PTE_U
 0x004

97 
	#PTE_PS
 0x080

98 

	)

100 
	#PTE_ADDR
(
ï¿½e
ï¿½((
uï¿½t
)Õ‹ï¿½& ~0xFFF)

	)

101 
	#PTE_FLAGS
(
ï¿½e
ï¿½((
uï¿½t
)Õ‹ï¿½& 0xFFF)

	)

103 #iï¿½deï¿½
__ASSEMBLER__


104 
uï¿½t
 
	tï¿½e_t
;

107 
	sï¿½skï¿½ï¿½e
 {

108 
uï¿½t
 
	mlï¿½k
;

109 
uï¿½t
 
	meï¿½0
;

110 
ushï¿½t
 
	mss0
;

111 
ushï¿½t
 
	mï¿½ddï¿½g1
;

112 
uï¿½t
 *
	meï¿½1
;

113 
ushï¿½t
 
	mss1
;

114 
ushï¿½t
 
	mï¿½ddï¿½g2
;

115 
uï¿½t
 *
	meï¿½2
;

116 
ushï¿½t
 
	mss2
;

117 
ushï¿½t
 
	mï¿½ddï¿½g3
;

118 *
	mï¿½3
;

119 
uï¿½t
 *
	meï¿½
;

120 
uï¿½t
 
	meï¿½ags
;

121 
uï¿½t
 
	mï¿½x
;

122 
uï¿½t
 
	mecx
;

123 
uï¿½t
 
	medx
;

124 
uï¿½t
 
	mebx
;

125 
uï¿½t
 *
	meï¿½
;

126 
uï¿½t
 *
	mebp
;

127 
uï¿½t
 
	mesi
;

128 
uï¿½t
 
	medi
;

129 
ushï¿½t
 
	mes
;

130 
ushï¿½t
 
	mï¿½ddï¿½g4
;

131 
ushï¿½t
 
	mcs
;

132 
ushï¿½t
 
	mï¿½ddï¿½g5
;

133 
ushï¿½t
 
	mss
;

134 
ushï¿½t
 
	mï¿½ddï¿½g6
;

135 
ushï¿½t
 
	mds
;

136 
ushï¿½t
 
	mï¿½ddï¿½g7
;

137 
ushï¿½t
 
	mfs
;

138 
ushï¿½t
 
	mï¿½ddï¿½g8
;

139 
ushï¿½t
 
	mgs
;

140 
ushï¿½t
 
	mï¿½ddï¿½g9
;

141 
ushï¿½t
 
	mldt
;

142 
ushï¿½t
 
	mï¿½ddï¿½g10
;

143 
ushï¿½t
 
	mt
;

144 
ushï¿½t
 
	miomb
;

148 
	sgï¿½edesc
 {

149 
uï¿½t
 
	moff_15_0
 : 16;

150 
uï¿½t
 
	mcs
 : 16;

151 
uï¿½t
 
	mï¿½gs
 : 5;

152 
uï¿½t
 
	mrsv1
 : 3;

153 
uï¿½t
 
	mtyï¿½
 : 4;

154 
uï¿½t
 
	ms
 : 1;

155 
uï¿½t
 
	mdï¿½
 : 2;

156 
uï¿½t
 
	mp
 : 1;

157 
uï¿½t
 
	moff_31_16
 : 16;

168 
	#SETGATE
(
gï¿½e
, 
iï¿½ï¿½p
, 
ï¿½l
, 
off
, 
d
) \

170 (
gï¿½e
).
off_15_0
 = (
uï¿½t
)(
off
) & 0xffff; \

171 (
gï¿½e
).
cs
 = (
ï¿½l
); \

172 (
gï¿½e
).
ï¿½gs
 = 0; \

173 (
gï¿½e
).
rsv1
 = 0; \

174 (
gï¿½e
).
tyï¿½
 = (
iï¿½ï¿½p
ï¿½? 
STS_TG32
 : 
STS_IG32
; \

175 (
gï¿½e
).
s
 = 0; \

176 (
gï¿½e
).
dï¿½
 = (
d
); \

177 (
gï¿½e
).
p
 = 1; \

178 (
gï¿½e
).
off_31_16
 = (
uï¿½t
)(
off
) >> 16; \

179 }

	)

	@mp.c

5 
	~"tyï¿½s.h
"

6 
	~"defs.h
"

7 
	~"ï¿½ï¿½m.h
"

8 
	~"memï¿½yout.h
"

9 
	~"mp.h
"

10 
	~"x86.h
"

11 
	~"mmu.h
"

12 
	~"ï¿½oc.h
"

14 
ï¿½u
 
	gï¿½us
[
NCPU
];

15 
	gnï¿½u
;

16 
uchï¿½
 
	giï¿½picid
;

18 
uchï¿½


19 
	$sum
(
uchï¿½
 *
addr
, 
ï¿½n
)

21 
i
, 
sum
;

23 
sum
 = 0;

24 
i
=0; i<
ï¿½n
; i++)

25 
sum
 +ï¿½
addr
[
i
];

26  
sum
;

27 
	}
}

30 
mp
*

31 
	$mpï¿½ï¿½ch1
(
uï¿½t
 
a
, 
ï¿½n
)

33 
uchï¿½
 *
e
, *
p
, *
addr
;

35 
addr
 = 
	`P2V
(
a
);

36 
e
 = 
addr
+
ï¿½n
;

37 
p
 = 
addr
;ï¿½ < 
e
;ï¿½ +ï¿½(
mp
))

38 if(
	`memcmp
(
p
, "_MP_", 4ï¿½=ï¿½0 && 
	`sum
ï¿½, (
mp
)) == 0)

39  (
mp
*)
p
;

41 
	}
}

48 
mp
*

49 
	$mpï¿½ï¿½ch
()

51 
uchï¿½
 *
bda
;

52 
uï¿½t
 
p
;

53 
mp
 *mp;

55 
bda
 = (
uchï¿½
 *ï¿½
	`P2V
(0x400);

56 if((
p
 = ((
bda
[0x0F]<<8)| bda[0x0E]) << 4)){

57 if((
mp
 = 
	`mpï¿½ï¿½ch1
(
p
, 1024)))

58  
mp
;

60 
p
 = ((
bda
[0x14]<<8)|bda[0x13])*1024;

61 if((
mp
 = 
	`mpï¿½ï¿½ch1
(
p
-1024, 1024)))

62  
mp
;

64  
	`mpï¿½ï¿½ch1
(0xF0000, 0x10000);

65 
	}
}

72 
mpcï¿½f
*

73 
	$mpcï¿½fig
(
mp
 **
pmp
)

75 
mpcï¿½f
 *
cï¿½f
;

76 
mp
 *mp;

78 if((
mp
 = 
	`mpï¿½ï¿½ch
()ï¿½=ï¿½0 || mp->
phyï¿½ddr
 == 0)

80 
cï¿½f
 = (
mpcï¿½f
*ï¿½
	`P2V
((
uï¿½t
ï¿½
mp
->
phyï¿½ddr
);

81 if(
	`memcmp
(
cï¿½f
, "PCMP", 4) != 0)

83 if(
cï¿½f
->
vï¿½siï¿½
 != 1 && conf->version != 4)

85 if(
	`sum
((
uchï¿½
*)
cï¿½f
, cï¿½f->
ï¿½ngth
) != 0)

87 *
pmp
 = 
mp
;

88  
cï¿½f
;

89 
	}
}

92 
	$mpï¿½ï¿½
()

94 
uchï¿½
 *
p
, *
e
;

95 
ismp
;

96 
mp
 *mp;

97 
mpcï¿½f
 *
cï¿½f
;

98 
mï¿½roc
 *
ï¿½oc
;

99 
mpiï¿½pic
 *
iï¿½pic
;

101 if((
cï¿½f
 = 
	`mpcï¿½fig
(&
mp
)) == 0)

102 
	`ï¿½nic
("Expectï¿½oï¿½un onï¿½n SMP");

103 
ismp
 = 1;

104 
ï¿½pic
 = (
uï¿½t
*)
cï¿½f
->
ï¿½piï¿½ddr
;

105 
p
=(
uchï¿½
*)(
cï¿½f
+1), 
e
=(uchï¿½*)cï¿½f+cï¿½f->
ï¿½ngth
;ï¿½<e; ){

106 *
p
){

107 
MPPROC
:

108 
ï¿½oc
 = (
mï¿½roc
*)
p
;

109 if(
nï¿½u
 < 
NCPU
) {

110 
ï¿½us
[
nï¿½u
].
ï¿½icid
 = 
ï¿½oc
->apicid;

111 
nï¿½u
++;

113 
p
 +ï¿½(
mï¿½roc
);

115 
MPIOAPIC
:

116 
iï¿½pic
 = (
mpiï¿½pic
*)
p
;

117 
iï¿½picid
 = 
iï¿½pic
->
ï¿½iï¿½o
;

118 
p
 +ï¿½(
mpiï¿½pic
);

120 
MPBUS
:

121 
MPIOINTR
:

122 
MPLINTR
:

123 
p
 += 8;

126 
ismp
 = 0;

130 if(!
ismp
)

131 
	`ï¿½nic
("Didn't findï¿½ suitable machine");

133 if(
mp
->
imï¿½p
){

136 
	`outb
(0x22, 0x70);

137 
	`outb
(0x23, 
	`ï¿½b
(0x23) | 1);

139 
	}
}

	@mp.h

3 
	smp
 {

4 
uchï¿½
 
	msigï¿½tuï¿½
[4];

5 *
	mphyï¿½ddr
;

6 
uchï¿½
 
	mï¿½ngth
;

7 
uchï¿½
 
	mï¿½eï¿½ev
;

8 
uchï¿½
 
	mchecksum
;

9 
uchï¿½
 
	mtyï¿½
;

10 
uchï¿½
 
	mimï¿½p
;

11 
uchï¿½
 
	mï¿½ï¿½rved
[3];

14 
	smpcï¿½f
 {

15 
uchï¿½
 
	msigï¿½tuï¿½
[4];

16 
ushï¿½t
 
	mï¿½ngth
;

17 
uchï¿½
 
	mvï¿½siï¿½
;

18 
uchï¿½
 
	mchecksum
;

19 
uchï¿½
 
	mï¿½oduï¿½
[20];

20 
uï¿½t
 *
	mï¿½mï¿½bï¿½
;

21 
ushï¿½t
 
	mï¿½mï¿½ngth
;

22 
ushï¿½t
 
	mï¿½ï¿½y
;

23 
uï¿½t
 *
	mï¿½piï¿½ddr
;

24 
ushï¿½t
 
	mxï¿½ngth
;

25 
uchï¿½
 
	mxchecksum
;

26 
uchï¿½
 
	mï¿½ï¿½rved
;

29 
	smï¿½roc
 {

30 
uchï¿½
 
	mtyï¿½
;

31 
uchï¿½
 
	mï¿½icid
;

32 
uchï¿½
 
	mvï¿½siï¿½
;

33 
uchï¿½
 
	mï¿½ags
;

34 
	#MPBOOT
 0x02

35 
uchï¿½
 
sigï¿½tuï¿½
[4];

36 
uï¿½t
 
ï¿½uï¿½
;

37 
uchï¿½
 
ï¿½ï¿½rved
[8];

	)

40 
	smpiï¿½pic
 {

41 
uchï¿½
 
	mtyï¿½
;

42 
uchï¿½
 
	mï¿½iï¿½o
;

43 
uchï¿½
 
	mvï¿½siï¿½
;

44 
uchï¿½
 
	mï¿½ags
;

45 
uï¿½t
 *
	maddr
;

49 
	#MPPROC
 0x00

50 
	#MPBUS
 0x01

51 
	#MPIOAPIC
 0x02

52 
	#MPIOINTR
 0x03

53 
	#MPLINTR
 0x04

54 

	)

	@param.h

1 
	#NPROC
 64

2 
	#KSTACKSIZE
 4096

3 
	#NCPU
 8

4 
	#NOFILE
 16

5 
	#NFILE
 100

6 
	#NINODE
 50

7 
	#NDEV
 10

8 
	#ROOTDEV
 1

9 
	#MAXARG
 32

10 
	#MAXOPBLOCKS
 10

11 
	#LOGSIZE
 (
MAXOPBLOCKS
*3)

12 
	#NBUF
 (
MAXOPBLOCKS
*3)

13 
	#FSSIZE
 1000

14 

	)

	@picirq.c

1 
	~"tyï¿½s.h
"

2 
	~"x86.h
"

3 
	~"ï¿½ï¿½s.h
"

6 
	#IO_PIC1
 0x20

7 
	#IO_PIC2
 0xA0

8 

	)

11 
	$picï¿½ï¿½
()

14 
	`outb
(
IO_PIC1
+1, 0xFF);

15 
	`outb
(
IO_PIC2
+1, 0xFF);

16 
	}
}

	@pipe.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"mmu.h
"

5 
	~"ï¿½oc.h
"

6 
	~"fs.h
"

7 
	~"ï¿½ï¿½lock.h
"

8 
	~"ï¿½ï¿½ï¿½ock.h
"

9 
	~"fï¿½e.h
"

11 
	#PIPESIZE
 512

	)

13 
	spï¿½e
 {

14 
ï¿½ï¿½lock
 
	mlock
;

15 
	mdï¿½a
[
PIPESIZE
];

16 
uï¿½t
 
	mÄ—d
;

17 
uï¿½t
 
	mnwrï¿½e
;

18 
	mï¿½adÝ’
;

19 
	mwrï¿½eÝ’
;

23 
	$pï¿½ï¿½ï¿½oc
(
fï¿½e
 **
f0
, fï¿½ï¿½**
f1
)

25 
pï¿½e
 *
p
;

27 
p
 = 0;

28 *
f0
 = *
f1
 = 0;

29 if((*
f0
 = 
	`fï¿½ï¿½ï¿½oc
()ï¿½=ï¿½0 || (*
f1
 = filealloc()) == 0)

30 
bad
;

31 if((
p
 = (
pï¿½e
*)
	`kï¿½loc
()) == 0)

32 
bad
;

33 
p
->
ï¿½adÝ’
 = 1;

34 
p
->
wrï¿½eÝ’
 = 1;

35 
p
->
nwrï¿½e
 = 0;

36 
p
->
Ä—d
 = 0;

37 
	`ï¿½ï¿½lock
(&
p
->
lock
, "pipe");

38 (*
f0
)->
tyï¿½
 = 
FD_PIPE
;

39 (*
f0
)->
ï¿½adabï¿½
 = 1;

40 (*
f0
)->
wrï¿½abï¿½
 = 0;

41 (*
f0
)->
pï¿½e
 = 
p
;

42 (*
f1
)->
tyï¿½
 = 
FD_PIPE
;

43 (*
f1
)->
ï¿½adabï¿½
 = 0;

44 (*
f1
)->
wrï¿½abï¿½
 = 1;

45 (*
f1
)->
pï¿½e
 = 
p
;

49 
bad
:

50 if(
p
)

51 
	`kï¿½
((*)
p
);

52 if(*
f0
)

53 
	`fï¿½eï¿½oï¿½
(*
f0
);

54 if(*
f1
)

55 
	`fï¿½eï¿½oï¿½
(*
f1
);

57 
	}
}

60 
	$pï¿½eï¿½oï¿½
(
pï¿½e
 *
p
, 
wrï¿½abï¿½
)

62 
	`acquï¿½e
(&
p
->
lock
);

63 if(
wrï¿½abï¿½
){

64 
p
->
wrï¿½eÝ’
 = 0;

65 
	`wakeup
(&
p
->
Ä—d
);

67 
p
->
ï¿½adÝ’
 = 0;

68 
	`wakeup
(&
p
->
nwrï¿½e
);

70 if(
p
->
ï¿½adÝ’
 =ï¿½0 &&ï¿½->
wrï¿½eÝ’
 == 0){

71 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

72 
	`kï¿½
((*)
p
);

74 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

75 
	}
}

79 
	$pï¿½ewrï¿½e
(
pï¿½e
 *
p
, *
addr
, 
n
)

81 
i
;

83 
	`acquï¿½e
(&
p
->
lock
);

84 
i
 = 0; i < 
n
; i++){

85 
p
->
nwrï¿½e
 =ï¿½p->
Ä—d
 + 
PIPESIZE
){

86 if(
p
->
ï¿½adÝ’
 =ï¿½0 || 
	`myï¿½oc
()->
kï¿½ï¿½d
){

87 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

90 
	`wakeup
(&
p
->
Ä—d
);

91 
	`ï¿½ï¿½p
(&
p
->
nwrï¿½e
, &p->
lock
);

93 
p
->
dï¿½a
[p->
nwrï¿½e
++ % 
PIPESIZE
] = 
addr
[
i
];

95 
	`wakeup
(&
p
->
Ä—d
);

96 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

97  
n
;

98 
	}
}

101 
	$pï¿½ï¿½ï¿½d
(
pï¿½e
 *
p
, *
addr
, 
n
)

103 
i
;

105 
	`acquï¿½e
(&
p
->
lock
);

106 
p
->
Ä—d
 =ï¿½p->
nwrï¿½e
 &&ï¿½->
wrï¿½eÝ’
){

107 if(
	`myï¿½oc
()->
kï¿½ï¿½d
){

108 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

111 
	`ï¿½ï¿½p
(&
p
->
Ä—d
, &p->
lock
);

113 
i
 = 0; i < 
n
; i++){

114 if(
p
->
Ä—d
 =ï¿½p->
nwrï¿½e
)

116 
addr
[
i
] = 
p
->
dï¿½a
[p->
Ä—d
++ % 
PIPESIZE
];

118 
	`wakeup
(&
p
->
nwrï¿½e
);

119 
	`ï¿½ï¿½aï¿½
(&
p
->
lock
);

120  
i
;

121 
	}
}

	@printf.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$putc
(
fd
, 
c
)

8 
	`wrï¿½e
(
fd
, &
c
, 1);

9 
	}
}

12 
	$ï¿½ï¿½tï¿½t
(
fd
, 
xx
, 
baï¿½
, 
sgn
)

14 
digï¿½s
[] = "0123456789ABCDEF";

15 
buf
[16];

16 
i
, 
ï¿½g
;

17 
uï¿½t
 
x
;

19 
ï¿½g
 = 0;

20 if(
sgn
 && 
xx
 < 0){

21 
ï¿½g
 = 1;

22 
x
 = -
xx
;

24 
x
 = 
xx
;

27 
i
 = 0;

29 
buf
[
i
++] = 
digï¿½s
[
x
 % 
baï¿½
];

30 }(
x
 /ï¿½
baï¿½
) != 0);

31 if(
ï¿½g
)

32 
buf
[
i
++] = '-';

34 --
i
 >= 0)

35 
	`putc
(
fd
, 
buf
[
i
]);

36 
	}
}

40 
	$ï¿½ï¿½tf
(
fd
, cÚ¡ *
fmt
, ...)

42 *
s
;

43 
c
, 
i
, 
ï¿½ï¿½e
;

44 
uï¿½t
 *
ï¿½
;

46 
ï¿½ï¿½e
 = 0;

47 
ï¿½
 = (
uï¿½t
*)(*)&
fmt
 + 1;

48 
i
 = 0; 
fmt
[i]; i++){

49 
c
 = 
fmt
[
i
] & 0xff;

50 if(
ï¿½ï¿½e
 == 0){

51 if(
c
 == '%'){

52 
ï¿½ï¿½e
 = '%';

54 
	`putc
(
fd
, 
c
);

56 } if(
ï¿½ï¿½e
 == '%'){

57 if(
c
 == 'd'){

58 
	`ï¿½ï¿½tï¿½t
(
fd
, *
ï¿½
, 10, 1);

59 
ï¿½
++;

60 } if(
c
 == 'x' || c == 'p'){

61 
	`ï¿½ï¿½tï¿½t
(
fd
, *
ï¿½
, 16, 0);

62 
ï¿½
++;

63 } if(
c
 == 's'){

64 
s
 = (*)*
ï¿½
;

65 
ï¿½
++;

66 if(
s
 == 0)

67 
s
 = "(null)";

68 *
s
 != 0){

69 
	`putc
(
fd
, *
s
);

70 
s
++;

72 } if(
c
 == 'c'){

73 
	`putc
(
fd
, *
ï¿½
);

74 
ï¿½
++;

75 } if(
c
 == '%'){

76 
	`putc
(
fd
, 
c
);

79 
	`putc
(
fd
, '%');

80 
	`putc
(
fd
, 
c
);

82 
ï¿½ï¿½e
 = 0;

85 
	}
}

	@proc.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"memï¿½yout.h
"

5 
	~"mmu.h
"

6 
	~"x86.h
"

7 
	~"ï¿½oc.h
"

8 
	~"ï¿½ï¿½lock.h
"

11 
ï¿½ï¿½lock
 
	mlock
;

12 
ï¿½oc
 
	mï¿½oc
[
NPROC
];

13 } 
	gï¿½abï¿½
;

15 
ï¿½oc
 *
	gï¿½ï¿½ï¿½oc
;

17 
	gï¿½xï¿½id
 = 1;

18 

fï¿½kï¿½t
();

19 

ï¿½ï¿½ï¿½t
();

21 
wakeup1
(*
chï¿½
);

24 
	$pï¿½ï¿½
()

26 
	`ï¿½ï¿½lock
(&
ï¿½abï¿½
.
lock
, "ptable");

27 
	}
}

31 
	$ï¿½uid
() {

32  
	`myï¿½u
()-
ï¿½us
;

33 
	}
}

37 
ï¿½u
*

38 
	$myï¿½u
()

40 
ï¿½icid
, 
i
;

42 if(
	`ï¿½adeï¿½ags
()&
FL_IF
)

43 
	`ï¿½nic
("mycpu called with interruptsï¿½nabled\n");

45 
ï¿½icid
 = 
	`ï¿½picid
();

48 
i
 = 0; i < 
nï¿½u
; ++i) {

49 iï¿½(
ï¿½us
[
i
].
ï¿½icid
 ==ï¿½picid)

50  &
ï¿½us
[
i
];

52 
	`ï¿½nic
("unknownï¿½picid\n");

53 
	}
}

57 
ï¿½oc
*

58 
	$myï¿½oc
() {

59 
ï¿½u
 *
c
;

60 
ï¿½oc
 *
p
;

61 
	`pushï¿½i
();

62 
c
 = 
	`myï¿½u
();

63 
p
 = 
c
->
ï¿½oc
;

64 
	`pï¿½ï¿½i
();

65  
p
;

66 
	}
}

73 
ï¿½oc
*

74 
	$ï¿½loï¿½roc
()

76 
ï¿½oc
 *
p
;

77 *
ï¿½
;

79 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

81 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++)

82 if(
p
->
ï¿½ï¿½e
 =ï¿½
UNUSED
)

83 
found
;

85 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

88 
found
:

89 
p
->
ï¿½ï¿½e
 = 
EMBRYO
;

90 
p
->
pid
 = 
ï¿½xï¿½id
++;

92 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

95 if((
p
->
kï¿½ack
 = 
	`kï¿½loc
()) == 0){

96 
p
->
ï¿½ï¿½e
 = 
UNUSED
;

99 
ï¿½
 = 
p
->
kï¿½ack
 + 
KSTACKSIZE
;

102 
ï¿½
 -ï¿½ *
p
->
tf
;

103 
p
->
tf
 = (
ï¿½ï¿½ï¿½ame
*)
ï¿½
;

107 
ï¿½
 -= 4;

108 *(
uï¿½t
*)
ï¿½
 = (uï¿½t)
ï¿½ï¿½ï¿½t
;

110 
ï¿½
 -ï¿½ *
p
->
cÚ‹xt
;

111 
p
->
cÚ‹xt
 = (cÚ‹xt*)
ï¿½
;

112 
	`memï¿½t
(
p
->
cÚ‹xt
, 0,  *p->context);

113 
p
->
cÚ‹xt
->
eï¿½
 = (
uï¿½t
)
fï¿½kï¿½t
;

115  
p
;

116 
	}
}

121 
	$uï¿½rï¿½ï¿½
()

123 
ï¿½oc
 *
p
;

124 

_bï¿½ï¿½y_ï¿½ï¿½code_ï¿½ï¿½t
[], 
_bï¿½ï¿½y_ï¿½ï¿½code_size
[];

126 
p
 = 
	`ï¿½loï¿½roc
();

128 
ï¿½ï¿½ï¿½oc
 = 
p
;

129 if((
p
->
pgdï¿½
 = 
	`ï¿½tupkvm
()) == 0)

130 
	`ï¿½nic
("userinit: out of memory?");

131 
	`ï¿½ï¿½uvm
(
p
->
pgdï¿½
, 
_bï¿½ï¿½y_ï¿½ï¿½code_ï¿½ï¿½t
, ()
_bï¿½ï¿½y_ï¿½ï¿½code_size
);

132 
p
->
sz
 = 
PGSIZE
;

133 
	`memï¿½t
(
p
->
tf
, 0, (*p->tf));

134 
p
->
tf
->
cs
 = (
SEG_UCODE
 << 3ï¿½| 
DPL_USER
;

135 
p
->
tf
->
ds
 = (
SEG_UDATA
 << 3ï¿½| 
DPL_USER
;

136 
p
->
tf
->
es
 =ï¿½->tf->
ds
;

137 
p
->
tf
->
ss
 =ï¿½->tf->
ds
;

138 
p
->
tf
->
eï¿½ags
 = 
FL_IF
;

139 
p
->
tf
->
eï¿½
 = 
PGSIZE
;

140 
p
->
tf
->
eï¿½
 = 0;

142 
	`ï¿½ï¿½rï¿½y
(
p
->
ï¿½me
, "initcode", (p->name));

143 
p
->
cwd
 = 
	`ï¿½mei
("/");

149 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

151 
p
->
ï¿½ï¿½e
 = 
RUNNABLE
;

153 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

154 
	}
}

159 
	$growï¿½oc
(
n
)

161 
uï¿½t
 
sz
;

162 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

164 
sz
 = 
cuï¿½roc
->sz;

165 if(
n
 > 0){

166 if((
sz
 = 
	`ï¿½locuvm
(
cuï¿½roc
->
pgdï¿½
, sz, sz + 
n
)) == 0)

168 } if(
n
 < 0){

169 if((
sz
 = 
	`dï¿½ï¿½ocuvm
(
cuï¿½roc
->
pgdï¿½
, sz, sz + 
n
)) == 0)

172 
cuï¿½roc
->
sz
 = sz;

173 
	`swï¿½chuvm
(
cuï¿½roc
);

175 
	}
}

181 
	$fï¿½k
()

183 
i
, 
pid
;

184 
ï¿½oc
 *
ï¿½
;

185 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

188 if((
ï¿½
 = 
	`ï¿½loï¿½roc
()) == 0){

193 if((
ï¿½
->
pgdï¿½
 = 
	`cï¿½yuvm
(
cuï¿½roc
->pgdï¿½, cuï¿½roc->
sz
)) == 0){

194 
	`kï¿½
(
ï¿½
->
kï¿½ack
);

195 
ï¿½
->
kï¿½ack
 = 0;

196 
ï¿½
->
ï¿½ï¿½e
 = 
UNUSED
;

199 
ï¿½
->
sz
 = 
cuï¿½roc
->sz;

200 
ï¿½
->
ï¿½ï¿½ï¿½
 = 
cuï¿½roc
;

201 *
ï¿½
->
tf
 = *
cuï¿½roc
->tf;

204 
ï¿½
->
tf
->
ï¿½x
 = 0;

206 
i
 = 0; i < 
NOFILE
; i++)

207 if(
cuï¿½roc
->
ofï¿½e
[
i
])

208 
ï¿½
->
ofï¿½e
[
i
] = 
	`fï¿½edup
(
cuï¿½roc
->ofile[i]);

209 
ï¿½
->
cwd
 = 
	`idup
(
cuï¿½roc
->cwd);

211 
	`ï¿½ï¿½rï¿½y
(
ï¿½
->
ï¿½me
, 
cuï¿½roc
->name, (curproc->name));

213 
pid
 = 
ï¿½
->pid;

215 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

217 
ï¿½
->
ï¿½ï¿½e
 = 
RUNNABLE
;

219 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

221  
pid
;

222 
	}
}

228 
	$exï¿½
()

230 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

231 
ï¿½oc
 *
p
;

232 
fd
;

234 if(
cuï¿½roc
 =ï¿½
ï¿½ï¿½ï¿½oc
)

235 
	`ï¿½nic
("initï¿½xiting");

238 
fd
 = 0; fd < 
NOFILE
; fd++){

239 if(
cuï¿½roc
->
ofï¿½e
[
fd
]){

240 
	`fï¿½eï¿½oï¿½
(
cuï¿½roc
->
ofï¿½e
[
fd
]);

241 
cuï¿½roc
->
ofï¿½e
[
fd
] = 0;

245 
	`begï¿½_ï¿½
();

246 
	`ï¿½ut
(
cuï¿½roc
->
cwd
);

247 
	`ï¿½d_ï¿½
();

248 
cuï¿½roc
->
cwd
 = 0;

250 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

253 
	`wakeup1
(
cuï¿½roc
->
ï¿½ï¿½ï¿½
);

256 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++){

257 if(
p
->
ï¿½ï¿½ï¿½
 =ï¿½
cuï¿½roc
){

258 
p
->
ï¿½ï¿½ï¿½
 = 
ï¿½ï¿½ï¿½oc
;

259 if(
p
->
ï¿½ï¿½e
 =ï¿½
ZOMBIE
)

260 
	`wakeup1
(
ï¿½ï¿½ï¿½oc
);

265 
cuï¿½roc
->
ï¿½ï¿½e
 = 
ZOMBIE
;

266 
	`sched
();

267 
	`ï¿½nic
("zombieï¿½xit");

268 
	}
}

273 
	$waï¿½
()

275 
ï¿½oc
 *
p
;

276 
havekids
, 
pid
;

277 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

279 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

282 
havekids
 = 0;

283 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++){

284 if(
p
->
ï¿½ï¿½ï¿½
 !ï¿½
cuï¿½roc
)

286 
havekids
 = 1;

287 if(
p
->
ï¿½ï¿½e
 =ï¿½
ZOMBIE
){

289 
pid
 = 
p
->pid;

290 
	`kï¿½
(
p
->
kï¿½ack
);

291 
p
->
kï¿½ack
 = 0;

292 
	`ï¿½vm
(
p
->
pgdï¿½
);

293 
p
->
pid
 = 0;

294 
p
->
ï¿½ï¿½ï¿½
 = 0;

295 
p
->
ï¿½me
[0] = 0;

296 
p
->
kï¿½ï¿½d
 = 0;

297 
p
->
ï¿½ï¿½e
 = 
UNUSED
;

298 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

299  
pid
;

304 if(!
havekids
 || 
cuï¿½roc
->
kï¿½ï¿½d
){

305 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

310 
	`ï¿½ï¿½p
(
cuï¿½roc
, &
ï¿½abï¿½
.
lock
);

312 
	}
}

323 
	$scheduï¿½r
()

325 
ï¿½oc
 *
p
;

326 
ï¿½u
 *
c
 = 
	`myï¿½u
();

327 
c
->
ï¿½oc
 = 0;

331 
	`ï¿½i
();

334 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

335 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++){

336 if(
p
->
ï¿½ï¿½e
 !ï¿½
RUNNABLE
)

342 
c
->
ï¿½oc
 = 
p
;

343 
	`swï¿½chuvm
(
p
);

344 
p
->
ï¿½ï¿½e
 = 
RUNNING
;

346 
	`swtch
(&(
c
->
scheduï¿½r
), 
p
->
cÚ‹xt
);

347 
	`swï¿½chkvm
();

351 
c
->
ï¿½oc
 = 0;

353 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

356 
	}
}

366 
	$sched
()

368 
ï¿½ï¿½ï¿½
;

369 
ï¿½oc
 *
p
 = 
	`myï¿½oc
();

371 if(!
	`hï¿½dï¿½g
(&
ï¿½abï¿½
.
lock
))

372 
	`ï¿½nic
("schedï¿½table.lock");

373 if(
	`myï¿½u
()->
nï¿½i
 != 1)

374 
	`ï¿½nic
("schedï¿½ocks");

375 if(
p
->
ï¿½ï¿½e
 =ï¿½
RUNNING
)

376 
	`ï¿½nic
("schedï¿½unning");

377 if(
	`ï¿½adeï¿½ags
()&
FL_IF
)

378 
	`ï¿½nic
("sched interruptible");

379 
ï¿½ï¿½ï¿½
 = 
	`myï¿½u
()->intena;

380 
	`swtch
(&
p
->
cÚ‹xt
, 
	`myï¿½u
()->
scheduï¿½r
);

381 
	`myï¿½u
()->
ï¿½ï¿½ï¿½
 = intena;

382 
	}
}

386 
	$yï¿½ld
()

388 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

389 
	`myï¿½oc
()->
ï¿½ï¿½e
 = 
RUNNABLE
;

390 
	`sched
();

391 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

392 
	}
}

397 
	$fï¿½kï¿½t
()

399 
fï¿½ï¿½
 = 1;

401 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

403 iï¿½(
fï¿½ï¿½
) {

407 
fï¿½ï¿½
 = 0;

408 
	`iï¿½ï¿½
(
ROOTDEV
);

409 
	`ï¿½ï¿½log
(
ROOTDEV
);

413 
	}
}

418 
	$ï¿½ï¿½p
(*
chï¿½
, 
ï¿½ï¿½lock
 *
lk
)

420 
ï¿½oc
 *
p
 = 
	`myï¿½oc
();

422 if(
p
 == 0)

423 
	`ï¿½nic
("sleep");

425 if(
lk
 == 0)

426 
	`ï¿½nic
("sleep withoutï¿½k");

434 if(
lk
 !ï¿½&
ï¿½abï¿½
.
lock
){

435 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

436 
	`ï¿½ï¿½aï¿½
(
lk
);

439 
p
->
chï¿½
 = chan;

440 
p
->
ï¿½ï¿½e
 = 
SLEEPING
;

442 
	`sched
();

445 
p
->
chï¿½
 = 0;

448 if(
lk
 !ï¿½&
ï¿½abï¿½
.
lock
){

449 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

450 
	`acquï¿½e
(
lk
);

452 
	}
}

458 
	$wakeup1
(*
chï¿½
)

460 
ï¿½oc
 *
p
;

462 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++)

463 if(
p
->
ï¿½ï¿½e
 =ï¿½
SLEEPING
 &&ï¿½->
chï¿½
 == chan)

464 
p
->
ï¿½ï¿½e
 = 
RUNNABLE
;

465 
	}
}

469 
	$wakeup
(*
chï¿½
)

471 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

472 
	`wakeup1
(
chï¿½
);

473 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

474 
	}
}

480 
	$kï¿½l
(
pid
)

482 
ï¿½oc
 *
p
;

484 
	`acquï¿½e
(&
ï¿½abï¿½
.
lock
);

485 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++){

486 if(
p
->
pid
 ==ï¿½id){

487 
p
->
kï¿½ï¿½d
 = 1;

489 if(
p
->
ï¿½ï¿½e
 =ï¿½
SLEEPING
)

490 
p
->
ï¿½ï¿½e
 = 
RUNNABLE
;

491 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

495 
	`ï¿½ï¿½aï¿½
(&
ï¿½abï¿½
.
lock
);

497 
	}
}

504 
	$ï¿½ocdump
()

506 *
ï¿½ï¿½es
[] = {

507 [
UNUSED
] "unused",

508 [
EMBRYO
] "embryo",

509 [
SLEEPING
] "sleep ",

510 [
RUNNABLE
] "runble",

511 [
RUNNING
] "run ",

512 [
ZOMBIE
] "zombie"

514 
i
;

515 
ï¿½oc
 *
p
;

516 *
ï¿½ï¿½e
;

517 
uï¿½t
 
pc
[10];

519 
p
 = 
ï¿½abï¿½
.
ï¿½oc
;ï¿½ < &ï¿½abï¿½.ï¿½oc[
NPROC
];ï¿½++){

520 if(
p
->
ï¿½ï¿½e
 =ï¿½
UNUSED
)

522 if(
p
->
ï¿½ï¿½e
 >ï¿½0 &&ï¿½->ï¿½ï¿½ï¿½< 
	`NELEM
(
ï¿½ï¿½es
) && states[p->state])

523 
ï¿½ï¿½e
 = 
ï¿½ï¿½es
[
p
->state];

525 
ï¿½ï¿½e
 = "???";

526 
	`ï¿½rï¿½tf
("%d %ï¿½%s", 
p
->
pid
, 
ï¿½ï¿½e
,ï¿½->
ï¿½me
);

527 if(
p
->
ï¿½ï¿½e
 =ï¿½
SLEEPING
){

528 
	`gï¿½ï¿½Î”pcs
((
uï¿½t
*)
p
->
cÚ‹xt
->
ebp
+2, 
pc
);

529 
i
=0; i<10 && 
pc
[i] != 0; i++)

530 
	`ï¿½rï¿½tf
(" %p", 
pc
[
i
]);

532 
	`ï¿½rï¿½tf
("\n");

534 
	}
}

	@proc.h

2 
	sï¿½u
 {

3 
uchï¿½
 
	mï¿½icid
;

4 
cÚ‹xt
 *
	mscheduï¿½r
;

5 
ï¿½skï¿½ï¿½e
 
	mts
;

6 
ï¿½gdesc
 
	mgdt
[
NSEGS
];

7 vÞ©ï¿½ï¿½
uï¿½t
 
	mï¿½ï¿½ï¿½d
;

8 
	mnï¿½i
;

9 
	mï¿½ï¿½ï¿½
;

10 
ï¿½oc
 *
	mï¿½oc
;

13 

ï¿½u
 
ï¿½us
[
NCPU
];

14 

nï¿½u
;

27 
	scÚ‹xt
 {

28 
uï¿½t
 
	medi
;

29 
uï¿½t
 
	mesi
;

30 
uï¿½t
 
	mebx
;

31 
uï¿½t
 
	mebp
;

32 
uï¿½t
 
	meï¿½
;

35 
	eï¿½ocï¿½ï¿½e
 { 
	mUNUSED
, 
	mEMBRYO
, 
	mSLEEPING
, 
	mRUNNABLE
, 
	mRUNNING
, 
	mZOMBIE
 };

38 
	sï¿½oc
 {

39 
uï¿½t
 
	msz
;

40 
pde_t
* 
	mpgdï¿½
;

41 *
	mkï¿½ack
;

42 
ï¿½ocï¿½ï¿½e
 
	mï¿½ï¿½e
;

43 
	mpid
;

44 
ï¿½oc
 *
	mï¿½ï¿½ï¿½
;

45 
ï¿½ï¿½ï¿½ame
 *
	mtf
;

46 
cÚ‹xt
 *
	mcÚ‹xt
;

47 *
	mchï¿½
;

48 
	mkï¿½ï¿½d
;

49 
fï¿½e
 *
	mofï¿½e
[
NOFILE
];

50 
ï¿½ode
 *
	mcwd
;

51 
	mï¿½me
[16];

	@rm.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

6 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

8 
i
;

10 if(
ï¿½gc
 < 2){

11 
	`ï¿½ï¿½tf
(2, "Usage:ï¿½m files...\n");

12 
	`exï¿½
();

15 
i
 = 1; i < 
ï¿½gc
; i++){

16 if(
	`uÆšk
(
ï¿½gv
[
i
]) < 0){

17 
	`ï¿½ï¿½tf
(2, "rm: %ï¿½ï¿½edï¿½ï¿½dï¿½ï¿½e\n", 
ï¿½gv
[
i
]);

22 
	`exï¿½
();

23 
	}
}

	@sh.c

3 
	~"tyï¿½s.h
"

4 
	~"uï¿½r.h
"

5 
	~"fï¿½ï¿½.h
"

8 
	#EXEC
 1

	)

9 
	#REDIR
 2

	)

10 
	#PIPE
 3

	)

11 
	#LIST
 4

	)

12 
	#BACK
 5

	)

14 
	#MAXARGS
 10

	)

16 
	scmd
 {

17 
	mtyï¿½
;

20 
	sexeccmd
 {

21 
	mtyï¿½
;

22 *
	mï¿½gv
[
MAXARGS
];

23 *
	mï¿½rgv
[
MAXARGS
];

26 
	sï¿½dï¿½cmd
 {

27 
	mtyï¿½
;

28 
cmd
 *
	mcmd
;

29 *
	mfï¿½e
;

30 *
	mefï¿½e
;

31 
	mmode
;

32 
	mfd
;

35 
	spï¿½ecmd
 {

36 
	mtyï¿½
;

37 
cmd
 *
	mï¿½ï¿½
;

38 
cmd
 *
	mright
;

41 
	sliï¿½cmd
 {

42 
	mtyï¿½
;

43 
cmd
 *
	mï¿½ï¿½
;

44 
cmd
 *
	mright
;

47 
	sbackcmd
 {

48 
	mtyï¿½
;

49 
cmd
 *
	mcmd
;

52 
fï¿½k1
();

53 
ï¿½nic
(*);

54 
cmd
 *
ï¿½rï¿½cmd
(*);

58 
	$runcmd
(
cmd
 *cmd)

60 
p
[2];

61 
backcmd
 *
bcmd
;

62 
execcmd
 *
ecmd
;

63 
liï¿½cmd
 *
lcmd
;

64 
pï¿½ecmd
 *
pcmd
;

65 
ï¿½dï¿½cmd
 *
rcmd
;

67 if(
cmd
 == 0)

68 
	`exï¿½
();

70 
cmd
->
tyï¿½
){

72 
	`ï¿½nic
("runcmd");

74 
EXEC
:

75 
ecmd
 = (
execcmd
*)
cmd
;

76 if(
ecmd
->
ï¿½gv
[0] == 0)

77 
	`exï¿½
();

78 
	`exec
(
ecmd
->
ï¿½gv
[0],ï¿½cmd->argv);

79 
	`ï¿½ï¿½tf
(2, "exeï¿½%ï¿½ï¿½ed\n", 
ecmd
->
ï¿½gv
[0]);

82 
REDIR
:

83 
rcmd
 = (
ï¿½dï¿½cmd
*)
cmd
;

84 
	`ï¿½oï¿½
(
rcmd
->
fd
);

85 if(
	`Ý’
(
rcmd
->
fï¿½e
,ï¿½cmd->
mode
) < 0){

86 
	`ï¿½ï¿½tf
(2, "Ý’ %ï¿½ï¿½ed\n", 
rcmd
->
fï¿½e
);

87 
	`exï¿½
();

89 
	`runcmd
(
rcmd
->
cmd
);

92 
LIST
:

93 
lcmd
 = (
liï¿½cmd
*)
cmd
;

94 if(
	`fï¿½k1
() == 0)

95 
	`runcmd
(
lcmd
->
ï¿½ï¿½
);

96 
	`waï¿½
();

97 
	`runcmd
(
lcmd
->
right
);

100 
PIPE
:

101 
pcmd
 = (
pï¿½ecmd
*)
cmd
;

102 if(
	`pï¿½e
(
p
) < 0)

103 
	`ï¿½nic
("pipe");

104 if(
	`fï¿½k1
() == 0){

105 
	`ï¿½oï¿½
(1);

106 
	`dup
(
p
[1]);

107 
	`ï¿½oï¿½
(
p
[0]);

108 
	`ï¿½oï¿½
(
p
[1]);

109 
	`runcmd
(
pcmd
->
ï¿½ï¿½
);

111 if(
	`fï¿½k1
() == 0){

112 
	`ï¿½oï¿½
(0);

113 
	`dup
(
p
[0]);

114 
	`ï¿½oï¿½
(
p
[0]);

115 
	`ï¿½oï¿½
(
p
[1]);

116 
	`runcmd
(
pcmd
->
right
);

118 
	`ï¿½oï¿½
(
p
[0]);

119 
	`ï¿½oï¿½
(
p
[1]);

120 
	`waï¿½
();

121 
	`waï¿½
();

124 
BACK
:

125 
bcmd
 = (
backcmd
*)
cmd
;

126 if(
	`fï¿½k1
() == 0)

127 
	`runcmd
(
bcmd
->
cmd
);

130 
	`exï¿½
();

131 
	}
}

134 
	$gï¿½cmd
(*
buf
, 
nbuf
)

136 
	`ï¿½ï¿½tf
(2, "$ ");

137 
	`memï¿½t
(
buf
, 0, 
nbuf
);

138 
	`gï¿½s
(
buf
, 
nbuf
);

139 if(
buf
[0] == 0)

142 
	}
}

145 
	$maï¿½
()

147 
buf
[100];

148 
fd
;

151 (
fd
 = 
	`Ý’
("cï¿½sï¿½e", 
O_RDWR
)) >= 0){

152 if(
fd
 >= 3){

153 
	`ï¿½oï¿½
(
fd
);

159 
	`gï¿½cmd
(
buf
, (buf)) >= 0){

160 if(
buf
[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){

162 
buf
[
	`ï¿½ï¿½ï¿½
(buf)-1] = 0;

163 if(
	`chdï¿½
(
buf
+3) < 0)

164 
	`ï¿½ï¿½tf
(2, "ï¿½ï¿½ï¿½ cd %s\n", 
buf
+3);

167 if(
	`fï¿½k1
() == 0)

168 
	`runcmd
(
	`ï¿½rï¿½cmd
(
buf
));

169 
	`waï¿½
();

171 
	`exï¿½
();

172 
	}
}

175 
	$ï¿½nic
(*
s
)

177 
	`ï¿½ï¿½tf
(2, "%s\n", 
s
);

178 
	`exï¿½
();

179 
	}
}

182 
	$fï¿½k1
()

184 
pid
;

186 
pid
 = 
	`fï¿½k
();

187 if(
pid
 == -1)

188 
	`ï¿½nic
("fork");

189  
pid
;

190 
	}
}

195 
cmd
*

196 
	$execcmd
()

198 
execcmd
 *
cmd
;

200 
cmd
 = 
	`mï¿½loc
((*cmd));

201 
	`memï¿½t
(
cmd
, 0, (*cmd));

202 
cmd
->
tyï¿½
 = 
EXEC
;

203  (
cmd
*)cmd;

204 
	}
}

206 
cmd
*

207 
	$ï¿½dï¿½cmd
(
cmd
 *
subcmd
, *
fï¿½e
, *
efï¿½e
, 
mode
, 
fd
)

209 
ï¿½dï¿½cmd
 *
cmd
;

211 
cmd
 = 
	`mï¿½loc
((*cmd));

212 
	`memï¿½t
(
cmd
, 0, (*cmd));

213 
cmd
->
tyï¿½
 = 
REDIR
;

214 
cmd
->cmd = 
subcmd
;

215 
cmd
->
fï¿½e
 = file;

216 
cmd
->
efï¿½e
 =ï¿½file;

217 
cmd
->
mode
 = mode;

218 
cmd
->
fd
 = fd;

219  (
cmd
*)cmd;

220 
	}
}

222 
cmd
*

223 
	$pï¿½ecmd
(
cmd
 *
ï¿½ï¿½
, cmd *
right
)

225 
pï¿½ecmd
 *
cmd
;

227 
cmd
 = 
	`mï¿½loc
((*cmd));

228 
	`memï¿½t
(
cmd
, 0, (*cmd));

229 
cmd
->
tyï¿½
 = 
PIPE
;

230 
cmd
->
ï¿½ï¿½
 =ï¿½eft;

231 
cmd
->
right
 =ï¿½ight;

232  (
cmd
*)cmd;

233 
	}
}

235 
cmd
*

236 
	$liï¿½cmd
(
cmd
 *
ï¿½ï¿½
, cmd *
right
)

238 
liï¿½cmd
 *
cmd
;

240 
cmd
 = 
	`mï¿½loc
((*cmd));

241 
	`memï¿½t
(
cmd
, 0, (*cmd));

242 
cmd
->
tyï¿½
 = 
LIST
;

243 
cmd
->
ï¿½ï¿½
 =ï¿½eft;

244 
cmd
->
right
 =ï¿½ight;

245  (
cmd
*)cmd;

246 
	}
}

248 
cmd
*

249 
	$backcmd
(
cmd
 *
subcmd
)

251 
backcmd
 *
cmd
;

253 
cmd
 = 
	`mï¿½loc
((*cmd));

254 
	`memï¿½t
(
cmd
, 0, (*cmd));

255 
cmd
->
tyï¿½
 = 
BACK
;

256 
cmd
->cmd = 
subcmd
;

257  (
cmd
*)cmd;

258 
	}
}

262 
	gwhï¿½eï¿½aï¿½
[] = " \t\r\n\v";

263 
	gsymbï¿½s
[] = "<|>&;()";

266 
	$gï¿½tokï¿½
(**
ps
, *
es
, **
q
, **
eq
)

268 *
s
;

269 
ï¿½t
;

271 
s
 = *
ps
;

272 
s
 < 
es
 && 
	`ï¿½rchr
(
whï¿½eï¿½aï¿½
, *s))

273 
s
++;

274 if(
q
)

275 *
q
 = 
s
;

276 
ï¿½t
 = *
s
;

277 *
s
){

286 
s
++;

289 
s
++;

290 if(*
s
 == '>'){

291 
ï¿½t
 = '+';

292 
s
++;

296 
ï¿½t
 = 'a';

297 
s
 < 
es
 && !
	`ï¿½rchr
(
whï¿½eï¿½aï¿½
, *sï¿½&& !ï¿½rchr(
symbï¿½s
, *s))

298 
s
++;

301 if(
eq
)

302 *
eq
 = 
s
;

304 
s
 < 
es
 && 
	`ï¿½rchr
(
whï¿½eï¿½aï¿½
, *s))

305 
s
++;

306 *
ps
 = 
s
;

307  
ï¿½t
;

308 
	}
}

311 
	$ï¿½ek
(**
ps
, *
es
, *
toks
)

313 *
s
;

315 
s
 = *
ps
;

316 
s
 < 
es
 && 
	`ï¿½rchr
(
whï¿½eï¿½aï¿½
, *s))

317 
s
++;

318 *
ps
 = 
s
;

319  *
s
 && 
	`ï¿½rchr
(
toks
, *s);

320 
	}
}

322 
cmd
 *
ï¿½rï¿½lï¿½e
(**, *);

323 
cmd
 *
ï¿½rï¿½pï¿½e
(**, *);

324 
cmd
 *
ï¿½rï¿½exec
(**, *);

325 
cmd
 *
nuÉ”mï¿½ï¿½e
(cmd*);

327 
cmd
*

328 
	$ï¿½rï¿½cmd
(*
s
)

330 *
es
;

331 
cmd
 *cmd;

333 
es
 = 
s
 + 
	`ï¿½ï¿½ï¿½
(s);

334 
cmd
 = 
	`ï¿½rï¿½lï¿½e
(&
s
, 
es
);

335 
	`ï¿½ek
(&
s
, 
es
, "");

336 if(
s
 !ï¿½
es
){

337 
	`ï¿½ï¿½tf
(2, "ï¿½ï¿½ovï¿½s: %s\n", 
s
);

338 
	`ï¿½nic
("syntax");

340 
	`nuÉ”mï¿½ï¿½e
(
cmd
);

341  
cmd
;

342 
	}
}

344 
cmd
*

345 
	$ï¿½rï¿½lï¿½e
(**
ps
, *
es
)

347 
cmd
 *cmd;

349 
cmd
 = 
	`ï¿½rï¿½pï¿½e
(
ps
, 
es
);

350 
	`ï¿½ek
(
ps
, 
es
, "&")){

351 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

352 
cmd
 = 
	`backcmd
(cmd);

354 if(
	`ï¿½ek
(
ps
, 
es
, ";")){

355 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

356 
cmd
 = 
	`liï¿½cmd
(cmd, 
	`ï¿½rï¿½lï¿½e
(
ps
, 
es
));

358  
cmd
;

359 
	}
}

361 
cmd
*

362 
	$ï¿½rï¿½pï¿½e
(**
ps
, *
es
)

364 
cmd
 *cmd;

366 
cmd
 = 
	`ï¿½rï¿½exec
(
ps
, 
es
);

367 if(
	`ï¿½ek
(
ps
, 
es
, "|")){

368 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

369 
cmd
 = 
	`pï¿½ecmd
(cmd, 
	`ï¿½rï¿½pï¿½e
(
ps
, 
es
));

371  
cmd
;

372 
	}
}

374 
cmd
*

375 
	$ï¿½rï¿½ï¿½dï¿½s
(
cmd
 *cmd, **
ps
, *
es
)

377 
tok
;

378 *
q
, *
eq
;

380 
	`ï¿½ek
(
ps
, 
es
, "<>")){

381 
tok
 = 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

382 if(
	`gï¿½tokï¿½
(
ps
, 
es
, &
q
, &
eq
) != 'a')

383 
	`ï¿½nic
("missing file forï¿½edirection");

384 
tok
){

386 
cmd
 = 
	`ï¿½dï¿½cmd
(cmd, 
q
, 
eq
, 
O_RDONLY
, 0);

389 
cmd
 = 
	`ï¿½dï¿½cmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
, 1);

392 
cmd
 = 
	`ï¿½dï¿½cmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
, 1);

396  
cmd
;

397 
	}
}

399 
cmd
*

400 
	$ï¿½rï¿½block
(**
ps
, *
es
)

402 
cmd
 *cmd;

404 if(!
	`ï¿½ek
(
ps
, 
es
, "("))

405 
	`ï¿½nic
("parseblock");

406 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

407 
cmd
 = 
	`ï¿½rï¿½lï¿½e
(
ps
, 
es
);

408 if(!
	`ï¿½ek
(
ps
, 
es
, ")"))

409 
	`ï¿½nic
("syntax - missing )");

410 
	`gï¿½tokï¿½
(
ps
, 
es
, 0, 0);

411 
cmd
 = 
	`ï¿½rï¿½ï¿½dï¿½s
(cmd, 
ps
, 
es
);

412  
cmd
;

413 
	}
}

415 
cmd
*

416 
	$ï¿½rï¿½exec
(**
ps
, *
es
)

418 *
q
, *
eq
;

419 
tok
, 
ï¿½gc
;

420 
execcmd
 *
cmd
;

421 
cmd
 *
ï¿½t
;

423 if(
	`ï¿½ek
(
ps
, 
es
, "("))

424  
	`ï¿½rï¿½block
(
ps
, 
es
);

426 
ï¿½t
 = 
	`execcmd
();

427 
cmd
 = (
execcmd
*)
ï¿½t
;

429 
ï¿½gc
 = 0;

430 
ï¿½t
 = 
	`ï¿½rï¿½ï¿½dï¿½s
Ô‘, 
ps
, 
es
);

431 !
	`ï¿½ek
(
ps
, 
es
, "|)&;")){

432 if((
tok
=
	`gï¿½tokï¿½
(
ps
, 
es
, &
q
, &
eq
)) == 0)

434 if(
tok
 != 'a')

435 
	`ï¿½nic
("syntax");

436 
cmd
->
ï¿½gv
[
ï¿½gc
] = 
q
;

437 
cmd
->
ï¿½rgv
[
ï¿½gc
] = 
eq
;

438 
ï¿½gc
++;

439 if(
ï¿½gc
 >ï¿½
MAXARGS
)

440 
	`ï¿½nic
("too manyï¿½rgs");

441 
ï¿½t
 = 
	`ï¿½rï¿½ï¿½dï¿½s
Ô‘, 
ps
, 
es
);

443 
cmd
->
ï¿½gv
[
ï¿½gc
] = 0;

444 
cmd
->
ï¿½rgv
[
ï¿½gc
] = 0;

445  
ï¿½t
;

446 
	}
}

449 
cmd
*

450 
	$nuÉ”mï¿½ï¿½e
(
cmd
 *cmd)

452 
i
;

453 
backcmd
 *
bcmd
;

454 
execcmd
 *
ecmd
;

455 
liï¿½cmd
 *
lcmd
;

456 
pï¿½ecmd
 *
pcmd
;

457 
ï¿½dï¿½cmd
 *
rcmd
;

459 if(
cmd
 == 0)

462 
cmd
->
tyï¿½
){

463 
EXEC
:

464 
ecmd
 = (
execcmd
*)
cmd
;

465 
i
=0; 
ecmd
->
ï¿½gv
[i]; i++)

466 *
ecmd
->
ï¿½rgv
[
i
] = 0;

469 
REDIR
:

470 
rcmd
 = (
ï¿½dï¿½cmd
*)
cmd
;

471 
	`nuÉ”mï¿½ï¿½e
(
rcmd
->
cmd
);

472 *
rcmd
->
efï¿½e
 = 0;

475 
PIPE
:

476 
pcmd
 = (
pï¿½ecmd
*)
cmd
;

477 
	`nuÉ”mï¿½ï¿½e
(
pcmd
->
ï¿½ï¿½
);

478 
	`nuÉ”mï¿½ï¿½e
(
pcmd
->
right
);

481 
LIST
:

482 
lcmd
 = (
liï¿½cmd
*)
cmd
;

483 
	`nuÉ”mï¿½ï¿½e
(
lcmd
->
ï¿½ï¿½
);

484 
	`nuÉ”mï¿½ï¿½e
(
lcmd
->
right
);

487 
BACK
:

488 
bcmd
 = (
backcmd
*)
cmd
;

489 
	`nuÉ”mï¿½ï¿½e
(
bcmd
->
cmd
);

492  
cmd
;

493 
	}
}

	@sleeplock.c

3 
	~"tyï¿½s.h
"

4 
	~"defs.h
"

5 
	~"ï¿½ï¿½m.h
"

6 
	~"x86.h
"

7 
	~"memï¿½yout.h
"

8 
	~"mmu.h
"

9 
	~"ï¿½oc.h
"

10 
	~"ï¿½ï¿½lock.h
"

11 
	~"ï¿½ï¿½ï¿½ock.h
"

14 
	$ï¿½ï¿½ï¿½ï¿½ï¿½ock
(
ï¿½ï¿½ï¿½ock
 *
lk
, *
ï¿½me
)

16 
	`ï¿½ï¿½lock
(&
lk
->lk, "sleepï¿½ock");

17 
lk
->
ï¿½me
 =ï¿½ame;

18 
lk
->
locked
 = 0;

19 
lk
->
pid
 = 0;

20 
	}
}

23 
	$acquï¿½eï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
 *
lk
)

25 
	`acquï¿½e
(&
lk
->lk);

26 
lk
->
locked
) {

27 
	`ï¿½ï¿½p
(
lk
, &lk->lk);

29 
lk
->
locked
 = 1;

30 
lk
->
pid
 = 
	`myï¿½oc
()->pid;

31 
	`ï¿½ï¿½aï¿½
(&
lk
->lk);

32 
	}
}

35 
	$ï¿½ï¿½aï¿½ï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
 *
lk
)

37 
	`acquï¿½e
(&
lk
->lk);

38 
lk
->
locked
 = 0;

39 
lk
->
pid
 = 0;

40 
	`wakeup
(
lk
);

41 
	`ï¿½ï¿½aï¿½
(&
lk
->lk);

42 
	}
}

45 
	$hï¿½dï¿½gï¿½ï¿½p
(
ï¿½ï¿½ï¿½ock
 *
lk
)

47 
r
;

49 
	`acquï¿½e
(&
lk
->lk);

50 
r
 = 
lk
->
locked
 && (lk->
pid
 =ï¿½
	`myï¿½oc
()->pid);

51 
	`ï¿½ï¿½aï¿½
(&
lk
->lk);

52  
r
;

53 
	}
}

	@sleeplock.h

2 
	sï¿½ï¿½ï¿½ock
 {

3 
uï¿½t
 
	mlocked
;

4 
ï¿½ï¿½lock
 
	mlk
;

7 *
	mï¿½me
;

8 
	mpid
;

	@spinlock.c

3 
	~"tyï¿½s.h
"

4 
	~"defs.h
"

5 
	~"ï¿½ï¿½m.h
"

6 
	~"x86.h
"

7 
	~"memï¿½yout.h
"

8 
	~"mmu.h
"

9 
	~"ï¿½oc.h
"

10 
	~"ï¿½ï¿½lock.h
"

13 
	$ï¿½ï¿½lock
(
ï¿½ï¿½lock
 *
lk
, *
ï¿½me
)

15 
lk
->
ï¿½me
 =ï¿½ame;

16 
lk
->
locked
 = 0;

17 
lk
->
ï¿½u
 = 0;

18 
	}
}

25 
	$acquï¿½e
(
ï¿½ï¿½lock
 *
lk
)

27 
	`pushï¿½i
();

28 if(
	`hï¿½dï¿½g
(
lk
))

29 
	`ï¿½nic
("acquire");

32 
	`xchg
(&
lk
->
locked
, 1) != 0)

38 
	`__sync_synchrï¿½ize
();

41 
lk
->
ï¿½u
 = 
	`myï¿½u
();

42 
	`gï¿½ï¿½Î”pcs
(&
lk
,ï¿½k->
pcs
);

43 
	}
}

47 
	$ï¿½ï¿½aï¿½
(
ï¿½ï¿½lock
 *
lk
)

49 if(!
	`hï¿½dï¿½g
(
lk
))

50 
	`ï¿½nic
("release");

52 
lk
->
pcs
[0] = 0;

53 
lk
->
ï¿½u
 = 0;

60 
	`__sync_synchrï¿½ize
();

65 
asm
 vÞ©ï¿½e("movï¿½$0, %0" : "+m" (
lk
->
locked
) : );

67 
	`pï¿½ï¿½i
();

68 
	}
}

72 
	$gï¿½ï¿½Î”pcs
(*
v
, 
uï¿½t
 
pcs
[])

74 
uï¿½t
 *
ebp
;

75 
i
;

77 
ebp
 = (
uï¿½t
*)
v
 - 2;

78 
i
 = 0; i < 10; i++){

79 if(
ebp
 =ï¿½0 ||ï¿½bï¿½< (
uï¿½t
*)
KERNBASE
 ||ï¿½bp == (uint*)0xffffffff)

81 
pcs
[
i
] = 
ebp
[1];

82 
ebp
 = (
uï¿½t
*)ebp[0];

84 ; 
i
 < 10; i++)

85 
pcs
[
i
] = 0;

86 
	}
}

90 
	$hï¿½dï¿½g
(
ï¿½ï¿½lock
 *
lock
)

92 
r
;

93 
	`pushï¿½i
();

94 
r
 = 
lock
->
locked
 &&ï¿½ock->
ï¿½u
 =ï¿½
	`myï¿½u
();

95 
	`pï¿½ï¿½i
();

96  
r
;

97 
	}
}

105 
	$pushï¿½i
()

107 
eï¿½ags
;

109 
eï¿½ags
 = 
	`ï¿½adeï¿½ags
();

110 
	`ï¿½i
();

111 if(
	`myï¿½u
()->
nï¿½i
 == 0)

112 
	`myï¿½u
()->
ï¿½ï¿½ï¿½
 = 
eï¿½ags
 & 
FL_IF
;

113 
	`myï¿½u
()->
nï¿½i
 += 1;

114 
	}
}

117 
	$pï¿½ï¿½i
()

119 if(
	`ï¿½adeï¿½ags
()&
FL_IF
)

120 
	`ï¿½nic
("popcli - interruptible");

121 if(--
	`myï¿½u
()->
nï¿½i
 < 0)

122 
	`ï¿½nic
("popcli");

123 if(
	`myï¿½u
()->
nï¿½i
 =ï¿½0 && myï¿½u()->
ï¿½ï¿½ï¿½
)

124 
	`ï¿½i
();

125 
	}
}

	@spinlock.h

2 
	sï¿½ï¿½lock
 {

3 
uï¿½t
 
	mlocked
;

6 *
	mï¿½me
;

7 
ï¿½u
 *
	mï¿½u
;

8 
uï¿½t
 
	mpcs
[10];

	@stat.h

1 
	#T_DIR
 1

2 
	#T_FILE
 2

3 
	#T_DEV
 3

4 

	)

5 
	sï¿½ï¿½
 {

6 
	mtyï¿½
;

7 
	mdev
;

8 
uï¿½t
 
	mï¿½o
;

9 
	mÆšk
;

10 
uï¿½t
 
	msize
;

	@stressfs.c

10 
	~"tyï¿½s.h
"

11 
	~"ï¿½ï¿½.h
"

12 
	~"uï¿½r.h
"

13 
	~"fs.h
"

14 
	~"fï¿½ï¿½.h
"

17 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

19 
fd
, 
i
;

20 
ï¿½th
[] = "stressfs0";

21 
dï¿½a
[512];

23 
	`ï¿½ï¿½tf
(1, "stressfs starting\n");

24 
	`memï¿½t
(
dï¿½a
, 'a', (data));

26 
i
 = 0; i < 4; i++)

27 if(
	`fï¿½k
() > 0)

30 
	`ï¿½ï¿½tf
(1, "wrï¿½ï¿½%d\n", 
i
);

32 
ï¿½th
[8] +ï¿½
i
;

33 
fd
 = 
	`Ý’
(
ï¿½th
, 
O_CREATE
 | 
O_RDWR
);

34 
i
 = 0; i < 20; i++)

36 
	`wrï¿½e
(
fd
, 
dï¿½a
, (data));

37 
	`ï¿½oï¿½
(
fd
);

39 
	`ï¿½ï¿½tf
(1, "read\n");

41 
fd
 = 
	`Ý’
(
ï¿½th
, 
O_RDONLY
);

42 
i
 = 0; i < 20; i++)

43 
	`ï¿½ad
(
fd
, 
dï¿½a
, (data));

44 
	`ï¿½oï¿½
(
fd
);

46 
	`waï¿½
();

48 
	`exï¿½
();

49 
	}
}

	@string.c

1 
	~"tyï¿½s.h
"

2 
	~"x86.h
"

5 
	$memï¿½t
(*
dï¿½
, 
c
, 
uï¿½t
 
n
)

7 iï¿½(()
dï¿½
%4 =ï¿½0 && 
n
%4 == 0){

8 
c
 &= 0xFF;

9 
	`ï¿½oï¿½
(
dï¿½
, (
c
<<24)|(c<<16)|(c<<8)|c, 
n
/4);

11 
	`ï¿½osb
(
dï¿½
, 
c
, 
n
);

12  
dï¿½
;

13 
	}
}

16 
	$memcmp
(cÚ¡ *
v1
, cÚ¡ *
v2
, 
uï¿½t
 
n
)

18 cÚ¡ 
uchï¿½
 *
s1
, *
s2
;

20 
s1
 = 
v1
;

21 
s2
 = 
v2
;

22 
n
-- > 0){

23 if(*
s1
 !ï¿½*
s2
)

24  *
s1
 - *
s2
;

25 
s1
++, 
s2
++;

29 
	}
}

32 
	$memmove
(*
dï¿½
, cÚ¡ *
ï¿½c
, 
uï¿½t
 
n
)

34 cÚ¡ *
s
;

35 *
d
;

37 
s
 = 
ï¿½c
;

38 
d
 = 
dï¿½
;

39 if(
s
 < 
d
 && s + 
n
 > d){

40 
s
 +ï¿½
n
;

41 
d
 +ï¿½
n
;

42 
n
-- > 0)

43 *--
d
 = *--
s
;

45 
n
-- > 0)

46 *
d
++ = *
s
++;

48  
dï¿½
;

49 
	}
}

53 
	$memï¿½y
(*
dï¿½
, cÚ¡ *
ï¿½c
, 
uï¿½t
 
n
)

55  
	`memmove
(
dï¿½
, 
ï¿½c
, 
n
);

56 
	}
}

59 
	$ï¿½ï¿½cmp
(cÚ¡ *
p
, cÚ¡ *
q
, 
uï¿½t
 
n
)

61 
n
 > 0 && *
p
 && *ï¿½=ï¿½*
q
)

62 
n
--, 
p
++, 
q
++;

63 if(
n
 == 0)

65  (
uchï¿½
)*
p
 - (uchï¿½)*
q
;

66 
	}
}

69 
	$ï¿½ï¿½ï¿½y
(*
s
, cÚ¡ *
t
, 
n
)

71 *
os
;

73 
os
 = 
s
;

74 
n
-- > 0 && (*
s
++ = *
t
++) != 0)

76 
n
-- > 0)

77 *
s
++ = 0;

78  
os
;

79 
	}
}

83 
	$ï¿½ï¿½rï¿½y
(*
s
, cÚ¡ *
t
, 
n
)

85 *
os
;

87 
os
 = 
s
;

88 if(
n
 <= 0)

89  
os
;

90 --
n
 > 0 && (*
s
++ = *
t
++) != 0)

92 *
s
 = 0;

93  
os
;

94 
	}
}

97 
	$ï¿½ï¿½ï¿½
(cÚ¡ *
s
)

99 
n
;

101 
n
 = 0; 
s
[n];ï¿½++)

103  
n
;

104 
	}
}

	@swtch.S

2 #
#void 
swtch
(
cÚ‹xt
 **
ï¿½d
, cÚ‹xï¿½*
ï¿½w
);

4 #
#Savï¿½
the
 
cuï¿½ï¿½t
 
ï¿½giï¿½ï¿½s
 
ï¿½
ï¿½hï¿½
ï¿½ack
, 
ï¿½ï¿½tï¿½g


6 #ï¿½
cÚ‹xt
, 
ï¿½d
 
ï¿½ve
 
ï¿½s
 
addï¿½ss
 
ï¿½
 *
ï¿½d
.

7 #Swï¿½ch 
ï¿½acks
 
to
 
ï¿½w
 
ï¿½d
 
pï¿½
 
ï¿½eviouï¿½y
-
ï¿½ved
 
ï¿½giï¿½ï¿½s
.

9 .
globl
 
swtch


10 
	gswtch
:

11 
movl
 4(%
eï¿½
), %
ï¿½x


12 
	gmovl
 8(%
	geï¿½
), %
	gedx


14 #Savï¿½
ï¿½d
 
ï¿½Î“
-
ï¿½ved
 
ï¿½giï¿½ï¿½s


15 
	gpushl
 %
ebp


16 
	gpushl
 %
ebx


17 
	gpushl
 %
esi


18 
	gpushl
 %
	gedi


20 #Swï¿½ch 
ï¿½acks


21 
	gmovl
 %
	geï¿½
, (%
	gï¿½x
)

22 
	gmovl
 %
	gedx
, %
	geï¿½


24 #Lï¿½d 
ï¿½w
 
ï¿½Î“
-
ï¿½ved
 
ï¿½giï¿½ï¿½s


25 
	gpï¿½l
 %
edi


26 
	gpï¿½l
 %
esi


27 
	gpï¿½l
 %
ebx


28 
	gpï¿½l
 %
ebp


29 
	gï¿½t


	@syscall.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"memï¿½yout.h
"

5 
	~"mmu.h
"

6 
	~"ï¿½oc.h
"

7 
	~"x86.h
"

8 
	~"sysï¿½ï¿½.h
"

18 
	$ï¿½tchï¿½t
(
uï¿½t
 
addr
, *
ï¿½
)

20 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

22 if(
addr
 >ï¿½
cuï¿½roc
->
sz
 ||ï¿½ddr+4 > curproc->sz)

24 *
ï¿½
 = *(*)(
addr
);

26 
	}
}

32 
	$ï¿½tchï¿½r
(
uï¿½t
 
addr
, **
ï¿½
)

34 *
s
, *
ï¿½
;

35 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

37 if(
addr
 >ï¿½
cuï¿½roc
->
sz
)

39 *
ï¿½
 = (*)
addr
;

40 
ï¿½
 = (*)
cuï¿½roc
->
sz
;

41 
s
 = *
ï¿½
; s < 
ï¿½
; s++){

42 if(*
s
 == 0)

43  
s
 - *
ï¿½
;

46 
	}
}

50 
	$ï¿½gï¿½t
(
n
, *
ï¿½
)

52  
	`ï¿½tchï¿½t
((
	`myï¿½oc
()->
tf
->
eï¿½
ï¿½+ 4 + 4*
n
, 
ï¿½
);

53 
	}
}

59 
	$ï¿½gï¿½r
(
n
, **
ï¿½
, 
size
)

61 
i
;

62 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

64 if(
	`ï¿½gï¿½t
(
n
, &
i
) < 0)

66 if(
size
 < 0 || (
uï¿½t
)
i
 >ï¿½
cuï¿½roc
->
sz
 || (uint)i+size > curproc->sz)

68 *
ï¿½
 = (*)
i
;

70 
	}
}

77 
	$ï¿½gï¿½r
(
n
, **
ï¿½
)

79 
addr
;

80 if(
	`ï¿½gï¿½t
(
n
, &
addr
) < 0)

82  
	`ï¿½tchï¿½r
(
addr
, 
ï¿½
);

83 
	}
}

85 

sys_chdï¿½
();

86 

sys_ï¿½oï¿½
();

87 

sys_dup
();

88 

sys_exec
();

89 

sys_exï¿½
();

90 

sys_fï¿½k
();

91 

sys_fï¿½ï¿½
();

92 

sys_gï¿½pid
();

93 

sys_kï¿½l
();

94 

sys_lï¿½k
();

95 

sys_mkdï¿½
();

96 

sys_mknod
();

97 

sys_Ý’
();

98 

sys_pï¿½e
();

99 

sys_ï¿½ad
();

100 

sys_sbrk
();

101 

sys_ï¿½ï¿½p
();

102 

sys_uÆšk
();

103 

sys_waï¿½
();

104 

sys_wrï¿½e
();

105 

sys_uï¿½ime
();

107 (*
sysï¿½ï¿½s
[])() = {

108 [
SYS_fï¿½k
] 
sys_fï¿½k
,

109 [
SYS_exï¿½
] 
sys_exï¿½
,

110 [
SYS_waï¿½
] 
sys_waï¿½
,

111 [
SYS_pï¿½e
] 
sys_pï¿½e
,

112 [
SYS_ï¿½ad
] 
sys_ï¿½ad
,

113 [
SYS_kï¿½l
] 
sys_kï¿½l
,

114 [
SYS_exec
] 
sys_exec
,

115 [
SYS_fï¿½ï¿½
] 
sys_fï¿½ï¿½
,

116 [
SYS_chdï¿½
] 
sys_chdï¿½
,

117 [
SYS_dup
] 
sys_dup
,

118 [
SYS_gï¿½pid
] 
sys_gï¿½pid
,

119 [
SYS_sbrk
] 
sys_sbrk
,

120 [
SYS_ï¿½ï¿½p
] 
sys_ï¿½ï¿½p
,

121 [
SYS_uï¿½ime
] 
sys_uï¿½ime
,

122 [
SYS_Ý’
] 
sys_Ý’
,

123 [
SYS_wrï¿½e
] 
sys_wrï¿½e
,

124 [
SYS_mknod
] 
sys_mknod
,

125 [
SYS_uÆšk
] 
sys_uÆšk
,

126 [
SYS_lï¿½k
] 
sys_lï¿½k
,

127 [
SYS_mkdï¿½
] 
sys_mkdï¿½
,

128 [
SYS_ï¿½oï¿½
] 
sys_ï¿½oï¿½
,

129 
	}
};

132 
	$sysï¿½ï¿½
()

134 
num
;

135 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

137 
num
 = 
cuï¿½roc
->
tf
->
ï¿½x
;

138 if(
num
 > 0 &&ï¿½um < 
	`NELEM
(
sysï¿½ï¿½s
) && syscalls[num]) {

139 
cuï¿½roc
->
tf
->
ï¿½x
 = 
sysï¿½ï¿½s
[
num
]();

141 
	`ï¿½rï¿½tf
("%d %s: unknown sys call %d\n",

142 
cuï¿½roc
->
pid
, cuï¿½roc->
ï¿½me
, 
num
);

143 
cuï¿½roc
->
tf
->
ï¿½x
 = -1;

145 
	}
}

	@syscall.h

2 
	#SYS_fï¿½k
 1

	)

3 
	#SYS_exï¿½
 2

	)

4 
	#SYS_waï¿½
 3

	)

5 
	#SYS_pï¿½e
 4

	)

6 
	#SYS_ï¿½ad
 5

	)

7 
	#SYS_kï¿½l
 6

	)

8 
	#SYS_exec
 7

	)

9 
	#SYS_fï¿½ï¿½
 8

	)

10 
	#SYS_chdï¿½
 9

	)

11 
	#SYS_dup
 10

	)

12 
	#SYS_gï¿½pid
 11

	)

13 
	#SYS_sbrk
 12

	)

14 
	#SYS_ï¿½ï¿½p
 13

	)

15 
	#SYS_uï¿½ime
 14

	)

16 
	#SYS_Ý’
 15

	)

17 
	#SYS_wrï¿½e
 16

	)

18 
	#SYS_mknod
 17

	)

19 
	#SYS_uÆšk
 18

	)

20 
	#SYS_lï¿½k
 19

	)

21 
	#SYS_mkdï¿½
 20

	)

22 
	#SYS_ï¿½oï¿½
 21

	)

	@sysfile.c

7 
	~"tyï¿½s.h
"

8 
	~"defs.h
"

9 
	~"ï¿½ï¿½m.h
"

10 
	~"ï¿½ï¿½.h
"

11 
	~"mmu.h
"

12 
	~"ï¿½oc.h
"

13 
	~"fs.h
"

14 
	~"ï¿½ï¿½lock.h
"

15 
	~"ï¿½ï¿½ï¿½ock.h
"

16 
	~"fï¿½e.h
"

17 
	~"fï¿½ï¿½.h
"

22 
	$ï¿½gfd
(
n
, *
pfd
, 
fï¿½e
 **
pf
)

24 
fd
;

25 
fï¿½e
 *
f
;

27 if(
	`ï¿½gï¿½t
(
n
, &
fd
) < 0)

29 if(
fd
 < 0 || fd >ï¿½
NOFILE
 || (
f
=
	`myï¿½oc
()->
ofï¿½e
[fd]) == 0)

31 if(
pfd
)

32 *
pfd
 = 
fd
;

33 if(
pf
)

34 *
pf
 = 
f
;

36 
	}
}

41 
	$fdï¿½loc
(
fï¿½e
 *
f
)

43 
fd
;

44 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

46 
fd
 = 0; fd < 
NOFILE
; fd++){

47 if(
cuï¿½roc
->
ofï¿½e
[
fd
] == 0){

48 
cuï¿½roc
->
ofï¿½e
[
fd
] = 
f
;

49  
fd
;

53 
	}
}

56 
	$sys_dup
()

58 
fï¿½e
 *
f
;

59 
fd
;

61 if(
	`ï¿½gfd
(0, 0, &
f
) < 0)

63 if((
fd
=
	`fdï¿½loc
(
f
)) < 0)

65 
	`fï¿½edup
(
f
);

66  
fd
;

67 
	}
}

70 
	$sys_ï¿½ad
()

72 
fï¿½e
 *
f
;

73 
n
;

74 *
p
;

76 if(
	`ï¿½gfd
(0, 0, &
f
ï¿½< 0 || 
	`ï¿½gï¿½t
(2, &
n
ï¿½< 0 || 
	`ï¿½gï¿½r
(1, &
p
,ï¿½) < 0)

78  
	`fï¿½ï¿½ï¿½d
(
f
, 
p
, 
n
);

79 
	}
}

82 
	$sys_wrï¿½e
()

84 
fï¿½e
 *
f
;

85 
n
;

86 *
p
;

88 if(
	`ï¿½gfd
(0, 0, &
f
ï¿½< 0 || 
	`ï¿½gï¿½t
(2, &
n
ï¿½< 0 || 
	`ï¿½gï¿½r
(1, &
p
,ï¿½) < 0)

90  
	`fï¿½ewrï¿½e
(
f
, 
p
, 
n
);

91 
	}
}

94 
	$sys_ï¿½oï¿½
()

96 
fd
;

97 
fï¿½e
 *
f
;

99 if(
	`ï¿½gfd
(0, &
fd
, &
f
) < 0)

101 
	`myï¿½oc
()->
ofï¿½e
[
fd
] = 0;

102 
	`fï¿½eï¿½oï¿½
(
f
);

104 
	}
}

107 
	$sys_fï¿½ï¿½
()

109 
fï¿½e
 *
f
;

110 
ï¿½ï¿½
 *
ï¿½
;

112 if(
	`ï¿½gfd
(0, 0, &
f
ï¿½< 0 || 
	`ï¿½gï¿½r
(1, (*)&
ï¿½
, (*st)) < 0)

114  
	`fï¿½eï¿½ï¿½
(
f
, 
ï¿½
);

115 
	}
}

119 
	$sys_lï¿½k
()

121 
ï¿½me
[
DIRSIZ
], *
ï¿½w
, *
ï¿½d
;

122 
ï¿½ode
 *
dp
, *
ï¿½
;

124 if(
	`ï¿½gï¿½r
(0, &
ï¿½d
ï¿½< 0 ||ï¿½rgï¿½r(1, &
ï¿½w
) < 0)

127 
	`begï¿½_ï¿½
();

128 if((
ï¿½
 = 
	`ï¿½mei
(
ï¿½d
)) == 0){

129 
	`ï¿½d_ï¿½
();

133 
	`ï¿½ock
(
ï¿½
);

134 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DIR
){

135 
	`iuï¿½ockput
(
ï¿½
);

136 
	`ï¿½d_ï¿½
();

140 
ï¿½
->
Æšk
++;

141 
	`iupdï¿½e
(
ï¿½
);

142 
	`iuï¿½ock
(
ï¿½
);

144 if((
dp
 = 
	`ï¿½meï¿½ï¿½ï¿½t
(
ï¿½w
, 
ï¿½me
)) == 0)

145 
bad
;

146 
	`ï¿½ock
(
dp
);

147 if(
dp
->
dev
 !ï¿½
ï¿½
->dev || 
	`dï¿½lï¿½k
(dp, 
ï¿½me
, ip->
ï¿½um
) < 0){

148 
	`iuï¿½ockput
(
dp
);

149 
bad
;

151 
	`iuï¿½ockput
(
dp
);

152 
	`ï¿½ut
(
ï¿½
);

154 
	`ï¿½d_ï¿½
();

158 
bad
:

159 
	`ï¿½ock
(
ï¿½
);

160 
ï¿½
->
Æšk
--;

161 
	`iupdï¿½e
(
ï¿½
);

162 
	`iuï¿½ockput
(
ï¿½
);

163 
	`ï¿½d_ï¿½
();

165 
	}
}

169 
	$isdï¿½emï¿½y
(
ï¿½ode
 *
dp
)

171 
off
;

172 
dï¿½ï¿½t
 
de
;

174 
off
=2*(
de
); off<
dp
->
size
; off+=(de)){

175 if(
	`ï¿½adi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

176 
	`ï¿½nic
("isdirempty:ï¿½eadi");

177 if(
de
.
ï¿½um
 != 0)

181 
	}
}

185 
	$sys_uÆšk
()

187 
ï¿½ode
 *
ï¿½
, *
dp
;

188 
dï¿½ï¿½t
 
de
;

189 
ï¿½me
[
DIRSIZ
], *
ï¿½th
;

190 
uï¿½t
 
off
;

192 if(
	`ï¿½gï¿½r
(0, &
ï¿½th
) < 0)

195 
	`begï¿½_ï¿½
();

196 if((
dp
 = 
	`ï¿½meï¿½ï¿½ï¿½t
(
ï¿½th
, 
ï¿½me
)) == 0){

197 
	`ï¿½d_ï¿½
();

201 
	`ï¿½ock
(
dp
);

204 if(
	`ï¿½mecmp
(
ï¿½me
, ".") == 0 ||ï¿½amecmp(name, "..") == 0)

205 
bad
;

207 if((
ï¿½
 = 
	`dï¿½lookup
(
dp
, 
ï¿½me
, &
off
)) == 0)

208 
bad
;

209 
	`ï¿½ock
(
ï¿½
);

211 if(
ï¿½
->
Æšk
 < 1)

212 
	`ï¿½nic
("unlink:ï¿½link < 1");

213 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DIR
 && !
	`isdï¿½emï¿½y
(ip)){

214 
	`iuï¿½ockput
(
ï¿½
);

215 
bad
;

218 
	`memï¿½t
(&
de
, 0, (de));

219 if(
	`wrï¿½ei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

220 
	`ï¿½nic
("unlink: writei");

221 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DIR
){

222 
dp
->
Æšk
--;

223 
	`iupdï¿½e
(
dp
);

225 
	`iuï¿½ockput
(
dp
);

227 
ï¿½
->
Æšk
--;

228 
	`iupdï¿½e
(
ï¿½
);

229 
	`iuï¿½ockput
(
ï¿½
);

231 
	`ï¿½d_ï¿½
();

235 
bad
:

236 
	`iuï¿½ockput
(
dp
);

237 
	`ï¿½d_ï¿½
();

239 
	}
}

241 
ï¿½ode
*

242 
	$ï¿½ï¿½ï¿½
(*
ï¿½th
, 
tyï¿½
, 
majï¿½
, 
mï¿½ï¿½
)

244 
ï¿½ode
 *
ï¿½
, *
dp
;

245 
ï¿½me
[
DIRSIZ
];

247 if((
dp
 = 
	`ï¿½meï¿½ï¿½ï¿½t
(
ï¿½th
, 
ï¿½me
)) == 0)

249 
	`ï¿½ock
(
dp
);

251 if((
ï¿½
 = 
	`dï¿½lookup
(
dp
, 
ï¿½me
, 0)) != 0){

252 
	`iuï¿½ockput
(
dp
);

253 
	`ï¿½ock
(
ï¿½
);

254 if(
tyï¿½
 =ï¿½
T_FILE
 && 
ï¿½
->type == T_FILE)

255  
ï¿½
;

256 
	`iuï¿½ockput
(
ï¿½
);

260 if((
ï¿½
 = 
	`ï¿½ï¿½oc
(
dp
->
dev
, 
tyï¿½
)) == 0)

261 
	`ï¿½nic
("create: ialloc");

263 
	`ï¿½ock
(
ï¿½
);

264 
ï¿½
->
majï¿½
 = major;

265 
ï¿½
->
mï¿½ï¿½
 = minor;

266 
ï¿½
->
Æšk
 = 1;

267 
	`iupdï¿½e
(
ï¿½
);

269 if(
tyï¿½
 =ï¿½
T_DIR
){

270 
dp
->
Æšk
++;

271 
	`iupdï¿½e
(
dp
);

273 if(
	`dï¿½lï¿½k
(
ï¿½
, ".", ip->
ï¿½um
ï¿½< 0 || dï¿½lï¿½k(ï¿½, "..", 
dp
->inum) < 0)

274 
	`ï¿½nic
("create dots");

277 if(
	`dï¿½lï¿½k
(
dp
, 
ï¿½me
, 
ï¿½
->
ï¿½um
) < 0)

278 
	`ï¿½nic
("create: dirlink");

280 
	`iuï¿½ockput
(
dp
);

282  
ï¿½
;

283 
	}
}

286 
	$sys_Ý’
()

288 *
ï¿½th
;

289 
fd
, 
omode
;

290 
fï¿½e
 *
f
;

291 
ï¿½ode
 *
ï¿½
;

293 if(
	`ï¿½gï¿½r
(0, &
ï¿½th
ï¿½< 0 || 
	`ï¿½gï¿½t
(1, &
omode
) < 0)

296 
	`begï¿½_ï¿½
();

298 if(
omode
 & 
O_CREATE
){

299 
ï¿½
 = 
	`ï¿½ï¿½ï¿½
(
ï¿½th
, 
T_FILE
, 0, 0);

300 if(
ï¿½
 == 0){

301 
	`ï¿½d_ï¿½
();

305 if((
ï¿½
 = 
	`ï¿½mei
(
ï¿½th
)) == 0){

306 
	`ï¿½d_ï¿½
();

309 
	`ï¿½ock
(
ï¿½
);

310 if(
ï¿½
->
tyï¿½
 =ï¿½
T_DIR
 && 
omode
 !ï¿½
O_RDONLY
){

311 
	`iuï¿½ockput
(
ï¿½
);

312 
	`ï¿½d_ï¿½
();

317 if((
f
 = 
	`fï¿½ï¿½ï¿½oc
()ï¿½=ï¿½0 || (
fd
 = 
	`fdï¿½loc
(f)) < 0){

318 if(
f
)

319 
	`fï¿½eï¿½oï¿½
(
f
);

320 
	`iuï¿½ockput
(
ï¿½
);

321 
	`ï¿½d_ï¿½
();

324 
	`iuï¿½ock
(
ï¿½
);

325 
	`ï¿½d_ï¿½
();

327 
f
->
tyï¿½
 = 
FD_INODE
;

328 
f
->
ï¿½
 = ip;

329 
f
->
off
 = 0;

330 
f
->
ï¿½adabï¿½
 = !(
omode
 & 
O_WRONLY
);

331 
f
->
wrï¿½abï¿½
 = (
omode
 & 
O_WRONLY
ï¿½|| (omodï¿½& 
O_RDWR
);

332  
fd
;

333 
	}
}

336 
	$sys_mkdï¿½
()

338 *
ï¿½th
;

339 
ï¿½ode
 *
ï¿½
;

341 
	`begï¿½_ï¿½
();

342 if(
	`ï¿½gï¿½r
(0, &
ï¿½th
ï¿½< 0 || (
ï¿½
 = 
	`ï¿½ï¿½ï¿½
Õ©h, 
T_DIR
, 0, 0)) == 0){

343 
	`ï¿½d_ï¿½
();

346 
	`iuï¿½ockput
(
ï¿½
);

347 
	`ï¿½d_ï¿½
();

349 
	}
}

352 
	$sys_mknod
()

354 
ï¿½ode
 *
ï¿½
;

355 *
ï¿½th
;

356 
majï¿½
, 
mï¿½ï¿½
;

358 
	`begï¿½_ï¿½
();

359 if((
	`ï¿½gï¿½r
(0, &
ï¿½th
)) < 0 ||

360 
	`ï¿½gï¿½t
(1, &
majï¿½
) < 0 ||

361 
	`ï¿½gï¿½t
(2, &
mï¿½ï¿½
) < 0 ||

362 (
ï¿½
 = 
	`ï¿½ï¿½ï¿½
(
ï¿½th
, 
T_DEV
, 
majï¿½
, 
mï¿½ï¿½
)) == 0){

363 
	`ï¿½d_ï¿½
();

366 
	`iuï¿½ockput
(
ï¿½
);

367 
	`ï¿½d_ï¿½
();

369 
	}
}

372 
	$sys_chdï¿½
()

374 *
ï¿½th
;

375 
ï¿½ode
 *
ï¿½
;

376 
ï¿½oc
 *
cuï¿½roc
 = 
	`myï¿½oc
();

378 
	`begï¿½_ï¿½
();

379 if(
	`ï¿½gï¿½r
(0, &
ï¿½th
ï¿½< 0 || (
ï¿½
 = 
	`ï¿½mei
(path)) == 0){

380 
	`ï¿½d_ï¿½
();

383 
	`ï¿½ock
(
ï¿½
);

384 if(
ï¿½
->
tyï¿½
 !ï¿½
T_DIR
){

385 
	`iuï¿½ockput
(
ï¿½
);

386 
	`ï¿½d_ï¿½
();

389 
	`iuï¿½ock
(
ï¿½
);

390 
	`ï¿½ut
(
cuï¿½roc
->
cwd
);

391 
	`ï¿½d_ï¿½
();

392 
cuï¿½roc
->
cwd
 = 
ï¿½
;

394 
	}
}

397 
	$sys_exec
()

399 *
ï¿½th
, *
ï¿½gv
[
MAXARG
];

400 
i
;

401 
uï¿½t
 
uï¿½gv
, 
uï¿½g
;

403 if(
	`ï¿½gï¿½r
(0, &
ï¿½th
ï¿½< 0 || 
	`ï¿½gï¿½t
(1, (*)&
uï¿½gv
) < 0){

406 
	`memï¿½t
(
ï¿½gv
, 0, (argv));

407 
i
=0;; i++){

408 if(
i
 >ï¿½
	`NELEM
(
ï¿½gv
))

410 if(
	`ï¿½tchï¿½t
(
uï¿½gv
+4*
i
, (*)&
uï¿½g
) < 0)

412 if(
uï¿½g
 == 0){

413 
ï¿½gv
[
i
] = 0;

416 if(
	`ï¿½tchï¿½r
(
uï¿½g
, &
ï¿½gv
[
i
]) < 0)

419  
	`exec
(
ï¿½th
, 
ï¿½gv
);

420 
	}
}

423 
	$sys_pï¿½e
()

425 *
fd
;

426 
fï¿½e
 *
rf
, *
wf
;

427 
fd0
, 
fd1
;

429 if(
	`ï¿½gï¿½r
(0, (*)&
fd
, 2*(fd[0])) < 0)

431 if(
	`pï¿½ï¿½ï¿½oc
(&
rf
, &
wf
) < 0)

433 
fd0
 = -1;

434 if((
fd0
 = 
	`fdï¿½loc
(
rf
)ï¿½< 0 || (
fd1
 = fdï¿½loc(
wf
)) < 0){

435 if(
fd0
 >= 0)

436 
	`myï¿½oc
()->
ofï¿½e
[
fd0
] = 0;

437 
	`fï¿½eï¿½oï¿½
(
rf
);

438 
	`fï¿½eï¿½oï¿½
(
wf
);

441 
fd
[0] = 
fd0
;

442 
fd
[1] = 
fd1
;

444 
	}
}

	@sysproc.c

1 
	~"tyï¿½s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"dï¿½e.h
"

5 
	~"ï¿½ï¿½m.h
"

6 
	~"memï¿½yout.h
"

7 
	~"mmu.h
"

8 
	~"ï¿½oc.h
"

11 
	$sys_fï¿½k
()

13  
	`fï¿½k
();

14 
	}
}

17 
	$sys_exï¿½
()

19 
	`exï¿½
();

21 
	}
}

24 
	$sys_waï¿½
()

26  
	`waï¿½
();

27 
	}
}

30 
	$sys_kï¿½l
()

32 
pid
;

34 if(
	`ï¿½gï¿½t
(0, &
pid
) < 0)

36  
	`kï¿½l
(
pid
);

37 
	}
}

40 
	$sys_gï¿½pid
()

42  
	`myï¿½oc
()->
pid
;

43 
	}
}

46 
	$sys_sbrk
()

48 
addr
;

49 
n
;

51 if(
	`ï¿½gï¿½t
(0, &
n
) < 0)

53 
addr
 = 
	`myï¿½oc
()->
sz
;

54 if(
	`growï¿½oc
(
n
) < 0)

56  
addr
;

57 
	}
}

60 
	$sys_ï¿½ï¿½p
()

62 
n
;

63 
uï¿½t
 
ticks0
;

65 if(
	`ï¿½gï¿½t
(0, &
n
) < 0)

67 
	`acquï¿½e
(&
tickï¿½ock
);

68 
ticks0
 = 
ticks
;

69 
ticks
 - 
ticks0
 < 
n
){

70 if(
	`myï¿½oc
()->
kï¿½ï¿½d
){

71 
	`ï¿½ï¿½aï¿½
(&
tickï¿½ock
);

74 
	`ï¿½ï¿½p
(&
ticks
, &
tickï¿½ock
);

76 
	`ï¿½ï¿½aï¿½
(&
tickï¿½ock
);

78 
	}
}

83 
	$sys_uï¿½ime
()

85 
uï¿½t
 
xticks
;

87 
	`acquï¿½e
(&
tickï¿½ock
);

88 
xticks
 = 
ticks
;

89 
	`ï¿½ï¿½aï¿½
(&
tickï¿½ock
);

90  
xticks
;

91 
	}
}

	@trap.c

1 
	~"tyï¿½s.h
"

2 
	~"defs.h
"

3 
	~"ï¿½ï¿½m.h
"

4 
	~"memï¿½yout.h
"

5 
	~"mmu.h
"

6 
	~"ï¿½oc.h
"

7 
	~"x86.h
"

8 
	~"ï¿½ï¿½s.h
"

9 
	~"ï¿½ï¿½lock.h
"

12 
gï¿½edesc
 
	gidt
[256];

13 
uï¿½t
 
veï¿½ï¿½s
[];

14 
ï¿½ï¿½lock
 
	gtickï¿½ock
;

15 
uï¿½t
 
	gticks
;

18 
	$tvï¿½ï¿½
()

20 
i
;

22 
i
 = 0; i < 256; i++)

23 
	`SETGATE
(
idt
[
i
], 0, 
SEG_KCODE
<<3, 
veï¿½ï¿½s
[i], 0);

24 
	`SETGATE
(
idt
[
T_SYSCALL
], 1, 
SEG_KCODE
<<3, 
veï¿½ï¿½s
[T_SYSCALL], 
DPL_USER
);

26 
	`ï¿½ï¿½lock
(&
tickï¿½ock
, "time");

27 
	}
}

30 
	$idtï¿½ï¿½
()

32 
	`lidt
(
idt
, (idt));

33 
	}
}

37 
	$ï¿½ï¿½
(
ï¿½ï¿½ï¿½ame
 *
tf
)

39 if(
tf
->
ï¿½ï¿½no
 =ï¿½
T_SYSCALL
){

40 if(
	`myï¿½oc
()->
kï¿½ï¿½d
)

41 
	`exï¿½
();

42 
	`myï¿½oc
()->
tf
 =ï¿½f;

43 
	`sysï¿½ï¿½
();

44 if(
	`myï¿½oc
()->
kï¿½ï¿½d
)

45 
	`exï¿½
();

49 
tf
->
ï¿½ï¿½no
){

50 
T_IRQ0
 + 
IRQ_TIMER
:

51 if(
	`ï¿½uid
() == 0){

52 
	`acquï¿½e
(&
tickï¿½ock
);

53 
ticks
++;

54 
	`wakeup
(&
ticks
);

55 
	`ï¿½ï¿½aï¿½
(&
tickï¿½ock
);

57 
	`ï¿½piï¿½oi
();

59 
T_IRQ0
 + 
IRQ_IDE
:

60 
	`ideï¿½ï¿½
();

61 
	`ï¿½piï¿½oi
();

63 
T_IRQ0
 + 
IRQ_IDE
+1:

66 
T_IRQ0
 + 
IRQ_KBD
:

67 
	`kbdï¿½ï¿½
();

68 
	`ï¿½piï¿½oi
();

70 
T_IRQ0
 + 
IRQ_COM1
:

71 
	`uï¿½tï¿½ï¿½
();

72 
	`ï¿½piï¿½oi
();

74 
T_IRQ0
 + 7:

75 
T_IRQ0
 + 
IRQ_SPURIOUS
:

76 
	`ï¿½rï¿½tf
("cpu%d: spurious interruptï¿½t %x:%x\n",

77 
	`ï¿½uid
(), 
tf
->
cs
,ï¿½f->
eï¿½
);

78 
	`ï¿½piï¿½oi
();

83 if(
	`myï¿½oc
(ï¿½=ï¿½0 || (
tf
->
cs
&3) == 0){

85 
	`ï¿½rï¿½tf
("unexpectedï¿½rap %d from cpu %dï¿½ip %x (cr2=0x%x)\n",

86 
tf
->
ï¿½ï¿½no
, 
	`ï¿½uid
(),ï¿½f->
eï¿½
, 
	`rï¿½2
());

87 
	`ï¿½nic
("trap");

90 
	`ï¿½rï¿½tf
("pid %d %s:ï¿½rap %dï¿½rr %d on cpu %d "

92 
	`myï¿½oc
()->
pid
, myï¿½oc()->
ï¿½me
, 
tf
->
ï¿½ï¿½no
,

93 
tf
->
ï¿½r
, 
	`ï¿½uid
(),ï¿½f->
eï¿½
, 
	`rï¿½2
());

94 
	`myï¿½oc
()->
kï¿½ï¿½d
 = 1;

100 if(
	`myï¿½oc
(ï¿½&& myï¿½oc()->
kï¿½ï¿½d
 && (
tf
->
cs
&3ï¿½=ï¿½
DPL_USER
)

101 
	`exï¿½
();

105 if(
	`myï¿½oc
(ï¿½&& myï¿½oc()->
ï¿½ï¿½e
 =ï¿½
RUNNING
 &&

106 
tf
->
ï¿½ï¿½no
 =ï¿½
T_IRQ0
+
IRQ_TIMER
)

107 
	`yï¿½ld
();

110 if(
	`myï¿½oc
(ï¿½&& myï¿½oc()->
kï¿½ï¿½d
 && (
tf
->
cs
&3ï¿½=ï¿½
DPL_USER
)

111 
	`exï¿½
();

112 
	}
}

	@trapasm.S

1 
	~"mmu.h
"

3 #veï¿½ï¿½s.
S
 
ï¿½nds
 
ï¿½l
 
ï¿½ï¿½s
 
hï¿½e
.

4 .
globl
 
ï¿½É¿ps


5 
	gï¿½É¿ps
:

6 #Buï¿½d 
ï¿½ï¿½
 
ï¿½ame
.

7 
pushl
 %
ds


8 
pushl
 %
es


9 
pushl
 %
fs


10 
pushl
 %
gs


11 
pushï¿½


13 #Sï¿½ 
up
 
dï¿½a
 
ï¿½gmï¿½ts
.

14 
movw
 
$
(
SEG_KDATA
<<3), %
ax


15 
	gmovw
 %
	gax
, %
ds


16 
	gmovw
 %
	gax
, %
	ges


18 #Cï¿½ï¿½
ï¿½ï¿½
(
tf
), 
whï¿½e
ï¿½f=%
eï¿½


19 
	gpushl
 %
eï¿½


20 
ï¿½ï¿½
 
ï¿½ï¿½


21 
addl
 
	g$4
, %
	geï¿½


23 #Rï¿½uï¿½ 
ï¿½ï¿½s
 
through
 
to
 
ï¿½ï¿½ï¿½t
...

24 .
globl
 
ï¿½ï¿½ï¿½t


25 
	gï¿½ï¿½ï¿½t
:

26 
pÝ®


27 
pï¿½l
 %
gs


28 
pï¿½l
 %
fs


29 
pï¿½l
 %
es


30 
pï¿½l
 %
ds


31 
addl
 
$0x8
, %
	geï¿½
 #ï¿½ï¿½nï¿½
ï¿½d
 
ï¿½rcode


32 
	gï¿½ï¿½


	@traps.h

4 
	#T_DIVIDE
 0

5 
	#T_DEBUG
 1

6 
	#T_NMI
 2

7 
	#T_BRKPT
 3

8 
	#T_OFLOW
 4

9 
	#T_BOUND
 5

10 
	#T_ILLOP
 6

11 
	#T_DEVICE
 7

12 
	#T_DBLFLT
 8

14 
	#T_TSS
 10

15 
	#T_SEGNP
 11

16 
	#T_STACK
 12

17 
	#T_GPFLT
 13

18 
	#T_PGFLT
 14

20 
	#T_FPERR
 16

21 
	#T_ALIGN
 17

22 
	#T_MCHK
 18

23 
	#T_SIMDERR
 19

24 

	)

27 
	#T_SYSCALL
 64

28 
	#T_DEFAULT
 500

29 

	)

30 
	#T_IRQ0
 32

31 

	)

32 
	#IRQ_TIMER
 0

	)

33 
	#IRQ_KBD
 1

	)

34 
	#IRQ_COM1
 4

	)

35 
	#IRQ_IDE
 14

	)

36 
	#IRQ_ERROR
 19

	)

37 
	#IRQ_SPURIOUS
 31

	)

	@types.h

1 
	tuï¿½t
;

2 
	tushï¿½t
;

3 
	tuchï¿½
;

4 
uï¿½t
 
	tpde_t
;

	@uart.c

3 
	~"tyï¿½s.h
"

4 
	~"defs.h
"

5 
	~"ï¿½ï¿½m.h
"

6 
	~"ï¿½ï¿½s.h
"

7 
	~"ï¿½ï¿½lock.h
"

8 
	~"ï¿½ï¿½ï¿½ock.h
"

9 
	~"fs.h
"

10 
	~"fï¿½e.h
"

11 
	~"mmu.h
"

12 
	~"ï¿½oc.h
"

13 
	~"x86.h
"

15 
	#COM1
 0x3f8

	)

17 
	guï¿½t
;

20 
	$uï¿½tï¿½ï¿½
()

22 *
p
;

25 
	`outb
(
COM1
+2, 0);

28 
	`outb
(
COM1
+3, 0x80);

29 
	`outb
(
COM1
+0, 115200/9600);

30 
	`outb
(
COM1
+1, 0);

31 
	`outb
(
COM1
+3, 0x03);

32 
	`outb
(
COM1
+4, 0);

33 
	`outb
(
COM1
+1, 0x01);

36 if(
	`ï¿½b
(
COM1
+5) == 0xFF)

38 
uï¿½t
 = 1;

42 
	`ï¿½b
(
COM1
+2);

43 
	`ï¿½b
(
COM1
+0);

44 
	`iï¿½piï¿½ï¿½bï¿½
(
IRQ_COM1
, 0);

47 
p
="xv6...\n"; *p;ï¿½++)

48 
	`uï¿½ï¿½utc
(*
p
);

49 
	}
}

52 
	$uï¿½ï¿½utc
(
c
)

54 
i
;

56 if(!
uï¿½t
)

58 
i
 = 0; i < 128 && !(
	`ï¿½b
(
COM1
+5) & 0x20); i++)

59 
	`miï¿½odï¿½ay
(10);

60 
	`outb
(
COM1
+0, 
c
);

61 
	}
}

64 
	$uï¿½tgï¿½c
()

66 if(!
uï¿½t
)

68 if(!(
	`ï¿½b
(
COM1
+5) & 0x01))

70  
	`ï¿½b
(
COM1
+0);

71 
	}
}

74 
	$uï¿½tï¿½ï¿½
()

76 
	`cï¿½sï¿½eï¿½ï¿½
(
uï¿½tgï¿½c
);

77 
	}
}

	@ulib.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"fï¿½ï¿½.h
"

4 
	~"uï¿½r.h
"

5 
	~"x86.h
"

8 
	$ï¿½rï¿½y
(*
s
, cÚ¡ *
t
)

10 *
os
;

12 
os
 = 
s
;

13 (*
s
++ = *
t
++) != 0)

15  
os
;

16 
	}
}

19 
	$ï¿½rcmp
(cÚ¡ *
p
, cÚ¡ *
q
)

21 *
p
 && *ï¿½=ï¿½*
q
)

22 
p
++, 
q
++;

23  (
uchï¿½
)*
p
 - (uchï¿½)*
q
;

24 
	}
}

26 
uï¿½t


27 
	$ï¿½ï¿½ï¿½
(cÚ¡ *
s
)

29 
n
;

31 
n
 = 0; 
s
[n];ï¿½++)

33  
n
;

34 
	}
}

37 
	$memï¿½t
(*
dï¿½
, 
c
, 
uï¿½t
 
n
)

39 
	`ï¿½osb
(
dï¿½
, 
c
, 
n
);

40  
dï¿½
;

41 
	}
}

44 
	$ï¿½rchr
(cÚ¡ *
s
, 
c
)

46 ; *
s
; s++)

47 if(*
s
 =ï¿½
c
)

48  (*)
s
;

50 
	}
}

53 
	$gï¿½s
(*
buf
, 
max
)

55 
i
, 
cc
;

56 
c
;

58 
i
=0; i+1 < 
max
; ){

59 
cc
 = 
	`ï¿½ad
(0, &
c
, 1);

60 if(
cc
 < 1)

62 
buf
[
i
++] = 
c
;

63 if(
c
 == '\n' || c == '\r')

66 
buf
[
i
] = '\0';

67  
buf
;

68 
	}
}

71 
	$ï¿½ï¿½
(cÚ¡ *
n
, 
ï¿½ï¿½
 *
ï¿½
)

73 
fd
;

74 
r
;

76 
fd
 = 
	`Ý’
(
n
, 
O_RDONLY
);

77 if(
fd
 < 0)

79 
r
 = 
	`fï¿½ï¿½
(
fd
, 
ï¿½
);

80 
	`ï¿½oï¿½
(
fd
);

81  
r
;

82 
	}
}

85 
	$ï¿½oi
(cÚ¡ *
s
)

87 
n
;

89 
n
 = 0;

90 '0' <ï¿½*
s
 && *s <= '9')

91 
n
 =ï¿½*10 + *
s
++ - '0';

92  
n
;

93 
	}
}

96 
	$memmove
(*
vdï¿½
, cÚ¡ *
vï¿½c
, 
n
)

98 *
dï¿½
;

99 cÚ¡ *
ï¿½c
;

101 
dï¿½
 = 
vdï¿½
;

102 
ï¿½c
 = 
vï¿½c
;

103 
n
-- > 0)

104 *
dï¿½
++ = *
ï¿½c
++;

105  
vdï¿½
;

106 
	}
}

	@umalloc.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

4 
	~"ï¿½ï¿½m.h
"

9 
	tAlign
;

11 
	uhï¿½dï¿½
 {

13 
hï¿½dï¿½
 *
	mï¿½r
;

14 
uï¿½t
 
	msize
;

15 } 
	ms
;

16 
Align
 
	mx
;

19 
hï¿½dï¿½
 
	tHï¿½dï¿½
;

21 
Hï¿½dï¿½
 
	gbaï¿½
;

22 
Hï¿½dï¿½
 *
	gï¿½p
;

25 
	$ï¿½
(*
ï¿½
)

27 
Hï¿½dï¿½
 *
bp
, *
p
;

29 
bp
 = (
Hï¿½dï¿½
*)
ï¿½
 - 1;

30 
p
 = 
ï¿½p
; !(
bp
 >ï¿½ && bï¿½<ï¿½->
s
.
ï¿½r
);ï¿½ =ï¿½->s.ptr)

31 if(
p
 >ï¿½p->
s
.
ï¿½r
 && (
bp
 >ï¿½ || bp <ï¿½->s.ptr))

33 if(
bp
 + bp->
s
.
size
 =ï¿½
p
->s.
ï¿½r
){

34 
bp
->
s
.
size
 +ï¿½
p
->s.
ï¿½r
->s.size;

35 
bp
->
s
.
ï¿½r
 = 
p
->s.ptr->s.ptr;

37 
bp
->
s
.
ï¿½r
 = 
p
->s.ptr;

38 if(
p
 +ï¿½->
s
.
size
 =ï¿½
bp
){

39 
p
->
s
.
size
 +ï¿½
bp
->s.size;

40 
p
->
s
.
ï¿½r
 = 
bp
->s.ptr;

42 
p
->
s
.
ï¿½r
 = 
bp
;

43 
ï¿½p
 = 
p
;

44 
	}
}

46 
Hï¿½dï¿½
*

47 
	$mï¿½ecï¿½e
(
uï¿½t
 
nu
)

49 *
p
;

50 
Hï¿½dï¿½
 *
hp
;

52 if(
nu
 < 4096)

53 
nu
 = 4096;

54 
p
 = 
	`sbrk
(
nu
 * (
Hï¿½dï¿½
));

55 if(
p
 == (*)-1)

57 
hp
 = (
Hï¿½dï¿½
*)
p
;

58 
hp
->
s
.
size
 = 
nu
;

59 
	`ï¿½
((*)(
hp
 + 1));

60  
ï¿½p
;

61 
	}
}

64 
	$mï¿½loc
(
uï¿½t
 
nbyï¿½s
)

66 
Hï¿½dï¿½
 *
p
, *
ï¿½evp
;

67 
uï¿½t
 
nunï¿½s
;

69 
nunï¿½s
 = (
nbyï¿½s
 + (
Hï¿½dï¿½
) - 1)/(Header) + 1;

70 if((
ï¿½evp
 = 
ï¿½p
) == 0){

71 
baï¿½
.
s
.
ï¿½r
 = 
ï¿½p
 = 
ï¿½evp
 = &base;

72 
baï¿½
.
s
.
size
 = 0;

74 
p
 = 
ï¿½evp
->
s
.
ï¿½r
; ;ï¿½revp =ï¿½,ï¿½ =ï¿½->s.ptr){

75 if(
p
->
s
.
size
 >ï¿½
nunï¿½s
){

76 if(
p
->
s
.
size
 =ï¿½
nunï¿½s
)

77 
ï¿½evp
->
s
.
ï¿½r
 = 
p
->s.ptr;

79 
p
->
s
.
size
 -ï¿½
nunï¿½s
;

80 
p
 +ï¿½p->
s
.
size
;

81 
p
->
s
.
size
 = 
nunï¿½s
;

83 
ï¿½p
 = 
ï¿½evp
;

84  (*)(
p
 + 1);

86 if(
p
 =ï¿½
ï¿½p
)

87 if((
p
 = 
	`mï¿½ecï¿½e
(
nunï¿½s
)) == 0)

90 
	}
}

	@user.h

1 
	gï¿½ï¿½
;

2 
	gï¿½cdï¿½e
;

5 
fï¿½k
();

6 
	$exï¿½
(ï¿½
	`__ï¿½ï¿½ibuï¿½__
((
nÜ‘uï¿½
));

7 
	`waï¿½
();

8 
	`pï¿½e
(*);

9 
	`wrï¿½e
(, const *, );

10 
	`ï¿½ad
(, *, );

11 
	`ï¿½oï¿½
();

12 
	`kï¿½l
();

13 
	`exec
(*, **);

14 
	`Ý’
(const *, );

15 
	`mknod
(const *, , );

16 
	`uÆšk
(const *);

17 
	`fï¿½ï¿½
(
fd
, 
ï¿½ï¿½
*);

18 
	`lï¿½k
(const *, const *);

19 
	`mkdï¿½
(const *);

20 
	`chdï¿½
(const *);

21 
	`dup
();

22 
	`gï¿½pid
();

23 * 
	`sbrk
();

24 
	`ï¿½ï¿½p
();

25 
	`uï¿½ime
();

28 
	`ï¿½ï¿½
(cÚ¡ *, 
ï¿½ï¿½
*);

29 * 
	`ï¿½rï¿½y
(*, const *);

30 *
	`memmove
(*, const *, );

31 * 
	`ï¿½rchr
(cÚ¡ *, 
c
);

32 
	`ï¿½rcmp
(const *, const *);

33 
	`ï¿½ï¿½tf
(, const *, ...);

34 * 
	`gï¿½s
(*, 
max
);

35 
uï¿½t
 
	`ï¿½ï¿½ï¿½
(const *);

36 * 
	`memï¿½t
(*, , 
uï¿½t
);

37 * 
	`mï¿½loc
(
uï¿½t
);

38 
	`ï¿½
(*);

39 
	`ï¿½oi
(const *);

	@usertests.c

1 
	~"ï¿½ï¿½m.h
"

2 
	~"tyï¿½s.h
"

3 
	~"ï¿½ï¿½.h
"

4 
	~"uï¿½r.h
"

5 
	~"fs.h
"

6 
	~"fï¿½ï¿½.h
"

7 
	~"sysï¿½ï¿½.h
"

8 
	~"ï¿½ï¿½s.h
"

9 
	~"memï¿½yout.h
"

11 
	gbuf
[8192];

12 
	gï¿½me
[3];

13 *
	gechï¿½rgv
[] = { "echo", "ALL", "TESTS", "PASSED", 0 };

14 
	gï¿½dout
 = 1;

18 
	$ï¿½uï¿½eï¿½
()

20 
	`ï¿½ï¿½tf
(
ï¿½dout
, "iputï¿½est\n");

22 if(
	`mkdï¿½
("iputdir") < 0){

23 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdir failed\n");

24 
	`exï¿½
();

26 if(
	`chdï¿½
("iputdir") < 0){

27 
	`ï¿½ï¿½tf
(
ï¿½dout
, "chdir iputdir failed\n");

28 
	`exï¿½
();

30 if(
	`uÆšk
("../iputdir") < 0){

31 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink ../iputdir failed\n");

32 
	`exï¿½
();

34 if(
	`chdï¿½
("/") < 0){

35 
	`ï¿½ï¿½tf
(
ï¿½dout
, "chdir / failed\n");

36 
	`exï¿½
();

38 
	`ï¿½ï¿½tf
(
ï¿½dout
, "iputï¿½est ok\n");

39 
	}
}

43 
	$exï¿½ï¿½uï¿½eï¿½
()

45 
pid
;

47 
	`ï¿½ï¿½tf
(
ï¿½dout
, "exitiputï¿½est\n");

49 
pid
 = 
	`fï¿½k
();

50 if(
pid
 < 0){

51 
	`ï¿½ï¿½tf
(
ï¿½dout
, "fork failed\n");

52 
	`exï¿½
();

54 if(
pid
 == 0){

55 if(
	`mkdï¿½
("iputdir") < 0){

56 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdir failed\n");

57 
	`exï¿½
();

59 if(
	`chdï¿½
("iputdir") < 0){

60 
	`ï¿½ï¿½tf
(
ï¿½dout
, "child chdir failed\n");

61 
	`exï¿½
();

63 if(
	`uÆšk
("../iputdir") < 0){

64 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink ../iputdir failed\n");

65 
	`exï¿½
();

67 
	`exï¿½
();

69 
	`waï¿½
();

70 
	`ï¿½ï¿½tf
(
ï¿½dout
, "exitiputï¿½est ok\n");

71 
	}
}

85 
	$Ý’ï¿½uï¿½eï¿½
()

87 
pid
;

89 
	`ï¿½ï¿½tf
(
ï¿½dout
, "openiputï¿½est\n");

90 if(
	`mkdï¿½
("oidir") < 0){

91 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdir oidir failed\n");

92 
	`exï¿½
();

94 
pid
 = 
	`fï¿½k
();

95 if(
pid
 < 0){

96 
	`ï¿½ï¿½tf
(
ï¿½dout
, "fork failed\n");

97 
	`exï¿½
();

99 if(
pid
 == 0){

100 
fd
 = 
	`Ý’
("oidï¿½", 
O_RDWR
);

101 if(
fd
 >= 0){

102 
	`ï¿½ï¿½tf
(
ï¿½dout
, "open directory for write succeeded\n");

103 
	`exï¿½
();

105 
	`exï¿½
();

107 
	`ï¿½ï¿½p
(1);

108 if(
	`uÆšk
("oidir") != 0){

109 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink failed\n");

110 
	`exï¿½
();

112 
	`waï¿½
();

113 
	`ï¿½ï¿½tf
(
ï¿½dout
, "openiputï¿½est ok\n");

114 
	}
}

119 
	$Ý’ï¿½ï¿½
()

121 
fd
;

123 
	`ï¿½ï¿½tf
(
ï¿½dout
, "openï¿½est\n");

124 
fd
 = 
	`Ý’
("echo", 0);

125 if(
fd
 < 0){

126 
	`ï¿½ï¿½tf
(
ï¿½dout
, "openï¿½cho failed!\n");

127 
	`exï¿½
();

129 
	`ï¿½oï¿½
(
fd
);

130 
fd
 = 
	`Ý’
("doesnotexist", 0);

131 if(
fd
 >= 0){

132 
	`ï¿½ï¿½tf
(
ï¿½dout
, "open doesnotexist succeeded!\n");

133 
	`exï¿½
();

135 
	`ï¿½ï¿½tf
(
ï¿½dout
, "openï¿½est ok\n");

136 
	}
}

139 
	$wrï¿½ï¿½eï¿½
()

141 
fd
;

142 
i
;

144 
	`ï¿½ï¿½tf
(
ï¿½dout
, "small fileï¿½est\n");

145 
fd
 = 
	`Ý’
("smï¿½l", 
O_CREATE
|
O_RDWR
);

146 if(
fd
 >= 0){

147 
	`ï¿½ï¿½tf
(
ï¿½dout
, "creat small succeeded; ok\n");

149 
	`ï¿½ï¿½tf
(
ï¿½dout
, "error: creat small failed!\n");

150 
	`exï¿½
();

152 
i
 = 0; i < 100; i++){

153 if(
	`wrï¿½e
(
fd
, "aaaaaaaaaa", 10) != 10){

154 
	`ï¿½ï¿½tf
(
ï¿½dout
, "ï¿½rï¿½: wrï¿½ï¿½ï¿½ %dï¿½ew fï¿½ï¿½ï¿½ed\n", 
i
);

155 
	`exï¿½
();

157 if(
	`wrï¿½e
(
fd
, "bbbbbbbbbb", 10) != 10){

158 
	`ï¿½ï¿½tf
(
ï¿½dout
, "ï¿½rï¿½: wrï¿½ï¿½bb %dï¿½ew fï¿½ï¿½ï¿½ed\n", 
i
);

159 
	`exï¿½
();

162 
	`ï¿½ï¿½tf
(
ï¿½dout
, "writes ok\n");

163 
	`ï¿½oï¿½
(
fd
);

164 
fd
 = 
	`Ý’
("smï¿½l", 
O_RDONLY
);

165 if(
fd
 >= 0){

166 
	`ï¿½ï¿½tf
(
ï¿½dout
, "open small succeeded ok\n");

168 
	`ï¿½ï¿½tf
(
ï¿½dout
, "error: open small failed!\n");

169 
	`exï¿½
();

171 
i
 = 
	`ï¿½ad
(
fd
, 
buf
, 2000);

172 if(
i
 == 2000){

173 
	`ï¿½ï¿½tf
(
ï¿½dout
, "read succeeded ok\n");

175 
	`ï¿½ï¿½tf
(
ï¿½dout
, "read failed\n");

176 
	`exï¿½
();

178 
	`ï¿½oï¿½
(
fd
);

180 if(
	`uÆšk
("small") < 0){

181 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink small failed\n");

182 
	`exï¿½
();

184 
	`ï¿½ï¿½tf
(
ï¿½dout
, "small fileï¿½est ok\n");

185 
	}
}

188 
	$wrï¿½ï¿½eï¿½1
()

190 
i
, 
fd
, 
n
;

192 
	`ï¿½ï¿½tf
(
ï¿½dout
, "big filesï¿½est\n");

194 
fd
 = 
	`Ý’
("big", 
O_CREATE
|
O_RDWR
);

195 if(
fd
 < 0){

196 
	`ï¿½ï¿½tf
(
ï¿½dout
, "error: creat big failed!\n");

197 
	`exï¿½
();

200 
i
 = 0; i < 
MAXFILE
; i++){

201 ((*)
buf
)[0] = 
i
;

202 if(
	`wrï¿½e
(
fd
, 
buf
, 512) != 512){

203 
	`ï¿½ï¿½tf
(
ï¿½dout
, "ï¿½rï¿½: wrï¿½ï¿½big fï¿½ï¿½ï¿½ed\n", 
i
);

204 
	`exï¿½
();

208 
	`ï¿½oï¿½
(
fd
);

210 
fd
 = 
	`Ý’
("big", 
O_RDONLY
);

211 if(
fd
 < 0){

212 
	`ï¿½ï¿½tf
(
ï¿½dout
, "error: open big failed!\n");

213 
	`exï¿½
();

216 
n
 = 0;

218 
i
 = 
	`ï¿½ad
(
fd
, 
buf
, 512);

219 if(
i
 == 0){

220 if(
n
 =ï¿½
MAXFILE
 - 1){

221 
	`ï¿½ï¿½tf
(
ï¿½dout
, "ï¿½ad oï¿½y %d blockï¿½ï¿½om big", 
n
);

222 
	`exï¿½
();

225 } if(
i
 != 512){

226 
	`ï¿½ï¿½tf
(
ï¿½dout
, "ï¿½ad faï¿½ed %d\n", 
i
);

227 
	`exï¿½
();

229 if(((*)
buf
)[0] !ï¿½
n
){

230 
	`ï¿½ï¿½tf
(
ï¿½dout
, "read content of block %d is %d\n",

231 
n
, ((*)
buf
)[0]);

232 
	`exï¿½
();

234 
n
++;

236 
	`ï¿½oï¿½
(
fd
);

237 if(
	`uÆšk
("big") < 0){

238 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink big failed\n");

239 
	`exï¿½
();

241 
	`ï¿½ï¿½tf
(
ï¿½dout
, "big files ok\n");

242 
	}
}

245 
	$ï¿½ï¿½ï¿½ï¿½ï¿½
()

247 
i
, 
fd
;

249 
	`ï¿½ï¿½tf
(
ï¿½dout
, "many creates, followed by unlinkï¿½est\n");

251 
ï¿½me
[0] = 'a';

252 
ï¿½me
[2] = '\0';

253 
i
 = 0; i < 52; i++){

254 
ï¿½me
[1] = '0' + 
i
;

255 
fd
 = 
	`Ý’
(
ï¿½me
, 
O_CREATE
|
O_RDWR
);

256 
	`ï¿½oï¿½
(
fd
);

258 
ï¿½me
[0] = 'a';

259 
ï¿½me
[2] = '\0';

260 
i
 = 0; i < 52; i++){

261 
ï¿½me
[1] = '0' + 
i
;

262 
	`uÆšk
(
ï¿½me
);

264 
	`ï¿½ï¿½tf
(
ï¿½dout
, "many creates, followed by unlink; ok\n");

265 
	}
}

267 
	$dï¿½ï¿½ï¿½
()

269 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdirï¿½est\n");

271 if(
	`mkdï¿½
("dir0") < 0){

272 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdir failed\n");

273 
	`exï¿½
();

276 if(
	`chdï¿½
("dir0") < 0){

277 
	`ï¿½ï¿½tf
(
ï¿½dout
, "chdir dir0 failed\n");

278 
	`exï¿½
();

281 if(
	`chdï¿½
("..") < 0){

282 
	`ï¿½ï¿½tf
(
ï¿½dout
, "chdir .. failed\n");

283 
	`exï¿½
();

286 if(
	`uÆšk
("dir0") < 0){

287 
	`ï¿½ï¿½tf
(
ï¿½dout
, "unlink dir0 failed\n");

288 
	`exï¿½
();

290 
	`ï¿½ï¿½tf
(
ï¿½dout
, "mkdirï¿½est ok\n");

291 
	}
}

294 
	$exeï¿½eï¿½
()

296 
	`ï¿½ï¿½tf
(
ï¿½dout
, "execï¿½est\n");

297 if(
	`exec
("echo", 
echï¿½rgv
) < 0){

298 
	`ï¿½ï¿½tf
(
ï¿½dout
, "execï¿½cho failed\n");

299 
	`exï¿½
();

301 
	}
}

306 
	$pï¿½e1
()

308 
fds
[2], 
pid
;

309 
ï¿½q
, 
i
, 
n
, 
cc
, 
tÙ®
;

311 if(
	`pï¿½e
(
fds
) != 0){

312 
	`ï¿½ï¿½tf
(1, "pipe() failed\n");

313 
	`exï¿½
();

315 
pid
 = 
	`fï¿½k
();

316 
ï¿½q
 = 0;

317 if(
pid
 == 0){

318 
	`ï¿½oï¿½
(
fds
[0]);

319 
n
 = 0;ï¿½ < 5;ï¿½++){

320 
i
 = 0; i < 1033; i++)

321 
buf
[
i
] = 
ï¿½q
++;

322 if(
	`wrï¿½e
(
fds
[1], 
buf
, 1033) != 1033){

323 
	`ï¿½ï¿½tf
(1, "pipe1 oops 1\n");

324 
	`exï¿½
();

327 
	`exï¿½
();

328 } if(
pid
 > 0){

329 
	`ï¿½oï¿½
(
fds
[1]);

330 
tÙ®
 = 0;

331 
cc
 = 1;

332 (
n
 = 
	`ï¿½ad
(
fds
[0], 
buf
, 
cc
)) > 0){

333 
i
 = 0; i < 
n
; i++){

334 if((
buf
[
i
] & 0xffï¿½!ï¿½(
ï¿½q
++ & 0xff)){

335 
	`ï¿½ï¿½tf
(1, "pipe1 oops 2\n");

339 
tÙ®
 +ï¿½
n
;

340 
cc
 = cc * 2;

341 if(
cc
 > (
buf
))

342 
cc
 = (
buf
);

344 if(
tÙ®
 != 5 * 1033){

345 
	`ï¿½ï¿½tf
(1, "pï¿½e1 oÝ 3ï¿½Ù® %d\n", 
tÙ®
);

346 
	`exï¿½
();

348 
	`ï¿½oï¿½
(
fds
[0]);

349 
	`waï¿½
();

351 
	`ï¿½ï¿½tf
(1, "fork() failed\n");

352 
	`exï¿½
();

354 
	`ï¿½ï¿½tf
(1, "pipe1 ok\n");

355 
	}
}

359 
	$ï¿½ï¿½mï¿½
()

361 
pid1
, 
pid2
, 
pid3
;

362 
pfds
[2];

364 
	`ï¿½ï¿½tf
(1, "preempt: ");

365 
pid1
 = 
	`fï¿½k
();

366 if(
pid1
 == 0)

370 
pid2
 = 
	`fï¿½k
();

371 if(
pid2
 == 0)

375 
	`pï¿½e
(
pfds
);

376 
pid3
 = 
	`fï¿½k
();

377 if(
pid3
 == 0){

378 
	`ï¿½oï¿½
(
pfds
[0]);

379 if(
	`wrï¿½e
(
pfds
[1], "x", 1) != 1)

380 
	`ï¿½ï¿½tf
(1, "preempt writeï¿½rror");

381 
	`ï¿½oï¿½
(
pfds
[1]);

386 
	`ï¿½oï¿½
(
pfds
[1]);

387 if(
	`ï¿½ad
(
pfds
[0], 
buf
, (buf)) != 1){

388 
	`ï¿½ï¿½tf
(1, "preemptï¿½eadï¿½rror");

391 
	`ï¿½oï¿½
(
pfds
[0]);

392 
	`ï¿½ï¿½tf
(1, "kill... ");

393 
	`kï¿½l
(
pid1
);

394 
	`kï¿½l
(
pid2
);

395 
	`kï¿½l
(
pid3
);

396 
	`ï¿½ï¿½tf
(1, "wait... ");

397 
	`waï¿½
();

398 
	`waï¿½
();

399 
	`waï¿½
();

400 
	`ï¿½ï¿½tf
(1, "preempt ok\n");

401 
	}
}

405 
	$exï¿½waï¿½
()

407 
i
, 
pid
;

409 
i
 = 0; i < 100; i++){

410 
pid
 = 
	`fï¿½k
();

411 if(
pid
 < 0){

412 
	`ï¿½ï¿½tf
(1, "fork failed\n");

415 if(
pid
){

416 if(
	`waï¿½
(ï¿½!ï¿½
pid
){

417 
	`ï¿½ï¿½tf
(1, "wait wrongï¿½id\n");

421 
	`exï¿½
();

424 
	`ï¿½ï¿½tf
(1, "exitwait ok\n");

425 
	}
}

428 
	$mem
()

430 *
m1
, *
m2
;

431 
pid
, 
ï¿½id
;

433 
	`ï¿½ï¿½tf
(1, "memï¿½est\n");

434 
ï¿½id
 = 
	`gï¿½pid
();

435 if((
pid
 = 
	`fï¿½k
()) == 0){

436 
m1
 = 0;

437 (
m2
 = 
	`mï¿½loc
(10001)) != 0){

438 *(**)
m2
 = 
m1
;

439 
m1
 = 
m2
;

441 
m1
){

442 
m2
 = *(**)
m1
;

443 
	`ï¿½
(
m1
);

444 
m1
 = 
m2
;

446 
m1
 = 
	`mï¿½loc
(1024*20);

447 if(
m1
 == 0){

448 
	`ï¿½ï¿½tf
(1, "couldn'tï¿½llocate mem?!!\n");

449 
	`kï¿½l
(
ï¿½id
);

450 
	`exï¿½
();

452 
	`ï¿½
(
m1
);

453 
	`ï¿½ï¿½tf
(1, "mem ok\n");

454 
	`exï¿½
();

456 
	`waï¿½
();

458 
	}
}

465 
	$shï¿½edfd
()

467 
fd
, 
pid
, 
i
, 
n
, 
nc
, 
ï¿½
;

468 
buf
[10];

470 
	`ï¿½ï¿½tf
(1, "sharedfdï¿½est\n");

472 
	`uÆšk
("sharedfd");

473 
fd
 = 
	`Ý’
("shï¿½edfd", 
O_CREATE
|
O_RDWR
);

474 if(
fd
 < 0){

475 
	`ï¿½ï¿½tf
(1, "fstests: cannot open sharedfd for writing");

478 
pid
 = 
	`fï¿½k
();

479 
	`memï¿½t
(
buf
, 
pid
==0?'c':'p', (buf));

480 
i
 = 0; i < 1000; i++){

481 if(
	`wrï¿½e
(
fd
, 
buf
, (buf)) != (buf)){

482 
	`ï¿½ï¿½tf
(1, "fstests: write sharedfd failed\n");

486 if(
pid
 == 0)

487 
	`exï¿½
();

489 
	`waï¿½
();

490 
	`ï¿½oï¿½
(
fd
);

491 
fd
 = 
	`Ý’
("sharedfd", 0);

492 if(
fd
 < 0){

493 
	`ï¿½ï¿½tf
(1, "fstests: cannot open sharedfd forï¿½eading\n");

496 
nc
 = 
ï¿½
 = 0;

497 (
n
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf))) > 0){

498 
i
 = 0; i < (
buf
); i++){

499 if(
buf
[
i
] == 'c')

500 
nc
++;

501 if(
buf
[
i
] == 'p')

502 
ï¿½
++;

505 
	`ï¿½oï¿½
(
fd
);

506 
	`uÆšk
("sharedfd");

507 if(
nc
 =ï¿½10000 && 
ï¿½
 == 10000){

508 
	`ï¿½ï¿½tf
(1, "sharedfd ok\n");

510 
	`ï¿½ï¿½tf
(1, "shï¿½edfd oÝ %d %d\n", 
nc
, 
ï¿½
);

511 
	`exï¿½
();

513 
	}
}

518 
	$fourfï¿½es
()

520 
fd
, 
pid
, 
i
, 
j
, 
n
, 
tÙ®
, 
pi
;

521 *
ï¿½mes
[] = { "f0", "f1", "f2", "f3" };

522 *
ï¿½ame
;

524 
	`ï¿½ï¿½tf
(1, "fourfilesï¿½est\n");

526 
pi
 = 0;ï¿½i < 4;ï¿½i++){

527 
ï¿½ame
 = 
ï¿½mes
[
pi
];

528 
	`uÆšk
(
ï¿½ame
);

530 
pid
 = 
	`fï¿½k
();

531 if(
pid
 < 0){

532 
	`ï¿½ï¿½tf
(1, "fork failed\n");

533 
	`exï¿½
();

536 if(
pid
 == 0){

537 
fd
 = 
	`Ý’
(
ï¿½ame
, 
O_CREATE
 | 
O_RDWR
);

538 if(
fd
 < 0){

539 
	`ï¿½ï¿½tf
(1, "create failed\n");

540 
	`exï¿½
();

543 
	`memï¿½t
(
buf
, '0'+
pi
, 512);

544 
i
 = 0; i < 12; i++){

545 if((
n
 = 
	`wrï¿½e
(
fd
, 
buf
, 500)) != 500){

546 
	`ï¿½ï¿½tf
(1, "wrï¿½ï¿½ï¿½ed %d\n", 
n
);

547 
	`exï¿½
();

550 
	`exï¿½
();

554 
pi
 = 0;ï¿½i < 4;ï¿½i++){

555 
	`waï¿½
();

558 
i
 = 0; i < 2; i++){

559 
ï¿½ame
 = 
ï¿½mes
[
i
];

560 
fd
 = 
	`Ý’
(
ï¿½ame
, 0);

561 
tÙ®
 = 0;

562 (
n
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf))) > 0){

563 
j
 = 0; j < 
n
; j++){

564 if(
buf
[
j
] !ï¿½'0'+
i
){

565 
	`ï¿½ï¿½tf
(1, "wrong char\n");

566 
	`exï¿½
();

569 
tÙ®
 +ï¿½
n
;

571 
	`ï¿½oï¿½
(
fd
);

572 if(
tÙ®
 != 12*500){

573 
	`ï¿½ï¿½tf
(1, "wrï¿½gï¿½ï¿½gth %d\n", 
tÙ®
);

574 
	`exï¿½
();

576 
	`uÆšk
(
ï¿½ame
);

579 
	`ï¿½ï¿½tf
(1, "fourfiles ok\n");

580 
	}
}

584 
	$ï¿½ï¿½ï¿½dï¿½ï¿½e
()

586 ï¿½um { 
N
 = 20 };

587 
pid
, 
i
, 
fd
, 
pi
;

588 
ï¿½me
[32];

590 
	`ï¿½ï¿½tf
(1, "createdeleteï¿½est\n");

592 
pi
 = 0;ï¿½i < 4;ï¿½i++){

593 
pid
 = 
	`fï¿½k
();

594 if(
pid
 < 0){

595 
	`ï¿½ï¿½tf
(1, "fork failed\n");

596 
	`exï¿½
();

599 if(
pid
 == 0){

600 
ï¿½me
[0] = 'p' + 
pi
;

601 
ï¿½me
[2] = '\0';

602 
i
 = 0; i < 
N
; i++){

603 
ï¿½me
[1] = '0' + 
i
;

604 
fd
 = 
	`Ý’
(
ï¿½me
, 
O_CREATE
 | 
O_RDWR
);

605 if(
fd
 < 0){

606 
	`ï¿½ï¿½tf
(1, "create failed\n");

607 
	`exï¿½
();

609 
	`ï¿½oï¿½
(
fd
);

610 if(
i
 > 0 && (i % 2 ) == 0){

611 
ï¿½me
[1] = '0' + (
i
 / 2);

612 if(
	`uÆšk
(
ï¿½me
) < 0){

613 
	`ï¿½ï¿½tf
(1, "unlink failed\n");

614 
	`exï¿½
();

618 
	`exï¿½
();

622 
pi
 = 0;ï¿½i < 4;ï¿½i++){

623 
	`waï¿½
();

626 
ï¿½me
[0] =ï¿½ame[1] =ï¿½ame[2] = 0;

627 
i
 = 0; i < 
N
; i++){

628 
pi
 = 0;ï¿½i < 4;ï¿½i++){

629 
ï¿½me
[0] = 'p' + 
pi
;

630 
ï¿½me
[1] = '0' + 
i
;

631 
fd
 = 
	`Ý’
(
ï¿½me
, 0);

632 if((
i
 =ï¿½0 || i >ï¿½
N
/2ï¿½&& 
fd
 < 0){

633 
	`ï¿½ï¿½tf
(1, "oÝ ï¿½ï¿½ï¿½dï¿½ï¿½ï¿½%ï¿½didn'ï¿½exiï¿½\n", 
ï¿½me
);

634 
	`exï¿½
();

635 } if((
i
 >ï¿½1 && i < 
N
/2ï¿½&& 
fd
 >= 0){

636 
	`ï¿½ï¿½tf
(1, "oÝ ï¿½ï¿½ï¿½dï¿½ï¿½ï¿½%ï¿½didï¿½xiï¿½\n", 
ï¿½me
);

637 
	`exï¿½
();

639 if(
fd
 >= 0)

640 
	`ï¿½oï¿½
(
fd
);

644 
i
 = 0; i < 
N
; i++){

645 
pi
 = 0;ï¿½i < 4;ï¿½i++){

646 
ï¿½me
[0] = 'p' + 
i
;

647 
ï¿½me
[1] = '0' + 
i
;

648 
	`uÆšk
(
ï¿½me
);

652 
	`ï¿½ï¿½tf
(1, "createdelete ok\n");

653 
	}
}

657 
	$uÆškï¿½ad
()

659 
fd
, 
fd1
;

661 
	`ï¿½ï¿½tf
(1, "unlinkreadï¿½est\n");

662 
fd
 = 
	`Ý’
("uÆškï¿½ad", 
O_CREATE
 | 
O_RDWR
);

663 if(
fd
 < 0){

664 
	`ï¿½ï¿½tf
(1, "create unlinkread failed\n");

665 
	`exï¿½
();

667 
	`wrï¿½e
(
fd
, "hello", 5);

668 
	`ï¿½oï¿½
(
fd
);

670 
fd
 = 
	`Ý’
("uÆškï¿½ad", 
O_RDWR
);

671 if(
fd
 < 0){

672 
	`ï¿½ï¿½tf
(1, "open unlinkread failed\n");

673 
	`exï¿½
();

675 if(
	`uÆšk
("unlinkread") != 0){

676 
	`ï¿½ï¿½tf
(1, "unlink unlinkread failed\n");

677 
	`exï¿½
();

680 
fd1
 = 
	`Ý’
("uÆškï¿½ad", 
O_CREATE
 | 
O_RDWR
);

681 
	`wrï¿½e
(
fd1
, "yyy", 3);

682 
	`ï¿½oï¿½
(
fd1
);

684 if(
	`ï¿½ad
(
fd
, 
buf
, (buf)) != 5){

685 
	`ï¿½ï¿½tf
(1, "unlinkreadï¿½ead failed");

686 
	`exï¿½
();

688 if(
buf
[0] != 'h'){

689 
	`ï¿½ï¿½tf
(1, "unlinkread wrong data\n");

690 
	`exï¿½
();

692 if(
	`wrï¿½e
(
fd
, 
buf
, 10) != 10){

693 
	`ï¿½ï¿½tf
(1, "unlinkread write failed\n");

694 
	`exï¿½
();

696 
	`ï¿½oï¿½
(
fd
);

697 
	`uÆšk
("unlinkread");

698 
	`ï¿½ï¿½tf
(1, "unlinkread ok\n");

699 
	}
}

702 
	$lï¿½kï¿½ï¿½
()

704 
fd
;

706 
	`ï¿½ï¿½tf
(1, "linktest\n");

708 
	`uÆšk
("lf1");

709 
	`uÆšk
("lf2");

711 
fd
 = 
	`Ý’
("lf1", 
O_CREATE
|
O_RDWR
);

712 if(
fd
 < 0){

713 
	`ï¿½ï¿½tf
(1, "createï¿½f1 failed\n");

714 
	`exï¿½
();

716 if(
	`wrï¿½e
(
fd
, "hello", 5) != 5){

717 
	`ï¿½ï¿½tf
(1, "writeï¿½f1 failed\n");

718 
	`exï¿½
();

720 
	`ï¿½oï¿½
(
fd
);

722 if(
	`lï¿½k
("lf1", "lf2") < 0){

723 
	`ï¿½ï¿½tf
(1, "linkï¿½f1ï¿½f2 failed\n");

724 
	`exï¿½
();

726 
	`uÆšk
("lf1");

728 if(
	`Ý’
("lf1", 0) >= 0){

729 
	`ï¿½ï¿½tf
(1, "unlinkedï¿½f1 but it is stillï¿½here!\n");

730 
	`exï¿½
();

733 
fd
 = 
	`Ý’
("lf2", 0);

734 if(
fd
 < 0){

735 
	`ï¿½ï¿½tf
(1, "openï¿½f2 failed\n");

736 
	`exï¿½
();

738 if(
	`ï¿½ad
(
fd
, 
buf
, (buf)) != 5){

739 
	`ï¿½ï¿½tf
(1, "readï¿½f2 failed\n");

740 
	`exï¿½
();

742 
	`ï¿½oï¿½
(
fd
);

744 if(
	`lï¿½k
("lf2", "lf2") >= 0){

745 
	`ï¿½ï¿½tf
(1, "linkï¿½f2ï¿½f2 succeeded! oops\n");

746 
	`exï¿½
();

749 
	`uÆšk
("lf2");

750 if(
	`lï¿½k
("lf2", "lf1") >= 0){

751 
	`ï¿½ï¿½tf
(1, "linkï¿½on-existant succeeded! oops\n");

752 
	`exï¿½
();

755 if(
	`lï¿½k
(".", "lf1") >= 0){

756 
	`ï¿½ï¿½tf
(1, "link .ï¿½f1 succeeded! oops\n");

757 
	`exï¿½
();

760 
	`ï¿½ï¿½tf
(1, "linktest ok\n");

761 
	}
}

765 
	$cï¿½ï¿½ï¿½ï¿½
()

767 
fï¿½e
[3];

768 
i
, 
pid
, 
n
, 
fd
;

769 
ï¿½
[40];

771 
ushï¿½t
 
ï¿½um
;

772 
ï¿½me
[14];

773 } 
de
;

775 
	`ï¿½ï¿½tf
(1, "concreateï¿½est\n");

776 
fï¿½e
[0] = 'C';

777 
fï¿½e
[2] = '\0';

778 
i
 = 0; i < 40; i++){

779 
fï¿½e
[1] = '0' + 
i
;

780 
	`uÆšk
(
fï¿½e
);

781 
pid
 = 
	`fï¿½k
();

782 if(
pid
 && (
i
 % 3) == 1){

783 
	`lï¿½k
("C0", 
fï¿½e
);

784 } if(
pid
 =ï¿½0 && (
i
 % 5) == 1){

785 
	`lï¿½k
("C0", 
fï¿½e
);

787 
fd
 = 
	`Ý’
(
fï¿½e
, 
O_CREATE
 | 
O_RDWR
);

788 if(
fd
 < 0){

789 
	`ï¿½ï¿½tf
(1, "cï¿½ï¿½ï¿½ï¿½ cï¿½ï¿½ï¿½%ï¿½ï¿½ed\n", 
fï¿½e
);

790 
	`exï¿½
();

792 
	`ï¿½oï¿½
(
fd
);

794 if(
pid
 == 0)

795 
	`exï¿½
();

797 
	`waï¿½
();

800 
	`memï¿½t
(
ï¿½
, 0, (fa));

801 
fd
 = 
	`Ý’
(".", 0);

802 
n
 = 0;

803 
	`ï¿½ad
(
fd
, &
de
, (de)) > 0){

804 if(
de
.
ï¿½um
 == 0)

806 if(
de
.
ï¿½me
[0] == 'C' && de.name[2] == '\0'){

807 
i
 = 
de
.
ï¿½me
[1] - '0';

808 if(
i
 < 0 || i >ï¿½(
ï¿½
)){

809 
	`ï¿½ï¿½tf
(1, "cï¿½ï¿½ï¿½ï¿½ weï¿½d fï¿½ï¿½%s\n", 
de
.
ï¿½me
);

810 
	`exï¿½
();

812 if(
ï¿½
[
i
]){

813 
	`ï¿½ï¿½tf
(1, "cï¿½ï¿½ï¿½ï¿½ duï¿½iï¿½ï¿½ fï¿½ï¿½%s\n", 
de
.
ï¿½me
);

814 
	`exï¿½
();

816 
ï¿½
[
i
] = 1;

817 
n
++;

820 
	`ï¿½oï¿½
(
fd
);

822 if(
n
 != 40){

823 
	`ï¿½ï¿½tf
(1, "concreateï¿½otï¿½nough files in directoryï¿½isting\n");

824 
	`exï¿½
();

827 
i
 = 0; i < 40; i++){

828 
fï¿½e
[1] = '0' + 
i
;

829 
pid
 = 
	`fï¿½k
();

830 if(
pid
 < 0){

831 
	`ï¿½ï¿½tf
(1, "fork failed\n");

832 
	`exï¿½
();

834 if(((
i
 % 3ï¿½=ï¿½0 && 
pid
 == 0) ||

835 ((
i
 % 3ï¿½=ï¿½1 && 
pid
 != 0)){

836 
	`ï¿½oï¿½
(
	`Ý’
(
fï¿½e
, 0));

837 
	`ï¿½oï¿½
(
	`Ý’
(
fï¿½e
, 0));

838 
	`ï¿½oï¿½
(
	`Ý’
(
fï¿½e
, 0));

839 
	`ï¿½oï¿½
(
	`Ý’
(
fï¿½e
, 0));

841 
	`uÆšk
(
fï¿½e
);

842 
	`uÆšk
(
fï¿½e
);

843 
	`uÆšk
(
fï¿½e
);

844 
	`uÆšk
(
fï¿½e
);

846 if(
pid
 == 0)

847 
	`exï¿½
();

849 
	`waï¿½
();

852 
	`ï¿½ï¿½tf
(1, "concreate ok\n");

853 
	}
}

858 
	$lï¿½kuÆšk
()

860 
pid
, 
i
;

862 
	`ï¿½ï¿½tf
(1, "linkunlinkï¿½est\n");

864 
	`uÆšk
("x");

865 
pid
 = 
	`fï¿½k
();

866 if(
pid
 < 0){

867 
	`ï¿½ï¿½tf
(1, "fork failed\n");

868 
	`exï¿½
();

871 
x
 = (
pid
 ? 1 : 97);

872 
i
 = 0; i < 100; i++){

873 
x
 = x * 1103515245 + 12345;

874 if((
x
 % 3) == 0){

875 
	`ï¿½oï¿½
(
	`Ý’
("x", 
O_RDWR
 | 
O_CREATE
));

876 } if((
x
 % 3) == 1){

877 
	`lï¿½k
("cat", "x");

879 
	`uÆšk
("x");

883 if(
pid
)

884 
	`waï¿½
();

886 
	`exï¿½
();

888 
	`ï¿½ï¿½tf
(1, "linkunlink ok\n");

889 
	}
}

893 
	$bigdï¿½
()

895 
i
, 
fd
;

896 
ï¿½me
[10];

898 
	`ï¿½ï¿½tf
(1, "bigdirï¿½est\n");

899 
	`uÆšk
("bd");

901 
fd
 = 
	`Ý’
("bd", 
O_CREATE
);

902 if(
fd
 < 0){

903 
	`ï¿½ï¿½tf
(1, "bigdir create failed\n");

904 
	`exï¿½
();

906 
	`ï¿½oï¿½
(
fd
);

908 
i
 = 0; i < 500; i++){

909 
ï¿½me
[0] = 'x';

910 
ï¿½me
[1] = '0' + (
i
 / 64);

911 
ï¿½me
[2] = '0' + (
i
 % 64);

912 
ï¿½me
[3] = '\0';

913 if(
	`lï¿½k
("bd", 
ï¿½me
) != 0){

914 
	`ï¿½ï¿½tf
(1, "bigdirï¿½ink failed\n");

915 
	`exï¿½
();

919 
	`uÆšk
("bd");

920 
i
 = 0; i < 500; i++){

921 
ï¿½me
[0] = 'x';

922 
ï¿½me
[1] = '0' + (
i
 / 64);

923 
ï¿½me
[2] = '0' + (
i
 % 64);

924 
ï¿½me
[3] = '\0';

925 if(
	`uÆšk
(
ï¿½me
) != 0){

926 
	`ï¿½ï¿½tf
(1, "bigdir unlink failed");

927 
	`exï¿½
();

931 
	`ï¿½ï¿½tf
(1, "bigdir ok\n");

932 
	}
}

935 
	$subdï¿½
()

937 
fd
, 
cc
;

939 
	`ï¿½ï¿½tf
(1, "subdirï¿½est\n");

941 
	`uÆšk
("ff");

942 if(
	`mkdï¿½
("dd") != 0){

943 
	`ï¿½ï¿½tf
(1, "subdir mkdir dd failed\n");

944 
	`exï¿½
();

947 
fd
 = 
	`Ý’
("dd/ff", 
O_CREATE
 | 
O_RDWR
);

948 if(
fd
 < 0){

949 
	`ï¿½ï¿½tf
(1, "create dd/ff failed\n");

950 
	`exï¿½
();

952 
	`wrï¿½e
(
fd
, "ff", 2);

953 
	`ï¿½oï¿½
(
fd
);

955 if(
	`uÆšk
("dd") >= 0){

956 
	`ï¿½ï¿½tf
(1, "unlink dd (non-empty dir) succeeded!\n");

957 
	`exï¿½
();

960 if(
	`mkdï¿½
("/dd/dd") != 0){

961 
	`ï¿½ï¿½tf
(1, "subdir mkdir dd/dd failed\n");

962 
	`exï¿½
();

965 
fd
 = 
	`Ý’
("dd/dd/ff", 
O_CREATE
 | 
O_RDWR
);

966 if(
fd
 < 0){

967 
	`ï¿½ï¿½tf
(1, "create dd/dd/ff failed\n");

968 
	`exï¿½
();

970 
	`wrï¿½e
(
fd
, "FF", 2);

971 
	`ï¿½oï¿½
(
fd
);

973 
fd
 = 
	`Ý’
("dd/dd/../ff", 0);

974 if(
fd
 < 0){

975 
	`ï¿½ï¿½tf
(1, "open dd/dd/../ff failed\n");

976 
	`exï¿½
();

978 
cc
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf));

979 if(
cc
 !ï¿½2 || 
buf
[0] != 'f'){

980 
	`ï¿½ï¿½tf
(1, "dd/dd/../ff wrong content\n");

981 
	`exï¿½
();

983 
	`ï¿½oï¿½
(
fd
);

985 if(
	`lï¿½k
("dd/dd/ff", "dd/dd/ffff") != 0){

986 
	`ï¿½ï¿½tf
(1, "link dd/dd/ff dd/dd/ffff failed\n");

987 
	`exï¿½
();

990 if(
	`uÆšk
("dd/dd/ff") != 0){

991 
	`ï¿½ï¿½tf
(1, "unlink dd/dd/ff failed\n");

992 
	`exï¿½
();

994 if(
	`Ý’
("dd/dd/ff", 
O_RDONLY
) >= 0){

995 
	`ï¿½ï¿½tf
(1, "open (unlinked) dd/dd/ff succeeded\n");

996 
	`exï¿½
();

999 if(
	`chdï¿½
("dd") != 0){

1000 
	`ï¿½ï¿½tf
(1, "chdir dd failed\n");

1001 
	`exï¿½
();

1003 if(
	`chdï¿½
("dd/../../dd") != 0){

1004 
	`ï¿½ï¿½tf
(1, "chdir dd/../../dd failed\n");

1005 
	`exï¿½
();

1007 if(
	`chdï¿½
("dd/../../../dd") != 0){

1008 
	`ï¿½ï¿½tf
(1, "chdir dd/../../dd failed\n");

1009 
	`exï¿½
();

1011 if(
	`chdï¿½
("./..") != 0){

1012 
	`ï¿½ï¿½tf
(1, "chdir ./.. failed\n");

1013 
	`exï¿½
();

1016 
fd
 = 
	`Ý’
("dd/dd/ffff", 0);

1017 if(
fd
 < 0){

1018 
	`ï¿½ï¿½tf
(1, "open dd/dd/ffff failed\n");

1019 
	`exï¿½
();

1021 if(
	`ï¿½ad
(
fd
, 
buf
, (buf)) != 2){

1022 
	`ï¿½ï¿½tf
(1, "read dd/dd/ffff wrongï¿½en\n");

1023 
	`exï¿½
();

1025 
	`ï¿½oï¿½
(
fd
);

1027 if(
	`Ý’
("dd/dd/ff", 
O_RDONLY
) >= 0){

1028 
	`ï¿½ï¿½tf
(1, "open (unlinked) dd/dd/ff succeeded!\n");

1029 
	`exï¿½
();

1032 if(
	`Ý’
("dd/ff/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1033 
	`ï¿½ï¿½tf
(1, "create dd/ff/ff succeeded!\n");

1034 
	`exï¿½
();

1036 if(
	`Ý’
("dd/xx/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1037 
	`ï¿½ï¿½tf
(1, "create dd/xx/ff succeeded!\n");

1038 
	`exï¿½
();

1040 if(
	`Ý’
("dd", 
O_CREATE
) >= 0){

1041 
	`ï¿½ï¿½tf
(1, "create dd succeeded!\n");

1042 
	`exï¿½
();

1044 if(
	`Ý’
("dd", 
O_RDWR
) >= 0){

1045 
	`ï¿½ï¿½tf
(1, "open ddï¿½dwr succeeded!\n");

1046 
	`exï¿½
();

1048 if(
	`Ý’
("dd", 
O_WRONLY
) >= 0){

1049 
	`ï¿½ï¿½tf
(1, "open dd wronly succeeded!\n");

1050 
	`exï¿½
();

1052 if(
	`lï¿½k
("dd/ff/ff", "dd/dd/xx") == 0){

1053 
	`ï¿½ï¿½tf
(1, "link dd/ff/ff dd/dd/xx succeeded!\n");

1054 
	`exï¿½
();

1056 if(
	`lï¿½k
("dd/xx/ff", "dd/dd/xx") == 0){

1057 
	`ï¿½ï¿½tf
(1, "link dd/xx/ff dd/dd/xx succeeded!\n");

1058 
	`exï¿½
();

1060 if(
	`lï¿½k
("dd/ff", "dd/dd/ffff") == 0){

1061 
	`ï¿½ï¿½tf
(1, "link dd/ff dd/dd/ffff succeeded!\n");

1062 
	`exï¿½
();

1064 if(
	`mkdï¿½
("dd/ff/ff") == 0){

1065 
	`ï¿½ï¿½tf
(1, "mkdir dd/ff/ff succeeded!\n");

1066 
	`exï¿½
();

1068 if(
	`mkdï¿½
("dd/xx/ff") == 0){

1069 
	`ï¿½ï¿½tf
(1, "mkdir dd/xx/ff succeeded!\n");

1070 
	`exï¿½
();

1072 if(
	`mkdï¿½
("dd/dd/ffff") == 0){

1073 
	`ï¿½ï¿½tf
(1, "mkdir dd/dd/ffff succeeded!\n");

1074 
	`exï¿½
();

1076 if(
	`uÆšk
("dd/xx/ff") == 0){

1077 
	`ï¿½ï¿½tf
(1, "unlink dd/xx/ff succeeded!\n");

1078 
	`exï¿½
();

1080 if(
	`uÆšk
("dd/ff/ff") == 0){

1081 
	`ï¿½ï¿½tf
(1, "unlink dd/ff/ff succeeded!\n");

1082 
	`exï¿½
();

1084 if(
	`chdï¿½
("dd/ff") == 0){

1085 
	`ï¿½ï¿½tf
(1, "chdir dd/ff succeeded!\n");

1086 
	`exï¿½
();

1088 if(
	`chdï¿½
("dd/xx") == 0){

1089 
	`ï¿½ï¿½tf
(1, "chdir dd/xx succeeded!\n");

1090 
	`exï¿½
();

1093 if(
	`uÆšk
("dd/dd/ffff") != 0){

1094 
	`ï¿½ï¿½tf
(1, "unlink dd/dd/ff failed\n");

1095 
	`exï¿½
();

1097 if(
	`uÆšk
("dd/ff") != 0){

1098 
	`ï¿½ï¿½tf
(1, "unlink dd/ff failed\n");

1099 
	`exï¿½
();

1101 if(
	`uÆšk
("dd") == 0){

1102 
	`ï¿½ï¿½tf
(1, "unlinkï¿½on-empty dd succeeded!\n");

1103 
	`exï¿½
();

1105 if(
	`uÆšk
("dd/dd") < 0){

1106 
	`ï¿½ï¿½tf
(1, "unlink dd/dd failed\n");

1107 
	`exï¿½
();

1109 if(
	`uÆšk
("dd") < 0){

1110 
	`ï¿½ï¿½tf
(1, "unlink dd failed\n");

1111 
	`exï¿½
();

1114 
	`ï¿½ï¿½tf
(1, "subdir ok\n");

1115 
	}
}

1119 
	$bigwrï¿½e
()

1121 
fd
, 
sz
;

1123 
	`ï¿½ï¿½tf
(1, "bigwriteï¿½est\n");

1125 
	`uÆšk
("bigwrite");

1126 
sz
 = 499; sz < 12*512; sz += 471){

1127 
fd
 = 
	`Ý’
("bigwrï¿½e", 
O_CREATE
 | 
O_RDWR
);

1128 if(
fd
 < 0){

1129 
	`ï¿½ï¿½tf
(1, "cannot create bigwrite\n");

1130 
	`exï¿½
();

1132 
i
;

1133 
i
 = 0; i < 2; i++){

1134 
cc
 = 
	`wrï¿½e
(
fd
, 
buf
, 
sz
);

1135 if(
cc
 !ï¿½
sz
){

1136 
	`ï¿½ï¿½tf
(1, "wrï¿½e(%dè»ˆ%d\n", 
sz
, 
cc
);

1137 
	`exï¿½
();

1140 
	`ï¿½oï¿½
(
fd
);

1141 
	`uÆšk
("bigwrite");

1144 
	`ï¿½ï¿½tf
(1, "bigwrite ok\n");

1145 
	}
}

1148 
	$bigfï¿½e
()

1150 
fd
, 
i
, 
tÙ®
, 
cc
;

1152 
	`ï¿½ï¿½tf
(1, "bigfileï¿½est\n");

1154 
	`uÆšk
("bigfile");

1155 
fd
 = 
	`Ý’
("bigfï¿½e", 
O_CREATE
 | 
O_RDWR
);

1156 if(
fd
 < 0){

1157 
	`ï¿½ï¿½tf
(1, "cannot create bigfile");

1158 
	`exï¿½
();

1160 
i
 = 0; i < 20; i++){

1161 
	`memï¿½t
(
buf
, 
i
, 600);

1162 if(
	`wrï¿½e
(
fd
, 
buf
, 600) != 600){

1163 
	`ï¿½ï¿½tf
(1, "write bigfile failed\n");

1164 
	`exï¿½
();

1167 
	`ï¿½oï¿½
(
fd
);

1169 
fd
 = 
	`Ý’
("bigfile", 0);

1170 if(
fd
 < 0){

1171 
	`ï¿½ï¿½tf
(1, "cannot open bigfile\n");

1172 
	`exï¿½
();

1174 
tÙ®
 = 0;

1175 
i
 = 0; ; i++){

1176 
cc
 = 
	`ï¿½ad
(
fd
, 
buf
, 300);

1177 if(
cc
 < 0){

1178 
	`ï¿½ï¿½tf
(1, "read bigfile failed\n");

1179 
	`exï¿½
();

1181 if(
cc
 == 0)

1183 if(
cc
 != 300){

1184 
	`ï¿½ï¿½tf
(1, "shortï¿½ead bigfile\n");

1185 
	`exï¿½
();

1187 if(
buf
[0] !ï¿½
i
/2 || buf[299] != i/2){

1188 
	`ï¿½ï¿½tf
(1, "read bigfile wrong data\n");

1189 
	`exï¿½
();

1191 
tÙ®
 +ï¿½
cc
;

1193 
	`ï¿½oï¿½
(
fd
);

1194 if(
tÙ®
 != 20*600){

1195 
	`ï¿½ï¿½tf
(1, "read bigfile wrongï¿½otal\n");

1196 
	`exï¿½
();

1198 
	`uÆšk
("bigfile");

1200 
	`ï¿½ï¿½tf
(1, "bigfileï¿½est ok\n");

1201 
	}
}

1204 
	$fouï¿½ï¿½n
()

1206 
fd
;

1209 
	`ï¿½ï¿½tf
(1, "fourteenï¿½est\n");

1211 if(
	`mkdï¿½
("12345678901234") != 0){

1212 
	`ï¿½ï¿½tf
(1, "mkdir 12345678901234 failed\n");

1213 
	`exï¿½
();

1215 if(
	`mkdï¿½
("12345678901234/123456789012345") != 0){

1216 
	`ï¿½ï¿½tf
(1, "mkdir 12345678901234/123456789012345 failed\n");

1217 
	`exï¿½
();

1219 
fd
 = 
	`Ý’
("123456789012345/123456789012345/123456789012345", 
O_CREATE
);

1220 if(
fd
 < 0){

1221 
	`ï¿½ï¿½tf
(1, "create 123456789012345/123456789012345/123456789012345 failed\n");

1222 
	`exï¿½
();

1224 
	`ï¿½oï¿½
(
fd
);

1225 
fd
 = 
	`Ý’
("12345678901234/12345678901234/12345678901234", 0);

1226 if(
fd
 < 0){

1227 
	`ï¿½ï¿½tf
(1, "open 12345678901234/12345678901234/12345678901234 failed\n");

1228 
	`exï¿½
();

1230 
	`ï¿½oï¿½
(
fd
);

1232 if(
	`mkdï¿½
("12345678901234/12345678901234") == 0){

1233 
	`ï¿½ï¿½tf
(1, "mkdir 12345678901234/12345678901234 succeeded!\n");

1234 
	`exï¿½
();

1236 if(
	`mkdï¿½
("123456789012345/12345678901234") == 0){

1237 
	`ï¿½ï¿½tf
(1, "mkdir 12345678901234/123456789012345 succeeded!\n");

1238 
	`exï¿½
();

1241 
	`ï¿½ï¿½tf
(1, "fourteen ok\n");

1242 
	}
}

1245 
	$rmdï¿½
()

1247 
	`ï¿½ï¿½tf
(1, "rmdotï¿½est\n");

1248 if(
	`mkdï¿½
("dots") != 0){

1249 
	`ï¿½ï¿½tf
(1, "mkdir dots failed\n");

1250 
	`exï¿½
();

1252 if(
	`chdï¿½
("dots") != 0){

1253 
	`ï¿½ï¿½tf
(1, "chdir dots failed\n");

1254 
	`exï¿½
();

1256 if(
	`uÆšk
(".") == 0){

1257 
	`ï¿½ï¿½tf
(1, "rm . worked!\n");

1258 
	`exï¿½
();

1260 if(
	`uÆšk
("..") == 0){

1261 
	`ï¿½ï¿½tf
(1, "rm .. worked!\n");

1262 
	`exï¿½
();

1264 if(
	`chdï¿½
("/") != 0){

1265 
	`ï¿½ï¿½tf
(1, "chdir / failed\n");

1266 
	`exï¿½
();

1268 if(
	`uÆšk
("dots/.") == 0){

1269 
	`ï¿½ï¿½tf
(1, "unlink dots/. worked!\n");

1270 
	`exï¿½
();

1272 if(
	`uÆšk
("dots/..") == 0){

1273 
	`ï¿½ï¿½tf
(1, "unlink dots/.. worked!\n");

1274 
	`exï¿½
();

1276 if(
	`uÆšk
("dots") != 0){

1277 
	`ï¿½ï¿½tf
(1, "unlink dots failed!\n");

1278 
	`exï¿½
();

1280 
	`ï¿½ï¿½tf
(1, "rmdot ok\n");

1281 
	}
}

1284 
	$dï¿½fï¿½e
()

1286 
fd
;

1288 
	`ï¿½ï¿½tf
(1, "dir vs file\n");

1290 
fd
 = 
	`Ý’
("dï¿½fï¿½e", 
O_CREATE
);

1291 if(
fd
 < 0){

1292 
	`ï¿½ï¿½tf
(1, "create dirfile failed\n");

1293 
	`exï¿½
();

1295 
	`ï¿½oï¿½
(
fd
);

1296 if(
	`chdï¿½
("dirfile") == 0){

1297 
	`ï¿½ï¿½tf
(1, "chdir dirfile succeeded!\n");

1298 
	`exï¿½
();

1300 
fd
 = 
	`Ý’
("dirfile/xx", 0);

1301 if(
fd
 >= 0){

1302 
	`ï¿½ï¿½tf
(1, "create dirfile/xx succeeded!\n");

1303 
	`exï¿½
();

1305 
fd
 = 
	`Ý’
("dï¿½fï¿½e/xx", 
O_CREATE
);

1306 if(
fd
 >= 0){

1307 
	`ï¿½ï¿½tf
(1, "create dirfile/xx succeeded!\n");

1308 
	`exï¿½
();

1310 if(
	`mkdï¿½
("dirfile/xx") == 0){

1311 
	`ï¿½ï¿½tf
(1, "mkdir dirfile/xx succeeded!\n");

1312 
	`exï¿½
();

1314 if(
	`uÆšk
("dirfile/xx") == 0){

1315 
	`ï¿½ï¿½tf
(1, "unlink dirfile/xx succeeded!\n");

1316 
	`exï¿½
();

1318 if(
	`lï¿½k
("README", "dirfile/xx") == 0){

1319 
	`ï¿½ï¿½tf
(1, "linkï¿½o dirfile/xx succeeded!\n");

1320 
	`exï¿½
();

1322 if(
	`uÆšk
("dirfile") != 0){

1323 
	`ï¿½ï¿½tf
(1, "unlink dirfile failed!\n");

1324 
	`exï¿½
();

1327 
fd
 = 
	`Ý’
(".", 
O_RDWR
);

1328 if(
fd
 >= 0){

1329 
	`ï¿½ï¿½tf
(1, "open . for writing succeeded!\n");

1330 
	`exï¿½
();

1332 
fd
 = 
	`Ý’
(".", 0);

1333 if(
	`wrï¿½e
(
fd
, "x", 1) > 0){

1334 
	`ï¿½ï¿½tf
(1, "write . succeeded!\n");

1335 
	`exï¿½
();

1337 
	`ï¿½oï¿½
(
fd
);

1339 
	`ï¿½ï¿½tf
(1, "dir vs file OK\n");

1340 
	}
}

1344 
	$ï¿½ef
()

1346 
i
, 
fd
;

1348 
	`ï¿½ï¿½tf
(1, "empty fileï¿½ame\n");

1351 
i
 = 0; i < 50 + 1; i++){

1352 if(
	`mkdï¿½
("irefd") != 0){

1353 
	`ï¿½ï¿½tf
(1, "mkdir irefd failed\n");

1354 
	`exï¿½
();

1356 if(
	`chdï¿½
("irefd") != 0){

1357 
	`ï¿½ï¿½tf
(1, "chdir irefd failed\n");

1358 
	`exï¿½
();

1361 
	`mkdï¿½
("");

1362 
	`lï¿½k
("README", "");

1363 
fd
 = 
	`Ý’
("", 
O_CREATE
);

1364 if(
fd
 >= 0)

1365 
	`ï¿½oï¿½
(
fd
);

1366 
fd
 = 
	`Ý’
("xx", 
O_CREATE
);

1367 if(
fd
 >= 0)

1368 
	`ï¿½oï¿½
(
fd
);

1369 
	`uÆšk
("xx");

1372 
	`chdï¿½
("/");

1373 
	`ï¿½ï¿½tf
(1, "empty fileï¿½ame OK\n");

1374 
	}
}

1380 
	$fï¿½kï¿½ï¿½
()

1382 
n
, 
pid
;

1384 
	`ï¿½ï¿½tf
(1, "forkï¿½est\n");

1386 
n
=0;ï¿½<1000;ï¿½++){

1387 
pid
 = 
	`fï¿½k
();

1388 if(
pid
 < 0)

1390 if(
pid
 == 0)

1391 
	`exï¿½
();

1394 if(
n
 == 1000){

1395 
	`ï¿½ï¿½tf
(1, "fork claimedï¿½o work 1000ï¿½imes!\n");

1396 
	`exï¿½
();

1399 ; 
n
 > 0;ï¿½--){

1400 if(
	`waï¿½
() < 0){

1401 
	`ï¿½ï¿½tf
(1, "wait stoppedï¿½arly\n");

1402 
	`exï¿½
();

1406 if(
	`waï¿½
() != -1){

1407 
	`ï¿½ï¿½tf
(1, "wait gotï¿½oo many\n");

1408 
	`exï¿½
();

1411 
	`ï¿½ï¿½tf
(1, "forkï¿½est OK\n");

1412 
	}
}

1415 
	$sbrkï¿½ï¿½
()

1417 
fds
[2], 
pid
, 
pids
[10], 
ï¿½id
;

1418 *
a
, *
b
, *
c
, *
Ï¡addr
, *
ï¿½dbrk
, *
p
, 
sï¿½ï¿½ch
;

1419 
uï¿½t
 
amt
;

1421 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½est\n");

1422 
ï¿½dbrk
 = 
	`sbrk
(0);

1425 
a
 = 
	`sbrk
(0);

1426 
i
;

1427 
i
 = 0; i < 5000; i++){

1428 
b
 = 
	`sbrk
(1);

1429 if(
b
 !ï¿½
a
){

1430 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½eï¿½ faï¿½ed %d %x %x\n", 
i
, 
a
, 
b
);

1431 
	`exï¿½
();

1433 *
b
 = 1;

1434 
a
 = 
b
 + 1;

1436 
pid
 = 
	`fï¿½k
();

1437 if(
pid
 < 0){

1438 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½est fork failed\n");

1439 
	`exï¿½
();

1441 
c
 = 
	`sbrk
(1);

1442 
c
 = 
	`sbrk
(1);

1443 if(
c
 !ï¿½
a
 + 1){

1444 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½est failedï¿½ost-fork\n");

1445 
	`exï¿½
();

1447 if(
pid
 == 0)

1448 
	`exï¿½
();

1449 
	`waï¿½
();

1452 
	#BIG
 (100*1024*1024)

	)

1453 
a
 = 
	`sbrk
(0);

1454 
amt
 = (
BIG
ï¿½- (
uï¿½t
)
a
;

1455 
p
 = 
	`sbrk
(
amt
);

1456 iï¿½(
p
 !ï¿½
a
) {

1457 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½est failedï¿½o grow bigï¿½ddress space;ï¿½noughï¿½hys mem?\n");

1458 
	`exï¿½
();

1460 
Ï¡addr
 = (*ï¿½(
BIG
-1);

1461 *
Ï¡addr
 = 99;

1464 
a
 = 
	`sbrk
(0);

1465 
c
 = 
	`sbrk
(-4096);

1466 if(
c
 == (*)0xffffffff){

1467 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrk couldï¿½ot deallocate\n");

1468 
	`exï¿½
();

1470 
c
 = 
	`sbrk
(0);

1471 if(
c
 !ï¿½
a
 - 4096){

1472 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrk dï¿½ï¿½oï¿½tiÚ…roduï¿½d wrï¿½gï¿½ddï¿½ss,ï¿½ %x c %x\n", 
a
, 
c
);

1473 
	`exï¿½
();

1477 
a
 = 
	`sbrk
(0);

1478 
c
 = 
	`sbrk
(4096);

1479 if(
c
 !ï¿½
a
 || 
	`sbrk
(0) !=ï¿½ + 4096){

1480 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½e-ï¿½loï¿½tiï¿½ faï¿½ed,ï¿½ %x c %x\n", 
a
, 
c
);

1481 
	`exï¿½
();

1483 if(*
Ï¡addr
 == 99){

1485 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrk de-allocation didn'tï¿½eally deallocate\n");

1486 
	`exï¿½
();

1489 
a
 = 
	`sbrk
(0);

1490 
c
 = 
	`sbrk
(-(sbrk(0ï¿½- 
ï¿½dbrk
));

1491 if(
c
 !ï¿½
a
){

1492 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrk downsizï¿½ï¿½ed,ï¿½ %x c %x\n", 
a
, 
c
);

1493 
	`exï¿½
();

1497 
a
 = (*)(
KERNBASE
);ï¿½ < (*) (KERNBASE+2000000);ï¿½ += 50000){

1498 
ï¿½id
 = 
	`gï¿½pid
();

1499 
pid
 = 
	`fï¿½k
();

1500 if(
pid
 < 0){

1501 
	`ï¿½ï¿½tf
(
ï¿½dout
, "fork failed\n");

1502 
	`exï¿½
();

1504 if(
pid
 == 0){

1505 
	`ï¿½ï¿½tf
(
ï¿½dout
, "oÝ couldï¿½ï¿½d %x = %x\n", 
a
, *a);

1506 
	`kï¿½l
(
ï¿½id
);

1507 
	`exï¿½
();

1509 
	`waï¿½
();

1514 if(
	`pï¿½e
(
fds
) != 0){

1515 
	`ï¿½ï¿½tf
(1, "pipe() failed\n");

1516 
	`exï¿½
();

1518 
i
 = 0; i < (
pids
)/(pids[0]); i++){

1519 if((
pids
[
i
] = 
	`fï¿½k
()) == 0){

1521 
	`sbrk
(
BIG
 - (
uï¿½t
)sbrk(0));

1522 
	`wrï¿½e
(
fds
[1], "x", 1);

1524 ;;ï¿½
	`ï¿½ï¿½p
(1000);

1526 if(
pids
[
i
] != -1)

1527 
	`ï¿½ad
(
fds
[0], &
sï¿½ï¿½ch
, 1);

1531 
c
 = 
	`sbrk
(4096);

1532 
i
 = 0; i < (
pids
)/(pids[0]); i++){

1533 if(
pids
[
i
] == -1)

1535 
	`kï¿½l
(
pids
[
i
]);

1536 
	`waï¿½
();

1538 if(
c
 == (*)0xffffffff){

1539 
	`ï¿½ï¿½tf
(
ï¿½dout
, "failed sbrkï¿½eaked memory\n");

1540 
	`exï¿½
();

1543 if(
	`sbrk
(0ï¿½> 
ï¿½dbrk
)

1544 
	`sbrk
(-(sbrk(0ï¿½- 
ï¿½dbrk
));

1546 
	`ï¿½ï¿½tf
(
ï¿½dout
, "sbrkï¿½est OK\n");

1547 
	}
}

1550 
	$vï¿½idï¿½eï¿½t
(*
p
)

1552 
ï¿½s
;

1553 
	`asm
("mov %%esp, %%ebx\n\t"

1557 "ï¿½" (
ï¿½s
) :

1558 "a" (
SYS_ï¿½ï¿½p
), "n" (
T_SYSCALL
), "c" (
p
) :

1560 
	}
}

1563 
	$vï¿½idï¿½ï¿½eï¿½
()

1565 
hi
, 
pid
;

1566 
uï¿½t
 
p
;

1568 
	`ï¿½ï¿½tf
(
ï¿½dout
, "validateï¿½est\n");

1569 
hi
 = 1100*1024;

1571 
p
 = 0;ï¿½ <ï¿½(
uï¿½t
)
hi
;ï¿½ += 4096){

1572 if((
pid
 = 
	`fï¿½k
()) == 0){

1574 
	`vï¿½idï¿½eï¿½t
((*)
p
);

1575 
	`exï¿½
();

1577 
	`ï¿½ï¿½p
(0);

1578 
	`ï¿½ï¿½p
(0);

1579 
	`kï¿½l
(
pid
);

1580 
	`waï¿½
();

1583 if(
	`lï¿½k
("nosuchfï¿½e", (*)
p
) != -1){

1584 
	`ï¿½ï¿½tf
(
ï¿½dout
, "link shouldï¿½ot succeed\n");

1585 
	`exï¿½
();

1589 
	`ï¿½ï¿½tf
(
ï¿½dout
, "validate ok\n");

1590 
	}
}

1593 
	gunï¿½ï¿½
[10000];

1595 
	$bsï¿½eï¿½
()

1597 
i
;

1599 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bssï¿½est\n");

1600 
i
 = 0; i < (
unï¿½ï¿½
); i++){

1601 if(
unï¿½ï¿½
[
i
] != '\0'){

1602 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bssï¿½est failed\n");

1603 
	`exï¿½
();

1606 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bssï¿½est ok\n");

1607 
	}
}

1613 
	$bigï¿½gï¿½ï¿½
()

1615 
pid
, 
fd
;

1617 
	`uÆšk
("bigarg-ok");

1618 
pid
 = 
	`fï¿½k
();

1619 if(
pid
 == 0){

1620 *
ï¿½gs
[
MAXARG
];

1621 
i
;

1622 
i
 = 0; i < 
MAXARG
-1; i++)

1623 
ï¿½gs
[
i
] = "bigargsï¿½est: failed\n ";

1624 
ï¿½gs
[
MAXARG
-1] = 0;

1625 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bigargï¿½est\n");

1626 
	`exec
("echo", 
ï¿½gs
);

1627 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bigargï¿½est ok\n");

1628 
fd
 = 
	`Ý’
("bigï¿½g-ok", 
O_CREATE
);

1629 
	`ï¿½oï¿½
(
fd
);

1630 
	`exï¿½
();

1631 } if(
pid
 < 0){

1632 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bigargtest: fork failed\n");

1633 
	`exï¿½
();

1635 
	`waï¿½
();

1636 
fd
 = 
	`Ý’
("bigarg-ok", 0);

1637 if(
fd
 < 0){

1638 
	`ï¿½ï¿½tf
(
ï¿½dout
, "bigargï¿½est failed!\n");

1639 
	`exï¿½
();

1641 
	`ï¿½oï¿½
(
fd
);

1642 
	`uÆšk
("bigarg-ok");

1643 
	}
}

1648 
	$fsfuï¿½
()

1650 
nfï¿½es
;

1651 
fsblocks
 = 0;

1653 
	`ï¿½ï¿½tf
(1, "fsfullï¿½est\n");

1655 
nfï¿½es
 = 0; ;ï¿½files++){

1656 
ï¿½me
[64];

1657 
ï¿½me
[0] = 'f';

1658 
ï¿½me
[1] = '0' + 
nfï¿½es
 / 1000;

1659 
ï¿½me
[2] = '0' + (
nfï¿½es
 % 1000) / 100;

1660 
ï¿½me
[3] = '0' + (
nfï¿½es
 % 100) / 10;

1661 
ï¿½me
[4] = '0' + (
nfï¿½es
 % 10);

1662 
ï¿½me
[5] = '\0';

1663 
	`ï¿½ï¿½tf
(1, "wrï¿½ï¿½g %s\n", 
ï¿½me
);

1664 
fd
 = 
	`Ý’
(
ï¿½me
, 
O_CREATE
|
O_RDWR
);

1665 if(
fd
 < 0){

1666 
	`ï¿½ï¿½tf
(1, "Ý’ %ï¿½ï¿½ed\n", 
ï¿½me
);

1669 
tÙ®
 = 0;

1671 
cc
 = 
	`wrï¿½e
(
fd
, 
buf
, 512);

1672 if(
cc
 < 512)

1674 
tÙ®
 +ï¿½
cc
;

1675 
fsblocks
++;

1677 
	`ï¿½ï¿½tf
(1, "wrÙ%d byï¿½s\n", 
tÙ®
);

1678 
	`ï¿½oï¿½
(
fd
);

1679 if(
tÙ®
 == 0)

1683 
nfï¿½es
 >= 0){

1684 
ï¿½me
[64];

1685 
ï¿½me
[0] = 'f';

1686 
ï¿½me
[1] = '0' + 
nfï¿½es
 / 1000;

1687 
ï¿½me
[2] = '0' + (
nfï¿½es
 % 1000) / 100;

1688 
ï¿½me
[3] = '0' + (
nfï¿½es
 % 100) / 10;

1689 
ï¿½me
[4] = '0' + (
nfï¿½es
 % 10);

1690 
ï¿½me
[5] = '\0';

1691 
	`uÆšk
(
ï¿½me
);

1692 
nfï¿½es
--;

1695 
	`ï¿½ï¿½tf
(1, "fsfullï¿½est finished\n");

1696 
	}
}

1699 
	$uio
()

1701 
	#RTC_ADDR
 0x70

	)

1702 
	#RTC_DATA
 0x71

	)

1704 
ushï¿½t
 
pï¿½t
 = 0;

1705 
uchï¿½
 
vï¿½
 = 0;

1706 
pid
;

1708 
	`ï¿½ï¿½tf
(1, "uioï¿½est\n");

1709 
pid
 = 
	`fï¿½k
();

1710 if(
pid
 == 0){

1711 
pï¿½t
 = 
RTC_ADDR
;

1712 
vï¿½
 = 0x09;

1714 
asm
 vÞ©ï¿½e("outb %0,%1"::"a"(
vï¿½
), "d" (
pï¿½t
));

1715 
pï¿½t
 = 
RTC_DATA
;

1716 
asm
 vÞ©ï¿½e("ï¿½b %1,%0" : "ï¿½" (
vï¿½
ï¿½: "d" (
pï¿½t
));

1717 
	`ï¿½ï¿½tf
(1, "uio: uio succeeded;ï¿½est FAILED\n");

1718 
	`exï¿½
();

1719 } if(
pid
 < 0){

1720 
	`ï¿½ï¿½tf
 (1, "fork failed\n");

1721 
	`exï¿½
();

1723 
	`waï¿½
();

1724 
	`ï¿½ï¿½tf
(1, "uioï¿½est done\n");

1725 
	}
}

1727 
	$ï¿½gï¿½eï¿½
()

1729 
fd
;

1730 
fd
 = 
	`Ý’
("ï¿½ï¿½", 
O_RDONLY
);

1731 iï¿½(
fd
 < 0) {

1732 
	`ï¿½ï¿½tf
(2, "open failed\n");

1733 
	`exï¿½
();

1735 
	`ï¿½ad
(
fd
, 
	`sbrk
(0) - 1, -1);

1736 
	`ï¿½oï¿½
(
fd
);

1737 
	`ï¿½ï¿½tf
(1, "argï¿½estï¿½assed\n");

1738 
	}
}

1740 
	gï¿½ndï¿½ï¿½e
 = 1;

1742 
	$ï¿½nd
()

1744 
ï¿½ndï¿½ï¿½e
 =ï¿½andstate * 1664525 + 1013904223;

1745  
ï¿½ndï¿½ï¿½e
;

1746 
	}
}

1749 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

1751 
	`ï¿½ï¿½tf
(1, "usertests starting\n");

1753 if(
	`Ý’
("usertests.ran", 0) >= 0){

1754 
	`ï¿½ï¿½tf
(1, "alreadyï¿½an userï¿½ests --ï¿½ebuild fs.img\n");

1755 
	`exï¿½
();

1757 
	`ï¿½oï¿½
(
	`Ý’
("uï¿½ï¿½eï¿½s.ï¿½n", 
O_CREATE
));

1759 
	`ï¿½gï¿½eï¿½
();

1760 
	`ï¿½ï¿½ï¿½dï¿½ï¿½e
();

1761 
	`lï¿½kuÆšk
();

1762 
	`cï¿½ï¿½ï¿½ï¿½
();

1763 
	`fourfï¿½es
();

1764 
	`shï¿½edfd
();

1766 
	`bigï¿½gï¿½ï¿½
();

1767 
	`bigwrï¿½e
();

1768 
	`bigï¿½gï¿½ï¿½
();

1769 
	`bsï¿½eï¿½
();

1770 
	`sbrkï¿½ï¿½
();

1771 
	`vï¿½idï¿½ï¿½eï¿½
();

1773 
	`Ý’ï¿½ï¿½
();

1774 
	`wrï¿½ï¿½eï¿½
();

1775 
	`wrï¿½ï¿½eï¿½1
();

1776 
	`ï¿½ï¿½ï¿½ï¿½ï¿½
();

1778 
	`Ý’ï¿½uï¿½eï¿½
();

1779 
	`exï¿½ï¿½uï¿½eï¿½
();

1780 
	`ï¿½uï¿½eï¿½
();

1782 
	`mem
();

1783 
	`pï¿½e1
();

1784 
	`ï¿½ï¿½mï¿½
();

1785 
	`exï¿½waï¿½
();

1787 
	`rmdï¿½
();

1788 
	`fouï¿½ï¿½n
();

1789 
	`bigfï¿½e
();

1790 
	`subdï¿½
();

1791 
	`lï¿½kï¿½ï¿½
();

1792 
	`uÆškï¿½ad
();

1793 
	`dï¿½fï¿½e
();

1794 
	`ï¿½ef
();

1795 
	`fï¿½kï¿½ï¿½
();

1796 
	`bigdï¿½
();

1798 
	`uio
();

1800 
	`exeï¿½eï¿½
();

1802 
	`exï¿½
();

1803 
	}
}

	@usys.S

1 
	~"sysï¿½ï¿½.h
"

2 
	~"ï¿½ï¿½s.h
"

4 
	#SYSCALL
(
ï¿½me
) \

5 .
globl
 
ï¿½me
; \

6 
ï¿½me
: \

7 
movl
 
$SYS_
 ## 
ï¿½me
, %
ï¿½x
; \

8 
$T_SYSCALL
; \

9 
ï¿½t


	)

11 
	$SYSCALL
(
fï¿½k
)

12 
	$SYSCALL
(
exï¿½
)

13 
	$SYSCALL
(
waï¿½
)

14 
	$SYSCALL
(
pï¿½e
)

15 
	$SYSCALL
(
ï¿½ad
)

16 
	$SYSCALL
(
wrï¿½e
)

17 
	$SYSCALL
(
ï¿½oï¿½
)

18 
	$SYSCALL
(
kï¿½l
)

19 
	$SYSCALL
(
exec
)

20 
	$SYSCALL
(
Ý’
)

21 
	$SYSCALL
(
mknod
)

22 
	$SYSCALL
(
uÆšk
)

23 
	$SYSCALL
(
fï¿½ï¿½
)

24 
	$SYSCALL
(
lï¿½k
)

25 
	$SYSCALL
(
mkdï¿½
)

26 
	$SYSCALL
(
chdï¿½
)

27 
	$SYSCALL
(
dup
)

28 
	$SYSCALL
(
gï¿½pid
)

29 
	$SYSCALL
(
sbrk
)

30 
	$SYSCALL
(
ï¿½ï¿½p
)

31 
	`SYSCALL
(
uï¿½ime
)

	@vectors.S

1 #gï¿½ï¿½ï¿½ed 
by
 
veï¿½ï¿½s
.
ï¿½
 - dï¿½
nï¿½
 
edï¿½


3 .
globl
 
	gï¿½É¿ps


4 .
globl
 
veï¿½ï¿½0


5 
	gveï¿½ï¿½0
:

6 
pushl
 
$0


7 
pushl
 
$0


8 
jmp
 
ï¿½É¿ps


9 .
globl
 
veï¿½ï¿½1


10 
veï¿½ï¿½1
:

11 
pushl
 
$0


12 
pushl
 
$1


13 
jmp
 
ï¿½É¿ps


14 .
globl
 
veï¿½ï¿½2


15 
veï¿½ï¿½2
:

16 
pushl
 
$0


17 
pushl
 
$2


18 
jmp
 
ï¿½É¿ps


19 .
globl
 
veï¿½ï¿½3


20 
veï¿½ï¿½3
:

21 
pushl
 
$0


22 
pushl
 
$3


23 
jmp
 
ï¿½É¿ps


24 .
globl
 
veï¿½ï¿½4


25 
veï¿½ï¿½4
:

26 
pushl
 
$0


27 
pushl
 
$4


28 
jmp
 
ï¿½É¿ps


29 .
globl
 
veï¿½ï¿½5


30 
veï¿½ï¿½5
:

31 
pushl
 
$0


32 
pushl
 
$5


33 
jmp
 
ï¿½É¿ps


34 .
globl
 
veï¿½ï¿½6


35 
veï¿½ï¿½6
:

36 
pushl
 
$0


37 
pushl
 
$6


38 
jmp
 
ï¿½É¿ps


39 .
globl
 
veï¿½ï¿½7


40 
veï¿½ï¿½7
:

41 
pushl
 
$0


42 
pushl
 
$7


43 
jmp
 
ï¿½É¿ps


44 .
globl
 
veï¿½ï¿½8


45 
veï¿½ï¿½8
:

46 
pushl
 
$8


47 
jmp
 
ï¿½É¿ps


48 .
globl
 
veï¿½ï¿½9


49 
veï¿½ï¿½9
:

50 
pushl
 
$0


51 
pushl
 
$9


52 
jmp
 
ï¿½É¿ps


53 .
globl
 
veï¿½ï¿½10


54 
veï¿½ï¿½10
:

55 
pushl
 
$10


56 
jmp
 
ï¿½É¿ps


57 .
globl
 
veï¿½ï¿½11


58 
veï¿½ï¿½11
:

59 
pushl
 
$11


60 
jmp
 
ï¿½É¿ps


61 .
globl
 
veï¿½ï¿½12


62 
veï¿½ï¿½12
:

63 
pushl
 
$12


64 
jmp
 
ï¿½É¿ps


65 .
globl
 
veï¿½ï¿½13


66 
veï¿½ï¿½13
:

67 
pushl
 
$13


68 
jmp
 
ï¿½É¿ps


69 .
globl
 
veï¿½ï¿½14


70 
veï¿½ï¿½14
:

71 
pushl
 
$14


72 
jmp
 
ï¿½É¿ps


73 .
globl
 
veï¿½ï¿½15


74 
veï¿½ï¿½15
:

75 
pushl
 
$0


76 
pushl
 
$15


77 
jmp
 
ï¿½É¿ps


78 .
globl
 
veï¿½ï¿½16


79 
veï¿½ï¿½16
:

80 
pushl
 
$0


81 
pushl
 
$16


82 
jmp
 
ï¿½É¿ps


83 .
globl
 
veï¿½ï¿½17


84 
veï¿½ï¿½17
:

85 
pushl
 
$17


86 
jmp
 
ï¿½É¿ps


87 .
globl
 
veï¿½ï¿½18


88 
veï¿½ï¿½18
:

89 
pushl
 
$0


90 
pushl
 
$18


91 
jmp
 
ï¿½É¿ps


92 .
globl
 
veï¿½ï¿½19


93 
veï¿½ï¿½19
:

94 
pushl
 
$0


95 
pushl
 
$19


96 
jmp
 
ï¿½É¿ps


97 .
globl
 
veï¿½ï¿½20


98 
veï¿½ï¿½20
:

99 
pushl
 
$0


100 
pushl
 
$20


101 
jmp
 
ï¿½É¿ps


102 .
globl
 
veï¿½ï¿½21


103 
veï¿½ï¿½21
:

104 
pushl
 
$0


105 
pushl
 
$21


106 
jmp
 
ï¿½É¿ps


107 .
globl
 
veï¿½ï¿½22


108 
veï¿½ï¿½22
:

109 
pushl
 
$0


110 
pushl
 
$22


111 
jmp
 
ï¿½É¿ps


112 .
globl
 
veï¿½ï¿½23


113 
veï¿½ï¿½23
:

114 
pushl
 
$0


115 
pushl
 
$23


116 
jmp
 
ï¿½É¿ps


117 .
globl
 
veï¿½ï¿½24


118 
veï¿½ï¿½24
:

119 
pushl
 
$0


120 
pushl
 
$24


121 
jmp
 
ï¿½É¿ps


122 .
globl
 
veï¿½ï¿½25


123 
veï¿½ï¿½25
:

124 
pushl
 
$0


125 
pushl
 
$25


126 
jmp
 
ï¿½É¿ps


127 .
globl
 
veï¿½ï¿½26


128 
veï¿½ï¿½26
:

129 
pushl
 
$0


130 
pushl
 
$26


131 
jmp
 
ï¿½É¿ps


132 .
globl
 
veï¿½ï¿½27


133 
veï¿½ï¿½27
:

134 
pushl
 
$0


135 
pushl
 
$27


136 
jmp
 
ï¿½É¿ps


137 .
globl
 
veï¿½ï¿½28


138 
veï¿½ï¿½28
:

139 
pushl
 
$0


140 
pushl
 
$28


141 
jmp
 
ï¿½É¿ps


142 .
globl
 
veï¿½ï¿½29


143 
veï¿½ï¿½29
:

144 
pushl
 
$0


145 
pushl
 
$29


146 
jmp
 
ï¿½É¿ps


147 .
globl
 
veï¿½ï¿½30


148 
veï¿½ï¿½30
:

149 
pushl
 
$0


150 
pushl
 
$30


151 
jmp
 
ï¿½É¿ps


152 .
globl
 
veï¿½ï¿½31


153 
veï¿½ï¿½31
:

154 
pushl
 
$0


155 
pushl
 
$31


156 
jmp
 
ï¿½É¿ps


157 .
globl
 
veï¿½ï¿½32


158 
veï¿½ï¿½32
:

159 
pushl
 
$0


160 
pushl
 
$32


161 
jmp
 
ï¿½É¿ps


162 .
globl
 
veï¿½ï¿½33


163 
veï¿½ï¿½33
:

164 
pushl
 
$0


165 
pushl
 
$33


166 
jmp
 
ï¿½É¿ps


167 .
globl
 
veï¿½ï¿½34


168 
veï¿½ï¿½34
:

169 
pushl
 
$0


170 
pushl
 
$34


171 
jmp
 
ï¿½É¿ps


172 .
globl
 
veï¿½ï¿½35


173 
veï¿½ï¿½35
:

174 
pushl
 
$0


175 
pushl
 
$35


176 
jmp
 
ï¿½É¿ps


177 .
globl
 
veï¿½ï¿½36


178 
veï¿½ï¿½36
:

179 
pushl
 
$0


180 
pushl
 
$36


181 
jmp
 
ï¿½É¿ps


182 .
globl
 
veï¿½ï¿½37


183 
veï¿½ï¿½37
:

184 
pushl
 
$0


185 
pushl
 
$37


186 
jmp
 
ï¿½É¿ps


187 .
globl
 
veï¿½ï¿½38


188 
veï¿½ï¿½38
:

189 
pushl
 
$0


190 
pushl
 
$38


191 
jmp
 
ï¿½É¿ps


192 .
globl
 
veï¿½ï¿½39


193 
veï¿½ï¿½39
:

194 
pushl
 
$0


195 
pushl
 
$39


196 
jmp
 
ï¿½É¿ps


197 .
globl
 
veï¿½ï¿½40


198 
veï¿½ï¿½40
:

199 
pushl
 
$0


200 
pushl
 
$40


201 
jmp
 
ï¿½É¿ps


202 .
globl
 
veï¿½ï¿½41


203 
veï¿½ï¿½41
:

204 
pushl
 
$0


205 
pushl
 
$41


206 
jmp
 
ï¿½É¿ps


207 .
globl
 
veï¿½ï¿½42


208 
veï¿½ï¿½42
:

209 
pushl
 
$0


210 
pushl
 
$42


211 
jmp
 
ï¿½É¿ps


212 .
globl
 
veï¿½ï¿½43


213 
veï¿½ï¿½43
:

214 
pushl
 
$0


215 
pushl
 
$43


216 
jmp
 
ï¿½É¿ps


217 .
globl
 
veï¿½ï¿½44


218 
veï¿½ï¿½44
:

219 
pushl
 
$0


220 
pushl
 
$44


221 
jmp
 
ï¿½É¿ps


222 .
globl
 
veï¿½ï¿½45


223 
veï¿½ï¿½45
:

224 
pushl
 
$0


225 
pushl
 
$45


226 
jmp
 
ï¿½É¿ps


227 .
globl
 
veï¿½ï¿½46


228 
veï¿½ï¿½46
:

229 
pushl
 
$0


230 
pushl
 
$46


231 
jmp
 
ï¿½É¿ps


232 .
globl
 
veï¿½ï¿½47


233 
veï¿½ï¿½47
:

234 
pushl
 
$0


235 
pushl
 
$47


236 
jmp
 
ï¿½É¿ps


237 .
globl
 
veï¿½ï¿½48


238 
veï¿½ï¿½48
:

239 
pushl
 
$0


240 
pushl
 
$48


241 
jmp
 
ï¿½É¿ps


242 .
globl
 
veï¿½ï¿½49


243 
veï¿½ï¿½49
:

244 
pushl
 
$0


245 
pushl
 
$49


246 
jmp
 
ï¿½É¿ps


247 .
globl
 
veï¿½ï¿½50


248 
veï¿½ï¿½50
:

249 
pushl
 
$0


250 
pushl
 
$50


251 
jmp
 
ï¿½É¿ps


252 .
globl
 
veï¿½ï¿½51


253 
veï¿½ï¿½51
:

254 
pushl
 
$0


255 
pushl
 
$51


256 
jmp
 
ï¿½É¿ps


257 .
globl
 
veï¿½ï¿½52


258 
veï¿½ï¿½52
:

259 
pushl
 
$0


260 
pushl
 
$52


261 
jmp
 
ï¿½É¿ps


262 .
globl
 
veï¿½ï¿½53


263 
veï¿½ï¿½53
:

264 
pushl
 
$0


265 
pushl
 
$53


266 
jmp
 
ï¿½É¿ps


267 .
globl
 
veï¿½ï¿½54


268 
veï¿½ï¿½54
:

269 
pushl
 
$0


270 
pushl
 
$54


271 
jmp
 
ï¿½É¿ps


272 .
globl
 
veï¿½ï¿½55


273 
veï¿½ï¿½55
:

274 
pushl
 
$0


275 
pushl
 
$55


276 
jmp
 
ï¿½É¿ps


277 .
globl
 
veï¿½ï¿½56


278 
veï¿½ï¿½56
:

279 
pushl
 
$0


280 
pushl
 
$56


281 
jmp
 
ï¿½É¿ps


282 .
globl
 
veï¿½ï¿½57


283 
veï¿½ï¿½57
:

284 
pushl
 
$0


285 
pushl
 
$57


286 
jmp
 
ï¿½É¿ps


287 .
globl
 
veï¿½ï¿½58


288 
veï¿½ï¿½58
:

289 
pushl
 
$0


290 
pushl
 
$58


291 
jmp
 
ï¿½É¿ps


292 .
globl
 
veï¿½ï¿½59


293 
veï¿½ï¿½59
:

294 
pushl
 
$0


295 
pushl
 
$59


296 
jmp
 
ï¿½É¿ps


297 .
globl
 
veï¿½ï¿½60


298 
veï¿½ï¿½60
:

299 
pushl
 
$0


300 
pushl
 
$60


301 
jmp
 
ï¿½É¿ps


302 .
globl
 
veï¿½ï¿½61


303 
veï¿½ï¿½61
:

304 
pushl
 
$0


305 
pushl
 
$61


306 
jmp
 
ï¿½É¿ps


307 .
globl
 
veï¿½ï¿½62


308 
veï¿½ï¿½62
:

309 
pushl
 
$0


310 
pushl
 
$62


311 
jmp
 
ï¿½É¿ps


312 .
globl
 
veï¿½ï¿½63


313 
veï¿½ï¿½63
:

314 
pushl
 
$0


315 
pushl
 
$63


316 
jmp
 
ï¿½É¿ps


317 .
globl
 
veï¿½ï¿½64


318 
veï¿½ï¿½64
:

319 
pushl
 
$0


320 
pushl
 
$64


321 
jmp
 
ï¿½É¿ps


322 .
globl
 
veï¿½ï¿½65


323 
veï¿½ï¿½65
:

324 
pushl
 
$0


325 
pushl
 
$65


326 
jmp
 
ï¿½É¿ps


327 .
globl
 
veï¿½ï¿½66


328 
veï¿½ï¿½66
:

329 
pushl
 
$0


330 
pushl
 
$66


331 
jmp
 
ï¿½É¿ps


332 .
globl
 
veï¿½ï¿½67


333 
veï¿½ï¿½67
:

334 
pushl
 
$0


335 
pushl
 
$67


336 
jmp
 
ï¿½É¿ps


337 .
globl
 
veï¿½ï¿½68


338 
veï¿½ï¿½68
:

339 
pushl
 
$0


340 
pushl
 
$68


341 
jmp
 
ï¿½É¿ps


342 .
globl
 
veï¿½ï¿½69


343 
veï¿½ï¿½69
:

344 
pushl
 
$0


345 
pushl
 
$69


346 
jmp
 
ï¿½É¿ps


347 .
globl
 
veï¿½ï¿½70


348 
veï¿½ï¿½70
:

349 
pushl
 
$0


350 
pushl
 
$70


351 
jmp
 
ï¿½É¿ps


352 .
globl
 
veï¿½ï¿½71


353 
veï¿½ï¿½71
:

354 
pushl
 
$0


355 
pushl
 
$71


356 
jmp
 
ï¿½É¿ps


357 .
globl
 
veï¿½ï¿½72


358 
veï¿½ï¿½72
:

359 
pushl
 
$0


360 
pushl
 
$72


361 
jmp
 
ï¿½É¿ps


362 .
globl
 
veï¿½ï¿½73


363 
veï¿½ï¿½73
:

364 
pushl
 
$0


365 
pushl
 
$73


366 
jmp
 
ï¿½É¿ps


367 .
globl
 
veï¿½ï¿½74


368 
veï¿½ï¿½74
:

369 
pushl
 
$0


370 
pushl
 
$74


371 
jmp
 
ï¿½É¿ps


372 .
globl
 
veï¿½ï¿½75


373 
veï¿½ï¿½75
:

374 
pushl
 
$0


375 
pushl
 
$75


376 
jmp
 
ï¿½É¿ps


377 .
globl
 
veï¿½ï¿½76


378 
veï¿½ï¿½76
:

379 
pushl
 
$0


380 
pushl
 
$76


381 
jmp
 
ï¿½É¿ps


382 .
globl
 
veï¿½ï¿½77


383 
veï¿½ï¿½77
:

384 
pushl
 
$0


385 
pushl
 
$77


386 
jmp
 
ï¿½É¿ps


387 .
globl
 
veï¿½ï¿½78


388 
veï¿½ï¿½78
:

389 
pushl
 
$0


390 
pushl
 
$78


391 
jmp
 
ï¿½É¿ps


392 .
globl
 
veï¿½ï¿½79


393 
veï¿½ï¿½79
:

394 
pushl
 
$0


395 
pushl
 
$79


396 
jmp
 
ï¿½É¿ps


397 .
globl
 
veï¿½ï¿½80


398 
veï¿½ï¿½80
:

399 
pushl
 
$0


400 
pushl
 
$80


401 
jmp
 
ï¿½É¿ps


402 .
globl
 
veï¿½ï¿½81


403 
veï¿½ï¿½81
:

404 
pushl
 
$0


405 
pushl
 
$81


406 
jmp
 
ï¿½É¿ps


407 .
globl
 
veï¿½ï¿½82


408 
veï¿½ï¿½82
:

409 
pushl
 
$0


410 
pushl
 
$82


411 
jmp
 
ï¿½É¿ps


412 .
globl
 
veï¿½ï¿½83


413 
veï¿½ï¿½83
:

414 
pushl
 
$0


415 
pushl
 
$83


416 
jmp
 
ï¿½É¿ps


417 .
globl
 
veï¿½ï¿½84


418 
veï¿½ï¿½84
:

419 
pushl
 
$0


420 
pushl
 
$84


421 
jmp
 
ï¿½É¿ps


422 .
globl
 
veï¿½ï¿½85


423 
veï¿½ï¿½85
:

424 
pushl
 
$0


425 
pushl
 
$85


426 
jmp
 
ï¿½É¿ps


427 .
globl
 
veï¿½ï¿½86


428 
veï¿½ï¿½86
:

429 
pushl
 
$0


430 
pushl
 
$86


431 
jmp
 
ï¿½É¿ps


432 .
globl
 
veï¿½ï¿½87


433 
veï¿½ï¿½87
:

434 
pushl
 
$0


435 
pushl
 
$87


436 
jmp
 
ï¿½É¿ps


437 .
globl
 
veï¿½ï¿½88


438 
veï¿½ï¿½88
:

439 
pushl
 
$0


440 
pushl
 
$88


441 
jmp
 
ï¿½É¿ps


442 .
globl
 
veï¿½ï¿½89


443 
veï¿½ï¿½89
:

444 
pushl
 
$0


445 
pushl
 
$89


446 
jmp
 
ï¿½É¿ps


447 .
globl
 
veï¿½ï¿½90


448 
veï¿½ï¿½90
:

449 
pushl
 
$0


450 
pushl
 
$90


451 
jmp
 
ï¿½É¿ps


452 .
globl
 
veï¿½ï¿½91


453 
veï¿½ï¿½91
:

454 
pushl
 
$0


455 
pushl
 
$91


456 
jmp
 
ï¿½É¿ps


457 .
globl
 
veï¿½ï¿½92


458 
veï¿½ï¿½92
:

459 
pushl
 
$0


460 
pushl
 
$92


461 
jmp
 
ï¿½É¿ps


462 .
globl
 
veï¿½ï¿½93


463 
veï¿½ï¿½93
:

464 
pushl
 
$0


465 
pushl
 
$93


466 
jmp
 
ï¿½É¿ps


467 .
globl
 
veï¿½ï¿½94


468 
veï¿½ï¿½94
:

469 
pushl
 
$0


470 
pushl
 
$94


471 
jmp
 
ï¿½É¿ps


472 .
globl
 
veï¿½ï¿½95


473 
veï¿½ï¿½95
:

474 
pushl
 
$0


475 
pushl
 
$95


476 
jmp
 
ï¿½É¿ps


477 .
globl
 
veï¿½ï¿½96


478 
veï¿½ï¿½96
:

479 
pushl
 
$0


480 
pushl
 
$96


481 
jmp
 
ï¿½É¿ps


482 .
globl
 
veï¿½ï¿½97


483 
veï¿½ï¿½97
:

484 
pushl
 
$0


485 
pushl
 
$97


486 
jmp
 
ï¿½É¿ps


487 .
globl
 
veï¿½ï¿½98


488 
veï¿½ï¿½98
:

489 
pushl
 
$0


490 
pushl
 
$98


491 
jmp
 
ï¿½É¿ps


492 .
globl
 
veï¿½ï¿½99


493 
veï¿½ï¿½99
:

494 
pushl
 
$0


495 
pushl
 
$99


496 
jmp
 
ï¿½É¿ps


497 .
globl
 
veï¿½ï¿½100


498 
veï¿½ï¿½100
:

499 
pushl
 
$0


500 
pushl
 
$100


501 
jmp
 
ï¿½É¿ps


502 .
globl
 
veï¿½ï¿½101


503 
veï¿½ï¿½101
:

504 
pushl
 
$0


505 
pushl
 
$101


506 
jmp
 
ï¿½É¿ps


507 .
globl
 
veï¿½ï¿½102


508 
veï¿½ï¿½102
:

509 
pushl
 
$0


510 
pushl
 
$102


511 
jmp
 
ï¿½É¿ps


512 .
globl
 
veï¿½ï¿½103


513 
veï¿½ï¿½103
:

514 
pushl
 
$0


515 
pushl
 
$103


516 
jmp
 
ï¿½É¿ps


517 .
globl
 
veï¿½ï¿½104


518 
veï¿½ï¿½104
:

519 
pushl
 
$0


520 
pushl
 
$104


521 
jmp
 
ï¿½É¿ps


522 .
globl
 
veï¿½ï¿½105


523 
veï¿½ï¿½105
:

524 
pushl
 
$0


525 
pushl
 
$105


526 
jmp
 
ï¿½É¿ps


527 .
globl
 
veï¿½ï¿½106


528 
veï¿½ï¿½106
:

529 
pushl
 
$0


530 
pushl
 
$106


531 
jmp
 
ï¿½É¿ps


532 .
globl
 
veï¿½ï¿½107


533 
veï¿½ï¿½107
:

534 
pushl
 
$0


535 
pushl
 
$107


536 
jmp
 
ï¿½É¿ps


537 .
globl
 
veï¿½ï¿½108


538 
veï¿½ï¿½108
:

539 
pushl
 
$0


540 
pushl
 
$108


541 
jmp
 
ï¿½É¿ps


542 .
globl
 
veï¿½ï¿½109


543 
veï¿½ï¿½109
:

544 
pushl
 
$0


545 
pushl
 
$109


546 
jmp
 
ï¿½É¿ps


547 .
globl
 
veï¿½ï¿½110


548 
veï¿½ï¿½110
:

549 
pushl
 
$0


550 
pushl
 
$110


551 
jmp
 
ï¿½É¿ps


552 .
globl
 
veï¿½ï¿½111


553 
veï¿½ï¿½111
:

554 
pushl
 
$0


555 
pushl
 
$111


556 
jmp
 
ï¿½É¿ps


557 .
globl
 
veï¿½ï¿½112


558 
veï¿½ï¿½112
:

559 
pushl
 
$0


560 
pushl
 
$112


561 
jmp
 
ï¿½É¿ps


562 .
globl
 
veï¿½ï¿½113


563 
veï¿½ï¿½113
:

564 
pushl
 
$0


565 
pushl
 
$113


566 
jmp
 
ï¿½É¿ps


567 .
globl
 
veï¿½ï¿½114


568 
veï¿½ï¿½114
:

569 
pushl
 
$0


570 
pushl
 
$114


571 
jmp
 
ï¿½É¿ps


572 .
globl
 
veï¿½ï¿½115


573 
veï¿½ï¿½115
:

574 
pushl
 
$0


575 
pushl
 
$115


576 
jmp
 
ï¿½É¿ps


577 .
globl
 
veï¿½ï¿½116


578 
veï¿½ï¿½116
:

579 
pushl
 
$0


580 
pushl
 
$116


581 
jmp
 
ï¿½É¿ps


582 .
globl
 
veï¿½ï¿½117


583 
veï¿½ï¿½117
:

584 
pushl
 
$0


585 
pushl
 
$117


586 
jmp
 
ï¿½É¿ps


587 .
globl
 
veï¿½ï¿½118


588 
veï¿½ï¿½118
:

589 
pushl
 
$0


590 
pushl
 
$118


591 
jmp
 
ï¿½É¿ps


592 .
globl
 
veï¿½ï¿½119


593 
veï¿½ï¿½119
:

594 
pushl
 
$0


595 
pushl
 
$119


596 
jmp
 
ï¿½É¿ps


597 .
globl
 
veï¿½ï¿½120


598 
veï¿½ï¿½120
:

599 
pushl
 
$0


600 
pushl
 
$120


601 
jmp
 
ï¿½É¿ps


602 .
globl
 
veï¿½ï¿½121


603 
veï¿½ï¿½121
:

604 
pushl
 
$0


605 
pushl
 
$121


606 
jmp
 
ï¿½É¿ps


607 .
globl
 
veï¿½ï¿½122


608 
veï¿½ï¿½122
:

609 
pushl
 
$0


610 
pushl
 
$122


611 
jmp
 
ï¿½É¿ps


612 .
globl
 
veï¿½ï¿½123


613 
veï¿½ï¿½123
:

614 
pushl
 
$0


615 
pushl
 
$123


616 
jmp
 
ï¿½É¿ps


617 .
globl
 
veï¿½ï¿½124


618 
veï¿½ï¿½124
:

619 
pushl
 
$0


620 
pushl
 
$124


621 
jmp
 
ï¿½É¿ps


622 .
globl
 
veï¿½ï¿½125


623 
veï¿½ï¿½125
:

624 
pushl
 
$0


625 
pushl
 
$125


626 
jmp
 
ï¿½É¿ps


627 .
globl
 
veï¿½ï¿½126


628 
veï¿½ï¿½126
:

629 
pushl
 
$0


630 
pushl
 
$126


631 
jmp
 
ï¿½É¿ps


632 .
globl
 
veï¿½ï¿½127


633 
veï¿½ï¿½127
:

634 
pushl
 
$0


635 
pushl
 
$127


636 
jmp
 
ï¿½É¿ps


637 .
globl
 
veï¿½ï¿½128


638 
veï¿½ï¿½128
:

639 
pushl
 
$0


640 
pushl
 
$128


641 
jmp
 
ï¿½É¿ps


642 .
globl
 
veï¿½ï¿½129


643 
veï¿½ï¿½129
:

644 
pushl
 
$0


645 
pushl
 
$129


646 
jmp
 
ï¿½É¿ps


647 .
globl
 
veï¿½ï¿½130


648 
veï¿½ï¿½130
:

649 
pushl
 
$0


650 
pushl
 
$130


651 
jmp
 
ï¿½É¿ps


652 .
globl
 
veï¿½ï¿½131


653 
veï¿½ï¿½131
:

654 
pushl
 
$0


655 
pushl
 
$131


656 
jmp
 
ï¿½É¿ps


657 .
globl
 
veï¿½ï¿½132


658 
veï¿½ï¿½132
:

659 
pushl
 
$0


660 
pushl
 
$132


661 
jmp
 
ï¿½É¿ps


662 .
globl
 
veï¿½ï¿½133


663 
veï¿½ï¿½133
:

664 
pushl
 
$0


665 
pushl
 
$133


666 
jmp
 
ï¿½É¿ps


667 .
globl
 
veï¿½ï¿½134


668 
veï¿½ï¿½134
:

669 
pushl
 
$0


670 
pushl
 
$134


671 
jmp
 
ï¿½É¿ps


672 .
globl
 
veï¿½ï¿½135


673 
veï¿½ï¿½135
:

674 
pushl
 
$0


675 
pushl
 
$135


676 
jmp
 
ï¿½É¿ps


677 .
globl
 
veï¿½ï¿½136


678 
veï¿½ï¿½136
:

679 
pushl
 
$0


680 
pushl
 
$136


681 
jmp
 
ï¿½É¿ps


682 .
globl
 
veï¿½ï¿½137


683 
veï¿½ï¿½137
:

684 
pushl
 
$0


685 
pushl
 
$137


686 
jmp
 
ï¿½É¿ps


687 .
globl
 
veï¿½ï¿½138


688 
veï¿½ï¿½138
:

689 
pushl
 
$0


690 
pushl
 
$138


691 
jmp
 
ï¿½É¿ps


692 .
globl
 
veï¿½ï¿½139


693 
veï¿½ï¿½139
:

694 
pushl
 
$0


695 
pushl
 
$139


696 
jmp
 
ï¿½É¿ps


697 .
globl
 
veï¿½ï¿½140


698 
veï¿½ï¿½140
:

699 
pushl
 
$0


700 
pushl
 
$140


701 
jmp
 
ï¿½É¿ps


702 .
globl
 
veï¿½ï¿½141


703 
veï¿½ï¿½141
:

704 
pushl
 
$0


705 
pushl
 
$141


706 
jmp
 
ï¿½É¿ps


707 .
globl
 
veï¿½ï¿½142


708 
veï¿½ï¿½142
:

709 
pushl
 
$0


710 
pushl
 
$142


711 
jmp
 
ï¿½É¿ps


712 .
globl
 
veï¿½ï¿½143


713 
veï¿½ï¿½143
:

714 
pushl
 
$0


715 
pushl
 
$143


716 
jmp
 
ï¿½É¿ps


717 .
globl
 
veï¿½ï¿½144


718 
veï¿½ï¿½144
:

719 
pushl
 
$0


720 
pushl
 
$144


721 
jmp
 
ï¿½É¿ps


722 .
globl
 
veï¿½ï¿½145


723 
veï¿½ï¿½145
:

724 
pushl
 
$0


725 
pushl
 
$145


726 
jmp
 
ï¿½É¿ps


727 .
globl
 
veï¿½ï¿½146


728 
veï¿½ï¿½146
:

729 
pushl
 
$0


730 
pushl
 
$146


731 
jmp
 
ï¿½É¿ps


732 .
globl
 
veï¿½ï¿½147


733 
veï¿½ï¿½147
:

734 
pushl
 
$0


735 
pushl
 
$147


736 
jmp
 
ï¿½É¿ps


737 .
globl
 
veï¿½ï¿½148


738 
veï¿½ï¿½148
:

739 
pushl
 
$0


740 
pushl
 
$148


741 
jmp
 
ï¿½É¿ps


742 .
globl
 
veï¿½ï¿½149


743 
veï¿½ï¿½149
:

744 
pushl
 
$0


745 
pushl
 
$149


746 
jmp
 
ï¿½É¿ps


747 .
globl
 
veï¿½ï¿½150


748 
veï¿½ï¿½150
:

749 
pushl
 
$0


750 
pushl
 
$150


751 
jmp
 
ï¿½É¿ps


752 .
globl
 
veï¿½ï¿½151


753 
veï¿½ï¿½151
:

754 
pushl
 
$0


755 
pushl
 
$151


756 
jmp
 
ï¿½É¿ps


757 .
globl
 
veï¿½ï¿½152


758 
veï¿½ï¿½152
:

759 
pushl
 
$0


760 
pushl
 
$152


761 
jmp
 
ï¿½É¿ps


762 .
globl
 
veï¿½ï¿½153


763 
veï¿½ï¿½153
:

764 
pushl
 
$0


765 
pushl
 
$153


766 
jmp
 
ï¿½É¿ps


767 .
globl
 
veï¿½ï¿½154


768 
veï¿½ï¿½154
:

769 
pushl
 
$0


770 
pushl
 
$154


771 
jmp
 
ï¿½É¿ps


772 .
globl
 
veï¿½ï¿½155


773 
veï¿½ï¿½155
:

774 
pushl
 
$0


775 
pushl
 
$155


776 
jmp
 
ï¿½É¿ps


777 .
globl
 
veï¿½ï¿½156


778 
veï¿½ï¿½156
:

779 
pushl
 
$0


780 
pushl
 
$156


781 
jmp
 
ï¿½É¿ps


782 .
globl
 
veï¿½ï¿½157


783 
veï¿½ï¿½157
:

784 
pushl
 
$0


785 
pushl
 
$157


786 
jmp
 
ï¿½É¿ps


787 .
globl
 
veï¿½ï¿½158


788 
veï¿½ï¿½158
:

789 
pushl
 
$0


790 
pushl
 
$158


791 
jmp
 
ï¿½É¿ps


792 .
globl
 
veï¿½ï¿½159


793 
veï¿½ï¿½159
:

794 
pushl
 
$0


795 
pushl
 
$159


796 
jmp
 
ï¿½É¿ps


797 .
globl
 
veï¿½ï¿½160


798 
veï¿½ï¿½160
:

799 
pushl
 
$0


800 
pushl
 
$160


801 
jmp
 
ï¿½É¿ps


802 .
globl
 
veï¿½ï¿½161


803 
veï¿½ï¿½161
:

804 
pushl
 
$0


805 
pushl
 
$161


806 
jmp
 
ï¿½É¿ps


807 .
globl
 
veï¿½ï¿½162


808 
veï¿½ï¿½162
:

809 
pushl
 
$0


810 
pushl
 
$162


811 
jmp
 
ï¿½É¿ps


812 .
globl
 
veï¿½ï¿½163


813 
veï¿½ï¿½163
:

814 
pushl
 
$0


815 
pushl
 
$163


816 
jmp
 
ï¿½É¿ps


817 .
globl
 
veï¿½ï¿½164


818 
veï¿½ï¿½164
:

819 
pushl
 
$0


820 
pushl
 
$164


821 
jmp
 
ï¿½É¿ps


822 .
globl
 
veï¿½ï¿½165


823 
veï¿½ï¿½165
:

824 
pushl
 
$0


825 
pushl
 
$165


826 
jmp
 
ï¿½É¿ps


827 .
globl
 
veï¿½ï¿½166


828 
veï¿½ï¿½166
:

829 
pushl
 
$0


830 
pushl
 
$166


831 
jmp
 
ï¿½É¿ps


832 .
globl
 
veï¿½ï¿½167


833 
veï¿½ï¿½167
:

834 
pushl
 
$0


835 
pushl
 
$167


836 
jmp
 
ï¿½É¿ps


837 .
globl
 
veï¿½ï¿½168


838 
veï¿½ï¿½168
:

839 
pushl
 
$0


840 
pushl
 
$168


841 
jmp
 
ï¿½É¿ps


842 .
globl
 
veï¿½ï¿½169


843 
veï¿½ï¿½169
:

844 
pushl
 
$0


845 
pushl
 
$169


846 
jmp
 
ï¿½É¿ps


847 .
globl
 
veï¿½ï¿½170


848 
veï¿½ï¿½170
:

849 
pushl
 
$0


850 
pushl
 
$170


851 
jmp
 
ï¿½É¿ps


852 .
globl
 
veï¿½ï¿½171


853 
veï¿½ï¿½171
:

854 
pushl
 
$0


855 
pushl
 
$171


856 
jmp
 
ï¿½É¿ps


857 .
globl
 
veï¿½ï¿½172


858 
veï¿½ï¿½172
:

859 
pushl
 
$0


860 
pushl
 
$172


861 
jmp
 
ï¿½É¿ps


862 .
globl
 
veï¿½ï¿½173


863 
veï¿½ï¿½173
:

864 
pushl
 
$0


865 
pushl
 
$173


866 
jmp
 
ï¿½É¿ps


867 .
globl
 
veï¿½ï¿½174


868 
veï¿½ï¿½174
:

869 
pushl
 
$0


870 
pushl
 
$174


871 
jmp
 
ï¿½É¿ps


872 .
globl
 
veï¿½ï¿½175


873 
veï¿½ï¿½175
:

874 
pushl
 
$0


875 
pushl
 
$175


876 
jmp
 
ï¿½É¿ps


877 .
globl
 
veï¿½ï¿½176


878 
veï¿½ï¿½176
:

879 
pushl
 
$0


880 
pushl
 
$176


881 
jmp
 
ï¿½É¿ps


882 .
globl
 
veï¿½ï¿½177


883 
veï¿½ï¿½177
:

884 
pushl
 
$0


885 
pushl
 
$177


886 
jmp
 
ï¿½É¿ps


887 .
globl
 
veï¿½ï¿½178


888 
veï¿½ï¿½178
:

889 
pushl
 
$0


890 
pushl
 
$178


891 
jmp
 
ï¿½É¿ps


892 .
globl
 
veï¿½ï¿½179


893 
veï¿½ï¿½179
:

894 
pushl
 
$0


895 
pushl
 
$179


896 
jmp
 
ï¿½É¿ps


897 .
globl
 
veï¿½ï¿½180


898 
veï¿½ï¿½180
:

899 
pushl
 
$0


900 
pushl
 
$180


901 
jmp
 
ï¿½É¿ps


902 .
globl
 
veï¿½ï¿½181


903 
veï¿½ï¿½181
:

904 
pushl
 
$0


905 
pushl
 
$181


906 
jmp
 
ï¿½É¿ps


907 .
globl
 
veï¿½ï¿½182


908 
veï¿½ï¿½182
:

909 
pushl
 
$0


910 
pushl
 
$182


911 
jmp
 
ï¿½É¿ps


912 .
globl
 
veï¿½ï¿½183


913 
veï¿½ï¿½183
:

914 
pushl
 
$0


915 
pushl
 
$183


916 
jmp
 
ï¿½É¿ps


917 .
globl
 
veï¿½ï¿½184


918 
veï¿½ï¿½184
:

919 
pushl
 
$0


920 
pushl
 
$184


921 
jmp
 
ï¿½É¿ps


922 .
globl
 
veï¿½ï¿½185


923 
veï¿½ï¿½185
:

924 
pushl
 
$0


925 
pushl
 
$185


926 
jmp
 
ï¿½É¿ps


927 .
globl
 
veï¿½ï¿½186


928 
veï¿½ï¿½186
:

929 
pushl
 
$0


930 
pushl
 
$186


931 
jmp
 
ï¿½É¿ps


932 .
globl
 
veï¿½ï¿½187


933 
veï¿½ï¿½187
:

934 
pushl
 
$0


935 
pushl
 
$187


936 
jmp
 
ï¿½É¿ps


937 .
globl
 
veï¿½ï¿½188


938 
veï¿½ï¿½188
:

939 
pushl
 
$0


940 
pushl
 
$188


941 
jmp
 
ï¿½É¿ps


942 .
globl
 
veï¿½ï¿½189


943 
veï¿½ï¿½189
:

944 
pushl
 
$0


945 
pushl
 
$189


946 
jmp
 
ï¿½É¿ps


947 .
globl
 
veï¿½ï¿½190


948 
veï¿½ï¿½190
:

949 
pushl
 
$0


950 
pushl
 
$190


951 
jmp
 
ï¿½É¿ps


952 .
globl
 
veï¿½ï¿½191


953 
veï¿½ï¿½191
:

954 
pushl
 
$0


955 
pushl
 
$191


956 
jmp
 
ï¿½É¿ps


957 .
globl
 
veï¿½ï¿½192


958 
veï¿½ï¿½192
:

959 
pushl
 
$0


960 
pushl
 
$192


961 
jmp
 
ï¿½É¿ps


962 .
globl
 
veï¿½ï¿½193


963 
veï¿½ï¿½193
:

964 
pushl
 
$0


965 
pushl
 
$193


966 
jmp
 
ï¿½É¿ps


967 .
globl
 
veï¿½ï¿½194


968 
veï¿½ï¿½194
:

969 
pushl
 
$0


970 
pushl
 
$194


971 
jmp
 
ï¿½É¿ps


972 .
globl
 
veï¿½ï¿½195


973 
veï¿½ï¿½195
:

974 
pushl
 
$0


975 
pushl
 
$195


976 
jmp
 
ï¿½É¿ps


977 .
globl
 
veï¿½ï¿½196


978 
veï¿½ï¿½196
:

979 
pushl
 
$0


980 
pushl
 
$196


981 
jmp
 
ï¿½É¿ps


982 .
globl
 
veï¿½ï¿½197


983 
veï¿½ï¿½197
:

984 
pushl
 
$0


985 
pushl
 
$197


986 
jmp
 
ï¿½É¿ps


987 .
globl
 
veï¿½ï¿½198


988 
veï¿½ï¿½198
:

989 
pushl
 
$0


990 
pushl
 
$198


991 
jmp
 
ï¿½É¿ps


992 .
globl
 
veï¿½ï¿½199


993 
veï¿½ï¿½199
:

994 
pushl
 
$0


995 
pushl
 
$199


996 
jmp
 
ï¿½É¿ps


997 .
globl
 
veï¿½ï¿½200


998 
veï¿½ï¿½200
:

999 
pushl
 
$0


1000 
pushl
 
$200


1001 
jmp
 
ï¿½É¿ps


1002 .
globl
 
veï¿½ï¿½201


1003 
veï¿½ï¿½201
:

1004 
pushl
 
$0


1005 
pushl
 
$201


1006 
jmp
 
ï¿½É¿ps


1007 .
globl
 
veï¿½ï¿½202


1008 
veï¿½ï¿½202
:

1009 
pushl
 
$0


1010 
pushl
 
$202


1011 
jmp
 
ï¿½É¿ps


1012 .
globl
 
veï¿½ï¿½203


1013 
veï¿½ï¿½203
:

1014 
pushl
 
$0


1015 
pushl
 
$203


1016 
jmp
 
ï¿½É¿ps


1017 .
globl
 
veï¿½ï¿½204


1018 
veï¿½ï¿½204
:

1019 
pushl
 
$0


1020 
pushl
 
$204


1021 
jmp
 
ï¿½É¿ps


1022 .
globl
 
veï¿½ï¿½205


1023 
veï¿½ï¿½205
:

1024 
pushl
 
$0


1025 
pushl
 
$205


1026 
jmp
 
ï¿½É¿ps


1027 .
globl
 
veï¿½ï¿½206


1028 
veï¿½ï¿½206
:

1029 
pushl
 
$0


1030 
pushl
 
$206


1031 
jmp
 
ï¿½É¿ps


1032 .
globl
 
veï¿½ï¿½207


1033 
veï¿½ï¿½207
:

1034 
pushl
 
$0


1035 
pushl
 
$207


1036 
jmp
 
ï¿½É¿ps


1037 .
globl
 
veï¿½ï¿½208


1038 
veï¿½ï¿½208
:

1039 
pushl
 
$0


1040 
pushl
 
$208


1041 
jmp
 
ï¿½É¿ps


1042 .
globl
 
veï¿½ï¿½209


1043 
veï¿½ï¿½209
:

1044 
pushl
 
$0


1045 
pushl
 
$209


1046 
jmp
 
ï¿½É¿ps


1047 .
globl
 
veï¿½ï¿½210


1048 
veï¿½ï¿½210
:

1049 
pushl
 
$0


1050 
pushl
 
$210


1051 
jmp
 
ï¿½É¿ps


1052 .
globl
 
veï¿½ï¿½211


1053 
veï¿½ï¿½211
:

1054 
pushl
 
$0


1055 
pushl
 
$211


1056 
jmp
 
ï¿½É¿ps


1057 .
globl
 
veï¿½ï¿½212


1058 
veï¿½ï¿½212
:

1059 
pushl
 
$0


1060 
pushl
 
$212


1061 
jmp
 
ï¿½É¿ps


1062 .
globl
 
veï¿½ï¿½213


1063 
veï¿½ï¿½213
:

1064 
pushl
 
$0


1065 
pushl
 
$213


1066 
jmp
 
ï¿½É¿ps


1067 .
globl
 
veï¿½ï¿½214


1068 
veï¿½ï¿½214
:

1069 
pushl
 
$0


1070 
pushl
 
$214


1071 
jmp
 
ï¿½É¿ps


1072 .
globl
 
veï¿½ï¿½215


1073 
veï¿½ï¿½215
:

1074 
pushl
 
$0


1075 
pushl
 
$215


1076 
jmp
 
ï¿½É¿ps


1077 .
globl
 
veï¿½ï¿½216


1078 
veï¿½ï¿½216
:

1079 
pushl
 
$0


1080 
pushl
 
$216


1081 
jmp
 
ï¿½É¿ps


1082 .
globl
 
veï¿½ï¿½217


1083 
veï¿½ï¿½217
:

1084 
pushl
 
$0


1085 
pushl
 
$217


1086 
jmp
 
ï¿½É¿ps


1087 .
globl
 
veï¿½ï¿½218


1088 
veï¿½ï¿½218
:

1089 
pushl
 
$0


1090 
pushl
 
$218


1091 
jmp
 
ï¿½É¿ps


1092 .
globl
 
veï¿½ï¿½219


1093 
veï¿½ï¿½219
:

1094 
pushl
 
$0


1095 
pushl
 
$219


1096 
jmp
 
ï¿½É¿ps


1097 .
globl
 
veï¿½ï¿½220


1098 
veï¿½ï¿½220
:

1099 
pushl
 
$0


1100 
pushl
 
$220


1101 
jmp
 
ï¿½É¿ps


1102 .
globl
 
veï¿½ï¿½221


1103 
veï¿½ï¿½221
:

1104 
pushl
 
$0


1105 
pushl
 
$221


1106 
jmp
 
ï¿½É¿ps


1107 .
globl
 
veï¿½ï¿½222


1108 
veï¿½ï¿½222
:

1109 
pushl
 
$0


1110 
pushl
 
$222


1111 
jmp
 
ï¿½É¿ps


1112 .
globl
 
veï¿½ï¿½223


1113 
veï¿½ï¿½223
:

1114 
pushl
 
$0


1115 
pushl
 
$223


1116 
jmp
 
ï¿½É¿ps


1117 .
globl
 
veï¿½ï¿½224


1118 
veï¿½ï¿½224
:

1119 
pushl
 
$0


1120 
pushl
 
$224


1121 
jmp
 
ï¿½É¿ps


1122 .
globl
 
veï¿½ï¿½225


1123 
veï¿½ï¿½225
:

1124 
pushl
 
$0


1125 
pushl
 
$225


1126 
jmp
 
ï¿½É¿ps


1127 .
globl
 
veï¿½ï¿½226


1128 
veï¿½ï¿½226
:

1129 
pushl
 
$0


1130 
pushl
 
$226


1131 
jmp
 
ï¿½É¿ps


1132 .
globl
 
veï¿½ï¿½227


1133 
veï¿½ï¿½227
:

1134 
pushl
 
$0


1135 
pushl
 
$227


1136 
jmp
 
ï¿½É¿ps


1137 .
globl
 
veï¿½ï¿½228


1138 
veï¿½ï¿½228
:

1139 
pushl
 
$0


1140 
pushl
 
$228


1141 
jmp
 
ï¿½É¿ps


1142 .
globl
 
veï¿½ï¿½229


1143 
veï¿½ï¿½229
:

1144 
pushl
 
$0


1145 
pushl
 
$229


1146 
jmp
 
ï¿½É¿ps


1147 .
globl
 
veï¿½ï¿½230


1148 
veï¿½ï¿½230
:

1149 
pushl
 
$0


1150 
pushl
 
$230


1151 
jmp
 
ï¿½É¿ps


1152 .
globl
 
veï¿½ï¿½231


1153 
veï¿½ï¿½231
:

1154 
pushl
 
$0


1155 
pushl
 
$231


1156 
jmp
 
ï¿½É¿ps


1157 .
globl
 
veï¿½ï¿½232


1158 
veï¿½ï¿½232
:

1159 
pushl
 
$0


1160 
pushl
 
$232


1161 
jmp
 
ï¿½É¿ps


1162 .
globl
 
veï¿½ï¿½233


1163 
veï¿½ï¿½233
:

1164 
pushl
 
$0


1165 
pushl
 
$233


1166 
jmp
 
ï¿½É¿ps


1167 .
globl
 
veï¿½ï¿½234


1168 
veï¿½ï¿½234
:

1169 
pushl
 
$0


1170 
pushl
 
$234


1171 
jmp
 
ï¿½É¿ps


1172 .
globl
 
veï¿½ï¿½235


1173 
veï¿½ï¿½235
:

1174 
pushl
 
$0


1175 
pushl
 
$235


1176 
jmp
 
ï¿½É¿ps


1177 .
globl
 
veï¿½ï¿½236


1178 
veï¿½ï¿½236
:

1179 
pushl
 
$0


1180 
pushl
 
$236


1181 
jmp
 
ï¿½É¿ps


1182 .
globl
 
veï¿½ï¿½237


1183 
veï¿½ï¿½237
:

1184 
pushl
 
$0


1185 
pushl
 
$237


1186 
jmp
 
ï¿½É¿ps


1187 .
globl
 
veï¿½ï¿½238


1188 
veï¿½ï¿½238
:

1189 
pushl
 
$0


1190 
pushl
 
$238


1191 
jmp
 
ï¿½É¿ps


1192 .
globl
 
veï¿½ï¿½239


1193 
veï¿½ï¿½239
:

1194 
pushl
 
$0


1195 
pushl
 
$239


1196 
jmp
 
ï¿½É¿ps


1197 .
globl
 
veï¿½ï¿½240


1198 
veï¿½ï¿½240
:

1199 
pushl
 
$0


1200 
pushl
 
$240


1201 
jmp
 
ï¿½É¿ps


1202 .
globl
 
veï¿½ï¿½241


1203 
veï¿½ï¿½241
:

1204 
pushl
 
$0


1205 
pushl
 
$241


1206 
jmp
 
ï¿½É¿ps


1207 .
globl
 
veï¿½ï¿½242


1208 
veï¿½ï¿½242
:

1209 
pushl
 
$0


1210 
pushl
 
$242


1211 
jmp
 
ï¿½É¿ps


1212 .
globl
 
veï¿½ï¿½243


1213 
veï¿½ï¿½243
:

1214 
pushl
 
$0


1215 
pushl
 
$243


1216 
jmp
 
ï¿½É¿ps


1217 .
globl
 
veï¿½ï¿½244


1218 
veï¿½ï¿½244
:

1219 
pushl
 
$0


1220 
pushl
 
$244


1221 
jmp
 
ï¿½É¿ps


1222 .
globl
 
veï¿½ï¿½245


1223 
veï¿½ï¿½245
:

1224 
pushl
 
$0


1225 
pushl
 
$245


1226 
jmp
 
ï¿½É¿ps


1227 .
globl
 
veï¿½ï¿½246


1228 
veï¿½ï¿½246
:

1229 
pushl
 
$0


1230 
pushl
 
$246


1231 
jmp
 
ï¿½É¿ps


1232 .
globl
 
veï¿½ï¿½247


1233 
veï¿½ï¿½247
:

1234 
pushl
 
$0


1235 
pushl
 
$247


1236 
jmp
 
ï¿½É¿ps


1237 .
globl
 
veï¿½ï¿½248


1238 
veï¿½ï¿½248
:

1239 
pushl
 
$0


1240 
pushl
 
$248


1241 
jmp
 
ï¿½É¿ps


1242 .
globl
 
veï¿½ï¿½249


1243 
veï¿½ï¿½249
:

1244 
pushl
 
$0


1245 
pushl
 
$249


1246 
jmp
 
ï¿½É¿ps


1247 .
globl
 
veï¿½ï¿½250


1248 
veï¿½ï¿½250
:

1249 
pushl
 
$0


1250 
pushl
 
$250


1251 
jmp
 
ï¿½É¿ps


1252 .
globl
 
veï¿½ï¿½251


1253 
veï¿½ï¿½251
:

1254 
pushl
 
$0


1255 
pushl
 
$251


1256 
jmp
 
ï¿½É¿ps


1257 .
globl
 
veï¿½ï¿½252


1258 
veï¿½ï¿½252
:

1259 
pushl
 
$0


1260 
pushl
 
$252


1261 
jmp
 
ï¿½É¿ps


1262 .
globl
 
veï¿½ï¿½253


1263 
veï¿½ï¿½253
:

1264 
pushl
 
$0


1265 
pushl
 
$253


1266 
jmp
 
ï¿½É¿ps


1267 .
globl
 
veï¿½ï¿½254


1268 
veï¿½ï¿½254
:

1269 
pushl
 
$0


1270 
pushl
 
$254


1271 
jmp
 
ï¿½É¿ps


1272 .
globl
 
veï¿½ï¿½255


1273 
veï¿½ï¿½255
:

1274 
pushl
 
$0


1275 
pushl
 
$255


1276 
jmp
 
ï¿½É¿ps


1278 #veï¿½ï¿½ 
ï¿½bï¿½


1279 .
dï¿½a


1280 .
globl
 
veï¿½ï¿½s


1281 
veï¿½ï¿½s
:

1282 .
veï¿½ï¿½0


1283 .
veï¿½ï¿½1


1284 .
veï¿½ï¿½2


1285 .
veï¿½ï¿½3


1286 .
veï¿½ï¿½4


1287 .
veï¿½ï¿½5


1288 .
veï¿½ï¿½6


1289 .
veï¿½ï¿½7


1290 .
veï¿½ï¿½8


1291 .
veï¿½ï¿½9


1292 .
veï¿½ï¿½10


1293 .
veï¿½ï¿½11


1294 .
veï¿½ï¿½12


1295 .
veï¿½ï¿½13


1296 .
veï¿½ï¿½14


1297 .
veï¿½ï¿½15


1298 .
veï¿½ï¿½16


1299 .
veï¿½ï¿½17


1300 .
veï¿½ï¿½18


1301 .
veï¿½ï¿½19


1302 .
veï¿½ï¿½20


1303 .
veï¿½ï¿½21


1304 .
veï¿½ï¿½22


1305 .
veï¿½ï¿½23


1306 .
veï¿½ï¿½24


1307 .
veï¿½ï¿½25


1308 .
veï¿½ï¿½26


1309 .
veï¿½ï¿½27


1310 .
veï¿½ï¿½28


1311 .
veï¿½ï¿½29


1312 .
veï¿½ï¿½30


1313 .
veï¿½ï¿½31


1314 .
veï¿½ï¿½32


1315 .
veï¿½ï¿½33


1316 .
veï¿½ï¿½34


1317 .
veï¿½ï¿½35


1318 .
veï¿½ï¿½36


1319 .
veï¿½ï¿½37


1320 .
veï¿½ï¿½38


1321 .
veï¿½ï¿½39


1322 .
veï¿½ï¿½40


1323 .
veï¿½ï¿½41


1324 .
veï¿½ï¿½42


1325 .
veï¿½ï¿½43


1326 .
veï¿½ï¿½44


1327 .
veï¿½ï¿½45


1328 .
veï¿½ï¿½46


1329 .
veï¿½ï¿½47


1330 .
veï¿½ï¿½48


1331 .
veï¿½ï¿½49


1332 .
veï¿½ï¿½50


1333 .
veï¿½ï¿½51


1334 .
veï¿½ï¿½52


1335 .
veï¿½ï¿½53


1336 .
veï¿½ï¿½54


1337 .
veï¿½ï¿½55


1338 .
veï¿½ï¿½56


1339 .
veï¿½ï¿½57


1340 .
veï¿½ï¿½58


1341 .
veï¿½ï¿½59


1342 .
veï¿½ï¿½60


1343 .
veï¿½ï¿½61


1344 .
veï¿½ï¿½62


1345 .
veï¿½ï¿½63


1346 .
veï¿½ï¿½64


1347 .
veï¿½ï¿½65


1348 .
veï¿½ï¿½66


1349 .
veï¿½ï¿½67


1350 .
veï¿½ï¿½68


1351 .
veï¿½ï¿½69


1352 .
veï¿½ï¿½70


1353 .
veï¿½ï¿½71


1354 .
veï¿½ï¿½72


1355 .
veï¿½ï¿½73


1356 .
veï¿½ï¿½74


1357 .
veï¿½ï¿½75


1358 .
veï¿½ï¿½76


1359 .
veï¿½ï¿½77


1360 .
veï¿½ï¿½78


1361 .
veï¿½ï¿½79


1362 .
veï¿½ï¿½80


1363 .
veï¿½ï¿½81


1364 .
veï¿½ï¿½82


1365 .
veï¿½ï¿½83


1366 .
veï¿½ï¿½84


1367 .
veï¿½ï¿½85


1368 .
veï¿½ï¿½86


1369 .
veï¿½ï¿½87


1370 .
veï¿½ï¿½88


1371 .
veï¿½ï¿½89


1372 .
veï¿½ï¿½90


1373 .
veï¿½ï¿½91


1374 .
veï¿½ï¿½92


1375 .
veï¿½ï¿½93


1376 .
veï¿½ï¿½94


1377 .
veï¿½ï¿½95


1378 .
veï¿½ï¿½96


1379 .
veï¿½ï¿½97


1380 .
veï¿½ï¿½98


1381 .
veï¿½ï¿½99


1382 .
veï¿½ï¿½100


1383 .
veï¿½ï¿½101


1384 .
veï¿½ï¿½102


1385 .
veï¿½ï¿½103


1386 .
veï¿½ï¿½104


1387 .
veï¿½ï¿½105


1388 .
veï¿½ï¿½106


1389 .
veï¿½ï¿½107


1390 .
veï¿½ï¿½108


1391 .
veï¿½ï¿½109


1392 .
veï¿½ï¿½110


1393 .
veï¿½ï¿½111


1394 .
veï¿½ï¿½112


1395 .
veï¿½ï¿½113


1396 .
veï¿½ï¿½114


1397 .
veï¿½ï¿½115


1398 .
veï¿½ï¿½116


1399 .
veï¿½ï¿½117


1400 .
veï¿½ï¿½118


1401 .
veï¿½ï¿½119


1402 .
veï¿½ï¿½120


1403 .
veï¿½ï¿½121


1404 .
veï¿½ï¿½122


1405 .
veï¿½ï¿½123


1406 .
veï¿½ï¿½124


1407 .
veï¿½ï¿½125


1408 .
veï¿½ï¿½126


1409 .
veï¿½ï¿½127


1410 .
veï¿½ï¿½128


1411 .
veï¿½ï¿½129


1412 .
veï¿½ï¿½130


1413 .
veï¿½ï¿½131


1414 .
veï¿½ï¿½132


1415 .
veï¿½ï¿½133


1416 .
veï¿½ï¿½134


1417 .
veï¿½ï¿½135


1418 .
veï¿½ï¿½136


1419 .
veï¿½ï¿½137


1420 .
veï¿½ï¿½138


1421 .
veï¿½ï¿½139


1422 .
veï¿½ï¿½140


1423 .
veï¿½ï¿½141


1424 .
veï¿½ï¿½142


1425 .
veï¿½ï¿½143


1426 .
veï¿½ï¿½144


1427 .
veï¿½ï¿½145


1428 .
veï¿½ï¿½146


1429 .
veï¿½ï¿½147


1430 .
veï¿½ï¿½148


1431 .
veï¿½ï¿½149


1432 .
veï¿½ï¿½150


1433 .
veï¿½ï¿½151


1434 .
veï¿½ï¿½152


1435 .
veï¿½ï¿½153


1436 .
veï¿½ï¿½154


1437 .
veï¿½ï¿½155


1438 .
veï¿½ï¿½156


1439 .
veï¿½ï¿½157


1440 .
veï¿½ï¿½158


1441 .
veï¿½ï¿½159


1442 .
veï¿½ï¿½160


1443 .
veï¿½ï¿½161


1444 .
veï¿½ï¿½162


1445 .
veï¿½ï¿½163


1446 .
veï¿½ï¿½164


1447 .
veï¿½ï¿½165


1448 .
veï¿½ï¿½166


1449 .
veï¿½ï¿½167


1450 .
veï¿½ï¿½168


1451 .
veï¿½ï¿½169


1452 .
veï¿½ï¿½170


1453 .
veï¿½ï¿½171


1454 .
veï¿½ï¿½172


1455 .
veï¿½ï¿½173


1456 .
veï¿½ï¿½174


1457 .
veï¿½ï¿½175


1458 .
veï¿½ï¿½176


1459 .
veï¿½ï¿½177


1460 .
veï¿½ï¿½178


1461 .
veï¿½ï¿½179


1462 .
veï¿½ï¿½180


1463 .
veï¿½ï¿½181


1464 .
veï¿½ï¿½182


1465 .
veï¿½ï¿½183


1466 .
veï¿½ï¿½184


1467 .
veï¿½ï¿½185


1468 .
veï¿½ï¿½186


1469 .
veï¿½ï¿½187


1470 .
veï¿½ï¿½188


1471 .
veï¿½ï¿½189


1472 .
veï¿½ï¿½190


1473 .
veï¿½ï¿½191


1474 .
veï¿½ï¿½192


1475 .
veï¿½ï¿½193


1476 .
veï¿½ï¿½194


1477 .
veï¿½ï¿½195


1478 .
veï¿½ï¿½196


1479 .
veï¿½ï¿½197


1480 .
veï¿½ï¿½198


1481 .
veï¿½ï¿½199


1482 .
veï¿½ï¿½200


1483 .
veï¿½ï¿½201


1484 .
veï¿½ï¿½202


1485 .
veï¿½ï¿½203


1486 .
veï¿½ï¿½204


1487 .
veï¿½ï¿½205


1488 .
veï¿½ï¿½206


1489 .
veï¿½ï¿½207


1490 .
veï¿½ï¿½208


1491 .
veï¿½ï¿½209


1492 .
veï¿½ï¿½210


1493 .
veï¿½ï¿½211


1494 .
veï¿½ï¿½212


1495 .
veï¿½ï¿½213


1496 .
veï¿½ï¿½214


1497 .
veï¿½ï¿½215


1498 .
veï¿½ï¿½216


1499 .
veï¿½ï¿½217


1500 .
veï¿½ï¿½218


1501 .
veï¿½ï¿½219


1502 .
veï¿½ï¿½220


1503 .
veï¿½ï¿½221


1504 .
veï¿½ï¿½222


1505 .
veï¿½ï¿½223


1506 .
veï¿½ï¿½224


1507 .
veï¿½ï¿½225


1508 .
veï¿½ï¿½226


1509 .
veï¿½ï¿½227


1510 .
veï¿½ï¿½228


1511 .
veï¿½ï¿½229


1512 .
veï¿½ï¿½230


1513 .
veï¿½ï¿½231


1514 .
veï¿½ï¿½232


1515 .
veï¿½ï¿½233


1516 .
veï¿½ï¿½234


1517 .
veï¿½ï¿½235


1518 .
veï¿½ï¿½236


1519 .
veï¿½ï¿½237


1520 .
veï¿½ï¿½238


1521 .
veï¿½ï¿½239


1522 .
veï¿½ï¿½240


1523 .
veï¿½ï¿½241


1524 .
veï¿½ï¿½242


1525 .
veï¿½ï¿½243


1526 .
veï¿½ï¿½244


1527 .
veï¿½ï¿½245


1528 .
veï¿½ï¿½246


1529 .
veï¿½ï¿½247


1530 .
veï¿½ï¿½248


1531 .
veï¿½ï¿½249


1532 .
veï¿½ï¿½250


1533 .
veï¿½ï¿½251


1534 .
veï¿½ï¿½252


1535 .
veï¿½ï¿½253


1536 .
veï¿½ï¿½254


1537 .
veï¿½ï¿½255


	@vm.c

1 
	~"ï¿½ï¿½m.h
"

2 
	~"tyï¿½s.h
"

3 
	~"defs.h
"

4 
	~"x86.h
"

5 
	~"memï¿½yout.h
"

6 
	~"mmu.h
"

7 
	~"ï¿½oc.h
"

8 
	~"ï¿½f.h
"

10 

dï¿½a
[];

11 
pde_t
 *
	gkpgdï¿½
;

16 
	$ï¿½gï¿½ï¿½
()

18 
ï¿½u
 *
c
;

24 
c
 = &
ï¿½us
[
	`ï¿½uid
()];

25 
c
->
gdt
[
SEG_KCODE
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 0);

26 
c
->
gdt
[
SEG_KDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 0);

27 
c
->
gdt
[
SEG_UCODE
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 
DPL_USER
);

28 
c
->
gdt
[
SEG_UDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 
DPL_USER
);

29 
	`lgdt
(
c
->
gdt
, (c->gdt));

30 
	}
}

35 
ï¿½e_t
 *

36 
	$wï¿½kpgdï¿½
(
pde_t
 *
pgdï¿½
, cÚ¡ *
va
, 
ï¿½loc
)

38 
pde_t
 *
pde
;

39 
ï¿½e_t
 *
pgï¿½b
;

41 
pde
 = &
pgdï¿½
[
	`PDX
(
va
)];

42 if(*
pde
 & 
PTE_P
){

43 
pgï¿½b
 = (
ï¿½e_t
*)
	`P2V
(
	`PTE_ADDR
(*
pde
));

45 if(!
ï¿½loc
 || (
pgï¿½b
 = (
ï¿½e_t
*)
	`kï¿½loc
()) == 0)

48 
	`memï¿½t
(
pgï¿½b
, 0, 
PGSIZE
);

52 *
pde
 = 
	`V2P
(
pgï¿½b
ï¿½| 
PTE_P
 | 
PTE_W
 | 
PTE_U
;

54  &
pgï¿½b
[
	`PTX
(
va
)];

55 
	}
}

61 
	$mï¿½ï¿½ges
(
pde_t
 *
pgdï¿½
, *
va
, 
uï¿½t
 
size
, uï¿½ï¿½
ï¿½
, 
ï¿½rm
)

63 *
a
, *
Ï¡
;

64 
ï¿½e_t
 *
ï¿½e
;

66 
a
 = (*)
	`PGROUNDDOWN
((
uï¿½t
)
va
);

67 
Ï¡
 = (*)
	`PGROUNDDOWN
(((
uï¿½t
)
va
ï¿½+ 
size
 - 1);

69 if((
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, 
a
, 1)) == 0)

71 if(*
ï¿½e
 & 
PTE_P
)

72 
	`ï¿½nic
("remap");

73 *
ï¿½e
 = 
ï¿½
 | 
ï¿½rm
 | 
PTE_P
;

74 if(
a
 =ï¿½
Ï¡
)

76 
a
 +ï¿½
PGSIZE
;

77 
ï¿½
 +ï¿½
PGSIZE
;

80 
	}
}

105 
	skmï¿½
 {

106 *
	mvï¿½t
;

107 
uï¿½t
 
	mphys_ï¿½ï¿½t
;

108 
uï¿½t
 
	mphys_ï¿½d
;

109 
	mï¿½rm
;

110 } 
	gkmï¿½
[] = {

111 { (*)
KERNBASE
, 0, 
EXTMEM
, 
PTE_W
},

112 { (*)
KERNLINK
, 
V2P
(KERNLINK), V2P(
dï¿½a
), 0},

113 { (*)
dï¿½a
, 
V2P
(dï¿½a), 
PHYSTOP
, 
PTE_W
},

114 { (*)
DEVSPACE
, DEVSPACE, 0, 
PTE_W
},

118 
pde_t
*

119 
	$ï¿½tupkvm
()

121 
pde_t
 *
pgdï¿½
;

122 
kmï¿½
 *
k
;

124 if((
pgdï¿½
 = (
pde_t
*)
	`kï¿½loc
()) == 0)

126 
	`memï¿½t
(
pgdï¿½
, 0, 
PGSIZE
);

127 iï¿½(
	`P2V
(
PHYSTOP
ï¿½> (*)
DEVSPACE
)

128 
	`ï¿½nic
("PHYSTOPï¿½oo high");

129 
k
 = 
kmï¿½
; k < &kmï¿½[
	`NELEM
(kmap)]; k++)

130 if(
	`mï¿½ï¿½ges
(
pgdï¿½
, 
k
->
vï¿½t
, k->
phys_ï¿½d
 - k->
phys_ï¿½ï¿½t
,

131 (
uï¿½t
)
k
->
phys_ï¿½ï¿½t
, k->
ï¿½rm
) < 0) {

132 
	`ï¿½vm
(
pgdï¿½
);

135  
pgdï¿½
;

136 
	}
}

141 
	$kvmï¿½loc
()

143 
kpgdï¿½
 = 
	`ï¿½tupkvm
();

144 
	`swï¿½chkvm
();

145 
	}
}

150 
	$swï¿½chkvm
()

152 
	`lï¿½3
(
	`V2P
(
kpgdï¿½
));

153 
	}
}

157 
	$swï¿½chuvm
(
ï¿½oc
 *
p
)

159 if(
p
 == 0)

160 
	`ï¿½nic
("switchuvm:ï¿½oï¿½rocess");

161 if(
p
->
kï¿½ack
 == 0)

162 
	`ï¿½nic
("switchuvm:ï¿½o kstack");

163 if(
p
->
pgdï¿½
 == 0)

164 
	`ï¿½nic
("switchuvm:ï¿½oï¿½gdir");

166 
	`pushï¿½i
();

167 
	`myï¿½u
()->
gdt
[
SEG_TSS
] = 
	`SEG16
(
STS_T32A
, &myï¿½u()->
ts
,

168 (
	`myï¿½u
()->
ts
)-1, 0);

169 
	`myï¿½u
()->
gdt
[
SEG_TSS
].
s
 = 0;

170 
	`myï¿½u
()->
ts
.
ss0
 = 
SEG_KDATA
 << 3;

171 
	`myï¿½u
()->
ts
.
eï¿½0
 = (
uï¿½t
)
p
->
kï¿½ack
 + 
KSTACKSIZE
;

174 
	`myï¿½u
()->
ts
.
iomb
 = (
ushï¿½t
) 0xFFFF;

175 
	`ï¿½r
(
SEG_TSS
 << 3);

176 
	`lï¿½3
(
	`V2P
(
p
->
pgdï¿½
));

177 
	`pï¿½ï¿½i
();

178 
	}
}

183 
	$ï¿½ï¿½uvm
(
pde_t
 *
pgdï¿½
, *
ï¿½ï¿½
, 
uï¿½t
 
sz
)

185 *
mem
;

187 if(
sz
 >ï¿½
PGSIZE
)

188 
	`ï¿½nic
("inituvm: moreï¿½hanï¿½ï¿½age");

189 
mem
 = 
	`kï¿½loc
();

190 
	`memï¿½t
(
mem
, 0, 
PGSIZE
);

191 
	`mï¿½ï¿½ges
(
pgdï¿½
, 0, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
|
PTE_U
);

192 
	`memmove
(
mem
, 
ï¿½ï¿½
, 
sz
);

193 
	}
}

198 
	$lï¿½duvm
(
pde_t
 *
pgdï¿½
, *
addr
, 
ï¿½ode
 *
ï¿½
, 
uï¿½t
 
offï¿½t
, uï¿½ï¿½
sz
)

200 
uï¿½t
 
i
, 
ï¿½
, 
n
;

201 
ï¿½e_t
 *
ï¿½e
;

203 if((
uï¿½t
ï¿½
addr
 % 
PGSIZE
 != 0)

204 
	`ï¿½nic
("loaduvm:ï¿½ddr must beï¿½ageï¿½ligned");

205 
i
 = 0; i < 
sz
; i +ï¿½
PGSIZE
){

206 if((
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, 
addr
+
i
, 0)) == 0)

207 
	`ï¿½nic
("loaduvm:ï¿½ddress shouldï¿½xist");

208 
ï¿½
 = 
	`PTE_ADDR
(*
ï¿½e
);

209 if(
sz
 - 
i
 < 
PGSIZE
)

210 
n
 = 
sz
 - 
i
;

212 
n
 = 
PGSIZE
;

213 if(
	`ï¿½adi
(
ï¿½
, 
	`P2V
(
ï¿½
), 
offï¿½t
+
i
, 
n
) !=ï¿½)

217 
	}
}

222 
	$ï¿½locuvm
(
pde_t
 *
pgdï¿½
, 
uï¿½t
 
ï¿½dsz
, uï¿½ï¿½
ï¿½wsz
)

224 *
mem
;

225 
uï¿½t
 
a
;

227 if(
ï¿½wsz
 >ï¿½
KERNBASE
)

229 if(
ï¿½wsz
 < 
ï¿½dsz
)

230  
ï¿½dsz
;

232 
a
 = 
	`PGROUNDUP
(
ï¿½dsz
);

233 ; 
a
 < 
ï¿½wsz
;ï¿½ +ï¿½
PGSIZE
){

234 
mem
 = 
	`kï¿½loc
();

235 if(
mem
 == 0){

236 
	`ï¿½rï¿½tf
("allocuvm out of memory\n");

237 
	`dï¿½ï¿½ocuvm
(
pgdï¿½
, 
ï¿½wsz
, 
ï¿½dsz
);

240 
	`memï¿½t
(
mem
, 0, 
PGSIZE
);

241 if(
	`mï¿½ï¿½ges
(
pgdï¿½
, (*)
a
, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
|
PTE_U
) < 0){

242 
	`ï¿½rï¿½tf
("allocuvm out of memory (2)\n");

243 
	`dï¿½ï¿½ocuvm
(
pgdï¿½
, 
ï¿½wsz
, 
ï¿½dsz
);

244 
	`kï¿½
(
mem
);

248  
ï¿½wsz
;

249 
	}
}

256 
	$dï¿½ï¿½ocuvm
(
pde_t
 *
pgdï¿½
, 
uï¿½t
 
ï¿½dsz
, uï¿½ï¿½
ï¿½wsz
)

258 
ï¿½e_t
 *
ï¿½e
;

259 
uï¿½t
 
a
, 
ï¿½
;

261 if(
ï¿½wsz
 >ï¿½
ï¿½dsz
)

262  
ï¿½dsz
;

264 
a
 = 
	`PGROUNDUP
(
ï¿½wsz
);

265 ; 
a
 < 
ï¿½dsz
;ï¿½ +ï¿½
PGSIZE
){

266 
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, (*)
a
, 0);

267 if(!
ï¿½e
)

268 
a
 = 
	`PGADDR
(
	`PDX
ï¿½ï¿½+ 1, 0, 0ï¿½- 
PGSIZE
;

269 if((*
ï¿½e
 & 
PTE_P
) != 0){

270 
ï¿½
 = 
	`PTE_ADDR
(*
ï¿½e
);

271 if(
ï¿½
 == 0)

272 
	`ï¿½nic
("kfree");

273 *
v
 = 
	`P2V
(
ï¿½
);

274 
	`kï¿½
(
v
);

275 *
ï¿½e
 = 0;

278  
ï¿½wsz
;

279 
	}
}

284 
	$ï¿½vm
(
pde_t
 *
pgdï¿½
)

286 
uï¿½t
 
i
;

288 if(
pgdï¿½
 == 0)

289 
	`ï¿½nic
("freevm:ï¿½oï¿½gdir");

290 
	`dï¿½ï¿½ocuvm
(
pgdï¿½
, 
KERNBASE
, 0);

291 
i
 = 0; i < 
NPDENTRIES
; i++){

292 if(
pgdï¿½
[
i
] & 
PTE_P
){

293 * 
v
 = 
	`P2V
(
	`PTE_ADDR
(
pgdï¿½
[
i
]));

294 
	`kï¿½
(
v
);

297 
	`kï¿½
((*)
pgdï¿½
);

298 
	}
}

303 
	$ï¿½ï¿½ï¿½ï¿½u
(
pde_t
 *
pgdï¿½
, *
uva
)

305 
ï¿½e_t
 *
ï¿½e
;

307 
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, 
uva
, 0);

308 if(
ï¿½e
 == 0)

309 
	`ï¿½nic
("clearpteu");

310 *
ï¿½e
 &ï¿½~
PTE_U
;

311 
	}
}

315 
pde_t
*

316 
	$cï¿½yuvm
(
pde_t
 *
pgdï¿½
, 
uï¿½t
 
sz
)

318 
pde_t
 *
d
;

319 
ï¿½e_t
 *
ï¿½e
;

320 
uï¿½t
 
ï¿½
, 
i
, 
ï¿½ags
;

321 *
mem
;

323 if((
d
 = 
	`ï¿½tupkvm
()) == 0)

325 
i
 = 0; i < 
sz
; i +ï¿½
PGSIZE
){

326 if((
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, (*ï¿½
i
, 0)) == 0)

327 
	`ï¿½nic
("copyuvm:ï¿½te shouldï¿½xist");

328 if(!(*
ï¿½e
 & 
PTE_P
))

329 
	`ï¿½nic
("copyuvm:ï¿½ageï¿½otï¿½resent");

330 
ï¿½
 = 
	`PTE_ADDR
(*
ï¿½e
);

331 
ï¿½ags
 = 
	`PTE_FLAGS
(*
ï¿½e
);

332 if((
mem
 = 
	`kï¿½loc
()) == 0)

333 
bad
;

334 
	`memmove
(
mem
, (*)
	`P2V
(
ï¿½
), 
PGSIZE
);

335 if(
	`mï¿½ï¿½ges
(
d
, (*)
i
, 
PGSIZE
, 
	`V2P
(
mem
), 
ï¿½ags
) < 0) {

336 
	`kï¿½
(
mem
);

337 
bad
;

340  
d
;

342 
bad
:

343 
	`ï¿½vm
(
d
);

345 
	}
}

350 
	$uva2ka
(
pde_t
 *
pgdï¿½
, *
uva
)

352 
ï¿½e_t
 *
ï¿½e
;

354 
ï¿½e
 = 
	`wï¿½kpgdï¿½
(
pgdï¿½
, 
uva
, 0);

355 if((*
ï¿½e
 & 
PTE_P
) == 0)

357 if((*
ï¿½e
 & 
PTE_U
) == 0)

359  (*)
	`P2V
(
	`PTE_ADDR
(*
ï¿½e
));

360 
	}
}

366 
	$cï¿½yout
(
pde_t
 *
pgdï¿½
, 
uï¿½t
 
va
, *
p
, uï¿½ï¿½
ï¿½n
)

368 *
buf
, *
ï¿½0
;

369 
uï¿½t
 
n
, 
va0
;

371 
buf
 = (*)
p
;

372 
ï¿½n
 > 0){

373 
va0
 = (
uï¿½t
)
	`PGROUNDDOWN
(
va
);

374 
ï¿½0
 = 
	`uva2ka
(
pgdï¿½
, (*)
va0
);

375 if(
ï¿½0
 == 0)

377 
n
 = 
PGSIZE
 - (
va
 - 
va0
);

378 if(
n
 > 
ï¿½n
)

379 
n
 = 
ï¿½n
;

380 
	`memmove
(
ï¿½0
 + (
va
 - 
va0
), 
buf
, 
n
);

381 
ï¿½n
 -ï¿½
n
;

382 
buf
 +ï¿½
n
;

383 
va
 = 
va0
 + 
PGSIZE
;

386 
	}
}

	@wc.c

1 
	~"tyï¿½s.h
"

2 
	~"ï¿½ï¿½.h
"

3 
	~"uï¿½r.h
"

5 
	gbuf
[512];

8 
	$wc
(
fd
, *
ï¿½me
)

10 
i
, 
n
;

11 
l
, 
w
, 
c
, 
ï¿½wï¿½d
;

13 
l
 = 
w
 = 
c
 = 0;

14 
ï¿½wï¿½d
 = 0;

15 (
n
 = 
	`ï¿½ad
(
fd
, 
buf
, (buf))) > 0){

16 
i
=0; i<
n
; i++){

17 
c
++;

18 if(
buf
[
i
] == '\n')

19 
l
++;

20 if(
	`ï¿½rchr
(" \r\t\n\v", 
buf
[
i
]))

21 
ï¿½wï¿½d
 = 0;

22 if(!
ï¿½wï¿½d
){

23 
w
++;

24 
ï¿½wï¿½d
 = 1;

28 if(
n
 < 0){

29 
	`ï¿½ï¿½tf
(1, "wc:ï¿½eadï¿½rror\n");

30 
	`exï¿½
();

32 
	`ï¿½ï¿½tf
(1, "%d %d %d %s\n", 
l
, 
w
, 
c
, 
ï¿½me
);

33 
	}
}

36 
	$maï¿½
(
ï¿½gc
, *
ï¿½gv
[])

38 
fd
, 
i
;

40 if(
ï¿½gc
 <= 1){

41 
	`wc
(0, "");

42 
	`exï¿½
();

45 
i
 = 1; i < 
ï¿½gc
; i++){

46 if((
fd
 = 
	`Ý’
(
ï¿½gv
[
i
], 0)) < 0){

47 
	`ï¿½ï¿½tf
(1, "wc: cï¿½nï¿½ oï¿½ï¿½%s\n", 
ï¿½gv
[
i
]);

48 
	`exï¿½
();

50 
	`wc
(
fd
, 
ï¿½gv
[
i
]);

51 
	`ï¿½oï¿½
(
fd
);

53 
	`exï¿½
();

54 
	}
}

	@x86.h

3 
ï¿½lï¿½e
 
uchï¿½


4 
	$ï¿½b
(
ushï¿½t
 
pï¿½t
)

6 
uchï¿½
 
dï¿½a
;

8 
asm
 vÞ©ï¿½e("ï¿½ %1,%0" : "ï¿½" (
dï¿½a
ï¿½: "d" (
pï¿½t
));

9  
dï¿½a
;

10 
	}
}

12 
ï¿½lï¿½e
 

13 
	$ï¿½ï¿½
(
pï¿½t
, *
addr
, 
ï¿½t
)

15 
asm
 volatile("cld;ï¿½ep insl" :

16 "=D" (
addr
), "=c" (
ï¿½t
) :

17 "d" (
pï¿½t
), "0" (
addr
), "1" (
ï¿½t
) :

19 
	}
}

21 
ï¿½lï¿½e
 

22 
	$outb
(
ushï¿½t
 
pï¿½t
, 
uchï¿½
 
dï¿½a
)

24 
asm
 vÞ©ï¿½e("ouï¿½%0,%1" : : "a" (
dï¿½a
), "d" (
pï¿½t
));

25 
	}
}

27 
ï¿½lï¿½e
 

28 
	$outw
(
ushï¿½t
 
pï¿½t
, ushÜˆ
dï¿½a
)

30 
asm
 vÞ©ï¿½e("ouï¿½%0,%1" : : "a" (
dï¿½a
), "d" (
pï¿½t
));

31 
	}
}

33 
ï¿½lï¿½e
 

34 
	$outï¿½
(
pï¿½t
, cÚ¡ *
addr
, 
ï¿½t
)

36 
asm
 volatile("cld;ï¿½ep outsl" :

37 "=S" (
addr
), "=c" (
ï¿½t
) :

38 "d" (
pï¿½t
), "0" (
addr
), "1" (
ï¿½t
) :

40 
	}
}

42 
ï¿½lï¿½e
 

43 
	$ï¿½osb
(*
addr
, 
dï¿½a
, 
ï¿½t
)

45 
asm
 volatile("cld;ï¿½ep stosb" :

46 "=D" (
addr
), "=c" (
ï¿½t
) :

47 "0" (
addr
), "1" (
ï¿½t
), "a" (
dï¿½a
) :

49 
	}
}

51 
ï¿½lï¿½e
 

52 
	$ï¿½oï¿½
(*
addr
, 
dï¿½a
, 
ï¿½t
)

54 
asm
 volatile("cld;ï¿½ep stosl" :

55 "=D" (
addr
), "=c" (
ï¿½t
) :

56 "0" (
addr
), "1" (
ï¿½t
), "a" (
dï¿½a
) :

58 
	}
}

60 
	gï¿½gdesc
;

62 
ï¿½lï¿½e
 

63 
	$lgdt
(
ï¿½gdesc
 *
p
, 
size
)

65 vÞ©ï¿½ï¿½
ushï¿½t
 
pd
[3];

67 
pd
[0] = 
size
-1;

68 
pd
[1] = (
uï¿½t
)
p
;

69 
pd
[2] = (
uï¿½t
)
p
 >> 16;

71 
asm
 vÞ©ï¿½e("lgdï¿½(%0)" : : "r" (
pd
));

72 
	}
}

74 
	ggï¿½edesc
;

76 
ï¿½lï¿½e
 

77 
	$lidt
(
gï¿½edesc
 *
p
, 
size
)

79 vÞ©ï¿½ï¿½
ushï¿½t
 
pd
[3];

81 
pd
[0] = 
size
-1;

82 
pd
[1] = (
uï¿½t
)
p
;

83 
pd
[2] = (
uï¿½t
)
p
 >> 16;

85 
asm
 vÞ©ï¿½e("lidï¿½(%0)" : : "r" (
pd
));

86 
	}
}

88 
ï¿½lï¿½e
 

89 
	$ï¿½r
(
ushï¿½t
 
ï¿½l
)

91 
asm
 vÞ©ï¿½e("É¸%0" : : "r" (
ï¿½l
));

92 
	}
}

94 
ï¿½lï¿½e
 
uï¿½t


95 
	$ï¿½adeï¿½ags
()

97 
uï¿½t
 
eï¿½ags
;

98 
asm
 vÞ©ï¿½e("pushï¿½;ï¿½ï¿½ï¿½%0" : "ï¿½" (
eï¿½ags
));

99  
eï¿½ags
;

100 
	}
}

102 
ï¿½lï¿½e
 

103 
	$lï¿½dgs
(
ushï¿½t
 
v
)

105 
asm
 vÞ©ï¿½e("movw %0, %%gs" : : "r" (
v
));

106 
	}
}

108 
ï¿½lï¿½e
 

109 
	$ï¿½i
()

111 
asm
 volatile("cli");

112 
	}
}

114 
ï¿½lï¿½e
 

115 
	$ï¿½i
()

117 
asm
 volatile("sti");

118 
	}
}

120 
ï¿½lï¿½e
 
uï¿½t


121 
	$xchg
(vÞ©ï¿½ï¿½
uï¿½t
 *
addr
, uï¿½ï¿½
ï¿½wvï¿½
)

123 
uï¿½t
 
ï¿½suï¿½
;

126 
asm
 volatile("lock; xchgl %0, %1" :

127 "+m" (*
addr
), "ï¿½" (
ï¿½suï¿½
) :

128 "1" (
ï¿½wvï¿½
) :

130  
ï¿½suï¿½
;

131 
	}
}

133 
ï¿½lï¿½e
 
uï¿½t


134 
	$rï¿½2
()

136 
uï¿½t
 
vï¿½
;

137 
asm
 vÞ©ï¿½e("movï¿½%%ï¿½2,%0" : "ï¿½" (
vï¿½
));

138  
vï¿½
;

139 
	}
}

141 
ï¿½lï¿½e
 

142 
	$lï¿½3
(
uï¿½t
 
vï¿½
)

144 
asm
 vÞ©ï¿½e("movï¿½%0,%%ï¿½3" : : "r" (
vï¿½
));

145 
	}
}

150 
	sï¿½ï¿½ï¿½ame
 {

152 
uï¿½t
 
	medi
;

153 
uï¿½t
 
	mesi
;

154 
uï¿½t
 
	mebp
;

155 
uï¿½t
 
	mÛ¥
;

156 
uï¿½t
 
	mebx
;

157 
uï¿½t
 
	medx
;

158 
uï¿½t
 
	mecx
;

159 
uï¿½t
 
	mï¿½x
;

162 
ushï¿½t
 
	mgs
;

163 
ushï¿½t
 
	mï¿½ddï¿½g1
;

164 
ushï¿½t
 
	mfs
;

165 
ushï¿½t
 
	mï¿½ddï¿½g2
;

166 
ushï¿½t
 
	mes
;

167 
ushï¿½t
 
	mï¿½ddï¿½g3
;

168 
ushï¿½t
 
	mds
;

169 
ushï¿½t
 
	mï¿½ddï¿½g4
;

170 
uï¿½t
 
	mï¿½ï¿½no
;

173 
uï¿½t
 
	mï¿½r
;

174 
uï¿½t
 
	meï¿½
;

175 
ushï¿½t
 
	mcs
;

176 
ushï¿½t
 
	mï¿½ddï¿½g5
;

177 
uï¿½t
 
	meï¿½ags
;

180 
uï¿½t
 
	meï¿½
;

181 
ushï¿½t
 
	mss
;

182 
ushï¿½t
 
	mï¿½ddï¿½g6
;

	@zombie.c

4 
	~"tyï¿½s.h
"

5 
	~"ï¿½ï¿½.h
"

6 
	~"uï¿½r.h
"

9 
	$maï¿½
()

11 if(
	`fï¿½k
() > 0)

12 
	`ï¿½ï¿½p
(5);

13 
	`exï¿½
();

14 
	}
}

	@
1
.
0
76
600
asm.h
bio.c
bootasm.S
bootmain.c
buf.h
cat.c
console.c
date.h
defs.h
echo.c
elf.h
entry.S
entryother.S
exec.c
fcntl.h
file.c
file.h
forktest.c
fs.c
fs.h
grep.c
ide.c
init.c
initcode.S
ioapic.c
kalloc.c
kbd.c
kbd.h
kill.c
lapic.c
ln.c
log.c
ls.c
main.c
memide.c
memlayout.h
mkdir.c
mkfs.c
mmu.h
mp.c
mp.h
param.h
picirq.c
pipe.c
printf.c
proc.c
proc.h
rm.c
sh.c
sleeplock.c
sleeplock.h
spinlock.c
spinlock.h
stat.h
stressfs.c
string.c
swtch.S
syscall.c
syscall.h
sysfile.c
sysproc.c
trap.c
trapasm.S
traps.h
types.h
uart.c
ulib.c
umalloc.c
user.h
usertests.c
usys.S
vectors.S
vm.c
wc.c
x86.h
zombie.c
